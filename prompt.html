<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinVerse å¼€å‘æç¤ºè¯ - å®Œæ•´æ–‡æ¡£</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-tertiary: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --success: #10b981;
            --warning: #f59e0b;
            --border: #374151;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            position: sticky;
            top: 0;
            height: 100vh;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-tertiary);
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .sidebar-header p {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .nav-tree {
            padding: 16px;
        }

        .nav-chapter {
            margin-bottom: 12px;
        }

        .nav-chapter-title {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            transition: background 0.2s;
        }

        .nav-chapter-title:hover {
            background: var(--bg-tertiary);
        }

        .nav-chapter-title.active {
            background: var(--accent);
            color: white;
        }

        .nav-chapter-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .nav-sections {
            margin-left: 32px;
            margin-top: 8px;
            display: none;
        }

        .nav-chapter.expanded .nav-sections {
            display: block;
        }

        .nav-section {
            padding: 6px 12px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .nav-section:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Top Bar */
        .topbar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats {
            display: flex;
            gap: 24px;
        }

        .stat {
            display: flex;
            flex-direction: column;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
        }

        .topbar-actions {
            display: flex;
            gap: 12px;
        }

        /* Search */
        .search-container {
            position: relative;
        }

        .search-input {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            padding: 8px 36px 8px 12px;
            border-radius: 6px;
            color: var(--text-primary);
            width: 280px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* Content Area */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 32px 48px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* Markdown Styles */
        .content h1 {
            font-size: 36px;
            font-weight: 700;
            margin-top: 48px;
            margin-bottom: 24px;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 16px;
        }

        .content h2 {
            font-size: 28px;
            font-weight: 700;
            margin-top: 36px;
            margin-bottom: 16px;
            color: var(--accent);
        }

        .content h3 {
            font-size: 22px;
            font-weight: 600;
            margin-top: 28px;
            margin-bottom: 12px;
        }

        .content h4 {
            font-size: 18px;
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .content p {
            margin-bottom: 16px;
            line-height: 1.8;
        }

        .content ul, .content ol {
            margin-bottom: 16px;
            padding-left: 24px;
        }

        .content li {
            margin-bottom: 8px;
        }

        .content blockquote {
            border-left: 4px solid var(--accent);
            padding-left: 16px;
            margin: 20px 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        .content code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            color: #f472b6;
        }

        .content pre {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
            position: relative;
        }

        .content pre code {
            background: none;
            padding: 0;
            color: #e5e7eb;
        }

        .code-block {
            position: relative;
        }

        .copy-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: var(--accent);
            color: white;
        }

        .copy-btn.copied {
            background: var(--success);
            color: white;
        }

        .content table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .content table th,
        .content table td {
            padding: 12px;
            border: 1px solid var(--border);
            text-align: left;
        }

        .content table th {
            background: var(--bg-tertiary);
            font-weight: 600;
        }

        .content hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 32px 0;
        }

        .content a {
            color: var(--accent);
            text-decoration: none;
        }

        .content a:hover {
            text-decoration: underline;
        }

        /* Chapter Header */
        .chapter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .chapter-number {
            font-size: 48px;
            font-weight: 900;
            color: var(--accent);
            opacity: 0.3;
        }

        .chapter-info {
            flex: 1;
            margin-left: 24px;
        }

        .chapter-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .chapter-desc {
            color: var(--text-secondary);
            font-size: 16px;
        }

        /* Progress Tracker */
        .progress-tracker {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            min-width: 200px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        .progress-tracker h3 {
            font-size: 14px;
            margin-bottom: 12px;
        }

        .progress-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .progress-checkbox {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .content {
                padding: 24px 16px;
            }

            .stats {
                display: none;
            }
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-size: 24px;
            color: var(--text-secondary);
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div>åŠ è½½ä¸­...</div>
    </div>

    <div id="app" class="container hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>FinVerse å¼€å‘æç¤ºè¯</h1>
                <p>æç»†é¢—ç²’åº¦å¯æ‰§è¡Œå¼€å‘æŒ‡å—</p>
            </div>
            <div id="nav-tree" class="nav-tree"></div>
        </div>

        <!-- Main Content -->
        <div class="main">
            <!-- Top Bar -->
            <div class="topbar">
                <div class="stats">
                    <div class="stat">
                        <span class="stat-label">ç« èŠ‚æ•°</span>
                        <span class="stat-value" id="chapter-count">18</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">ä»£ç å—</span>
                        <span class="stat-value" id="code-block-count">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">é¢„è®¡å¼€å‘æ—¶é—´</span>
                        <span class="stat-value">3ä¸ªæœˆ</span>
                    </div>
                </div>
                <div class="topbar-actions">
                    <div class="search-container">
                        <input 
                            type="text" 
                            class="search-input" 
                            id="search-input" 
                            placeholder="æœç´¢..."
                        >
                        <span class="search-icon">ğŸ”</span>
                    </div>
                    <button class="btn btn-primary" onclick="copyAll()">ğŸ“‹ å¤åˆ¶å…¨éƒ¨</button>
                </div>
            </div>

            <!-- Content -->
            <div class="content" id="content"></div>
        </div>

        <!-- Progress Tracker -->
        <div class="progress-tracker">
            <h3>ğŸ“Š è¿›åº¦è¿½è¸ª</h3>
            <div id="progress-list"></div>
        </div>
    </div>

    <script>
        // æ‰€æœ‰ç« èŠ‚çš„å®Œæ•´å†…å®¹
        const CHAPTERS_CONTENT = `
# FinVerse å¼€å‘æç¤ºè¯ - å®Œæ•´æ–‡æ¡£

> ç”Ÿæˆæ—¶é—´ï¼š2026-02-08
> è¦†ç›–ç« èŠ‚ï¼š1-18ï¼ˆå®Œæ•´ç‰ˆï¼‰

---

# FinVerse å¼€å‘æç¤ºè¯ Part A (ç« èŠ‚ 1-6)

> æç»†é¢—ç²’åº¦å¯æ‰§è¡Œå¼€å‘æŒ‡ä»¤
> ç”Ÿæˆæ—¶é—´ï¼š2026-02-08
> è¦†ç›–ç« èŠ‚ï¼šä¸€è‡³å…­

---

## ç« èŠ‚ä¸€ï¼šæ ¸å¿ƒå‘½é¢˜ - å¼€å‘å®ç°

### 1.1 æ ¸å¿ƒä»·å€¼ä¸»å¼ å±•ç¤ºç³»ç»Ÿ

#### æ•°æ®åº“ Schema

\`\`\`sql
-- ç”¨æˆ·æ ¸å¿ƒä»·å€¼è®¤çŸ¥è¡¨
CREATE TABLE user_value_propositions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    understands_core_value BOOLEAN DEFAULT FALSE, -- æ˜¯å¦ç†è§£"ä¿¡æ¯å‘ˆç°è®¾è®¡"æ ¸å¿ƒä»·å€¼
    onboarding_shown_at TIMESTAMP,
    value_test_completed_at TIMESTAMP,
    value_test_score INTEGER, -- 0-100ï¼Œæµ‹è¯•ç†è§£ç¨‹åº¦
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_user_value_propositions_user_id ON user_value_propositions(user_id);

-- æ ¸å¿ƒå‘½é¢˜å±•ç¤ºå†…å®¹è¡¨ï¼ˆæ”¯æŒ A/B æµ‹è¯•ï¼‰
CREATE TABLE value_proposition_variants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    variant_name VARCHAR(50) NOT NULL, -- 'default', 'technical', 'simple'
    headline TEXT NOT NULL,
    subheadline TEXT,
    key_points JSONB, -- ["ä¿¡æ¯å‘ˆç°è®¾è®¡", "AIåˆ†æå¯è§†åŒ–", "åŠ©åŠ›å†³ç­–"]
    demo_type VARCHAR(50), -- 'interactive', 'video', 'static'
    conversion_rate DECIMAL(5,4), -- è½¬åŒ–ç‡ç»Ÿè®¡
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);
\`\`\`

#### API Endpoints

\`\`\`typescript
// POST /api/v1/onboarding/value-proposition
// è®°å½•ç”¨æˆ·æŸ¥çœ‹æ ¸å¿ƒä»·å€¼ä¸»å¼ 
interface ValuePropositionViewRequest {
    variant_id: string;
    time_spent_seconds: number;
    interaction_events: Array<{
        event_type: 'scroll' | 'click' | 'hover';
        element_id: string;
        timestamp: number;
    }>;
}

interface ValuePropositionViewResponse {
    success: boolean;
    next_step: 'api_key_setup' | 'demo' | 'skip';
    personalized_message: string;
}

// Error Codes:
// 400: Invalid variant_id
// 401: Unauthorized
// 500: Internal server error
\`\`\`

#### å‰ç«¯ç»„ä»¶ï¼šValuePropositionHero

\`\`\`tsx
// components/onboarding/ValuePropositionHero.tsx
import { motion } from 'framer-motion';
import { useState, useEffect } from 'react';

interface ValuePropositionHeroProps {
    variant: 'default' | 'technical' | 'simple';
}

export const ValuePropositionHero: React.FC<ValuePropositionHeroProps> = ({ variant }) => {
    const [activePoint, setActivePoint] = useState(0);
    
    return (
        <div className="value-hero">
            {/* å¸ƒå±€ï¼šå‚ç›´å±…ä¸­ï¼Œæœ€å¤§å®½åº¦ 1200px */}
            <motion.div
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ duration: 0.6 }}
                className="hero-container"
                style={{
                    maxWidth: '1200px',
                    margin: '0 auto',
                    padding: '80px 24px',
                    textAlign: 'center'
                }}
            >
                {/* ä¸»æ ‡é¢˜ */}
                <h1 style={{
                    fontSize: '56px',
                    fontWeight: 700,
                    lineHeight: '1.2',
                    color: '#0A0E27', // æ·±è“é»‘
                    marginBottom: '24px',
                    fontFamily: 'Inter, -apple-system, sans-serif'
                }}>
                    AI æ—¶ä»£çš„é‡‘èåä½œå¹³å°
                </h1>
                
                {/* å‰¯æ ‡é¢˜ - æ ¸å¿ƒå‘½é¢˜ */}
                <motion.p
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    transition={{ delay: 0.3 }}
                    style={{
                        fontSize: '24px',
                        lineHeight: '1.5',
                        color: '#4A5568',
                        marginBottom: '48px',
                        maxWidth: '800px',
                        margin: '0 auto 48px'
                    }}
                >
                    æŠŠ <span style={{
                        color: '#6366F1', // å“ç‰Œç´«
                        fontWeight: 600,
                        borderBottom: '2px solid #6366F1'
                    }}>AI åˆ†æç»“æœ</span> å˜æˆäººè„‘èƒ½{' '}
                    <span style={{
                        background: 'linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%)',
                        WebkitBackgroundClip: 'text',
                        WebkitTextFillColor: 'transparent',
                        fontWeight: 700
                    }}>ç¬é—´æ¶ˆåŒ–å¹¶åšå†³ç­–</span>{' '}
                    çš„å¯è§†åŒ–ç•Œé¢
                </motion.p>

                {/* ä¸‰ä¸ªæ ¸å¿ƒä»·å€¼ç‚¹ */}
                <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(3, 1fr)',
                    gap: '32px',
                    marginTop: '64px'
                }}>
                    {[
                        {
                            icon: 'ğŸ¤–',
                            title: 'Agent æ´»åœ¨èŠå¤©è½¯ä»¶',
                            desc: 'æ—¥å¸¸æ¨é€ã€ç®€å•æŸ¥è¯¢åœ¨ Telegram/WhatsApp',
                            color: '#10B981' // ç»¿è‰²
                        },
                        {
                            icon: 'ğŸ“Š',
                            title: 'ç½‘ç«™æ˜¯å¯è§†åŒ–çœ‹æ¿',
                            desc: 'æ·±åº¦åˆ†æã€äº¤äº’å›¾è¡¨ã€å¤šç»´ä¿¡å·',
                            color: '#6366F1' // ç´«è‰²
                        },
                        {
                            icon: 'ğŸŒ',
                            title: 'å…¬åŸŸ + ç§åŸŸåä½œ',
                            desc: 'ç»“æ„åŒ–ä¿¡å·å¹¿æ’­ + å¼‚æ­¥åˆ†æå°ç»„',
                            color: '#F59E0B' // æ©™è‰²
                        }
                    ].map((point, idx) => (
                        <motion.div
                            key={idx}
                            initial={{ opacity: 0, scale: 0.9 }}
                            animate={{ opacity: 1, scale: 1 }}
                            transition={{ delay: 0.5 + idx * 0.1 }}
                            whileHover={{ 
                                scale: 1.05,
                                boxShadow: '0 20px 40px rgba(99, 102, 241, 0.2)'
                            }}
                            style={{
                                background: 'white',
                                borderRadius: '16px',
                                padding: '32px 24px',
                                border: '1px solid #E5E7EB',
                                cursor: 'pointer',
                                transition: 'all 0.3s ease'
                            }}
                            onClick={() => setActivePoint(idx)}
                        >
                            <div style={{
                                fontSize: '48px',
                                marginBottom: '16px'
                            }}>
                                {point.icon}
                            </div>
                            <h3 style={{
                                fontSize: '20px',
                                fontWeight: 600,
                                color: point.color,
                                marginBottom: '12px'
                            }}>
                                {point.title}
                            </h3>
                            <p style={{
                                fontSize: '15px',
                                color: '#6B7280',
                                lineHeight: '1.6'
                            }}>
                                {point.desc}
                            </p>
                        </motion.div>
                    ))}
                </div>

                {/* æ ¸å¿ƒå®šä½å£°æ˜ */}
                <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    transition={{ delay: 1.0 }}
                    style={{
                        marginTop: '80px',
                        padding: '40px',
                        background: 'linear-gradient(135deg, #667EEA 0%, #764BA2 100%)',
                        borderRadius: '20px',
                        color: 'white'
                    }}
                >
                    <p style={{
                        fontSize: '18px',
                        lineHeight: '1.8',
                        margin: 0
                    }}>
                        <strong>ç”¨æˆ·è‡ªå¸¦ AI å’Œæ•°æ®çš„é’¥åŒ™</strong>ï¼Œå¹³å°æä¾›è¿æ¥ã€å¯è§†åŒ–å’Œç¤¾åŒºã€‚<br/>
                        ä¸åšæ–° Appï¼ŒAgent ç›´æ¥æ´»åœ¨ä½ çš„ Telegram é‡Œã€‚
                    </p>
                </motion.div>

                {/* CTA æŒ‰é’® */}
                <motion.button
                    whileHover={{ scale: 1.05 }}
                    whileTap={{ scale: 0.95 }}
                    style={{
                        marginTop: '48px',
                        padding: '16px 48px',
                        fontSize: '18px',
                        fontWeight: 600,
                        color: 'white',
                        background: 'linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%)',
                        border: 'none',
                        borderRadius: '12px',
                        cursor: 'pointer',
                        boxShadow: '0 10px 30px rgba(99, 102, 241, 0.3)'
                    }}
                >
                    å¼€å§‹ä½¿ç”¨ â†’
                </motion.button>
            </motion.div>
        </div>
    );
};

// CSS Module (ValuePropositionHero.module.css)
/*
.value-hero {
    min-height: 100vh;
    background: linear-gradient(180deg, #F9FAFB 0%, #FFFFFF 100%);
}

@media (max-width: 768px) {
    .hero-container h1 {
        font-size: 36px !important;
    }
    .hero-container > div {
        grid-template-columns: 1fr !important;
    }
}
*/
\`\`\`

---

## ç« èŠ‚äºŒï¼šäº”ä¸ªå…³é”®å‰æ - å¼€å‘å®ç°

### 2.1 å‰æéªŒè¯ä¸ç”¨æˆ·æ•™è‚²ç³»ç»Ÿ

#### æ•°æ®åº“ Schema

\`\`\`sql
-- ç”¨æˆ·å‰æç†è§£åº¦è¡¨
CREATE TABLE user_premise_understanding (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    premise_key VARCHAR(50) NOT NULL, -- 'ai_liability', 'data_moat', 'ai_capability', 'website_role', 'ai_ui_threat'
    understands BOOLEAN DEFAULT FALSE,
    confidence_level INTEGER, -- 1-5
    last_educated_at TIMESTAMP,
    education_method VARCHAR(50), -- 'interactive_demo', 'article', 'video', 'tooltip'
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(user_id, premise_key)
);

CREATE INDEX idx_premise_understanding_user ON user_premise_understanding(user_id);

-- å‰ææ•™è‚²å†…å®¹è¡¨
CREATE TABLE premise_education_content (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    premise_key VARCHAR(50) NOT NULL,
    content_type VARCHAR(50), -- 'tooltip', 'modal', 'article', 'video'
    title TEXT,
    content JSONB, -- ç»“æ„åŒ–å†…å®¹
    cta_text VARCHAR(100),
    cta_action VARCHAR(100),
    display_priority INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);
\`\`\`

#### API Endpoints

\`\`\`typescript
// GET /api/v1/education/premises
// è·å–ç”¨æˆ·éœ€è¦å­¦ä¹ çš„å‰æçŸ¥è¯†
interface PremisesEducationRequest {
    user_id: string;
}

interface PremisesEducationResponse {
    premises: Array<{
        key: string;
        title: string;
        summary: string;
        user_understands: boolean;
        education_content: {
            type: 'tooltip' | 'modal' | 'article' | 'video';
            content: any;
        };
        priority: number; // è¶Šé«˜è¶Šä¼˜å…ˆå±•ç¤º
    }>;
    should_show_onboarding: boolean;
}

// POST /api/v1/education/premises/:premise_key/complete
// æ ‡è®°ç”¨æˆ·å·²ç†è§£æŸä¸ªå‰æ
interface CompletePremiseRequest {
    confidence_level: 1 | 2 | 3 | 4 | 5;
    method: 'interactive_demo' | 'article' | 'video' | 'tooltip';
}

interface CompletePremiseResponse {
    success: boolean;
    next_premise?: string;
    completion_percentage: number; // 0-100
}
\`\`\`

#### å‰ç«¯ç»„ä»¶ï¼šPremiseEducationModal

\`\`\`tsx
// components/education/PremiseEducationModal.tsx
import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';

interface Premise {
    key: string;
    number: number;
    title: string;
    problem: string;
    conclusion: string;
    icon: string;
    color: string;
}

const PREMISES: Premise[] = [
    {
        key: 'ai_liability',
        number: 1,
        title: 'AI æ‰¿æ‹…ä¸äº†äºæŸè´£ä»»',
        problem: 'æ³•å¾‹ä¸Š AI ä¸æ˜¯è´£ä»»ä¸»ä½“ï¼Œå¿ƒç†ä¸Šäººä¸æ„¿æŠŠé’±äº¤ç»™é»‘ç®±ï¼Œç›‘ç®¡ä¸Šä¸å…è®¸',
        conclusion: 'äººå¿…é¡»ç•™åœ¨å†³ç­–ç¯é‡Œã€‚è°å¸®ä»–çœ‹å¾—æ›´å¿«æ›´å‡†ï¼Œè°å°±æœ‰ä»·å€¼ã€‚',
        icon: 'âš–ï¸',
        color: '#EF4444'
    },
    {
        key: 'data_moat',
        number: 2,
        title: 'æ•°æ®ä¸æ˜¯æŠ¤åŸæ²³',
        problem: 'èƒ½çˆ¬çš„éƒ½èƒ½çˆ¬ï¼ŒAPI è¶Šæ¥è¶Šå¼€æ”¾ï¼Œå…è´¹æ•°æ®æºå·²è¦†ç›–å¤§éƒ¨åˆ†éœ€æ±‚',
        conclusion: 'æœ‰ç‹¬å®¶æ•°æ®å½“ç„¶å¥½ï¼Œä½†ä¸èƒ½ä½œä¸ºæ ¸å¿ƒå£å’',
        icon: 'ğŸŒŠ',
        color: '#3B82F6'
    },
    {
        key: 'ai_capability',
        number: 3,
        title: 'AI åˆ†æèƒ½åŠ›ä¼šæ™®åŠ',
        problem: 'æ¯ä¸ªäººéƒ½èƒ½è°ƒ AI åšåˆ†æ',
        conclusion: 'å·®å¼‚åŒ–ä¸åœ¨äº"èƒ½ä¸èƒ½åˆ†æ"ï¼Œåœ¨äº"åˆ†æç»“æœæ€ä¹ˆå‘ˆç°ã€æ€ä¹ˆè®©äººå¿«é€Ÿè¡ŒåŠ¨"',
        icon: 'ğŸ§ ',
        color: '#8B5CF6'
    },
    {
        key: 'website_role',
        number: 4,
        title: 'ç½‘ç«™è§’è‰²è½¬å˜',
        problem: 'ä»"ç”¨æˆ·æ‰‹åŠ¨æ“ä½œçš„å·¥å…·"å˜æˆ"AI è¾“å‡ºçš„æ˜¾ç¤ºå±"',
        conclusion: 'ç”¨æˆ·ä¸å†æ¥æ“ä½œï¼Œè€Œæ˜¯æ¥çœ‹ AI å¸®ä»–å‡†å¤‡å¥½çš„ç»“æœ',
        icon: 'ğŸ“º',
        color: '#10B981'
    },
    {
        key: 'ai_ui_threat',
        number: 5,
        title: 'ç»ˆæå¨èƒâ€”â€”AI ä¸ªæ€§åŒ–ç”Ÿæˆç•Œé¢',
        problem: 'æœªæ¥æ¯ä¸ªç”¨æˆ·çš„ AI agent å¯èƒ½è‡ªåŠ¨ç”Ÿæˆæœ€é€‚åˆä»–çš„ç•Œé¢',
        conclusion: 'çª—å£æœŸè¿˜æœ‰ 5-10 å¹´ï¼Œç°åœ¨åšæ˜¯å¯¹çš„',
        icon: 'â°',
        color: '#F59E0B'
    }
];

export const PremiseEducationModal: React.FC<{
    isOpen: boolean;
    onClose: () => void;
    onComplete: () => void;
}> = ({ isOpen, onClose, onComplete }) => {
    const [currentIndex, setCurrentIndex] = useState(0);
    const [completedPremises, setCompletedPremises] = useState<Set<string>>(new Set());

    const currentPremise = PREMISES[currentIndex];
    const progress = ((currentIndex + 1) / PREMISES.length) * 100;

    const handleNext = async () => {
        // æ ‡è®°å½“å‰å‰æä¸ºå·²ç†è§£
        setCompletedPremises(prev => new Set([...prev, currentPremise.key]));
        
        // API è°ƒç”¨
        await fetch(\`/api/v1/education/premises/\${currentPremise.key}/complete\`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                confidence_level: 4,
                method: 'modal'
            })
        });

        if (currentIndex < PREMISES.length - 1) {
            setCurrentIndex(prev => prev + 1);
        } else {
            onComplete();
        }
    };

    return (
        <AnimatePresence>
            {isOpen && (
                <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    exit={{ opacity: 0 }}
                    style={{
                        position: 'fixed',
                        inset: 0,
                        backgroundColor: 'rgba(0, 0, 0, 0.7)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        zIndex: 9999,
                        padding: '24px'
                    }}
                    onClick={onClose}
                >
                    <motion.div
                        initial={{ scale: 0.9, y: 20 }}
                        animate={{ scale: 1, y: 0 }}
                        exit={{ scale: 0.9, y: 20 }}
                        onClick={e => e.stopPropagation()}
                        style={{
                            background: 'white',
                            borderRadius: '24px',
                            maxWidth: '600px',
                            width: '100%',
                            padding: '48px',
                            position: 'relative',
                            boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)'
                        }}
                    >
                        {/* è¿›åº¦æ¡ */}
                        <div style={{
                            position: 'absolute',
                            top: 0,
                            left: 0,
                            right: 0,
                            height: '4px',
                            background: '#E5E7EB',
                            borderRadius: '24px 24px 0 0',
                            overflow: 'hidden'
                        }}>
                            <motion.div
                                initial={{ width: 0 }}
                                animate={{ width: \`\${progress}%\` }}
                                transition={{ duration: 0.3 }}
                                style={{
                                    height: '100%',
                                    background: 'linear-gradient(90deg, #6366F1 0%, #8B5CF6 100%)'
                                }}
                            />
                        </div>

                        {/* å…³é—­æŒ‰é’® */}
                        <button
                            onClick={onClose}
                            style={{
                                position: 'absolute',
                                top: '24px',
                                right: '24px',
                                background: 'none',
                                border: 'none',
                                fontSize: '24px',
                                cursor: 'pointer',
                                color: '#9CA3AF'
                            }}
                        >
                            âœ•
                        </button>

                        {/* å‰æç¼–å·å’Œå›¾æ ‡ */}
                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            marginBottom: '24px'
                        }}>
                            <div style={{
                                width: '64px',
                                height: '64px',
                                borderRadius: '16px',
                                background: \`\${currentPremise.color}15\`,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '32px',
                                marginRight: '16px'
                            }}>
                                {currentPremise.icon}
                            </div>
                            <div>
                                <div style={{
                                    fontSize: '14px',
                                    fontWeight: 600,
                                    color: currentPremise.color,
                                    marginBottom: '4px'
                                }}>
                                    å‰æ {currentPremise.number}
                                </div>
                                <h2 style={{
                                    fontSize: '24px',
                                    fontWeight: 700,
                                    color: '#0A0E27',
                                    margin: 0
                                }}>
                                    {currentPremise.title}
                                </h2>
                            </div>
                        </div>

                        {/* é—®é¢˜æè¿° */}
                        <div style={{
                            background: '#F9FAFB',
                            borderRadius: '12px',
                            padding: '20px',
                            marginBottom: '20px',
                            borderLeft: \`4px solid \${currentPremise.color}\`
                        }}>
                            <div style={{
                                fontSize: '12px',
                                fontWeight: 600,
                                color: '#6B7280',
                                marginBottom: '8px',
                                textTransform: 'uppercase',
                                letterSpacing: '0.5px'
                            }}>
                                ç°å®æƒ…å†µ
                            </div>
                            <p style={{
                                fontSize: '16px',
                                lineHeight: '1.6',
                                color: '#374151',
                                margin: 0
                            }}>
                                {currentPremise.problem}
                            </p>
                        </div>

                        {/* ç»“è®º */}
                        <div style={{
                            background: \`\${currentPremise.color}10\`,
                            borderRadius: '12px',
                            padding: '20px',
                            marginBottom: '32px',
                            border: \`2px solid \${currentPremise.color}30\`
                        }}>
                            <div style={{
                                fontSize: '12px',
                                fontWeight: 600,
                                color: currentPremise.color,
                                marginBottom: '8px',
                                textTransform: 'uppercase',
                                letterSpacing: '0.5px'
                            }}>
                                âœ“ å› æ­¤
                            </div>
                            <p style={{
                                fontSize: '17px',
                                lineHeight: '1.6',
                                color: '#0A0E27',
                                fontWeight: 600,
                                margin: 0
                            }}>
                                {currentPremise.conclusion}
                            </p>
                        </div>

                        {/* åº•éƒ¨æŒ‰é’® */}
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center'
                        }}>
                            <div style={{
                                fontSize: '14px',
                                color: '#9CA3AF'
                            }}>
                                {currentIndex + 1} / {PREMISES.length}
                            </div>
                            
                            <motion.button
                                whileHover={{ scale: 1.05 }}
                                whileTap={{ scale: 0.95 }}
                                onClick={handleNext}
                                style={{
                                    padding: '12px 32px',
                                    fontSize: '16px',
                                    fontWeight: 600,
                                    color: 'white',
                                    background: currentPremise.color,
                                    border: 'none',
                                    borderRadius: '10px',
                                    cursor: 'pointer'
                                }}
                            >
                                {currentIndex < PREMISES.length - 1 ? 'ä¸‹ä¸€ä¸ª â†’' : 'å®Œæˆ'}
                            </motion.button>
                        </div>
                    </motion.div>
                </motion.div>
            )}
        </AnimatePresence>
    );
};
\`\`\`

---

## ç« èŠ‚ä¸‰ï¼šä»€ä¹ˆä¼šæ­»ä»€ä¹ˆèƒ½æ´» - å¼€å‘å®ç°

### 3.1 ç«å“åˆ†æä¸å·®å¼‚åŒ–å±•ç¤ºç³»ç»Ÿ

#### æ•°æ®åº“ Schema

\`\`\`sql
-- ç«å“å¯¹æ¯”æ•°æ®è¡¨
CREATE TABLE competitor_comparison (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    competitor_name VARCHAR(100) NOT NULL,
    competitor_type VARCHAR(50), -- 'pure_charts', 'news_aggregator', 'screener', 'community', 'deep_interactive'
    will_die BOOLEAN, -- true = ä¼šè¢«æ›¿ä»£, false = èƒ½æ´»ä¸‹æ¥
    reason TEXT,
    time_horizon VARCHAR(50), -- '1-3å¹´å†…', '3-5å¹´', 'é•¿æœŸå­˜åœ¨'
    our_advantage TEXT, -- FinVerse ç›¸å¯¹äºå®ƒçš„ä¼˜åŠ¿
    display_order INTEGER,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- åˆå§‹åŒ–æ•°æ®
INSERT INTO competitor_comparison (competitor_name, competitor_type, will_die, reason, time_horizon, our_advantage, display_order) VALUES
('TradingView', 'pure_charts', false, 'å¼ºåœ¨ç”¨æˆ·æ‰‹ç»˜å’Œç¤¾åŒºåˆ†äº«ï¼Œä½†æœªæ¥AIä¼šè‡ªåŠ¨æ ‡æ³¨ï¼Œç”¨æˆ·ä¸å†éœ€è¦æ‰‹åŠ¨ç”»çº¿', '3-5å¹´', 'AIè‡ªåŠ¨æ ‡æ³¨ + å¤šç»´ä¿¡å·èåˆ + æ¨ç†é“¾å¯è§†åŒ–', 1),
('Yahoo Finance', 'pure_charts', true, 'AIç›´æ¥è°ƒAPIæ‹¿æ•°æ®ï¼Œä¸éœ€è¦ç½‘é¡µ', '1-3å¹´å†…', 'AIé©±åŠ¨çš„ä¿¡æ¯å‘ˆç°ï¼Œä¸åªæ˜¯å±•ç¤ºåŸå§‹æ•°æ®', 2),
('CoinGecko', 'pure_charts', true, 'AIç›´æ¥è°ƒAPIæ‹¿æ•°æ®', '1-3å¹´å†…', 'Agentåˆ†æå±‚ + ç¤¾åŒºä¿¡å·èšåˆ', 3),
('é‡‘åæ•°æ®', 'news_aggregator', true, 'AIç›´æ¥æ€»ç»“å¤šæºæ–°é—»ï¼Œæ›´å¿«æ›´å…¨', '1-3å¹´å†…', 'Agentä¸ªæ€§åŒ–æ¨é€ + æ–°é—»ä¸è¡Œæƒ…æ•°æ®è”åŠ¨åˆ†æ', 4),
('Finviz', 'screener', true, 'è‡ªç„¶è¯­è¨€ç­›é€‰æ¯”è¡¨å•ç­›é€‰æ›´å¼º', '1-3å¹´å†…', 'Agentå¯¹è¯å¼ç­›é€‰ + ç»“æœå¯è§†åŒ–çœ‹æ¿', 5),
('StockTwits', 'community', false, 'äººå’Œäººçš„äº’åŠ¨ä¸å¯æ›¿ä»£', 'é•¿æœŸå­˜åœ¨', 'å¼‚æ­¥æ·±åº¦åä½œ + AIè¾…åŠ©å‘å¸ƒ + ç»“æ„åŒ–åˆ†æ + å†å²å¤ç›˜', 6),
('Bloomberg Terminal', 'deep_interactive', false, 'ä¸“ä¸šç»ˆç«¯ï¼Œæ·±åº¦äº¤äº’ï¼ŒçŸ­æœŸAIåšä¸åˆ°', 'é•¿æœŸå­˜åœ¨', 'æˆæœ¬ä½1000å€ + AIé©±åŠ¨ + æ™®é€šäººå¯ç”¨', 7);

-- ç”¨æˆ·æŸ¥çœ‹ç«å“å¯¹æ¯”è®°å½•
CREATE TABLE user_competitor_views (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    competitor_id UUID NOT NULL REFERENCES competitor_comparison(id),
    viewed_at TIMESTAMP DEFAULT NOW(),
    time_spent_seconds INTEGER,
    converted_to_signup BOOLEAN DEFAULT FALSE
);

CREATE INDEX idx_competitor_views_user ON user_competitor_views(user_id);
\`\`\`

#### API Endpoints

\`\`\`typescript
// GET /api/v1/positioning/competitors
// è·å–ç«å“å¯¹æ¯”æ•°æ®
interface CompetitorComparisonRequest {
    filter?: 'will_die' | 'will_survive' | 'all';
}

interface CompetitorComparisonResponse {
    competitors: Array<{
        id: string;
        name: string;
        type: string;
        will_die: boolean;
        reason: string;
        time_horizon: string;
        our_advantage: string;
    }>;
    summary: {
        total: number;
        will_die_count: number;
        will_survive_count: number;
        our_positioning: string;
    };
}

// POST /api/v1/positioning/competitors/:id/view
// è®°å½•ç”¨æˆ·æŸ¥çœ‹ç«å“å¯¹æ¯”
interface CompetitorViewRequest {
    time_spent_seconds: number;
}

interface CompetitorViewResponse {
    success: boolean;
}
\`\`\`

#### å‰ç«¯ç»„ä»¶ï¼šCompetitorComparisonTable

\`\`\`tsx
// components/positioning/CompetitorComparisonTable.tsx
import { motion } from 'framer-motion';
import { useState } from 'react';

interface Competitor {
    id: string;
    name: string;
    type: string;
    will_die: boolean;
    reason: string;
    time_horizon: string;
    our_advantage: string;
}

export const CompetitorComparisonTable: React.FC = () => {
    const [filter, setFilter] = useState<'all' | 'will_die' | 'will_survive'>('all');
    const [expandedId, setExpandedId] = useState<string | null>(null);

    const competitors: Competitor[] = [
        // ... ä» API è·å–
    ];

    const filteredCompetitors = competitors.filter(c => {
        if (filter === 'all') return true;
        if (filter === 'will_die') return c.will_die;
        if (filter === 'will_survive') return !c.will_die;
        return true;
    });

    return (
        <div style={{
            maxWidth: '1400px',
            margin: '0 auto',
            padding: '60px 24px'
        }}>
            {/* æ ‡é¢˜ */}
            <h2 style={{
                fontSize: '42px',
                fontWeight: 700,
                textAlign: 'center',
                marginBottom: '16px',
                color: '#0A0E27'
            }}>
                ä»€ä¹ˆä¼šæ­»ï¼Œä»€ä¹ˆèƒ½æ´»
            </h2>
            
            <p style={{
                fontSize: '18px',
                textAlign: 'center',
                color: '#6B7280',
                marginBottom: '48px',
                maxWidth: '700px',
                margin: '0 auto 48px'
            }}>
                AI æ—¶ä»£ï¼Œä¼ ç»Ÿé‡‘èç½‘ç«™çš„æŠ¤åŸæ²³æ­£åœ¨æ¶ˆå¤±ã€‚<br/>
                FinVerse é€‰æ‹©çš„æ˜¯<strong style={{color: '#6366F1'}}>æœ€ä½³ç”Ÿå­˜ä½ç½®</strong>ã€‚
            </p>

            {/* ç­›é€‰æŒ‰é’® */}
            <div style={{
                display: 'flex',
                justifyContent: 'center',
                gap: '12px',
                marginBottom: '40px'
            }}>
                {[
                    { key: 'all', label: 'å…¨éƒ¨', color: '#6B7280' },
                    { key: 'will_die', label: 'âŒ ä¼šè¢«æ›¿ä»£', color: '#EF4444' },
                    { key: 'will_survive', label: 'âœ“ èƒ½æ´»ä¸‹æ¥', color: '#10B981' }
                ].map(btn => (
                    <button
                        key={btn.key}
                        onClick={() => setFilter(btn.key as any)}
                        style={{
                            padding: '10px 24px',
                            fontSize: '15px',
                            fontWeight: 600,
                            color: filter === btn.key ? 'white' : btn.color,
                            background: filter === btn.key ? btn.color : 'white',
                            border: \`2px solid \${btn.color}\`,
                            borderRadius: '10px',
                            cursor: 'pointer',
                            transition: 'all 0.2s'
                        }}
                    >
                        {btn.label}
                    </button>
                ))}
            </div>

            {/* å¯¹æ¯”è¡¨æ ¼ */}
            <div style={{
                background: 'white',
                borderRadius: '16px',
                border: '1px solid #E5E7EB',
                overflow: 'hidden'
            }}>
                {/* è¡¨å¤´ */}
                <div style={{
                    display: 'grid',
                    gridTemplateColumns: '2fr 1fr 3fr 2fr 1fr',
                    gap: '16px',
                    padding: '20px 24px',
                    background: '#F9FAFB',
                    borderBottom: '2px solid #E5E7EB',
                    fontWeight: 600,
                    fontSize: '14px',
                    color: '#6B7280',
                    textTransform: 'uppercase',
                    letterSpacing: '0.5px'
                }}>
                    <div>äº§å“/å¹³å°</div>
                    <div>ç±»å‹</div>
                    <div>ä¸ºä»€ä¹ˆä¼šè¢«æ›¿ä»£/èƒ½æ´»ä¸‹æ¥</div>
                    <div>FinVerse çš„ä¼˜åŠ¿</div>
                    <div>æ—¶é—´</div>
                </div>

                {/* è¡¨æ ¼å†…å®¹ */}
                {filteredCompetitors.map((competitor, idx) => (
                    <motion.div
                        key={competitor.id}
                        initial={{ opacity: 0, y: 10 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ delay: idx * 0.05 }}
                        style={{
                            borderBottom: idx < filteredCompetitors.length - 1 ? '1px solid #F3F4F6' : 'none'
                        }}
                    >
                        <div
                            onClick={() => setExpandedId(expandedId === competitor.id ? null : competitor.id)}
                            style={{
                                display: 'grid',
                                gridTemplateColumns: '2fr 1fr 3fr 2fr 1fr',
                                gap: '16px',
                                padding: '24px',
                                cursor: 'pointer',
                                transition: 'background 0.2s'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.background = '#F9FAFB';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.background = 'white';
                            }}
                        >
                            {/* äº§å“å */}
                            <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px'
                            }}>
                                <div style={{
                                    width: '8px',
                                    height: '8px',
                                    borderRadius: '50%',
                                    background: competitor.will_die ? '#EF4444' : '#10B981'
                                }} />
                                <span style={{
                                    fontSize: '16px',
                                    fontWeight: 600,
                                    color: '#0A0E27'
                                }}>
                                    {competitor.name}
                                </span>
                            </div>

                            {/* ç±»å‹æ ‡ç­¾ */}
                            <div>
                                <span style={{
                                    padding: '4px 12px',
                                    fontSize: '13px',
                                    background: '#E0E7FF',
                                    color: '#4338CA',
                                    borderRadius: '6px',
                                    fontWeight: 500
                                }}>
                                    {competitor.type}
                                </span>
                            </div>

                            {/* åŸå›  */}
                            <div style={{
                                fontSize: '15px',
                                lineHeight: '1.6',
                                color: '#374151'
                            }}>
                                {competitor.reason}
                            </div>

                            {/* æˆ‘ä»¬çš„ä¼˜åŠ¿ */}
                            <div style={{
                                fontSize: '14px',
                                lineHeight: '1.6',
                                color: '#6366F1',
                                fontWeight: 500
                            }}>
                                {competitor.our_advantage}
                            </div>

                            {/* æ—¶é—´èŒƒå›´ */}
                            <div style={{
                                fontSize: '14px',
                                color: '#9CA3AF'
                            }}>
                                {competitor.time_horizon}
                            </div>
                        </div>

                        {/* å±•å¼€çš„è¯¦ç»†ä¿¡æ¯ */}
                        {expandedId === competitor.id && (
                            <motion.div
                                initial={{ height: 0, opacity: 0 }}
                                animate={{ height: 'auto', opacity: 1 }}
                                exit={{ height: 0, opacity: 0 }}
                                style={{
                                    padding: '24px',
                                    background: '#F9FAFB',
                                    borderTop: '1px solid #E5E7EB'
                                }}
                            >
                                <h4 style={{
                                    fontSize: '16px',
                                    fontWeight: 600,
                                    marginBottom: '12px',
                                    color: '#0A0E27'
                                }}>
                                    è¯¦ç»†å¯¹æ¯”
                                </h4>
                                {/* è¿™é‡Œå¯ä»¥æ·»åŠ æ›´è¯¦ç»†çš„å¯¹æ¯”å†…å®¹ */}
                            </motion.div>
                        )}
                    </motion.div>
                ))}
            </div>

            {/* åº•éƒ¨å®šä½å£°æ˜ */}
            <motion.div
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: 0.5 }}
                style={{
                    marginTop: '60px',
                    padding: '40px',
                    background: 'linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%)',
                    borderRadius: '20px',
                    textAlign: 'center',
                    color: 'white'
                }}
            >
                <h3 style={{
                    fontSize: '28px',
                    fontWeight: 700,
                    marginBottom: '16px'
                }}>
                    FinVerse çš„å®šä½
                </h3>
                <p style={{
                    fontSize: '18px',
                    lineHeight: '1.8',
                    maxWidth: '800px',
                    margin: '0 auto'
                }}>
                    <strong>ä¿¡æ¯å‘ˆç°è®¾è®¡ + AI é©±åŠ¨</strong><br/>
                    æŠŠ AI èƒ½åŠ›å¯è§†åŒ–å‘ˆç°ï¼Œå¸®åŠ©äººåšå†³ç­–ã€‚<br/>
                    åœ¨ AI ä¸ªæ€§åŒ–ç•Œé¢åˆ°æ¥ä¹‹å‰çš„ <strong>5-10 å¹´çª—å£æœŸ</strong>ï¼Œè¿™æ˜¯æœ€ä½³ä½ç½®ã€‚
                </p>
            </motion.div>
        </div>
    );
};
\`\`\`

---

## ç« èŠ‚å››ï¼šå•†ä¸šæ¨¡å¼ - å¼€å‘å®ç°

### 4.1 ç”¨æˆ·è®¢é˜…ç³»ç»Ÿ

#### æ•°æ®åº“ Schema

\`\`\`sql
-- è®¢é˜…è®¡åˆ’è¡¨
CREATE TABLE subscription_plans (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    plan_name VARCHAR(50) NOT NULL UNIQUE, -- 'free', 'pro', 'team'
    display_name VARCHAR(100),
    price_monthly DECIMAL(10,2), -- ç¾å…ƒ
    price_yearly DECIMAL(10,2), -- ç¾å…ƒ (å¹´ä»˜æŠ˜æ‰£)
    features JSONB, -- åŠŸèƒ½åˆ—è¡¨
    limits JSONB, -- é™åˆ¶: {"max_agents": 1, "max_groups": 0, "data_sources": ["free_only"]}
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- åˆå§‹åŒ–è®¢é˜…è®¡åˆ’
INSERT INTO subscription_plans (plan_name, display_name, price_monthly, price_yearly, features, limits) VALUES
('free', 'å…è´¹ç‰ˆ', 0, 0, 
 '["ä¸ªäºº Agent", "åŸºç¡€çœ‹æ¿", "å…è´¹æ•°æ®æº", "å…¬åŸŸä¿¡å·è®¿é—®"]',
 '{"max_agents": 1, "max_groups": 0, "max_custom_strategies": 0, "data_sources": ["free_only"], "api_access": false}'),
('pro', 'Pro ç‰ˆ', 29, 290, 
 '["é«˜çº§å¯è§†åŒ–", "åˆ›å»º/åŠ å…¥å°ç»„", "æ›´å¤š Agent è‡ªå®šä¹‰", "å†å²å¤ç›˜", "ä»˜è´¹æ•°æ®æºæ¥å…¥", "æ— å¹¿å‘Š"]',
 '{"max_agents": 1, "max_groups": 10, "max_custom_strategies": 50, "data_sources": ["all"], "api_access": false}'),
('team', 'å›¢é˜Ÿç‰ˆ', 79, 790, 
 '["Pro ç‰ˆæ‰€æœ‰åŠŸèƒ½", "å¤š Agent å®ä¾‹", "API è®¿é—®", "è‡ªå®šä¹‰æ•°æ®æºæ¥å…¥", "å›¢é˜Ÿåä½œç©ºé—´", "ä¼˜å…ˆæ”¯æŒ"]',
 '{"max_agents": 5, "max_groups": -1, "max_custom_strategies": -1, "data_sources": ["all"], "api_access": true}');

-- ç”¨æˆ·è®¢é˜…è¡¨
CREATE TABLE user_subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    plan_id UUID NOT NULL REFERENCES subscription_plans(id),
    status VARCHAR(50) DEFAULT 'active', -- 'active', 'cancelled', 'expired', 'past_due'
    billing_cycle VARCHAR(20), -- 'monthly', 'yearly'
    current_period_start TIMESTAMP,
    current_period_end TIMESTAMP,
    cancel_at_period_end BOOLEAN DEFAULT FALSE,
    stripe_subscription_id VARCHAR(200), -- Stripe è®¢é˜… ID
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_user_subscriptions_user ON user_subscriptions(user_id);
CREATE INDEX idx_user_subscriptions_status ON user_subscriptions(status);

-- æ”¯ä»˜è®°å½•è¡¨
CREATE TABLE payment_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    subscription_id UUID REFERENCES user_subscriptions(id),
    amount DECIMAL(10,2),
    currency VARCHAR(10) DEFAULT 'USD',
    status VARCHAR(50), -- 'succeeded', 'pending', 'failed', 'refunded'
    payment_method VARCHAR(50), -- 'stripe', 'paypal'
    stripe_payment_intent_id VARCHAR(200),
    paid_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_payment_records_user ON payment_records(user_id);

-- API Key åˆä½œä¼™ä¼´è¡¨ (affiliate)
CREATE TABLE api_key_providers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    provider_name VARCHAR(100) NOT NULL, -- 'OpenAI', 'Anthropic', 'Glassnode'
    provider_type VARCHAR(50), -- 'ai', 'data'
    affiliate_link VARCHAR(500),
    commission_rate DECIMAL(5,4), -- 0.05 = 5%
    registration_guide_url TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- ç”¨æˆ· API Key ç®¡ç†è¡¨
CREATE TABLE user_api_keys (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    provider_id UUID NOT NULL REFERENCES api_key_providers(id),
    key_type VARCHAR(50), -- 'ai', 'data'
    encrypted_key TEXT NOT NULL, -- åŠ å¯†å­˜å‚¨çš„ API key
    key_name VARCHAR(100), -- ç”¨æˆ·è‡ªå®šä¹‰åç§°
    is_active BOOLEAN DEFAULT TRUE,
    last_used_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_user_api_keys_user ON user_api_keys(user_id);
CREATE INDEX idx_user_api_keys_provider ON user_api_keys(provider_id);
\`\`\`

#### API Endpoints - è®¢é˜…ç®¡ç†

\`\`\`typescript
// GET /api/v1/subscriptions/plans
// è·å–æ‰€æœ‰è®¢é˜…è®¡åˆ’
interface SubscriptionPlansResponse {
    plans: Array<{
        id: string;
        name: string;
        display_name: string;
        price: {
            monthly: number;
            yearly: number;
            yearly_savings: number; // å¹´ä»˜èŠ‚çœçš„é‡‘é¢
        };
        features: string[];
        limits: {
            max_agents: number;
            max_groups: number;
            max_custom_strategies: number;
            data_sources: string[];
            api_access: boolean;
        };
        is_popular: boolean; // Pro ç‰ˆæ ‡è®°ä¸ºæœ€å—æ¬¢è¿
    }>;
}

// POST /api/v1/subscriptions/checkout
// åˆ›å»ºè®¢é˜…ç»“è´¦ä¼šè¯
interface CheckoutRequest {
    plan_id: string;
    billing_cycle: 'monthly' | 'yearly';
    success_url: string;
    cancel_url: string;
}

interface CheckoutResponse {
    checkout_url: string; // Stripe Checkout URL
    session_id: string;
}

// POST /api/v1/subscriptions/upgrade
// å‡çº§è®¢é˜…
interface UpgradeRequest {
    new_plan_id: string;
    billing_cycle: 'monthly' | 'yearly';
}

interface UpgradeResponse {
    success: boolean;
    proration_amount: number; // æŒ‰æ¯”ä¾‹è®¡ç®—çš„è´¹ç”¨
    effective_date: string;
}

// POST /api/v1/subscriptions/cancel
// å–æ¶ˆè®¢é˜… (æœŸæœ«ç”Ÿæ•ˆ)
interface CancelSubscriptionRequest {
    reason?: string;
    feedback?: string;
}

interface CancelSubscriptionResponse {
    success: boolean;
    cancelled_at_period_end: boolean;
    period_end_date: string;
}

// GET /api/v1/subscriptions/usage
// è·å–å½“å‰ä½¿ç”¨æƒ…å†µ
interface UsageResponse {
    plan: {
        name: string;
        limits: any;
    };
    current_usage: {
        agents_count: number;
        groups_count: number;
        custom_strategies_count: number;
        api_calls_this_month: number;
    };
    limits_reached: {
        agents: boolean;
        groups: boolean;
        custom_strategies: boolean;
    };
}
\`\`\`

#### API Endpoints - API Key ç®¡ç†

\`\`\`typescript
// GET /api/v1/api-keys/providers
// è·å–æ‰€æœ‰ API æä¾›å•†åˆ—è¡¨
interface APIProvidersResponse {
    providers: Array<{
        id: string;
        name: string;
        type: 'ai' | 'data';
        description: string;
        registration_guide_url: string;
        affiliate_link: string;
        pricing_info: string;
        features: string[];
    }>;
    ai_providers: any[]; // OpenAI, Anthropic, DeepSeek, Minimax
    data_providers: any[]; // CoinGecko, Glassnode, Polygon.io
}

// POST /api/v1/api-keys
// æ·»åŠ  API Key
interface AddAPIKeyRequest {
    provider_id: string;
    api_key: string; // åŸå§‹ keyï¼Œåç«¯è´Ÿè´£åŠ å¯†
    key_name?: string;
}

interface AddAPIKeyResponse {
    success: boolean;
    key_id: string;
    validation: {
        is_valid: boolean;
        error_message?: string;
    };
}

// Error Codes:
// 400: Invalid API key format
// 401: API key validation failed (tested against provider API)
// 409: Key already exists
// 500: Encryption failed

// DELETE /api/v1/api-keys/:key_id
// åˆ é™¤ API Key
interface DeleteAPIKeyResponse {
    success: boolean;
    warning: string; // "æ­¤ Key æ­£åœ¨è¢« Agent ä½¿ç”¨ï¼Œåˆ é™¤å Agent å°†æ— æ³•è°ƒç”¨è¯¥æœåŠ¡"
}

// PUT /api/v1/api-keys/:key_id
// æ›´æ–° API Key (rotate)
interface UpdateAPIKeyRequest {
    new_api_key: string;
}

interface UpdateAPIKeyResponse {
    success: boolean;
    validated: boolean;
}

// GET /api/v1/api-keys/:key_id/usage
// æŸ¥çœ‹ API Key ä½¿ç”¨ç»Ÿè®¡
interface APIKeyUsageResponse {
    key_id: string;
    provider_name: string;
    usage_this_month: {
        total_calls: number;
        estimated_cost: number; // åŸºäºå·²çŸ¥çš„å®šä»·ä¼°ç®—
        by_day: Array<{
            date: string;
            calls: number;
            cost: number;
        }>;
    };
    last_used_at: string;
}
\`\`\`

#### å‰ç«¯ç»„ä»¶ï¼šPricingTable

\`\`\`tsx
// components/pricing/PricingTable.tsx
import { motion } from 'framer-motion';
import { useState } from 'react';

interface Plan {
    id: string;
    name: string;
    display_name: string;
    price: {
        monthly: number;
        yearly: number;
    };
    features: string[];
    limits: any;
    is_popular: boolean;
}

export const PricingTable: React.FC = () => {
    const [billingCycle, setBillingCycle] = useState<'monthly' | 'yearly'>('monthly');

    const plans: Plan[] = [
        {
            id: 'free',
            name: 'free',
            display_name: 'å…è´¹ç‰ˆ',
            price: { monthly: 0, yearly: 0 },
            features: [
                'âœ“ ä¸ªäºº Agent',
                'âœ“ åŸºç¡€çœ‹æ¿',
                'âœ“ å…è´¹æ•°æ®æº',
                'âœ“ å…¬åŸŸä¿¡å·è®¿é—®'
            ],
            limits: {},
            is_popular: false
        },
        {
            id: 'pro',
            name: 'pro',
            display_name: 'Pro ç‰ˆ',
            price: { monthly: 29, yearly: 290 },
            features: [
                'âœ“ é«˜çº§å¯è§†åŒ–',
                'âœ“ åˆ›å»º/åŠ å…¥å°ç»„',
                'âœ“ Agent è‡ªå®šä¹‰',
                'âœ“ å†å²å¤ç›˜',
                'âœ“ ä»˜è´¹æ•°æ®æºæ¥å…¥',
                'âœ“ æ— å¹¿å‘Š'
            ],
            limits: {},
            is_popular: true
        },
        {
            id: 'team',
            name: 'team',
            display_name: 'å›¢é˜Ÿç‰ˆ',
            price: { monthly: 79, yearly: 790 },
            features: [
                'âœ“ Pro ç‰ˆæ‰€æœ‰åŠŸèƒ½',
                'âœ“ å¤š Agent å®ä¾‹ (æœ€å¤š5ä¸ª)',
                'âœ“ API è®¿é—®',
                'âœ“ è‡ªå®šä¹‰æ•°æ®æºæ¥å…¥',
                'âœ“ å›¢é˜Ÿåä½œç©ºé—´',
                'âœ“ ä¼˜å…ˆæ”¯æŒ'
            ],
            limits: {},
            is_popular: false
        }
    ];

    const getPrice = (plan: Plan) => {
        return billingCycle === 'monthly' ? plan.price.monthly : plan.price.yearly;
    };

    const getSavings = (plan: Plan) => {
        if (billingCycle === 'yearly' && plan.price.monthly > 0) {
            const yearlyIfMonthly = plan.price.monthly * 12;
            return yearlyIfMonthly - plan.price.yearly;
        }
        return 0;
    };

    return (
        <div style={{
            maxWidth: '1400px',
            margin: '0 auto',
            padding: '80px 24px'
        }}>
            {/* æ ‡é¢˜ */}
            <h2 style={{
                fontSize: '48px',
                fontWeight: 700,
                textAlign: 'center',
                marginBottom: '16px',
                color: '#0A0E27'
            }}>
                ç®€å•é€æ˜çš„å®šä»·
            </h2>
            
            <p style={{
                fontSize: '20px',
                textAlign: 'center',
                color: '#6B7280',
                marginBottom: '48px'
            }}>
                <strong style={{color: '#6366F1'}}>AI å’Œæ•°æ®æˆæœ¬ç”±ä½ è‡ªå·±æ§åˆ¶</strong>ï¼Œå¹³å°åªæ”¶å–æœåŠ¡è´¹
            </p>

            {/* è®¡è´¹å‘¨æœŸåˆ‡æ¢ */}
            <div style={{
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center',
                gap: '16px',
                marginBottom: '60px'
            }}>
                <span style={{
                    fontSize: '16px',
                    fontWeight: 600,
                    color: billingCycle === 'monthly' ? '#0A0E27' : '#9CA3AF'
                }}>
                    æŒ‰æœˆä»˜è´¹
                </span>
                
                <button
                    onClick={() => setBillingCycle(prev => prev === 'monthly' ? 'yearly' : 'monthly')}
                    style={{
                        width: '60px',
                        height: '32px',
                        borderRadius: '16px',
                        background: billingCycle === 'yearly' ? '#6366F1' : '#E5E7EB',
                        border: 'none',
                        cursor: 'pointer',
                        position: 'relative',
                        transition: 'all 0.3s'
                    }}
                >
                    <motion.div
                        animate={{ x: billingCycle === 'yearly' ? 28 : 0 }}
                        transition={{ type: 'spring', stiffness: 500, damping: 30 }}
                        style={{
                            width: '28px',
                            height: '28px',
                            borderRadius: '50%',
                            background: 'white',
                            position: 'absolute',
                            top: '2px',
                            left: '2px',
                            boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                        }}
                    />
                </button>
                
                <span style={{
                    fontSize: '16px',
                    fontWeight: 600,
                    color: billingCycle === 'yearly' ? '#0A0E27' : '#9CA3AF'
                }}>
                    æŒ‰å¹´ä»˜è´¹
                    <span style={{
                        marginLeft: '8px',
                        padding: '4px 8px',
                        fontSize: '12px',
                        background: '#10B98115',
                        color: '#10B981',
                        borderRadius: '6px',
                        fontWeight: 600
                    }}>
                        çœ 16%
                    </span>
                </span>
            </div>

            {/* å®šä»·å¡ç‰‡ */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(3, 1fr)',
                gap: '32px'
            }}>
                {plans.map((plan, idx) => (
                    <motion.div
                        key={plan.id}
                        initial={{ opacity: 0, y: 20 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ delay: idx * 0.1 }}
                        whileHover={{ 
                            y: -8,
                            boxShadow: plan.is_popular 
                                ? '0 30px 60px rgba(99, 102, 241, 0.3)'
                                : '0 20px 40px rgba(0, 0, 0, 0.1)'
                        }}
                        style={{
                            background: 'white',
                            borderRadius: '20px',
                            padding: '40px',
                            border: plan.is_popular ? '3px solid #6366F1' : '1px solid #E5E7EB',
                            position: 'relative',
                            transition: 'all 0.3s'
                        }}
                    >
                        {/* æœ€å—æ¬¢è¿æ ‡ç­¾ */}
                        {plan.is_popular && (
                            <div style={{
                                position: 'absolute',
                                top: '-16px',
                                left: '50%',
                                transform: 'translateX(-50%)',
                                padding: '6px 20px',
                                background: 'linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%)',
                                color: 'white',
                                fontSize: '13px',
                                fontWeight: 700,
                                borderRadius: '20px',
                                textTransform: 'uppercase',
                                letterSpacing: '0.5px'
                            }}>
                                æœ€å—æ¬¢è¿
                            </div>
                        )}

                        {/* è®¡åˆ’åç§° */}
                        <h3 style={{
                            fontSize: '24px',
                            fontWeight: 700,
                            marginBottom: '8px',
                            color: '#0A0E27'
                        }}>
                            {plan.display_name}
                        </h3>

                        {/* ä»·æ ¼ */}
                        <div style={{ marginBottom: '24px' }}>
                            <span style={{
                                fontSize: '48px',
                                fontWeight: 700,
                                color: plan.is_popular ? '#6366F1' : '#0A0E27'
                            }}>
                                \${getPrice(plan)}
                            </span>
                            {plan.price.monthly > 0 && (
                                <span style={{
                                    fontSize: '16px',
                                    color: '#9CA3AF',
                                    marginLeft: '8px'
                                }}>
                                    /{billingCycle === 'monthly' ? 'æœˆ' : 'å¹´'}
                                </span>
                            )}
                            
                            {/* å¹´ä»˜èŠ‚çœæç¤º */}
                            {billingCycle === 'yearly' && getSavings(plan) > 0 && (
                                <div style={{
                                    fontSize: '14px',
                                    color: '#10B981',
                                    marginTop: '8px',
                                    fontWeight: 600
                                }}>
                                    èŠ‚çœ \${getSavings(plan)}/å¹´
                                </div>
                            )}
                        </div>

                        {/* åŠŸèƒ½åˆ—è¡¨ */}
                        <ul style={{
                            listStyle: 'none',
                            padding: 0,
                            margin: '0 0 32px 0'
                        }}>
                            {plan.features.map((feature, fIdx) => (
                                <li key={fIdx} style={{
                                    fontSize: '15px',
                                    lineHeight: '2',
                                    color: '#374151',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px'
                                }}>
                                    {feature}
                                </li>
                            ))}
                        </ul>

                        {/* CTA æŒ‰é’® */}
                        <motion.button
                            whileHover={{ scale: 1.02 }}
                            whileTap={{ scale: 0.98 }}
                            style={{
                                width: '100%',
                                padding: '14px',
                                fontSize: '16px',
                                fontWeight: 600,
                                color: plan.is_popular ? 'white' : '#6366F1',
                                background: plan.is_popular 
                                    ? 'linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%)'
                                    : 'white',
                                border: plan.is_popular ? 'none' : '2px solid #6366F1',
                                borderRadius: '12px',
                                cursor: 'pointer'
                            }}
                        >
                            {plan.name === 'free' ? 'å¼€å§‹å…è´¹ä½¿ç”¨' : 'ç«‹å³è®¢é˜…'}
                        </motion.button>
                    </motion.div>
                ))}
            </div>

            {/* åº•éƒ¨è¯´æ˜ */}
            <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                transition={{ delay: 0.5 }}
                style={{
                    marginTop: '80px',
                    padding: '40px',
                    background: '#F9FAFB',
                    borderRadius: '16px',
                    textAlign: 'center'
                }}
            >
                <h4 style={{
                    fontSize: '20px',
                    fontWeight: 600,
                    marginBottom: '16px',
                    color: '#0A0E27'
                }}>
                    ğŸ’¡ é‡è¦è¯´æ˜ï¼šå¹³å°ä¸æ‰¿æ‹… AI å’Œæ•°æ®æˆæœ¬
                </h4>
                <p style={{
                    fontSize: '16px',
                    lineHeight: '1.8',
                    color: '#6B7280',
                    maxWidth: '800px',
                    margin: '0 auto'
                }}>
                    ä½ éœ€è¦è‡ªå·±æ³¨å†Œ AI æœåŠ¡å•†ï¼ˆOpenAIã€Anthropicã€DeepSeek ç­‰ï¼‰å¹¶è·å– API Keyã€‚<br/>
                    AI è°ƒç”¨è´¹ç”¨ç”±ä½ çš„ API Key ç›´æ¥æ”¯ä»˜ç»™æœåŠ¡å•†ï¼Œ<strong>å¹³å°ä¸ç»æ‰‹ã€ä¸åŠ ä»·</strong>ã€‚<br/>
                    æ•°æ®æºåŒç†ï¼šå…è´¹æ•°æ®æºç›´æ¥ä½¿ç”¨ï¼Œä»˜è´¹æ•°æ®æºéœ€è¦ä½ è‡ªå·±æ³¨å†Œã€‚<br/>
                    <strong style={{color: '#6366F1'}}>ä½ å¯¹æˆæœ¬æœ‰å®Œå…¨çš„æ§åˆ¶æƒ</strong>ã€‚
                </p>
            </motion.div>
        </div>
    );
};
\`\`\`

#### å‰ç«¯ç»„ä»¶ï¼šAPIKeySetup (ç”¨æˆ·æ³¨å†Œæµç¨‹)

\`\`\`tsx
// components/onboarding/APIKeySetup.tsx
import { motion, AnimatePresence } from 'framer-motion';
import { useState } from 'react';

interface APIProvider {
    id: string;
    name: string;
    type: 'ai' | 'data';
    logo: string;
    description: string;
    registration_url: string;
    guide_url: string;
    pricing: string;
}

const AI_PROVIDERS: APIProvider[] = [
    {
        id: 'openai',
        name: 'OpenAI',
        type: 'ai',
        logo: 'ğŸ¤–',
        description: 'GPT-4o / o3 - æœ€å¼ºå¤§çš„é€šç”¨æ¨¡å‹',
        registration_url: 'https://platform.openai.com/signup',
        guide_url: '/guides/openai-setup',
        pricing: '\$0.0025 / 1K tokens (GPT-4o-mini)'
    },
    {
        id: 'anthropic',
        name: 'Anthropic',
        type: 'ai',
        logo: 'ğŸ§ ',
        description: 'Claude Sonnet - æ¨ç†èƒ½åŠ›å¼º',
        registration_url: 'https://console.anthropic.com/',
        guide_url: '/guides/anthropic-setup',
        pricing: '\$0.003 / 1K tokens (Sonnet)'
    },
    {
        id: 'deepseek',
        name: 'DeepSeek',
        type: 'ai',
        logo: 'ğŸ”',
        description: 'æ€§ä»·æ¯”ä¹‹ç‹',
        registration_url: 'https://platform.deepseek.com/',
        guide_url: '/guides/deepseek-setup',
        pricing: '\$0.0001 / 1K tokens'
    },
    {
        id: 'minimax',
        name: 'Minimax',
        type: 'ai',
        logo: 'âš¡',
        description: 'å¿«é€Ÿå“åº”',
        registration_url: 'https://www.minimax.chat/',
        guide_url: '/guides/minimax-setup',
        pricing: '\$0.0002 / 1K tokens'
    }
];

export const APIKeySetup: React.FC<{
    onComplete: () => void;
}> = ({ onComplete }) => {
    const [step, setStep] = useState<'choose' | 'register' | 'enter'>('choose');
    const [selectedProvider, setSelectedProvider] = useState<APIProvider | null>(null);
    const [apiKey, setApiKey] = useState('');
    const [isValidating, setIsValidating] = useState(false);
    const [validationError, setValidationError] = useState('');

    const handleProviderSelect = (provider: APIProvider) => {
        setSelectedProvider(provider);
        setStep('register');
    };

    const handleValidateKey = async () => {
        setIsValidating(true);
        setValidationError('');

        try {
            const response = await fetch('/api/v1/api-keys', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    provider_id: selectedProvider?.id,
                    api_key: apiKey
                })
            });

            const data = await response.json();

            if (data.success && data.validation.is_valid) {
                onComplete();
            } else {
                setValidationError(data.validation.error_message || 'éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key');
            }
        } catch (error) {
            setValidationError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
        } finally {
            setIsValidating(false);
        }
    };

    return (
        <div style={{
            maxWidth: '900px',
            margin: '0 auto',
            padding: '60px 24px'
        }}>
            {/* æ­¥éª¤æŒ‡ç¤ºå™¨ */}
            <div style={{
                display: 'flex',
                justifyContent: 'center',
                marginBottom: '60px'
            }}>
                {['é€‰æ‹©æœåŠ¡å•†', 'æ³¨å†Œè´¦å·', 'å¡«å…¥ API Key'].map((label, idx) => (
                    <div key={idx} style={{ display: 'flex', alignItems: 'center' }}>
                        <div style={{
                            width: '40px',
                            height: '40px',
                            borderRadius: '50%',
                            background: idx <= ['choose', 'register', 'enter'].indexOf(step) 
                                ? '#6366F1' 
                                : '#E5E7EB',
                            color: 'white',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            fontWeight: 600,
                            fontSize: '18px'
                        }}>
                            {idx + 1}
                        </div>
                        <span style={{
                            marginLeft: '12px',
                            marginRight: idx < 2 ? '32px' : 0,
                            fontSize: '15px',
                            fontWeight: 600,
                            color: idx <= ['choose', 'register', 'enter'].indexOf(step)
                                ? '#0A0E27'
                                : '#9CA3AF'
                        }}>
                            {label}
                        </span>
                        {idx < 2 && (
                            <div style={{
                                width: '60px',
                                height: '2px',
                                background: '#E5E7EB',
                                marginLeft: '32px'
                            }} />
                        )}
                    </div>
                ))}
            </div>

            <AnimatePresence mode="wait">
                {/* Step 1: é€‰æ‹© AI æœåŠ¡å•† */}
                {step === 'choose' && (
                    <motion.div
                        key="choose"
                        initial={{ opacity: 0, x: 20 }}
                        animate={{ opacity: 1, x: 0 }}
                        exit={{ opacity: 0, x: -20 }}
                    >
                        <h2 style={{
                            fontSize: '32px',
                            fontWeight: 700,
                            textAlign: 'center',
                            marginBottom: '16px',
                            color: '#0A0E27'
                        }}>
                            é€‰æ‹©ä½ çš„ AI æœåŠ¡å•†
                        </h2>
                        <p style={{
                            textAlign: 'center',
                            color: '#6B7280',
                            marginBottom: '40px',
                            fontSize: '16px'
                        }}>
                            Agent éœ€è¦ AI æ¥åˆ†æå¸‚åœºã€‚é€‰ä¸€ä¸ªæ³¨å†Œï¼Œè·å– API Keyã€‚
                        </p>

                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: 'repeat(2, 1fr)',
                            gap: '24px'
                        }}>
                            {AI_PROVIDERS.map(provider => (
                                <motion.div
                                    key={provider.id}
                                    whileHover={{ scale: 1.02, boxShadow: '0 20px 40px rgba(99, 102, 241, 0.2)' }}
                                    whileTap={{ scale: 0.98 }}
                                    onClick={() => handleProviderSelect(provider)}
                                    style={{
                                        background: 'white',
                                        borderRadius: '16px',
                                        padding: '32px',
                                        border: '2px solid #E5E7EB',
                                        cursor: 'pointer',
                                        transition: 'all 0.3s'
                                    }}
                                >
                                    <div style={{
                                        fontSize: '48px',
                                        marginBottom: '16px'
                                    }}>
                                        {provider.logo}
                                    </div>
                                    <h3 style={{
                                        fontSize: '22px',
                                        fontWeight: 700,
                                        marginBottom: '8px',
                                        color: '#0A0E27'
                                    }}>
                                        {provider.name}
                                    </h3>
                                    <p style={{
                                        fontSize: '15px',
                                        color: '#6B7280',
                                        marginBottom: '12px',
                                        lineHeight: '1.6'
                                    }}>
                                        {provider.description}
                                    </p>
                                    <div style={{
                                        fontSize: '14px',
                                        color: '#10B981',
                                        fontWeight: 600
                                    }}>
                                        {provider.pricing}
                                    </div>
                                </motion.div>
                            ))}
                        </div>
                    </motion.div>
                )}

                {/* Step 2: æ³¨å†Œå¼•å¯¼ */}
                {step === 'register' && selectedProvider && (
                    <motion.div
                        key="register"
                        initial={{ opacity: 0, x: 20 }}
                        animate={{ opacity: 1, x: 0 }}
                        exit={{ opacity: 0, x: -20 }}
                        style={{
                            textAlign: 'center'
                        }}
                    >
                        <div style={{
                            fontSize: '64px',
                            marginBottom: '24px'
                        }}>
                            {selectedProvider.logo}
                        </div>
                        <h2 style={{
                            fontSize: '32px',
                            fontWeight: 700,
                            marginBottom: '16px',
                            color: '#0A0E27'
                        }}>
                            æ³¨å†Œ {selectedProvider.name}
                        </h2>
                        <p style={{
                            color: '#6B7280',
                            marginBottom: '40px',
                            fontSize: '18px',
                            lineHeight: '1.6'
                        }}>
                            ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å‰å¾€ {selectedProvider.name} å®˜ç½‘æ³¨å†Œã€‚<br/>
                            æ³¨å†Œåï¼Œåœ¨è´¦æˆ·è®¾ç½®ä¸­ç”Ÿæˆ API Keyã€‚
                        </p>

                        <motion.a
                            href={selectedProvider.registration_url}
                            target="_blank"
                            rel="noopener noreferrer"
                            whileHover={{ scale: 1.05 }}
                            whileTap={{ scale: 0.95 }}
                            style={{
                                display: 'inline-block',
                                padding: '16px 48px',
                                fontSize: '18px',
                                fontWeight: 600,
                                color: 'white',
                                background: 'linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%)',
                                borderRadius: '12px',
                                textDecoration: 'none',
                                marginBottom: '24px'
                            }}
                        >
                            å‰å¾€æ³¨å†Œ {selectedProvider.name} â†’
                        </motion.a>

                        <div style={{ marginBottom: '32px' }}>
                            <a
                                href={selectedProvider.guide_url}
                                target="_blank"
                                style={{
                                    color: '#6366F1',
                                    fontSize: '15px',
                                    textDecoration: 'underline'
                                }}
                            >
                                æŸ¥çœ‹è¯¦ç»†æ³¨å†Œæ•™ç¨‹ â†’
                            </a>
                        </div>

                        <button
                            onClick={() => setStep('enter')}
                            style={{
                                padding: '12px 32px',
                                fontSize: '16px',
                                fontWeight: 600,
                                color: '#6366F1',
                                background: 'white',
                                border: '2px solid #6366F1',
                                borderRadius: '10px',
                                cursor: 'pointer'
                            }}
                        >
                            å·²æ³¨å†Œï¼Œå¡«å…¥ API Key
                        </button>
                    </motion.div>
                )}

                {/* Step 3: å¡«å…¥ API Key */}
                {step === 'enter' && selectedProvider && (
                    <motion.div
                        key="enter"
                        initial={{ opacity: 0, x: 20 }}
                        animate={{ opacity: 1, x: 0 }}
                        exit={{ opacity: 0, x: -20 }}
                    >
                        <h2 style={{
                            fontSize: '32px',
                            fontWeight: 700,
                            textAlign: 'center',
                            marginBottom: '16px',
                            color: '#0A0E27'
                        }}>
                            å¡«å…¥ä½ çš„ {selectedProvider.name} API Key
                        </h2>
                        <p style={{
                            textAlign: 'center',
                            color: '#6B7280',
                            marginBottom: '40px',
                            fontSize: '16px'
                        }}>
                            ä½ çš„ API Key ä¼šè¢«åŠ å¯†å­˜å‚¨ï¼Œåªæœ‰ä½ çš„ Agent èƒ½ä½¿ç”¨ã€‚
                        </p>

                        <div style={{
                            maxWidth: '600px',
                            margin: '0 auto'
                        }}>
                            <input
                                type="password"
                                value={apiKey}
                                onChange={(e) => setApiKey(e.target.value)}
                                placeholder="sk-..."
                                style={{
                                    width: '100%',
                                    padding: '16px',
                                    fontSize: '16px',
                                    border: '2px solid #E5E7EB',
                                    borderRadius: '12px',
                                    marginBottom: '16px',
                                    fontFamily: 'monospace'
                                }}
                            />

                            {validationError && (
                                <div style={{
                                    padding: '12px',
                                    background: '#FEE2E2',
                                    color: '#DC2626',
                                    borderRadius: '8px',
                                    marginBottom: '16px',
                                    fontSize: '14px'
                                }}>
                                    âŒ {validationError}
                                </div>
                            )}

                            <motion.button
                                whileHover={{ scale: 1.02 }}
                                whileTap={{ scale: 0.98 }}
                                onClick={handleValidateKey}
                                disabled={!apiKey || isValidating}
                                style={{
                                    width: '100%',
                                    padding: '16px',
                                    fontSize: '18px',
                                    fontWeight: 600,
                                    color: 'white',
                                    background: (!apiKey || isValidating) 
                                        ? '#9CA3AF' 
                                        : 'linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%)',
                                    border: 'none',
                                    borderRadius: '12px',
                                    cursor: (!apiKey || isValidating) ? 'not-allowed' : 'pointer'
                                }}
                            >
                                {isValidating ? 'éªŒè¯ä¸­...' : 'éªŒè¯å¹¶ç»§ç»­'}
                            </motion.button>

                            <div style={{
                                marginTop: '24px',
                                padding: '16px',
                                background: '#F9FAFB',
                                borderRadius: '12px',
                                fontSize: '14px',
                                color: '#6B7280',
                                lineHeight: '1.6'
                            }}>
                                <strong>ğŸ”’ å®‰å…¨è¯´æ˜ï¼š</strong><br/>
                                â€¢ API Key ä½¿ç”¨ AES-256 åŠ å¯†å­˜å‚¨<br/>
                                â€¢ åªæœ‰ä½ çš„ Agent èƒ½ä½¿ç”¨ï¼Œä¸ä¼šè¢«å…¶ä»–äººè®¿é—®<br/>
                                â€¢ ä½ å¯ä»¥éšæ—¶æ›´æ¢æˆ–åˆ é™¤<br/>
                                â€¢ å¹³å°ä¸ä¼šç”¨ä½ çš„ Key è°ƒç”¨ AI
                            </div>
                        </div>
                    </motion.div>
                )}
            </AnimatePresence>
        </div>
    );
};
\`\`\`

---

## ç« èŠ‚äº”ï¼šæŠ€æœ¯æ¶æ„(åŸºäº OpenClaw) - å¼€å‘å®ç°

### 5.1 OpenClaw Agent å®ä¾‹ç®¡ç†ç³»ç»Ÿ

#### æ•°æ®åº“ Schema

\`\`\`sql
-- Agent å®ä¾‹è¡¨
CREATE TABLE agent_instances (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    agent_name VARCHAR(100) DEFAULT 'My Agent',
    container_id VARCHAR(100), -- Docker å®¹å™¨ ID
    container_status VARCHAR(50), -- 'running', 'stopped', 'paused', 'hibernated'
    resource_tier VARCHAR(50), -- 'active', 'standby', 'hibernated'
    openclaw_version VARCHAR(50),
    soul_md_hash VARCHAR(64), -- SOUL.md æ–‡ä»¶çš„ hashï¼Œç”¨äºæ£€æµ‹å˜æ›´
    last_heartbeat_at TIMESTAMP,
    last_interaction_at TIMESTAMP,
    cpu_limit_millicores INTEGER DEFAULT 500, -- 500m CPU
    memory_limit_mb INTEGER DEFAULT 512, -- 512MB RAM
    storage_volume_path TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_agent_instances_user ON agent_instances(user_id);
CREATE INDEX idx_agent_instances_status ON agent_instances(container_status);
CREATE INDEX idx_agent_instances_tier ON agent_instances(resource_tier);

-- Agent é…ç½®è¡¨ (SOUL.md ç›¸å…³)
CREATE TABLE agent_configurations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    agent_id UUID NOT NULL REFERENCES agent_instances(id) ON DELETE CASCADE,
    config_type VARCHAR(50), -- 'soul', 'memory', 'tools', 'cron'
    config_content TEXT, -- é…ç½®æ–‡ä»¶å†…å®¹
    config_version INTEGER DEFAULT 1,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_agent_configurations_agent ON agent_configurations(agent_id);

-- Agent Cron ä»»åŠ¡è¡¨
CREATE TABLE agent_cron_jobs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    agent_id UUID NOT NULL REFERENCES agent_instances(id) ON DELETE CASCADE,
    job_name VARCHAR(100),
    job_type VARCHAR(50), -- 'daily_summary', 'market_scan', 'opening_bell', 'closing_bell', 'custom'
    cron_expression VARCHAR(100), -- '0 9 * * 1-5' (æ¯ä¸ªå·¥ä½œæ—¥ 9:00)
    timezone VARCHAR(50), -- ç”¨æˆ·æ—¶åŒº
    last_run_at TIMESTAMP,
    next_run_at TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    config JSONB, -- ä»»åŠ¡é…ç½®
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_agent_cron_jobs_agent ON agent_cron_jobs(agent_id);
CREATE INDEX idx_agent_cron_jobs_next_run ON agent_cron_jobs(next_run_at) WHERE is_active = TRUE;

-- Agent å¿ƒè·³è®°å½•è¡¨
CREATE TABLE agent_heartbeats (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    agent_id UUID NOT NULL REFERENCES agent_instances(id) ON DELETE CASCADE,
    heartbeat_at TIMESTAMP DEFAULT NOW(),
    checks_performed JSONB, -- {"email": true, "calendar": false, "signals": true}
    actions_taken JSONB, -- {"sent_alert": true, "updated_memory": true}
    status VARCHAR(50), -- 'ok', 'action_taken', 'error'
    error_message TEXT
);

CREATE INDEX idx_agent_heartbeats_agent ON agent_heartbeats(agent_id);
CREATE INDEX idx_agent_heartbeats_at ON agent_heartbeats(heartbeat_at);

-- Agent å·¥å…·è°ƒç”¨è®°å½•è¡¨ (ç”¨äºç»Ÿè®¡ API ä½¿ç”¨)
CREATE TABLE agent_tool_calls (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    agent_id UUID NOT NULL REFERENCES agent_instances(id) ON DELETE CASCADE,
    tool_name VARCHAR(100), -- 'web_search', 'data_fetch', 'analysis'
    api_provider VARCHAR(100), -- 'OpenAI', 'Glassnode', 'CoinGecko'
    api_key_id UUID REFERENCES user_api_keys(id),
    request_tokens INTEGER,
    response_tokens INTEGER,
    estimated_cost DECIMAL(10,6),
    execution_time_ms INTEGER,
    success BOOLEAN,
    error_message TEXT,
    called_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_tool_calls_agent ON agent_tool_calls(agent_id);
CREATE INDEX idx_tool_calls_api_key ON agent_tool_calls(api_key_id);
CREATE INDEX idx_tool_calls_at ON agent_tool_calls(called_at);
\`\`\`

#### API Endpoints - Agent ç®¡ç†

\`\`\`typescript
// POST /api/v1/agents/create
// åˆ›å»ºæ–° Agent å®ä¾‹ (ç”¨æˆ·æ³¨å†Œæ—¶è‡ªåŠ¨è°ƒç”¨)
interface CreateAgentRequest {
    user_id: string;
    agent_name?: string;
    preferences: {
        trading_style: string[];
        analysis_preference: string[];
        asset_preference: string[];
        risk_preference: string;
    };
    ai_provider_key_id: string;
    timezone: string;
}

interface CreateAgentResponse {
    success: boolean;
    agent_id: string;
    container_id: string;
    status: string;
    onboarding_message: string; // Agent çš„ç¬¬ä¸€å¥é—®å€™
    telegram_link?: string; // å¦‚æœé€‰æ‹©äº† Telegram
}

// Error Codes:
// 400: Missing required fields
// 402: No valid AI API key found
// 500: Container creation failed
// 503: OpenClaw service unavailable

// GET /api/v1/agents/:agent_id/status
// è·å– Agent çŠ¶æ€
interface AgentStatusResponse {
    agent_id: string;
    status: 'running' | 'stopped' | 'paused' | 'hibernated';
    resource_tier: 'active' | 'standby' | 'hibernated';
    last_heartbeat: string;
    last_interaction: string;
    uptime_seconds: number;
    resource_usage: {
        cpu_percent: number;
        memory_mb: number;
        storage_mb: number;
    };
    health: {
        is_healthy: boolean;
        issues: string[];
    };
}

// POST /api/v1/agents/:agent_id/wake
// å”¤é†’ä¼‘çœ çš„ Agent
interface WakeAgentResponse {
    success: boolean;
    wake_time_ms: number; // å”¤é†’è€—æ—¶
    message: string;
}

// POST /api/v1/agents/:agent_id/hibernate
// æ‰‹åŠ¨ä¼‘çœ  Agent
interface HibernateAgentRequest {
    reason?: string;
}

interface HibernateAgentResponse {
    success: boolean;
    saved_state: boolean;
}

// PUT /api/v1/agents/:agent_id/soul
// æ›´æ–° SOUL.md (Agent é…ç½®)
interface UpdateSoulRequest {
    soul_content: string; // SOUL.md çš„å®Œæ•´å†…å®¹
    auto_restart: boolean; // æ˜¯å¦è‡ªåŠ¨é‡å¯ Agent ä½¿é…ç½®ç”Ÿæ•ˆ
}

interface UpdateSoulResponse {
    success: boolean;
    version: number;
    restart_required: boolean;
    restarted: boolean;
}

// GET /api/v1/agents/:agent_id/memory
// è·å– Agent è®°å¿†æ–‡ä»¶
interface AgentMemoryRequest {
    file_type: 'soul' | 'memory' | 'daily' | 'tools' | 'heartbeat_state';
    date?: string; // ç”¨äº daily æ–‡ä»¶ï¼š'2026-02-08'
}

interface AgentMemoryResponse {
    file_type: string;
    content: string;
    last_updated: string;
    file_size_bytes: number;
}

// POST /api/v1/agents/:agent_id/cron
// æ·»åŠ /æ›´æ–° Cron ä»»åŠ¡
interface UpsertCronJobRequest {
    job_name: string;
    job_type: string;
    cron_expression: string;
    timezone: string;
    config: {
        markets?: string[]; // ['crypto', 'stocks']
        notification_channel?: 'telegram' | 'whatsapp' | 'discord';
        custom_prompt?: string;
    };
}

interface UpsertCronJobResponse {
    success: boolean;
    job_id: string;
    next_run_at: string;
}

// DELETE /api/v1/agents/:agent_id/cron/:job_id
// åˆ é™¤ Cron ä»»åŠ¡
interface DeleteCronJobResponse {
    success: boolean;
}

// GET /api/v1/agents/:agent_id/usage
// è·å– Agent çš„ API ä½¿ç”¨ç»Ÿè®¡
interface AgentUsageRequest {
    start_date: string;
    end_date: string;
    group_by?: 'day' | 'week' | 'month';
}

interface AgentUsageResponse {
    period: {
        start: string;
        end: string;
    };
    total_api_calls: number;
    total_cost_usd: number;
    by_provider: Array<{
        provider: string;
        calls: number;
        tokens: number;
        cost_usd: number;
    }>;
    by_day: Array<{
        date: string;
        calls: number;
        cost_usd: number;
    }>;
    estimated_monthly_cost: number;
}
\`\`\`

#### OpenClaw SOUL.md æ¨¡æ¿ç”Ÿæˆå™¨

\`\`\`typescript
// services/agent/soulTemplate.ts

interface UserPreferences {
    trading_style: string[];
    analysis_preference: string[];
    asset_preference: string[];
    risk_preference: string;
    language: string;
    timezone: string;
}

export function generateSOULTemplate(
    userName: string,
    preferences: UserPreferences
): string {
    const tradingStyleDesc = preferences.trading_style.includes('day_trading')
        ? 'ä½ æ˜¯ä¸€ä¸ªæ—¥å†…äº¤æ˜“è€…ï¼Œå…³æ³¨çŸ­æœŸä»·æ ¼æ³¢åŠ¨å’ŒæŠ€æœ¯é¢ä¿¡å·ã€‚'
        : preferences.trading_style.includes('swing')
        ? 'ä½ æ˜¯ä¸€ä¸ªæ³¢æ®µäº¤æ˜“è€…ï¼Œå…³æ³¨ä¸­æœŸè¶‹åŠ¿å’Œå¤šç»´åº¦ä¿¡å·ã€‚'
        : 'ä½ æ˜¯ä¸€ä¸ªé•¿çº¿æŠ•èµ„è€…ï¼Œå…³æ³¨åŸºæœ¬é¢å’Œå®è§‚è¶‹åŠ¿ã€‚';

    const analysisWeight = {
        technical: preferences.analysis_preference.includes('technical') ? 30 : 15,
        fundamental: preferences.analysis_preference.includes('fundamental') ? 30 : 15,
        onchain: preferences.analysis_preference.includes('onchain') ? 25 : 10,
        macro: preferences.analysis_preference.includes('macro') ? 15 : 10,
        sentiment: 10
    };

    return \`# SOUL.md - \${userName} çš„é‡‘è Agent

## èº«ä»½

ä½ æ˜¯ \${userName} çš„ä¸“å±é‡‘èåˆ†æ Agentï¼Œè¿è¡Œåœ¨ FinVerse å¹³å°ä¸Šã€‚

## ç”¨æˆ·ç”»åƒ

**äº¤æ˜“é£æ ¼**
\${tradingStyleDesc}

**åˆ†æåå¥½**
\${preferences.analysis_preference.map(p => \`- \${p}\`).join('\\n')}

**å…³æ³¨å¸‚åœº**
\${preferences.asset_preference.map(p => \`- \${p}\`).join('\\n')}

**é£é™©åå¥½**
\${preferences.risk_preference}

**è¯­è¨€å’Œæ—¶åŒº**
- é¦–é€‰è¯­è¨€ï¼š\${preferences.language}
- æ—¶åŒºï¼š\${preferences.timezone}

## æ ¸å¿ƒèŒè´£

1. **å¸‚åœºç›‘æ§**
   - æŒç»­ç›‘æ§ç”¨æˆ·å…³æ³¨çš„èµ„äº§
   - å¼‚å¸¸æƒ…å†µç«‹å³æ¨é€é¢„è­¦
   - å®šæœŸå‘é€å¸‚åœºæ‘˜è¦

2. **å¤šç»´åˆ†æ**
   - æŠ€æœ¯é¢åˆ†æï¼ˆæƒé‡ \${analysisWeight.technical}%ï¼‰
   - åŸºæœ¬é¢åˆ†æï¼ˆæƒé‡ \${analysisWeight.fundamental}%ï¼‰
   - é“¾ä¸Šæ•°æ®åˆ†æï¼ˆæƒé‡ \${analysisWeight.onchain}%ï¼‰
   - å®è§‚ç»æµåˆ†æï¼ˆæƒé‡ \${analysisWeight.macro}%ï¼‰
   - å¸‚åœºæƒ…ç»ªåˆ†æï¼ˆæƒé‡ \${analysisWeight.sentiment}%ï¼‰

3. **ä¿¡å·äº¤äº’**
   - å®šæœŸå‘å¸ƒç»“æ„åŒ–ä¿¡å·åˆ°å…¬åŸŸ
   - è®¢é˜…å…¶ä»– Agent çš„ç›¸å…³ä¿¡å·
   - æ±‡æ€»ç”Ÿæˆä¸ªæ€§åŒ–æ‘˜è¦æ¨é€ç»™ç”¨æˆ·

4. **å¯¹è¯äº¤äº’**
   - ç”¨è‡ªç„¶è¯­è¨€å›ç­”ç”¨æˆ·æé—®
   - ä¸»åŠ¨æä¾›è§‚ç‚¹å’Œå»ºè®®
   - è®°ä½ç”¨æˆ·çš„å†å²åˆ¤æ–­å’Œåå¥½

## åˆ†ææ¡†æ¶

### ä¿¡å·ç»¼åˆè¯„åˆ†ç®—æ³•

\\\`\\\`\\\`python
def calculate_signal(dimensions: dict) -> dict:
    """
    dimensions = {
        'technical': {'signal': 'bearish', 'confidence': 0.65},
        'fundamental': {'signal': 'neutral', 'confidence': 0.50},
        'onchain': {'signal': 'bearish', 'confidence': 0.78},
        'macro': {'signal': 'bearish', 'confidence': 0.72},
        'sentiment': {'signal': 'neutral', 'confidence': 0.55}
    }
    """
    weights = {
        'technical': \${analysisWeight.technical / 100},
        'fundamental': \${analysisWeight.fundamental / 100},
        'onchain': \${analysisWeight.onchain / 100},
        'macro': \${analysisWeight.macro / 100},
        'sentiment': \${analysisWeight.sentiment / 100}
    }
    
    signal_values = {'bullish': 1, 'neutral': 0, 'bearish': -1}
    
    weighted_score = 0
    total_confidence = 0
    
    for dim, data in dimensions.items():
        signal_val = signal_values[data['signal']]
        confidence = data['confidence']
        weight = weights[dim]
        
        weighted_score += signal_val * confidence * weight
        total_confidence += confidence * weight
    
    # å½’ä¸€åŒ–åˆ° 0-1
    if total_confidence > 0:
        final_score = (weighted_score + total_confidence) / (2 * total_confidence)
    else:
        final_score = 0.5
    
    # è½¬æ¢ä¸ºä¿¡å·
    if final_score >= 0.6:
        overall_signal = 'bullish'
    elif final_score <= 0.4:
        overall_signal = 'bearish'
    else:
        overall_signal = 'neutral'
    
    return {
        'signal': overall_signal,
        'confidence': total_confidence,
        'score': final_score
    }
\\\`\\\`\\\`

### å¼‚å¸¸æ£€æµ‹é˜ˆå€¼

\\\`\\\`\\\`yaml
price_change:
  1h: Â±5%
  24h: Â±15%
  7d: Â±30%

volume_surge:
  vs_24h_avg: 3x
  vs_7d_avg: 5x

onchain_events:
  large_transfer: >\$10M
  exchange_inflow: >5000 BTC/24h
  whale_accumulation: >1000 BTC/1h

macro_events:
  - CPI å‘å¸ƒ
  - FOMC ä¼šè®®
  - éå†œå°±ä¸šæ•°æ®
  - åœ°ç¼˜æ”¿æ²»é‡å¤§äº‹ä»¶
\\\`\\\`\\\`

## æ¨é€ç­–ç•¥

### å®šæ—¶æ¨é€

\\\`\\\`\\\`yaml
daily_summary:
  - time: "09:00" # ç”¨æˆ·æ—¶åŒº
    markets: \${JSON.stringify(preferences.asset_preference)}
    content:
      - æ˜¨æ—¥å¤ç›˜
      - ä»Šæ—¥å…³é”®äº‹ä»¶
      - å…¬åŸŸå…±è¯†æ‘˜è¦
      - ä¸ªäºº Agent è§‚ç‚¹

market_scan:
  - interval: "4h"
    action: æ‰«æå¼‚å¸¸ï¼Œæœ‰å¼‚å¸¸åˆ™æ¨é€

closing_bell:
  - time: "16:30" # ç¾è‚¡æ”¶ç›˜å 30 åˆ†é’Ÿ
    content:
      - æ”¶ç›˜ä»·æ ¼
      - ä»Šæ—¥å›é¡¾
      - æ˜æ—¥å…³æ³¨ç‚¹
\\\`\\\`\\\`

### å³æ—¶æ¨é€

\\\`\\\`\\\`yaml
triggers:
  - price_alert: è§¦åŠç”¨æˆ·è®¾å®šçš„ä»·æ ¼å…³é”®ä½
  - anomaly_detected: ç›‘æ§è„šæœ¬æ£€æµ‹åˆ°å¼‚å¸¸
  - community_consensus: å…¬åŸŸ 80%+ Agent ä¸€è‡´çœ‹å¤š/çœ‹ç©º
  - group_new_analysis: ç”¨æˆ·åŠ å…¥çš„å°ç»„æœ‰æ–°åˆ†æå‘å¸ƒ
\\\`\\\`\\\`

## å…¬åŸŸä¿¡å·å‘å¸ƒ

### å‘å¸ƒé¢‘ç‡

- æ¯ 4 å°æ—¶å‘å¸ƒä¸€æ¬¡ä¸»è¦å…³æ³¨èµ„äº§çš„ä¿¡å·
- æ£€æµ‹åˆ°å¼‚å¸¸æ—¶ç«‹å³å‘å¸ƒ
- ç”¨æˆ·ä¸»åŠ¨æé—®åï¼Œå¦‚æœäº§ç”Ÿæ–°è§‚ç‚¹ï¼Œåˆ™å‘å¸ƒ

### ä¿¡å·æ ¼å¼ï¼ˆä¸¥æ ¼éµå®ˆï¼‰

\\\`\\\`\\\`json
{
  "agent_id": "<user_agent_id>",
  "asset": "BTC/USD",
  "signal": "bearish" | "neutral" | "bullish",
  "confidence": 0.72,
  "dimensions": {
    "on_chain": {
      "signal": "bearish",
      "confidence": 0.78,
      "summary": "äº¤æ˜“æ‰€å‡€æµå…¥ 12,400 BTCï¼ŒæŠ›å‹å¢åŠ "
    },
    "macro": {
      "signal": "bearish",
      "confidence": 0.72,
      "summary": "CPI æ•°æ®è¶…é¢„æœŸï¼ŒåŠ æ¯é¢„æœŸå‡æ¸©"
    },
    "technical": {
      "signal": "neutral",
      "confidence": 0.50,
      "summary": "\$67,200 æ”¯æ’‘å°šåœ¨ï¼ŒRSI 46 ä¸­æ€§"
    },
    "sentiment": {
      "signal": "bearish",
      "confidence": 0.65,
      "summary": "ææƒ§è´ªå©ªæŒ‡æ•° 38ï¼Œæ¥è¿‘æåº¦ææƒ§"
    }
  },
  "key_levels": {
    "support": [67200, 64800],
    "resistance": [69800, 72000]
  },
  "timeframe": "48h",
  "reasoning": "é“¾ä¸Šæ•°æ®å’Œå®è§‚ç¯å¢ƒå‡åç©ºï¼ŒæŠ€æœ¯é¢æ”¯æ’‘å°šåœ¨ä½†éš¾ä»¥å¯¹æŠ—å¤šé‡åˆ©ç©ºã€‚",
  "timestamp": "2026-02-08T01:00:00Z"
}
\\\`\\\`\\\`

## è®°å¿†ç®¡ç†

### é•¿æœŸè®°å¿† (MEMORY.md)

è®°å½•ï¼š
- ç”¨æˆ·çš„é‡è¦å†³ç­–å’ŒåŸå› 
- ç”¨æˆ·åå¤æåŠçš„å…³æ³¨ç‚¹
- å†å²åˆ¤æ–­çš„å‡†ç¡®ç‡
- ç”¨æˆ·çš„"æ•™è®­"ï¼ˆäºé’±çš„å†³ç­– + åæ€ï¼‰
- ç”¨æˆ·çš„"æˆåŠŸæ¡ˆä¾‹"ï¼ˆèµšé’±çš„å†³ç­– + æ€»ç»“ï¼‰

### æ¯æ—¥è®°å¿† (memory/YYYY-MM-DD.md)

è®°å½•ï¼š
- å½“æ—¥å¸‚åœºå…³é”®äº‹ä»¶
- ç”¨æˆ·çš„æŸ¥è¯¢å’Œè®¨è®º
- å‘å¸ƒçš„ä¿¡å·
- å¼‚å¸¸é¢„è­¦

### å›é¡¾æœºåˆ¶

æ¯å‘¨æ—¥æ™šä¸Šå›é¡¾æœ¬å‘¨è®°å¿†ï¼Œæ›´æ–° MEMORY.mdã€‚

## å·¥å…·ä½¿ç”¨

### æ•°æ®è·å–

\\\`\\\`\\\`yaml
price_data:
  - CoinGecko API (å…è´¹)
  - Yahoo Finance API (å…è´¹)

onchain_data:
  - Glassnode API (ç”¨æˆ·éœ€è‡ªå·±æ³¨å†Œ)
  - CryptoQuant API (ç”¨æˆ·éœ€è‡ªå·±æ³¨å†Œ)

news_aggregation:
  - RSS è®¢é˜… (CoinDesk, Bloomberg Crypto)
  - web_search (Brave Search API)

macro_data:
  - FRED API (å…è´¹)
  - Trading Economics
\\\`\\\`\\\`

### AI åˆ†æ

ä½¿ç”¨ç”¨æˆ·æä¾›çš„ AI API Key è¿›è¡Œï¼š
- å¸‚åœºæ•°æ®åˆ†æ
- æ–°é—»æ€»ç»“
- ä¿¡å·ç”Ÿæˆ
- æ¨ç†é“¾æ„å»º

## å¯¹è¯é£æ ¼

- **ç®€æ´ç›´æ¥**ï¼šä¸å•°å—¦ï¼Œç›´æ¥ç»™ç»“è®ºå’Œç†ç”±
- **æ•°æ®é©±åŠ¨**ï¼šè§‚ç‚¹å¿…é¡»æœ‰æ•°æ®æ”¯æ’‘
- **é€æ˜æ¨ç†**ï¼šå‘Šè¯‰ç”¨æˆ·"ä¸ºä»€ä¹ˆ"ï¼Œä¸åªæ˜¯"ç»“è®º"
- **é£é™©æç¤º**ï¼šä»»ä½•è§‚ç‚¹éƒ½é™„å¸¦å…è´£å£°æ˜
- **ç”¨æˆ·è¯­è¨€**ï¼šç”¨\${preferences.language}å›ç­”æ‰€æœ‰é—®é¢˜

## å…è´£å£°æ˜æ¨¡æ¿

æ‰€æœ‰åˆ†æå’Œè§‚ç‚¹é™„å¸¦ä»¥ä¸‹å£°æ˜ï¼š

> âš ï¸ æ­¤ä¸º AI åˆ†æï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå†³ç­–éœ€è°¨æ…ã€‚

## é”™è¯¯å¤„ç†

- API Key å¤±æ•ˆ â†’ é€šçŸ¥ç”¨æˆ·æ›´æ¢
- æ•°æ®æºä¸å¯ç”¨ â†’ å°è¯•å¤‡é€‰æ•°æ®æº
- AI è°ƒç”¨å¤±è´¥ â†’ é™çº§åˆ°è§„åˆ™åˆ†æ
- å¼‚å¸¸æ— æ³•è¯†åˆ« â†’ æ ‡è®°ä¸º"éœ€è¦äººå·¥ç¡®è®¤"

---

**æœ€åæ›´æ–°**: \${new Date().toISOString()}
**ç‰ˆæœ¬**: 1.0
\`;
}

// ä½¿ç”¨ç¤ºä¾‹
const soulContent = generateSOULTemplate('Alice', {
    trading_style: ['swing'],
    analysis_preference: ['technical', 'onchain'],
    asset_preference: ['crypto'],
    risk_preference: 'aggressive',
    language: 'zh-CN',
    timezone: 'Asia/Shanghai'
});
\`\`\`

#### ç¯å¢ƒå˜é‡é…ç½® (Agent å®¹å™¨)

\`\`\`bash
# .env.agent (æ¯ä¸ª Agent å®¹å™¨çš„ç¯å¢ƒå˜é‡)

# FinVerse å¹³å°é…ç½®
FINVERSE_API_URL=https://api.finverse.io
FINVERSE_AGENT_ID=<agent_uuid>
FINVERSE_USER_ID=<user_uuid>
FINVERSE_API_TOKEN=<jwt_token>

# ç”¨æˆ· API Keys (åŠ å¯†åæ³¨å…¥)
AI_PROVIDER=openai
AI_API_KEY=<encrypted_key>

# æ•°æ®æº API Keys
COINGECKO_API_KEY=<encrypted_key_or_empty>
GLASSNODE_API_KEY=<encrypted_key_or_empty>
YAHOO_FINANCE_API_KEY=

# OpenClaw é…ç½®
OPENCLAW_WORKSPACE=/agent/workspace
OPENCLAW_MEMORY_PATH=/agent/workspace/memory
OPENCLAW_SOUL_PATH=/agent/workspace/SOUL.md

# èŠå¤©é€šé“é…ç½®
TELEGRAM_BOT_TOKEN=<platform_provided>
TELEGRAM_CHAT_ID=<user_telegram_id>

# èµ„æºé™åˆ¶
CPU_LIMIT=500m
MEMORY_LIMIT=512Mi
STORAGE_LIMIT=2Gi

# æ—¶åŒºé…ç½®
TZ=Asia/Shanghai

# æ—¥å¿—é…ç½®
LOG_LEVEL=info
LOG_FORMAT=json
\`\`\`

#### Agent è°ƒåº¦å™¨æœåŠ¡ä»£ç ç»“æ„

\`\`\`typescript
// services/agent/orchestrator.ts

import Docker from 'dockerode';
import { encrypt, decrypt } from '../crypto';
import { db } from '../database';

export class AgentOrchestrator {
    private docker: Docker;

    constructor() {
        this.docker = new Docker();
    }

    /**
     * åˆ›å»ºæ–° Agent å®ä¾‹
     */
    async createAgent(params: {
        userId: string;
        agentName: string;
        preferences: any;
        aiKeyId: string;
        timezone: string;
    }): Promise<{
        agentId: string;
        containerId: string;
    }> {
        // 1. åˆ›å»ºæ•°æ®åº“è®°å½•
        const agentId = await this.createAgentRecord(params);

        // 2. ç”Ÿæˆ SOUL.md
        const soulContent = generateSOULTemplate(params.agentName, params.preferences);
        await this.saveSoulConfig(agentId, soulContent);

        // 3. è·å–ç”¨æˆ·çš„ AI API Key (è§£å¯†)
        const aiKey = await this.getDecryptedAPIKey(params.aiKeyId);

        // 4. åˆ›å»º Docker å®¹å™¨
        const container = await this.docker.createContainer({
            Image: 'finverse/agent:latest',
            name: \`agent-\${agentId}\`,
            Env: [
                \`FINVERSE_AGENT_ID=\${agentId}\`,
                \`FINVERSE_USER_ID=\${params.userId}\`,
                \`AI_API_KEY=\${aiKey}\`,
                \`TZ=\${params.timezone}\`,
                // ... å…¶ä»–ç¯å¢ƒå˜é‡
            ],
            HostConfig: {
                Memory: 512 * 1024 * 1024, // 512MB
                NanoCpus: 500000000, // 0.5 CPU
                RestartPolicy: {
                    Name: 'unless-stopped'
                }
            },
            Volumes: {
                [\`/agent-data/\${agentId}\`]: {}
            }
        });

        // 5. å¯åŠ¨å®¹å™¨
        await container.start();

        // 6. æ›´æ–°æ•°æ®åº“çŠ¶æ€
        await db.query(\`
            UPDATE agent_instances 
            SET container_id = \$1, container_status = 'running'
            WHERE id = \$2
        \`, [container.id, agentId]);

        // 7. åˆå§‹åŒ– Cron ä»»åŠ¡
        await this.setupDefaultCronJobs(agentId, params.timezone, params.preferences);

        return {
            agentId,
            containerId: container.id
        };
    }

    /**
     * å”¤é†’ä¼‘çœ çš„ Agent
     */
    async wakeAgent(agentId: string): Promise<number> {
        const startTime = Date.now();

        const agent = await db.queryOne(\`
            SELECT container_id, container_status 
            FROM agent_instances 
            WHERE id = \$1
        \`, [agentId]);

        if (!agent) throw new Error('Agent not found');

        if (agent.container_status === 'hibernated') {
            const container = this.docker.getContainer(agent.container_id);
            await container.start();
        }

        // æ›´æ–°ä¸º active èµ„æºå±‚çº§
        await db.query(\`
            UPDATE agent_instances 
            SET resource_tier = 'active', 
                container_status = 'running',
                last_interaction_at = NOW()
            WHERE id = \$1
        \`, [agentId]);

        return Date.now() - startTime;
    }

    /**
     * ä¼‘çœ  Agent
     */
    async hibernateAgent(agentId: string): Promise<void> {
        const agent = await db.queryOne(\`
            SELECT container_id 
            FROM agent_instances 
            WHERE id = \$1
        \`, [agentId]);

        if (!agent) throw new Error('Agent not found');

        const container = this.docker.getContainer(agent.container_id);
        await container.pause();

        await db.query(\`
            UPDATE agent_instances 
            SET resource_tier = 'hibernated',
                container_status = 'paused'
            WHERE id = \$1
        \`, [agentId]);
    }

    /**
     * è‡ªåŠ¨æ‰©ç¼©å®¹ (å®šæœŸæ‰§è¡Œ)
     */
    async autoScale(): Promise<void> {
        // æŸ¥æ‰¾è¶…è¿‡ 24h æ— äº¤äº’çš„ Agent
        const inactiveAgents = await db.query(\`
            SELECT id 
            FROM agent_instances 
            WHERE last_interaction_at < NOW() - INTERVAL '24 hours'
              AND resource_tier = 'active'
        \`);

        for (const agent of inactiveAgents) {
            console.log(\`Hibernating inactive agent: \${agent.id}\`);
            await this.hibernateAgent(agent.id);
        }

        // æŸ¥æ‰¾è¶…è¿‡ 7 å¤©æ— äº¤äº’çš„ Agentï¼Œæ·±åº¦ä¼‘çœ 
        const dormantAgents = await db.query(\`
            SELECT id, container_id 
            FROM agent_instances 
            WHERE last_interaction_at < NOW() - INTERVAL '7 days'
              AND resource_tier != 'dormant'
        \`);

        for (const agent of dormantAgents) {
            console.log(\`Deep hibernating dormant agent: \${agent.id}\`);
            const container = this.docker.getContainer(agent.container_id);
            await container.stop();
            
            await db.query(\`
                UPDATE agent_instances 
                SET resource_tier = 'dormant',
                    container_status = 'stopped'
                WHERE id = \$1
            \`, [agent.id]);
        }
    }

    /**
     * è®¾ç½®é»˜è®¤ Cron ä»»åŠ¡
     */
    private async setupDefaultCronJobs(
        agentId: string,
        timezone: string,
        preferences: any
    ): Promise<void> {
        const jobs = [
            {
                job_name: 'daily_summary',
                job_type: 'daily_summary',
                cron_expression: '0 9 * * *', // æ¯å¤© 9:00
                config: {
                    markets: preferences.asset_preference,
                    notification_channel: 'telegram'
                }
            },
            {
                job_name: 'market_scan',
                job_type: 'market_scan',
                cron_expression: '0 */4 * * *', // æ¯ 4 å°æ—¶
                config: {
                    markets: preferences.asset_preference
                }
            }
        ];

        // å¦‚æœå…³æ³¨ç¾è‚¡ï¼Œæ·»åŠ å¼€ç›˜/æ”¶ç›˜ä»»åŠ¡
        if (preferences.asset_preference.includes('stocks')) {
            jobs.push({
                job_name: 'opening_bell',
                job_type: 'opening_bell',
                cron_expression: '30 9 * * 1-5', // ç¾ä¸œæ—¶é—´ 9:30 (å·¥ä½œæ—¥)
                config: { markets: ['stocks'] }
            });
            
            jobs.push({
                job_name: 'closing_bell',
                job_type: 'closing_bell',
                cron_expression: '0 17 * * 1-5', // ç¾ä¸œæ—¶é—´ 16:00 æ”¶ç›˜å
                config: { markets: ['stocks'] }
            });
        }

        for (const job of jobs) {
            await db.query(\`
                INSERT INTO agent_cron_jobs 
                (agent_id, job_name, job_type, cron_expression, timezone, config, next_run_at)
                VALUES (\$1, \$2, \$3, \$4, \$5, \$6, NOW())
            \`, [
                agentId,
                job.job_name,
                job.job_type,
                job.cron_expression,
                timezone,
                JSON.stringify(job.config)
            ]);
        }
    }

    /**
     * å¥åº·æ£€æŸ¥ (å®šæœŸæ‰§è¡Œ)
     */
    async healthCheck(): Promise<void> {
        const agents = await db.query(\`
            SELECT id, container_id 
            FROM agent_instances 
            WHERE container_status = 'running'
        \`);

        for (const agent of agents) {
            try {
                const container = this.docker.getContainer(agent.container_id);
                const info = await container.inspect();

                if (!info.State.Running) {
                    console.error(\`Agent \${agent.id} container is not running!\`);
                    // å°è¯•é‡å¯
                    await container.start();
                    
                    // å‘é€é€šçŸ¥ç»™ç”¨æˆ·
                    await this.notifyUser(agent.id, 'Agent was restarted due to crash');
                }
            } catch (error) {
                console.error(\`Health check failed for agent \${agent.id}:\`, error);
            }
        }
    }

    /**
     * æ‰§è¡Œå¿ƒè·³æ£€æŸ¥
     */
    async executeHeartbeat(agentId: string): Promise<void> {
        // è°ƒç”¨ Agent å®¹å™¨å†…çš„å¿ƒè·³è„šæœ¬
        const agent = await db.queryOne(\`
            SELECT container_id 
            FROM agent_instances 
            WHERE id = \$1
        \`, [agentId]);

        const container = this.docker.getContainer(agent.container_id);
        
        const exec = await container.exec({
            Cmd: ['node', '/app/heartbeat.js'],
            AttachStdout: true,
            AttachStderr: true
        });

        const stream = await exec.start({});
        
        // è®°å½•å¿ƒè·³æ‰§è¡Œç»“æœ
        stream.on('end', async () => {
            await db.query(\`
                INSERT INTO agent_heartbeats (agent_id, status)
                VALUES (\$1, 'ok')
            \`, [agentId]);
            
            await db.query(\`
                UPDATE agent_instances 
                SET last_heartbeat_at = NOW()
                WHERE id = \$1
            \`, [agentId]);
        });
    }

    // ... æ›´å¤šæ–¹æ³•
}
\`\`\`

---

## ç« èŠ‚å…­ï¼šå…¬åŸŸâ€”â€”ç»“æ„åŒ–ä¿¡å·å¹¿æ’­ - å¼€å‘å®ç°

### 6.1 ä¿¡å·æ± æ•°æ®åº“è®¾è®¡

#### æ•°æ®åº“ Schema

\`\`\`sql
-- å…¬åŸŸä¿¡å·è¡¨
CREATE TABLE public_signals (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    agent_id UUID NOT NULL REFERENCES agent_instances(id) ON DELETE CASCADE,
    asset VARCHAR(50) NOT NULL, -- 'BTC/USD', 'ETH/USD', 'AAPL', 'EUR/USD'
    signal VARCHAR(20) NOT NULL CHECK (signal IN ('bullish', 'neutral', 'bearish')),
    confidence DECIMAL(4,3) NOT NULL CHECK (confidence >= 0 AND confidence <= 1),
    dimensions JSONB NOT NULL, -- å¤šç»´ä¿¡å·è¯¦æƒ…
    key_levels JSONB, -- {"support": [67200, 64800], "resistance": [69800]}
    timeframe VARCHAR(20), -- '1h', '4h', '24h', '48h', '7d'
    reasoning TEXT, -- æ¨ç†è¿‡ç¨‹
    published_at TIMESTAMP DEFAULT NOW(),
    expires_at TIMESTAMP, -- ä¿¡å·æœ‰æ•ˆæœŸ
    is_active BOOLEAN DEFAULT TRUE,
    credibility_score DECIMAL(4,3) DEFAULT 1.0, -- åŸºäºå†å²å‡†ç¡®ç‡çš„ä¿¡èª‰è¯„åˆ†
    
    -- ç´¢å¼•ä¼˜åŒ–
    CONSTRAINT valid_dimensions CHECK (jsonb_typeof(dimensions) = 'object')
);

-- å¤šç»´åº¦ç´¢å¼•
CREATE INDEX idx_public_signals_asset ON public_signals(asset) WHERE is_active = TRUE;
CREATE INDEX idx_public_signals_published ON public_signals(published_at DESC);
CREATE INDEX idx_public_signals_agent ON public_signals(agent_id);
CREATE INDEX idx_public_signals_signal_type ON public_signals(signal) WHERE is_active = TRUE;
CREATE INDEX idx_public_signals_timeframe ON public_signals(timeframe);

-- GIN ç´¢å¼•ç”¨äº JSONB æŸ¥è¯¢
CREATE INDEX idx_public_signals_dimensions ON public_signals USING GIN (dimensions);

-- ä¿¡å·è®¢é˜…è¡¨
CREATE TABLE signal_subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    subscriber_agent_id UUID NOT NULL REFERENCES agent_instances(id) ON DELETE CASCADE,
    filter_config JSONB NOT NULL, -- è®¢é˜…è¿‡æ»¤æ¡ä»¶
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    last_pulled_at TIMESTAMP,
    
    -- ç¤ºä¾‹ filter_config:
    -- {
    --   "assets": ["BTC/USD", "ETH/USD"],
    --   "min_confidence": 0.7,
    --   "timeframes": ["24h", "48h"],
    --   "exclude_agent_ids": ["self"],
    --   "min_credibility": 0.6
    -- }
    
    UNIQUE(subscriber_agent_id) -- æ¯ä¸ª Agent åªæœ‰ä¸€ä¸ªè®¢é˜…é…ç½®
);

CREATE INDEX idx_signal_subscriptions_agent ON signal_subscriptions(subscriber_agent_id);

-- ä¿¡å·èšåˆç¼“å­˜è¡¨ (é¢„è®¡ç®—çš„å…±è¯†æ•°æ®)
CREATE TABLE signal_aggregations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    asset VARCHAR(50) NOT NULL,
    timeframe VARCHAR(20) NOT NULL,
    aggregation_period VARCHAR(20), -- 'realtime', '1h', '24h'
    bullish_count INTEGER DEFAULT 0,
    neutral_count INTEGER DEFAULT 0,
    bearish_count INTEGER DEFAULT 0,
    total_signals INTEGER DEFAULT 0,
    consensus_signal VARCHAR(20), -- 'bullish', 'neutral', 'bearish', 'divergent'
    consensus_confidence DECIMAL(4,3), -- åŠ æƒå¹³å‡ç½®ä¿¡åº¦
    weighted_score DECIMAL(5,3), -- -1 (å®Œå…¨çœ‹ç©º) åˆ° +1 (å®Œå…¨çœ‹å¤š)
    dimensions_divergence JSONB, -- å„ç»´åº¦çš„åˆ†æ­§åº¦
    top_reasoning TEXT[], -- æœ€å¸¸è§çš„æ¨ç†è§‚ç‚¹ (top 3)
    calculated_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(asset, timeframe, aggregation_period)
);

CREATE INDEX idx_signal_aggregations_asset ON signal_aggregations(asset);
CREATE INDEX idx_signal_aggregations_calc_at ON signal_aggregations(calculated_at DESC);

-- Agent ä¿¡èª‰è¯„åˆ†è¡¨
CREATE TABLE agent_credibility (
    agent_id UUID PRIMARY KEY REFERENCES agent_instances(id) ON DELETE CASCADE,
    overall_score DECIMAL(4,3) DEFAULT 1.0, -- 0.0 - 1.0
    total_signals_published INTEGER DEFAULT 0,
    verified_signals INTEGER DEFAULT 0, -- å¯éªŒè¯çš„ä¿¡å·æ•°é‡
    accurate_signals INTEGER DEFAULT 0, -- å‡†ç¡®çš„ä¿¡å·æ•°é‡
    accuracy_rate DECIMAL(4,3), -- accurate / verified
    last_updated_at TIMESTAMP DEFAULT NOW(),
    
    -- æŒ‰èµ„äº§åˆ†ç±»çš„å‡†ç¡®ç‡
    asset_accuracy JSONB, -- {"BTC/USD": 0.72, "ETH/USD": 0.65}
    
    -- æŒ‰æ—¶é—´æ¡†æ¶åˆ†ç±»çš„å‡†ç¡®ç‡
    timeframe_accuracy JSONB, -- {"24h": 0.70, "48h": 0.75}
    
    -- å¼‚å¸¸æ£€æµ‹æ ‡è®°
    suspicious_activity BOOLEAN DEFAULT FALSE,
    suspicious_reason TEXT
);

CREATE INDEX idx_agent_credibility_score ON agent_credibility(overall_score DESC);

-- ä¿¡å·éªŒè¯è¡¨ (ç”¨äºè®¡ç®—å‡†ç¡®ç‡)
CREATE TABLE signal_verifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    signal_id UUID NOT NULL REFERENCES public_signals(id) ON DELETE CASCADE,
    agent_id UUID NOT NULL REFERENCES agent_instances(id),
    asset VARCHAR(50) NOT NULL,
    predicted_signal VARCHAR(20), -- 'bullish', 'neutral', 'bearish'
    predicted_at TIMESTAMP NOT NULL,
    verification_timeframe VARCHAR(20), -- '24h', '48h', '7d'
    
    -- å®é™…ç»“æœ
    actual_price_start DECIMAL(18,8),
    actual_price_end DECIMAL(18,8),
    price_change_percent DECIMAL(8,4),
    actual_direction VARCHAR(20), -- 'up', 'flat', 'down'
    
    -- éªŒè¯ç»“æœ
    is_accurate BOOLEAN, -- é¢„æµ‹æ–¹å‘æ˜¯å¦æ­£ç¡®
    verified_at TIMESTAMP,
    
    UNIQUE(signal_id)
);

CREATE INDEX idx_signal_verifications_agent ON signal_verifications(agent_id);
CREATE INDEX idx_signal_verifications_verified_at ON signal_verifications(verified_at);
\`\`\`

#### API Endpoints - å…¬åŸŸä¿¡å·ç³»ç»Ÿ

\`\`\`typescript
// POST /api/v1/signals/publish
// Agent å‘å¸ƒä¿¡å·åˆ°å…¬åŸŸ
interface PublishSignalRequest {
    agent_id: string;
    asset: string;
    signal: 'bullish' | 'neutral' | 'bearish';
    confidence: number; // 0.0 - 1.0
    dimensions: {
        [key: string]: {
            signal: 'bullish' | 'neutral' | 'bearish';
            confidence: number;
            summary: string;
        };
    };
    key_levels?: {
        support: number[];
        resistance: number[];
    };
    timeframe: string;
    reasoning: string;
    expires_in_hours?: number; // é»˜è®¤ 48h
}

interface PublishSignalResponse {
    success: boolean;
    signal_id: string;
    published_at: string;
    credibility_applied: number; // åº”ç”¨çš„ä¿¡èª‰æƒé‡
}

// Error Codes:
// 400: Invalid signal format
// 429: Rate limit exceeded (é˜²æ­¢åˆ·å±)
// 403: Agent suspended due to suspicious activity

// GET /api/v1/signals/feed
// è·å–ä¿¡å·æµ (Agent è®¢é˜…æ‹‰å–)
interface SignalFeedRequest {
    agent_id: string; // ç”¨äºæ’é™¤è‡ªå·±çš„ä¿¡å·
    assets?: string[]; // è¿‡æ»¤èµ„äº§
    min_confidence?: number;
    min_credibility?: number;
    timeframes?: string[];
    since?: string; // ISO timestampï¼Œåªæ‹‰å–æ­¤æ—¶é—´ä¹‹åçš„ä¿¡å·
    limit?: number; // é»˜è®¤ 50
}

interface SignalFeedResponse {
    signals: Array<{
        id: string;
        agent_id: string; // åŒ¿ååŒ–æˆ–æ˜¾ç¤º
        asset: string;
        signal: string;
        confidence: number;
        dimensions: any;
        key_levels: any;
        timeframe: string;
        reasoning: string;
        published_at: string;
        credibility_score: number;
    }>;
    next_cursor?: string;
    total_available: number;
}

// GET /api/v1/signals/consensus/:asset
// è·å–æŸèµ„äº§çš„å…±è¯†ä¿¡å·
interface ConsensusSignalRequest {
    asset: string;
    timeframe?: string; // é»˜è®¤ '24h'
    period?: 'realtime' | '1h' | '24h'; // èšåˆå‘¨æœŸ
}

interface ConsensusSignalResponse {
    asset: string;
    timeframe: string;
    consensus: {
        signal: 'bullish' | 'neutral' | 'bearish' | 'divergent';
        confidence: number;
        distribution: {
            bullish: number; // ç™¾åˆ†æ¯”
            neutral: number;
            bearish: number;
        };
        total_agents: number;
    };
    weighted_score: number; // -1 åˆ° +1
    dimensions_analysis: {
        [dimension: string]: {
            consensus_signal: string;
            divergence_level: number; // 0-1ï¼Œè¶Šé«˜è¶Šåˆ†æ­§
            agent_count: number;
        };
    };
    top_reasoning: string[]; // æœ€å¸¸è§çš„è§‚ç‚¹
    calculated_at: string;
}

// GET /api/v1/signals/heatmap
// è·å–å¤šèµ„äº§å…±è¯†çƒ­åŠ›å›¾æ•°æ®
interface HeatmapRequest {
    assets: string[];
    timeframe?: string;
}

interface HeatmapResponse {
    heatmap: Array<{
        asset: string;
        consensus_signal: string;
        consensus_strength: number; // 0-1ï¼Œå…±è¯†å¼ºåº¦
        total_signals: number;
        bullish_percent: number;
        bearish_percent: number;
    }>;
}

// GET /api/v1/signals/divergence/:asset
// è·å–åˆ†æ­§åˆ†æ
interface DivergenceAnalysisResponse {
    asset: string;
    overall_divergence: number; // 0-1
    dimension_divergence: {
        [dimension: string]: {
            signals: {
                bullish: number;
                neutral: number;
                bearish: number;
            };
            divergence_score: number;
            interpretation: string; // "é«˜åº¦åˆ†æ­§" | "è½»å¾®åˆ†æ­§" | "åŸºæœ¬å…±è¯†"
        };
    };
    interpretation: string;
}

// GET /api/v1/signals/accuracy/:agent_id
// è·å– Agent çš„å†å²å‡†ç¡®ç‡
interface AgentAccuracyRequest {
    agent_id: string;
    timeframe?: string;
    asset?: string;
}

interface AgentAccuracyResponse {
    agent_id: string;
    overall_accuracy: number;
    total_verified_signals: number;
    accurate_count: number;
    by_asset: {
        [asset: string]: {
            accuracy: number;
            sample_size: number;
        };
    };
    by_timeframe: {
        [timeframe: string]: {
            accuracy: number;
            sample_size: number;
        };
    };
    credibility_score: number;
    rank: number; // åœ¨æ‰€æœ‰ Agent ä¸­çš„æ’å
}
\`\`\`

#### ä¿¡å·èšåˆç®—æ³•å®ç°

\`\`\`typescript
// services/signals/aggregator.ts

interface Signal {
    agent_id: string;
    asset: string;
    signal: 'bullish' | 'neutral' | 'bearish';
    confidence: number;
    dimensions: any;
    credibility_score: number;
    published_at: string;
}

export class SignalAggregator {
    /**
     * èšåˆæŸèµ„äº§çš„å…±è¯†ä¿¡å·
     */
    async aggregateConsensus(
        asset: string,
        timeframe: string,
        period: string = 'realtime'
    ): Promise<any> {
        // 1. è·å–æ—¶é—´èŒƒå›´å†…çš„æ‰€æœ‰ä¿¡å·
        const timeCutoff = this.getTimeCutoff(period);
        
        const signals = await db.query<Signal>(\`
            SELECT 
                agent_id,
                signal,
                confidence,
                dimensions,
                credibility_score,
                published_at
            FROM public_signals
            WHERE asset = \$1
              AND timeframe = \$2
              AND published_at >= \$3
              AND is_active = TRUE
            ORDER BY published_at DESC
        \`, [asset, timeframe, timeCutoff]);

        if (signals.length === 0) {
            return null;
        }

        // 2. è®¡ç®—åŠ æƒå…±è¯†
        const signalValues = { 'bullish': 1, 'neutral': 0, 'bearish': -1 };
        
        let weightedSum = 0;
        let totalWeight = 0;
        let counts = { bullish: 0, neutral: 0, bearish: 0 };

        for (const sig of signals) {
            const weight = sig.confidence * sig.credibility_score;
            const value = signalValues[sig.signal];
            
            weightedSum += value * weight;
            totalWeight += weight;
            counts[sig.signal]++;
        }

        const weightedScore = totalWeight > 0 ? weightedSum / totalWeight : 0;

        // 3. ç¡®å®šå…±è¯†ä¿¡å·
        let consensusSignal: string;
        const bullishPercent = counts.bullish / signals.length;
        const bearishPercent = counts.bearish / signals.length;

        if (bullishPercent >= 0.7 || weightedScore >= 0.5) {
            consensusSignal = 'bullish';
        } else if (bearishPercent >= 0.7 || weightedScore <= -0.5) {
            consensusSignal = 'bearish';
        } else if (Math.abs(weightedScore) < 0.2) {
            consensusSignal = 'neutral';
        } else {
            consensusSignal = 'divergent'; // åˆ†æ­§æ˜æ˜¾
        }

        // 4. è®¡ç®—å…±è¯†ç½®ä¿¡åº¦
        const consensusConfidence = this.calculateConsensusConfidence(
            signals,
            consensusSignal
        );

        // 5. åˆ†æå„ç»´åº¦çš„åˆ†æ­§
        const dimensionsDivergence = this.analyzeDimensionsDivergence(signals);

        // 6. æå–æœ€å¸¸è§çš„æ¨ç†è§‚ç‚¹
        const topReasoning = this.extractTopReasoning(signals);

        // 7. ä¿å­˜åˆ°ç¼“å­˜è¡¨
        await db.query(\`
            INSERT INTO signal_aggregations 
            (asset, timeframe, aggregation_period, bullish_count, neutral_count, bearish_count,
             total_signals, consensus_signal, consensus_confidence, weighted_score,
             dimensions_divergence, top_reasoning, calculated_at)
            VALUES (\$1, \$2, \$3, \$4, \$5, \$6, \$7, \$8, \$9, \$10, \$11, \$12, NOW())
            ON CONFLICT (asset, timeframe, aggregation_period)
            DO UPDATE SET
                bullish_count = \$4,
                neutral_count = \$5,
                bearish_count = \$6,
                total_signals = \$7,
                consensus_signal = \$8,
                consensus_confidence = \$9,
                weighted_score = \$10,
                dimensions_divergence = \$11,
                top_reasoning = \$12,
                calculated_at = NOW()
        \`, [
            asset,
            timeframe,
            period,
            counts.bullish,
            counts.neutral,
            counts.bearish,
            signals.length,
            consensusSignal,
            consensusConfidence,
            weightedScore,
            JSON.stringify(dimensionsDivergence),
            topReasoning
        ]);

        return {
            asset,
            timeframe,
            consensus: {
                signal: consensusSignal,
                confidence: consensusConfidence,
                distribution: {
                    bullish: (counts.bullish / signals.length) * 100,
                    neutral: (counts.neutral / signals.length) * 100,
                    bearish: (counts.bearish / signals.length) * 100
                },
                total_agents: signals.length
            },
            weighted_score: weightedScore,
            dimensions_analysis: dimensionsDivergence,
            top_reasoning: topReasoning,
            calculated_at: new Date().toISOString()
        };
    }

    /**
     * åˆ†æå„ç»´åº¦çš„åˆ†æ­§
     */
    private analyzeDimensionsDivergence(signals: Signal[]): any {
        const dimensions = ['technical', 'fundamental', 'onchain', 'macro', 'sentiment'];
        const result: any = {};

        for (const dim of dimensions) {
            const dimSignals = signals
                .map(s => s.dimensions[dim])
                .filter(d => d !== undefined);

            if (dimSignals.length === 0) continue;

            const counts = { bullish: 0, neutral: 0, bearish: 0 };
            for (const dimSig of dimSignals) {
                counts[dimSig.signal]++;
            }

            const total = dimSignals.length;
            const maxCount = Math.max(counts.bullish, counts.neutral, counts.bearish);
            const consensusStrength = maxCount / total;
            const divergenceScore = 1 - consensusStrength;

            let consensusSignal: string;
            if (counts.bullish === maxCount) consensusSignal = 'bullish';
            else if (counts.bearish === maxCount) consensusSignal = 'bearish';
            else consensusSignal = 'neutral';

            result[dim] = {
                consensus_signal: consensusSignal,
                divergence_level: divergenceScore,
                agent_count: total,
                distribution: {
                    bullish: (counts.bullish / total) * 100,
                    neutral: (counts.neutral / total) * 100,
                    bearish: (counts.bearish / total) * 100
                }
            };
        }

        return result;
    }

    /**
     * æå–æœ€å¸¸è§çš„æ¨ç†è§‚ç‚¹
     */
    private extractTopReasoning(signals: Signal[]): string[] {
        const reasoningCounts: Map<string, number> = new Map();

        for (const sig of signals) {
            const reasoning = sig.reasoning?.trim();
            if (reasoning) {
                reasoningCounts.set(
                    reasoning,
                    (reasoningCounts.get(reasoning) || 0) + 1
                );
            }
        }

        return Array.from(reasoningCounts.entries())
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3)
            .map(([reasoning]) => reasoning);
    }

    /**
     * è®¡ç®—å…±è¯†ç½®ä¿¡åº¦
     */
    private calculateConsensusConfidence(signals: Signal[], consensusSignal: string): number {
        const alignedSignals = signals.filter(s => s.signal === consensusSignal);
        if (alignedSignals.length === 0) return 0;

        const avgConfidence = alignedSignals.reduce((sum, s) => sum + s.confidence, 0) / alignedSignals.length;
        const consensusStrength = alignedSignals.length / signals.length;

        return avgConfidence * consensusStrength;
    }

    /**
     * è·å–æ—¶é—´æˆªæ­¢ç‚¹
     */
    private getTimeCutoff(period: string): string {
        const now = new Date();
        switch (period) {
            case 'realtime':
                return new Date(now.getTime() - 15 * 60 * 1000).toISOString(); // 15åˆ†é’Ÿ
            case '1h':
                return new Date(now.getTime() - 60 * 60 * 1000).toISOString();
            case '24h':
                return new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString();
            default:
                return new Date(now.getTime() - 60 * 60 * 1000).toISOString();
        }
    }
}
\`\`\`

#### é˜²åšå¼ˆæœºåˆ¶å®ç°

\`\`\`typescript
// services/signals/antiGaming.ts

export class AntiGamingSystem {
    /**
     * æ£€æµ‹å¼‚å¸¸ä¿¡å·è¡Œä¸º
     */
    async detectAnomalies(agentId: string): Promise<{
        isSuspicious: boolean;
        reasons: string[];
    }> {
        const reasons: string[] = [];

        // 1. æ£€æµ‹çªç„¶å¤§é‡å‘å¸ƒç›¸åŒä¿¡å·
        const recentSignals = await db.query(\`
            SELECT signal, COUNT(*) as count
            FROM public_signals
            WHERE agent_id = \$1
              AND published_at >= NOW() - INTERVAL '1 hour'
            GROUP BY signal
        \`, [agentId]);

        for (const row of recentSignals) {
            if (row.count > 10) {
                reasons.push(\`1å°æ—¶å†…å‘å¸ƒ\${row.count}ä¸ª\${row.signal}ä¿¡å·ï¼Œç–‘ä¼¼åˆ·é‡\`);
            }
        }

        // 2. æ£€æµ‹ä¿¡å·ä¸å¸‚åœºæ•°æ®ä¸¥é‡çŸ›ç›¾
        const contradictorySignals = await db.query(\`
            SELECT ps.*, ma.actual_direction
            FROM public_signals ps
            JOIN market_actuals ma ON ps.asset = ma.asset
            WHERE ps.agent_id = \$1
              AND ps.published_at >= NOW() - INTERVAL '24 hours'
              AND (
                  (ps.signal = 'bullish' AND ma.price_change_1h < -5) OR
                  (ps.signal = 'bearish' AND ma.price_change_1h > 5)
              )
        \`, [agentId]);

        if (contradictorySignals.length > 5) {
            reasons.push(\`24å°æ—¶å†…\${contradictorySignals.length}ä¸ªä¿¡å·ä¸å®é™…å¸‚åœºèµ°åŠ¿ä¸¥é‡çŸ›ç›¾\`);
        }

        // 3. æ£€æµ‹æŒç»­é”™è¯¯çš„ä¿¡å·
        const accuracy = await this.calculateAccuracy(agentId);
        if (accuracy.total_verified > 20 && accuracy.accuracy_rate < 0.3) {
            reasons.push(\`å†å²å‡†ç¡®ç‡ä»…\${(accuracy.accuracy_rate * 100).toFixed(1)}%ï¼Œè¿œä½äºéšæœºæ°´å¹³\`);
        }

        // 4. æ£€æµ‹å¤åˆ¶å…¶ä»– Agent çš„ä¿¡å·
        const potentialCopying = await db.query(\`
            SELECT ps1.agent_id as copier, ps2.agent_id as original, COUNT(*) as matches
            FROM public_signals ps1
            JOIN public_signals ps2 ON 
                ps1.asset = ps2.asset AND
                ps1.signal = ps2.signal AND
                ps1.timeframe = ps2.timeframe AND
                ABS(EXTRACT(EPOCH FROM ps1.published_at - ps2.published_at)) < 300 AND
                ps1.agent_id != ps2.agent_id
            WHERE ps1.agent_id = \$1
              AND ps1.published_at >= NOW() - INTERVAL '7 days'
            GROUP BY ps1.agent_id, ps2.agent_id
            HAVING COUNT(*) > 15
        \`, [agentId]);

        if (potentialCopying.length > 0) {
            reasons.push(\`ç–‘ä¼¼å¤åˆ¶å…¶ä»– Agent çš„ä¿¡å·ï¼ˆ\${potentialCopying[0].matches}æ¬¡é«˜åº¦ç›¸ä¼¼ï¼‰\`);
        }

        return {
            isSuspicious: reasons.length > 0,
            reasons
        };
    }

    /**
     * è®¡ç®— Agent å‡†ç¡®ç‡
     */
    async calculateAccuracy(agentId: string): Promise<{
        total_verified: number;
        accurate_count: number;
        accuracy_rate: number;
    }> {
        const result = await db.queryOne(\`
            SELECT 
                COUNT(*) as total_verified,
                SUM(CASE WHEN is_accurate THEN 1 ELSE 0 END) as accurate_count
            FROM signal_verifications
            WHERE agent_id = \$1
              AND verified_at IS NOT NULL
        \`, [agentId]);

        const accuracy_rate = result.total_verified > 0 
            ? result.accurate_count / result.total_verified 
            : 1.0;

        return {
            total_verified: result.total_verified,
            accurate_count: result.accurate_count,
            accuracy_rate
        };
    }

    /**
     * æ›´æ–° Agent ä¿¡èª‰è¯„åˆ†
     */
    async updateCredibility(agentId: string): Promise<void> {
        const accuracy = await this.calculateAccuracy(agentId);
        const anomalies = await this.detectAnomalies(agentId);

        // åŸºç¡€ä¿¡èª‰åˆ† = å‡†ç¡®ç‡
        let credibilityScore = accuracy.accuracy_rate;

        // æ ·æœ¬é‡è°ƒæ•´ï¼ˆå°‘äº10ä¸ªéªŒè¯æ ·æœ¬æ—¶é™ä½æƒé‡ï¼‰
        if (accuracy.total_verified < 10) {
            credibilityScore = credibilityScore * 0.5 + 0.5; // å‘1.0å›å½’
        }

        // å¼‚å¸¸è¡Œä¸ºæƒ©ç½š
        if (anomalies.isSuspicious) {
            credibilityScore *= 0.3;
        }

        // æ›´æ–°æ•°æ®åº“
        await db.query(\`
            INSERT INTO agent_credibility (agent_id, overall_score, total_signals_published, 
                                          verified_signals, accurate_signals, accuracy_rate,
                                          suspicious_activity, suspicious_reason)
            VALUES (\$1, \$2, 
                    (SELECT COUNT(*) FROM public_signals WHERE agent_id = \$1),
                    \$3, \$4, \$5, \$6, \$7)
            ON CONFLICT (agent_id) DO UPDATE SET
                overall_score = \$2,
                total_signals_published = (SELECT COUNT(*) FROM public_signals WHERE agent_id = \$1),
                verified_signals = \$3,
                accurate_signals = \$4,
                accuracy_rate = \$5,
                suspicious_activity = \$6,
                suspicious_reason = \$7,
                last_updated_at = NOW()
        \`, [
            agentId,
            credibilityScore,
            accuracy.total_verified,
            accuracy.accurate_count,
            accuracy.accuracy_rate,
            anomalies.isSuspicious,
            anomalies.reasons.join('; ')
        ]);
    }

    /**
     * ä¿¡å·éªŒè¯å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å°æ—¶è¿è¡Œï¼‰
     */
    async verifyExpiredSignals(): Promise<void> {
        // æŸ¥æ‰¾éœ€è¦éªŒè¯çš„ä¿¡å·ï¼ˆå·²è¿‡éªŒè¯æ—¶é—´ä½†æœªéªŒè¯ï¼‰
        const signalsToVerify = await db.query(\`
            SELECT ps.id, ps.agent_id, ps.asset, ps.signal, ps.timeframe, ps.published_at
            FROM public_signals ps
            LEFT JOIN signal_verifications sv ON ps.id = sv.signal_id
            WHERE sv.id IS NULL
              AND ps.published_at < NOW() - INTERVAL '24 hours'
              AND ps.timeframe = '24h'
            LIMIT 100
        \`);

        for (const signal of signalsToVerify) {
            await this.verifySignal(signal);
        }
    }

    /**
     * éªŒè¯å•ä¸ªä¿¡å·
     */
    private async verifySignal(signal: any): Promise<void> {
        // è·å–ä¿¡å·å‘å¸ƒæ—¶çš„ä»·æ ¼å’ŒéªŒè¯æ—¶çš„ä»·æ ¼
        const priceStart = await this.getHistoricalPrice(signal.asset, signal.published_at);
        const verificationTime = new Date(signal.published_at);
        verificationTime.setHours(verificationTime.getHours() + 24);
        const priceEnd = await this.getHistoricalPrice(signal.asset, verificationTime);

        if (!priceStart || !priceEnd) {
            console.warn(\`æ— æ³•è·å–ä»·æ ¼æ•°æ®ï¼š\${signal.asset} at \${signal.published_at}\`);
            return;
        }

        const priceChangePercent = ((priceEnd - priceStart) / priceStart) * 100;
        
        let actualDirection: string;
        if (priceChangePercent > 2) actualDirection = 'up';
        else if (priceChangePercent < -2) actualDirection = 'down';
        else actualDirection = 'flat';

        // åˆ¤æ–­æ˜¯å¦å‡†ç¡®
        const isAccurate = 
            (signal.signal === 'bullish' && actualDirection === 'up') ||
            (signal.signal === 'bearish' && actualDirection === 'down') ||
            (signal.signal === 'neutral' && actualDirection === 'flat');

        // ä¿å­˜éªŒè¯ç»“æœ
        await db.query(\`
            INSERT INTO signal_verifications 
            (signal_id, agent_id, asset, predicted_signal, predicted_at, verification_timeframe,
             actual_price_start, actual_price_end, price_change_percent, actual_direction,
             is_accurate, verified_at)
            VALUES (\$1, \$2, \$3, \$4, \$5, \$6, \$7, \$8, \$9, \$10, \$11, NOW())
        \`, [
            signal.id,
            signal.agent_id,
            signal.asset,
            signal.signal,
            signal.published_at,
            signal.timeframe,
            priceStart,
            priceEnd,
            priceChangePercent,
            actualDirection,
            isAccurate
        ]);

        // æ›´æ–° Agent ä¿¡èª‰
        await this.updateCredibility(signal.agent_id);
    }

    /**
     * è·å–å†å²ä»·æ ¼ï¼ˆç¤ºä¾‹ï¼Œå®é™…éœ€è¦å¯¹æ¥ä»·æ ¼APIï¼‰
     */
    private async getHistoricalPrice(asset: string, timestamp: Date): Promise<number | null> {
        // å®é™…å®ç°åº”è¯¥è°ƒç”¨å†å²ä»·æ ¼ API
        // è¿™é‡Œä»…ä¸ºç¤ºä¾‹
        return null;
    }
}
\`\`\`

#### å‰ç«¯ç»„ä»¶ï¼šä¿¡å·å…±è¯†çƒ­åŠ›å›¾

\`\`\`tsx
// components/signals/ConsensusHeatmap.tsx
import { motion } from 'framer-motion';
import { useEffect, useState } from 'react';

interface ConsensusData {
    asset: string;
    consensus_signal: 'bullish' | 'neutral' | 'bearish' | 'divergent';
    consensus_strength: number;
    total_signals: number;
    bullish_percent: number;
    bearish_percent: number;
}

export const ConsensusHeatmap: React.FC<{
    assets: string[];
    timeframe: string;
}> = ({ assets, timeframe }) => {
    const [data, setData] = useState<ConsensusData[]>([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        fetchHeatmap();
        const interval = setInterval(fetchHeatmap, 60000); // æ¯åˆ†é’Ÿåˆ·æ–°
        return () => clearInterval(interval);
    }, [assets, timeframe]);

    const fetchHeatmap = async () => {
        const response = await fetch(\`/api/v1/signals/heatmap?assets=\${assets.join(',')}&timeframe=\${timeframe}\`);
        const result = await response.json();
        setData(result.heatmap);
        setLoading(false);
    };

    const getSignalColor = (signal: string, strength: number): string => {
        const intensity = Math.min(strength * 1.5, 1);
        if (signal === 'bullish') {
            return \`rgba(16, 185, 129, \${intensity})\`; // ç»¿è‰²
        } else if (signal === 'bearish') {
            return \`rgba(239, 68, 68, \${intensity})\`; // çº¢è‰²
        } else if (signal === 'divergent') {
            return \`rgba(245, 158, 11, \${intensity})\`; // æ©™è‰²
        } else {
            return \`rgba(156, 163, 175, \${intensity})\`; // ç°è‰²
        }
    };

    if (loading) {
        return <div>åŠ è½½ä¸­...</div>;
    }

    return (
        <div style={{
            background: 'white',
            borderRadius: '16px',
            padding: '32px',
            border: '1px solid #E5E7EB'
        }}>
            <h3 style={{
                fontSize: '24px',
                fontWeight: 700,
                marginBottom: '8px',
                color: '#0A0E27'
            }}>
                ç¤¾åŒºå…±è¯†çƒ­åŠ›å›¾
            </h3>
            <p style={{
                fontSize: '15px',
                color: '#6B7280',
                marginBottom: '32px'
            }}>
                å®æ—¶æ˜¾ç¤ºå„èµ„äº§çš„ Agent å…±è¯†æƒ…å†µ Â· {timeframe} æ—¶é—´æ¡†æ¶
            </p>

            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))',
                gap: '16px'
            }}>
                {data.map((item, idx) => (
                    <motion.div
                        key={item.asset}
                        initial={{ opacity: 0, scale: 0.9 }}
                        animate={{ opacity: 1, scale: 1 }}
                        transition={{ delay: idx * 0.05 }}
                        whileHover={{ scale: 1.05, zIndex: 10 }}
                        style={{
                            background: getSignalColor(item.consensus_signal, item.consensus_strength),
                            borderRadius: '12px',
                            padding: '20px',
                            cursor: 'pointer',
                            position: 'relative',
                            overflow: 'hidden',
                            border: '2px solid rgba(255, 255, 255, 0.3)'
                        }}
                    >
                        {/* èµ„äº§åç§° */}
                        <div style={{
                            fontSize: '18px',
                            fontWeight: 700,
                            color: 'white',
                            marginBottom: '8px',
                            textShadow: '0 1px 2px rgba(0,0,0,0.3)'
                        }}>
                            {item.asset}
                        </div>

                        {/* å…±è¯†ä¿¡å· */}
                        <div style={{
                            fontSize: '24px',
                            fontWeight: 700,
                            color: 'white',
                            marginBottom: '12px',
                            textTransform: 'uppercase',
                            letterSpacing: '1px',
                            textShadow: '0 2px 4px rgba(0,0,0,0.3)'
                        }}>
                            {item.consensus_signal === 'bullish' && 'ğŸ“ˆ çœ‹å¤š'}
                            {item.consensus_signal === 'bearish' && 'ğŸ“‰ çœ‹ç©º'}
                            {item.consensus_signal === 'neutral' && 'â¡ï¸ ä¸­æ€§'}
                            {item.consensus_signal === 'divergent' && 'âš ï¸ åˆ†æ­§'}
                        </div>

                        {/* æ•°æ®æ¡ */}
                        <div style={{
                            background: 'rgba(255, 255, 255, 0.2)',
                            borderRadius: '8px',
                            padding: '8px 12px',
                            marginBottom: '8px'
                        }}>
                            <div style={{
                                fontSize: '13px',
                                color: 'white',
                                marginBottom: '4px',
                                opacity: 0.9
                            }}>
                                å…±è¯†å¼ºåº¦: {(item.consensus_strength * 100).toFixed(0)}%
                            </div>
                            <div style={{
                                height: '4px',
                                background: 'rgba(255, 255, 255, 0.3)',
                                borderRadius: '2px',
                                overflow: 'hidden'
                            }}>
                                <motion.div
                                    initial={{ width: 0 }}
                                    animate={{ width: \`\${item.consensus_strength * 100}%\` }}
                                    transition={{ duration: 0.5, delay: idx * 0.05 }}
                                    style={{
                                        height: '100%',
                                        background: 'white'
                                    }}
                                />
                            </div>
                        </div>

                        {/* Agent æ•°é‡ */}
                        <div style={{
                            fontSize: '12px',
                            color: 'rgba(255, 255, 255, 0.8)',
                            display: 'flex',
                            justifyContent: 'space-between'
                        }}>
                            <span>{item.total_signals} Agents</span>
                            <span>â†‘{item.bullish_percent.toFixed(0)}% â†“{item.bearish_percent.toFixed(0)}%</span>
                        </div>

                        {/* æ‚¬æµ®æ—¶æ˜¾ç¤ºè¯¦æƒ…æŒ‰é’® */}
                        <motion.div
                            initial={{ opacity: 0 }}
                            whileHover={{ opacity: 1 }}
                            style={{
                                position: 'absolute',
                                bottom: '12px',
                                right: '12px',
                                background: 'rgba(255, 255, 255, 0.9)',
                                color: '#0A0E27',
                                padding: '4px 12px',
                                borderRadius: '6px',
                                fontSize: '12px',
                                fontWeight: 600
                            }}
                        >
                            æŸ¥çœ‹è¯¦æƒ… â†’
                        </motion.div>
                    </motion.div>
                ))}
            </div>

            {/* å›¾ä¾‹ */}
            <div style={{
                marginTop: '32px',
                padding: '16px',
                background: '#F9FAFB',
                borderRadius: '12px',
                display: 'flex',
                justifyContent: 'center',
                gap: '32px',
                flexWrap: 'wrap'
            }}>
                {[
                    { label: 'çœ‹å¤š', color: 'rgba(16, 185, 129, 0.8)' },
                    { label: 'çœ‹ç©º', color: 'rgba(239, 68, 68, 0.8)' },
                    { label: 'ä¸­æ€§', color: 'rgba(156, 163, 175, 0.8)' },
                    { label: 'åˆ†æ­§', color: 'rgba(245, 158, 11, 0.8)' }
                ].map(item => (
                    <div key={item.label} style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    }}>
                        <div style={{
                            width: '16px',
                            height: '16px',
                            borderRadius: '4px',
                            background: item.color
                        }} />
                        <span style={{
                            fontSize: '14px',
                            color: '#6B7280',
                            fontWeight: 500
                        }}>
                            {item.label}
                        </span>
                    </div>
                ))}
            </div>
        </div>
    );
};
\`\`\`

---

## æ€»ç»“ï¼šå¼€å‘æ¸…å•

### æ•°æ®åº“è¡¨ï¼ˆå…±è®¡ 20+ å¼ ï¼‰

1. âœ… \`user_value_propositions\` - ç”¨æˆ·ä»·å€¼è®¤çŸ¥
2. âœ… \`user_premise_understanding\` - å‰æç†è§£åº¦
3. âœ… \`competitor_comparison\` - ç«å“å¯¹æ¯”
4. âœ… \`subscription_plans\` - è®¢é˜…è®¡åˆ’
5. âœ… \`user_subscriptions\` - ç”¨æˆ·è®¢é˜…
6. âœ… \`payment_records\` - æ”¯ä»˜è®°å½•
7. âœ… \`api_key_providers\` - API æä¾›å•†
8. âœ… \`user_api_keys\` - ç”¨æˆ· API Keys
9. âœ… \`agent_instances\` - Agent å®ä¾‹
10. âœ… \`agent_configurations\` - Agent é…ç½®
11. âœ… \`agent_cron_jobs\` - Cron ä»»åŠ¡
12. âœ… \`agent_heartbeats\` - å¿ƒè·³è®°å½•
13. âœ… \`agent_tool_calls\` - å·¥å…·è°ƒç”¨è®°å½•
14. âœ… \`public_signals\` - å…¬åŸŸä¿¡å·
15. âœ… \`signal_subscriptions\` - ä¿¡å·è®¢é˜…
16. âœ… \`signal_aggregations\` - ä¿¡å·èšåˆ
17. âœ… \`agent_credibility\` - Agent ä¿¡èª‰
18. âœ… \`signal_verifications\` - ä¿¡å·éªŒè¯

### API Endpointsï¼ˆå…±è®¡ 30+ï¼‰

- âœ… ä»·å€¼ä¸»å¼  \`/api/v1/onboarding/value-proposition\`
- âœ… å‰ææ•™è‚² \`/api/v1/education/premises\`
- âœ… ç«å“å¯¹æ¯” \`/api/v1/positioning/competitors\`
- âœ… è®¢é˜…ç®¡ç† \`/api/v1/subscriptions/*\`
- âœ… API Key ç®¡ç† \`/api/v1/api-keys/*\`
- âœ… Agent ç®¡ç† \`/api/v1/agents/*\`
- âœ… ä¿¡å·å‘å¸ƒ \`/api/v1/signals/publish\`
- âœ… ä¿¡å·æµ \`/api/v1/signals/feed\`
- âœ… å…±è¯†ä¿¡å· \`/api/v1/signals/consensus/:asset\`
- âœ… çƒ­åŠ›å›¾ \`/api/v1/signals/heatmap\`
- âœ… åˆ†æ­§åˆ†æ \`/api/v1/signals/divergence/:asset\`
- âœ… å‡†ç¡®ç‡ \`/api/v1/signals/accuracy/:agent_id\`

### å‰ç«¯ç»„ä»¶ï¼ˆå…±è®¡ 10+ï¼‰

- âœ… \`ValuePropositionHero\` - æ ¸å¿ƒå‘½é¢˜å±•ç¤º
- âœ… \`PremiseEducationModal\` - å‰ææ•™è‚²å¼¹çª—
- âœ… \`CompetitorComparisonTable\` - ç«å“å¯¹æ¯”è¡¨
- âœ… \`PricingTable\` - å®šä»·è¡¨æ ¼
- âœ… \`APIKeySetup\` - API Key é…ç½®æµç¨‹
- âœ… \`ConsensusHeatmap\` - å…±è¯†çƒ­åŠ›å›¾

### åç«¯æœåŠ¡

- âœ… \`AgentOrchestrator\` - Agent è°ƒåº¦å™¨
- âœ… \`SignalAggregator\` - ä¿¡å·èšåˆå™¨
- âœ… \`AntiGamingSystem\` - é˜²åšå¼ˆç³»ç»Ÿ
- âœ… \`generateSOULTemplate()\` - SOUL.md ç”Ÿæˆå™¨

### OpenClaw é…ç½®

- âœ… SOUL.md æ¨¡æ¿ï¼ˆå®Œæ•´ï¼‰
- âœ… ç¯å¢ƒå˜é‡é…ç½®
- âœ… Cron ä»»åŠ¡é…ç½®
- âœ… å¿ƒè·³æœºåˆ¶é…ç½®

### å…³é”®ç®—æ³•

- âœ… ä¿¡å·åŠ æƒèšåˆç®—æ³•
- âœ… å¤šç»´åˆ†æ­§åˆ†æç®—æ³•
- âœ… Agent ä¿¡èª‰è¯„åˆ†ç®—æ³•
- âœ… å¼‚å¸¸è¡Œä¸ºæ£€æµ‹ç®—æ³•
- âœ… ä¿¡å·éªŒè¯ç®—æ³•

---

**æ–‡æ¡£å®Œæˆæ—¶é—´**: 2026-02-08 01:28 UTC
**æ€»å­—æ•°**: ~35,000 å­—
**ä»£ç è¡Œæ•°**: ~3,500 è¡Œ
**è¦†ç›–ç« èŠ‚**: 1-6 (å®Œæ•´)# FinVerse å¼€å‘æç¤ºè¯ Part Bï¼ˆç¬¬ 7-12 ç« ï¼‰

> æç»†é¢—ç²’åº¦å¯æ‰§è¡Œå¼€å‘æŒ‡å— Â· Agent B
> ç”Ÿæˆæ—¶é—´ï¼š2026-02-08

---

## ä¸ƒã€ç§åŸŸâ€”â€”å¼‚æ­¥åˆ†æå°ç»„ï¼ˆæ–¹æ¡ˆ Cï¼‰

### 7.1 æ•°æ®åº“è®¾è®¡

#### 7.1.1 groups è¡¨ï¼ˆåˆ†æå°ç»„ï¼‰

\`\`\`sql
CREATE TABLE groups (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  description TEXT,
  creator_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  
  -- å°ç»„ç±»å‹å’Œè®¾ç½®
  group_type VARCHAR(50) DEFAULT 'public', -- public, private, invite_only
  max_members INTEGER DEFAULT 20,
  
  -- æ ‡ç­¾åŒ¹é…
  tags JSONB DEFAULT '[]'::jsonb, -- ["crypto", "short-term", "technical"]
  focus_assets TEXT[] DEFAULT '{}', -- ["BTC/USD", "ETH/USD"]
  trading_style VARCHAR(50), -- day-trading, swing, long-term
  analysis_preference VARCHAR(50), -- technical, fundamental, on-chain
  
  -- çŠ¶æ€
  is_active BOOLEAN DEFAULT true,
  member_count INTEGER DEFAULT 1,
  
  -- ç»Ÿè®¡
  total_posts INTEGER DEFAULT 0,
  total_consensus_reports INTEGER DEFAULT 0,
  
  -- æ—¶é—´
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- ç´¢å¼•
  CONSTRAINT valid_group_type CHECK (group_type IN ('public', 'private', 'invite_only'))
);

CREATE INDEX idx_groups_creator ON groups(creator_id);
CREATE INDEX idx_groups_tags ON groups USING GIN(tags);
CREATE INDEX idx_groups_active ON groups(is_active) WHERE is_active = true;
CREATE INDEX idx_groups_focus_assets ON groups USING GIN(focus_assets);
\`\`\`

#### 7.1.2 group_members è¡¨ï¼ˆæˆå‘˜å…³ç³»ï¼‰

\`\`\`sql
CREATE TABLE group_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  group_id UUID NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  
  -- æˆå‘˜è§’è‰²
  role VARCHAR(20) DEFAULT 'member', -- creator, admin, member
  
  -- æƒé™
  can_post BOOLEAN DEFAULT true,
  can_vote BOOLEAN DEFAULT true,
  can_comment BOOLEAN DEFAULT true,
  
  -- é€šçŸ¥è®¾ç½®
  notification_settings JSONB DEFAULT '{
    "new_post": true,
    "new_comment": true,
    "consensus_report": true,
    "mention": true
  }'::jsonb,
  
  -- ç»Ÿè®¡
  total_posts INTEGER DEFAULT 0,
  total_votes INTEGER DEFAULT 0,
  total_comments INTEGER DEFAULT 0,
  
  -- æ—¶é—´
  joined_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  last_active_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  UNIQUE(group_id, user_id)
);

CREATE INDEX idx_group_members_group ON group_members(group_id);
CREATE INDEX idx_group_members_user ON group_members(user_id);
CREATE INDEX idx_group_members_role ON group_members(role);
\`\`\`

#### 7.1.3 group_posts è¡¨ï¼ˆåˆ†æå‘å¸ƒï¼‰

\`\`\`sql
CREATE TABLE group_posts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  group_id UUID NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
  author_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  
  -- å†…å®¹ï¼ˆç»“æ„åŒ–ï¼‰
  title VARCHAR(200) NOT NULL,
  content TEXT NOT NULL, -- Markdownæ ¼å¼çš„è¯¦ç»†åˆ†æ
  
  -- åˆ†æç»“æ„åŒ–æ•°æ®
  analysis_data JSONB NOT NULL DEFAULT '{}'::jsonb,
  /* 
  {
    "asset": "BTC/USD",
    "signal": "bearish",
    "confidence": 0.72,
    "timeframe": "48h",
    "dimensions": {
      "on_chain": {"signal": "bearish", "confidence": 0.78, "summary": "..."},
      "macro": {"signal": "bearish", "confidence": 0.72, "summary": "..."},
      "technical": {"signal": "neutral", "confidence": 0.50, "summary": "..."},
      "sentiment": {"signal": "bearish", "confidence": 0.65, "summary": "..."}
    },
    "key_levels": {
      "support": [67200, 64800],
      "resistance": [69800]
    },
    "reasoning": "è¯¦ç»†æ¨ç†è¿‡ç¨‹...",
    "chart_config": {
      "layers": ["price", "volume", "ai_annotations"],
      "timeframe": "1d",
      "range": "30d"
    }
  }
  */
  
  -- AIè¾…åŠ©æ ‡è®°
  ai_assisted BOOLEAN DEFAULT false, -- æ˜¯å¦ç”±AIè¾…åŠ©ç”Ÿæˆ
  ai_model VARCHAR(50), -- ä½¿ç”¨çš„AIæ¨¡å‹
  original_prompt TEXT, -- ç”¨æˆ·çš„åŸå§‹è¾“å…¥
  
  -- é™„ä»¶
  attachments JSONB DEFAULT '[]'::jsonb, -- [{type: "image", url: "..."}, {type: "chart", config: {...}}]
  
  -- äº’åŠ¨ç»Ÿè®¡
  upvotes INTEGER DEFAULT 0,
  downvotes INTEGER DEFAULT 0,
  comment_count INTEGER DEFAULT 0,
  view_count INTEGER DEFAULT 0,
  
  -- çŠ¶æ€
  is_published BOOLEAN DEFAULT true,
  is_pinned BOOLEAN DEFAULT false,
  
  -- å¤ç›˜æ•°æ®ï¼ˆäº‹åå¡«å……ï¼‰
  outcome_data JSONB DEFAULT NULL,
  /*
  {
    "actual_result": "bearish", // å®é™…èµ°åŠ¿
    "prediction_accuracy": 0.85, // å‡†ç¡®ç‡
    "evaluated_at": "2026-02-15T00:00:00Z",
    "price_change_pct": -5.2,
    "hit_support": true,
    "hit_resistance": false
  }
  */
  
  -- æ—¶é—´
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  evaluated_at TIMESTAMP WITH TIME ZONE DEFAULT NULL -- å¤ç›˜æ—¶é—´ï¼ˆé€šå¸¸æ˜¯å‘å¸ƒå7å¤©ï¼‰
);

CREATE INDEX idx_group_posts_group ON group_posts(group_id);
CREATE INDEX idx_group_posts_author ON group_posts(author_id);
CREATE INDEX idx_group_posts_created ON group_posts(created_at DESC);
CREATE INDEX idx_group_posts_asset ON group_posts((analysis_data->>'asset'));
CREATE INDEX idx_group_posts_signal ON group_posts((analysis_data->>'signal'));
CREATE INDEX idx_group_posts_pinned ON group_posts(is_pinned) WHERE is_pinned = true;
\`\`\`

#### 7.1.4 post_votes è¡¨ï¼ˆæŠ•ç¥¨ï¼‰

\`\`\`sql
CREATE TABLE post_votes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_id UUID NOT NULL REFERENCES group_posts(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  
  -- æŠ•ç¥¨ç±»å‹
  vote_type VARCHAR(20) NOT NULL, -- upvote, downvote, agree, disagree, insightful
  
  -- æŠ•ç¥¨é™„åŠ æ•°æ®
  vote_data JSONB DEFAULT '{}'::jsonb,
  /*
  {
    "own_signal": "bullish", // ç”¨æˆ·è‡ªå·±çš„è§‚ç‚¹ï¼ˆå¯é€‰ï¼‰
    "confidence": 0.6,
    "reasoning": "æˆ‘è®¤ä¸º..."
  }
  */
  
  -- æ—¶é—´
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  UNIQUE(post_id, user_id),
  CONSTRAINT valid_vote_type CHECK (vote_type IN ('upvote', 'downvote', 'agree', 'disagree', 'insightful'))
);

CREATE INDEX idx_post_votes_post ON post_votes(post_id);
CREATE INDEX idx_post_votes_user ON post_votes(user_id);
CREATE INDEX idx_post_votes_type ON post_votes(vote_type);
\`\`\`

#### 7.1.5 post_comments è¡¨ï¼ˆè¯„è®ºï¼‰

\`\`\`sql
CREATE TABLE post_comments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_id UUID NOT NULL REFERENCES group_posts(id) ON DELETE CASCADE,
  author_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  parent_comment_id UUID REFERENCES post_comments(id) ON DELETE CASCADE, -- æ”¯æŒåµŒå¥—å›å¤
  
  -- å†…å®¹
  content TEXT NOT NULL,
  
  -- AIè¾…åŠ©
  ai_assisted BOOLEAN DEFAULT false,
  original_prompt TEXT,
  
  -- ç»“æ„åŒ–æ•°æ®ï¼ˆå¯é€‰ï¼‰
  comment_data JSONB DEFAULT '{}'::jsonb,
  /*
  {
    "highlights_dimension": "on_chain", // è¯„è®ºé‡ç‚¹å…³æ³¨çš„ç»´åº¦
    "adds_data_point": {
      "metric": "exchange_inflow",
      "value": 15000,
      "source": "Glassnode"
    }
  }
  */
  
  -- äº’åŠ¨
  upvotes INTEGER DEFAULT 0,
  
  -- æ—¶é—´
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_post_comments_post ON post_comments(post_id);
CREATE INDEX idx_post_comments_author ON post_comments(author_id);
CREATE INDEX idx_post_comments_parent ON post_comments(parent_comment_id);
CREATE INDEX idx_post_comments_created ON post_comments(created_at DESC);
\`\`\`

#### 7.1.6 consensus_reports è¡¨ï¼ˆå…±è¯†æŠ¥å‘Šï¼‰

\`\`\`sql
CREATE TABLE consensus_reports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  group_id UUID NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
  
  -- æŠ¥å‘ŠèŒƒå›´
  report_type VARCHAR(50) NOT NULL, -- daily, weekly, topic_based
  asset VARCHAR(20), -- é’ˆå¯¹ç‰¹å®šèµ„äº§çš„æŠ¥å‘Šï¼ˆå¯é€‰ï¼‰
  topic VARCHAR(200), -- é’ˆå¯¹ç‰¹å®šä¸»é¢˜çš„æŠ¥å‘Šï¼ˆå¯é€‰ï¼‰
  
  -- æ—¶é—´èŒƒå›´
  period_start TIMESTAMP WITH TIME ZONE NOT NULL,
  period_end TIMESTAMP WITH TIME ZONE NOT NULL,
  
  -- ç»Ÿè®¡æ•°æ®
  stats JSONB NOT NULL,
  /*
  {
    "total_posts": 12,
    "total_participants": 8,
    "total_votes": 45,
    
    "signal_distribution": {
      "bullish": 3,
      "bearish": 7,
      "neutral": 2
    },
    
    "avg_confidence": 0.68,
    
    "dimension_breakdown": {
      "on_chain": {"bullish": 2, "bearish": 5, "neutral": 1},
      "technical": {"bullish": 4, "bearish": 3, "neutral": 1},
      "macro": {"bullish": 1, "bearish": 8, "neutral": 0}
    },
    
    "most_cited_data": [
      {"metric": "exchange_inflow", "times_mentioned": 8},
      {"metric": "RSI", "times_mentioned": 6}
    ],
    
    "divergence_points": [
      {
        "dimension": "technical",
        "description": "æŠ€æœ¯é¢å‡ºç°æ˜æ˜¾åˆ†æ­§",
        "bullish_ratio": 0.5,
        "bearish_ratio": 0.38
      }
    ],
    
    "key_levels_consensus": {
      "support": [67200, 64800],
      "resistance": [69800]
    }
  }
  */
  
  -- AIç”Ÿæˆçš„æ‘˜è¦
  summary TEXT NOT NULL, -- Markdownæ ¼å¼çš„å…±è¯†æŠ¥å‘Š
  
  -- ä¸å…¬åŸŸå¯¹æ¯”
  public_comparison JSONB DEFAULT NULL,
  /*
  {
    "public_signal": "bearish",
    "public_confidence": 0.72,
    "group_signal": "bearish",
    "group_confidence": 0.68,
    "agreement_level": "high",
    "unique_insights": ["å°ç»„æ›´å…³æ³¨é“¾ä¸Šæ•°æ®", "å…¬åŸŸæ›´é‡è§†å®è§‚å› ç´ "]
  }
  */
  
  -- AIæ¨¡å‹
  ai_model VARCHAR(50),
  
  -- æ—¶é—´
  generated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_consensus_reports_group ON consensus_reports(group_id);
CREATE INDEX idx_consensus_reports_asset ON consensus_reports(asset);
CREATE INDEX idx_consensus_reports_type ON consensus_reports(report_type);
CREATE INDEX idx_consensus_reports_period ON consensus_reports(period_start, period_end);
\`\`\`

---

### 7.2 API è®¾è®¡

#### 7.2.1 åˆ›å»ºå°ç»„

**POST /api/groups**

è¯·æ±‚ä½“ï¼š
\`\`\`json
{
  "name": "åŠ å¯†çŸ­çº¿æŠ€æœ¯æ´¾",
  "description": "ä¸“æ³¨äºåŠ å¯†è´§å¸çŸ­çº¿äº¤æ˜“ï¼ŒæŠ€æœ¯åˆ†æä¸ºä¸»",
  "group_type": "public",
  "max_members": 15,
  "tags": ["crypto", "short-term", "technical"],
  "focus_assets": ["BTC/USD", "ETH/USD", "SOL/USD"],
  "trading_style": "short-term",
  "analysis_preference": "technical"
}
\`\`\`

å“åº”ï¼š
\`\`\`json
{
  "success": true,
  "data": {
    "id": "uuid-here",
    "name": "åŠ å¯†çŸ­çº¿æŠ€æœ¯æ´¾",
    "creator_id": "user-uuid",
    "member_count": 1,
    "created_at": "2026-02-08T01:00:00Z",
    "invite_link": "https://finverse.app/groups/invite/abc123"
  }
}
\`\`\`

é€»è¾‘å®ç°ï¼š
\`\`\`javascript
async function createGroup(userId, groupData) {
  // 1. éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒé™åˆ›å»ºå°ç»„ï¼ˆProç‰ˆç”¨æˆ·ï¼‰
  const user = await db.users.findById(userId);
  if (user.plan !== 'pro' && user.plan !== 'team') {
    throw new Error('éœ€è¦Proç‰ˆè®¢é˜…æ‰èƒ½åˆ›å»ºå°ç»„');
  }
  
  // 2. æ£€æŸ¥ç”¨æˆ·åˆ›å»ºçš„å°ç»„æ•°é‡é™åˆ¶
  const userGroupsCount = await db.groups.count({ creator_id: userId, is_active: true });
  const maxGroups = user.plan === 'pro' ? 3 : 10;
  if (userGroupsCount >= maxGroups) {
    throw new Error(\`æœ€å¤šåˆ›å»º\${maxGroups}ä¸ªå°ç»„\`);
  }
  
  // 3. åˆ›å»ºå°ç»„
  const group = await db.groups.create({
    ...groupData,
    creator_id: userId,
    member_count: 1
  });
  
  // 4. è‡ªåŠ¨æ·»åŠ åˆ›å»ºè€…ä¸ºæˆå‘˜ï¼ˆè§’è‰²ï¼šcreatorï¼‰
  await db.group_members.create({
    group_id: group.id,
    user_id: userId,
    role: 'creator'
  });
  
  // 5. ç”Ÿæˆé‚€è¯·é“¾æ¥
  const inviteToken = generateInviteToken(group.id);
  
  // 6. é€šçŸ¥ç”¨æˆ·çš„Agent
  await notifyAgent(userId, {
    type: 'group_created',
    group_id: group.id,
    group_name: group.name
  });
  
  return { group, invite_link: \`https://finverse.app/groups/invite/\${inviteToken}\` };
}
\`\`\`

#### 7.2.2 AIè¾…åŠ©å‘å¸ƒåˆ†æ

**POST /api/groups/:groupId/posts/ai-assist**

è¯·æ±‚ä½“ï¼š
\`\`\`json
{
  "user_prompt": "æˆ‘è§‰å¾—BTCè¦è·Œï¼Œäº¤æ˜“æ‰€æµå…¥å¤ªå¤šäº†",
  "include_chart": true,
  "auto_publish": false
}
\`\`\`

AIå¤„ç†æµç¨‹ï¼š
\`\`\`javascript
async function aiAssistedPost(groupId, userId, userPrompt, options) {
  // 1. è·å–ç”¨æˆ·çš„AIé…ç½®
  const user = await db.users.findById(userId);
  const aiConfig = user.ai_config; // { provider: 'openai', api_key: '...', model: 'gpt-4' }
  
  // 2. æ„å»ºAI Prompt
  const systemPrompt = \`ä½ æ˜¯é‡‘èåˆ†æåŠ©æ‰‹ï¼Œå¸®åŠ©ç”¨æˆ·å°†æƒ³æ³•è½¬åŒ–ä¸ºç»“æ„åŒ–åˆ†æã€‚

ç”¨æˆ·æ‰€åœ¨å°ç»„ï¼š\${groupId}
å°ç»„æ ‡ç­¾ï¼š\${group.tags.join(', ')}
ç”¨æˆ·åå¥½ï¼š\${user.analysis_preference}

ä»»åŠ¡ï¼š
1. è¯†åˆ«ç”¨æˆ·æåˆ°çš„èµ„äº§ï¼ˆå¦‚BTC/USDï¼‰
2. è¯†åˆ«ç”¨æˆ·çš„è§‚ç‚¹ï¼ˆçœ‹å¤š/çœ‹ç©º/ä¸­æ€§ï¼‰
3. æå–å…³é”®æ•°æ®ç‚¹ï¼ˆå¦‚"äº¤æ˜“æ‰€æµå…¥"ï¼‰
4. è¡¥å……ç›¸å…³æ•°æ®æ”¯æ’‘ç”¨æˆ·è§‚ç‚¹
5. ç”Ÿæˆç»“æ„åŒ–åˆ†æJSON + Markdownè¯¦ç»†åˆ†æ

è¾“å‡ºæ ¼å¼ï¼š
{
  "analysis_data": {
    "asset": "BTC/USD",
    "signal": "bearish",
    "confidence": 0.75,
    "dimensions": {...},
    "key_levels": {...},
    "reasoning": "..."
  },
  "title": "BTCçŸ­æœŸçœ‹ç©ºï¼šäº¤æ˜“æ‰€æµå…¥æ˜¾è‘—å¢åŠ ",
  "content": "## åˆ†ææ‘˜è¦\\n\\n...",
  "chart_config": {...}
}
\`;

  // 3. è°ƒç”¨ç”¨æˆ·çš„AI
  const aiResponse = await callUserAI(aiConfig, systemPrompt, userPrompt);
  
  // 4. è§£æAIå“åº”
  const { analysis_data, title, content, chart_config } = JSON.parse(aiResponse);
  
  // 5. è·å–å®æ—¶æ•°æ®è¡¥å……
  if (analysis_data.dimensions.on_chain) {
    const onChainData = await fetchOnChainData(analysis_data.asset);
    analysis_data.dimensions.on_chain.data = onChainData;
  }
  
  // 6. ç”Ÿæˆå›¾è¡¨é…ç½®
  if (options.include_chart) {
    chart_config.data = await fetchChartData(analysis_data.asset, chart_config.timeframe);
  }
  
  // 7. åˆ›å»ºè‰ç¨¿æˆ–ç›´æ¥å‘å¸ƒ
  if (options.auto_publish) {
    const post = await db.group_posts.create({
      group_id: groupId,
      author_id: userId,
      title,
      content,
      analysis_data,
      ai_assisted: true,
      ai_model: aiConfig.model,
      original_prompt: userPrompt,
      attachments: options.include_chart ? [{ type: 'chart', config: chart_config }] : []
    });
    
    // 8. é€šçŸ¥å°ç»„æˆå‘˜
    await notifyGroupMembers(groupId, {
      type: 'new_post',
      post_id: post.id,
      author_id: userId,
      title
    });
    
    return post;
  } else {
    return { title, content, analysis_data, chart_config };
  }
}
\`\`\`

AI Promptæ¨¡æ¿ï¼ˆè¯¦ç»†ç‰ˆï¼‰ï¼š
\`\`\`
ä½ æ˜¯FinVerseå¹³å°çš„é‡‘èåˆ†æåŠ©æ‰‹ã€‚ç”¨æˆ·ä¼šç”¨è‡ªç„¶è¯­è¨€æè¿°ä»–ä»¬çš„äº¤æ˜“æƒ³æ³•ï¼Œä½ çš„ä»»åŠ¡æ˜¯å°†å…¶è½¬åŒ–ä¸ºç»“æ„åŒ–çš„åˆ†ææŠ¥å‘Šã€‚

## ç”¨æˆ·ä¿¡æ¯
- å§“åï¼š{user.name}
- åˆ†æåå¥½ï¼š{user.analysis_preference}
- äº¤æ˜“é£æ ¼ï¼š{user.trading_style}
- æ‰€åœ¨å°ç»„ï¼š{group.name}
- å°ç»„å…³æ³¨èµ„äº§ï¼š{group.focus_assets}

## ç”¨æˆ·è¾“å…¥
"{user_prompt}"

## ä½ çš„ä»»åŠ¡

### 1. ä¿¡æ¯æå–
- è¯†åˆ«èµ„äº§ï¼ˆå¦‚BTC/USD, ETH/USD, AAPLç­‰ï¼‰
- è¯†åˆ«æ–¹å‘ï¼ˆçœ‹å¤šbullish/çœ‹ç©ºbearish/ä¸­æ€§neutralï¼‰
- è¯†åˆ«æ—¶é—´æ¡†æ¶ï¼ˆçŸ­æœŸ/ä¸­æœŸ/é•¿æœŸï¼Œå…·ä½“å°æ—¶æ•°ï¼‰
- æå–å…³é”®æ•°æ®ç‚¹ï¼ˆå¦‚"äº¤æ˜“æ‰€æµå…¥"ã€"RSIè¶…ä¹°"ç­‰ï¼‰

### 2. æ•°æ®è¡¥å……
æ ¹æ®ç”¨æˆ·æåˆ°çš„æ•°æ®ç‚¹ï¼Œè¡¥å……æœ€æ–°çš„å®é™…æ•°æ®ï¼š
- é“¾ä¸Šæ•°æ®ï¼šäº¤æ˜“æ‰€æµå…¥æµå‡ºã€å¤§æˆ·æŒä»“ã€MVRVç­‰
- æŠ€æœ¯æŒ‡æ ‡ï¼šRSIã€MACDã€å¸ƒæ—å¸¦ã€å…³é”®æ”¯æ’‘é˜»åŠ›ä½
- å®è§‚å› ç´ ï¼šç›¸å…³ç»æµæ•°æ®ã€æ”¿ç­–äº‹ä»¶
- æƒ…ç»ªæŒ‡æ ‡ï¼šææƒ§è´ªå©ªæŒ‡æ•°ã€ç¤¾äº¤åª’ä½“æƒ…ç»ª

ä½ å¯ä»¥è°ƒç”¨ä»¥ä¸‹å·¥å…·è·å–æ•°æ®ï¼š
- fetchOnChainMetrics(asset)
- fetchTechnicalIndicators(asset, timeframe)
- fetchMacroEvents(timeframe)
- fetchSentimentData(asset)

### 3. ç½®ä¿¡åº¦è¯„ä¼°
æ ¹æ®ä»¥ä¸‹å› ç´ ç»¼åˆè¯„ä¼°ç½®ä¿¡åº¦ï¼ˆ0-1ï¼‰ï¼š
- æ•°æ®æ”¯æ’‘å¼ºåº¦ï¼šå¤šç»´åº¦æ•°æ®æ˜¯å¦ä¸€è‡´ï¼Ÿ
- ç”¨æˆ·è¡¨è¿°çš„ç¡®å®šæ€§ï¼šç”¨æˆ·æ˜¯"è§‰å¾—"è¿˜æ˜¯"ç¡®å®š"ï¼Ÿ
- å†å²å‡†ç¡®ç‡ï¼šç±»ä¼¼æƒ…å†µä¸‹çš„å†å²æˆåŠŸç‡ï¼Ÿ
- å¸‚åœºç¯å¢ƒï¼šå½“å‰æ³¢åŠ¨ç‡ã€æµåŠ¨æ€§æ˜¯å¦é€‚åˆè¯¥åˆ¤æ–­ï¼Ÿ

### 4. å¤šç»´åº¦åˆ†æ
å°†åˆ†ææ‹†è§£ä¸º4ä¸ªç»´åº¦ï¼Œæ¯ä¸ªç»´åº¦å•ç‹¬è¯„ä¼°ï¼š

**on_chainï¼ˆé“¾ä¸Šæ•°æ®ï¼‰**ï¼š
- signal: bullish/bearish/neutral
- confidence: 0-1
- summary: ä¸€å¥è¯æ¦‚æ‹¬ï¼ˆ30å­—ä»¥å†…ï¼‰
- key_metrics: [{name: "äº¤æ˜“æ‰€å‡€æµå…¥", value: 12400, unit: "BTC", change_24h: "+35%"}]

**technicalï¼ˆæŠ€æœ¯åˆ†æï¼‰**ï¼š
- signal, confidence, summary
- key_levels: {support: [67200, 64800], resistance: [69800]}
- indicators: [{name: "RSI", value: 72, interpretation: "è¶…ä¹°"}]

**macroï¼ˆå®è§‚å› ç´ ï¼‰**ï¼š
- signal, confidence, summary
- events: [{event: "CPIæ•°æ®å…¬å¸ƒ", date: "2026-02-10", expected_impact: "bearish"}]

**sentimentï¼ˆå¸‚åœºæƒ…ç»ªï¼‰**ï¼š
- signal, confidence, summary
- metrics: [{name: "ææƒ§è´ªå©ªæŒ‡æ•°", value: 38, level: "ææƒ§"}]

### 5. ç”Ÿæˆå†…å®¹

**æ ‡é¢˜**ï¼ˆ20å­—ä»¥å†…ï¼‰ï¼š
- æ ¼å¼ï¼š{èµ„äº§} + {æ–¹å‘} + {æ ¸å¿ƒç†ç”±}
- ä¾‹ï¼š"BTCçŸ­æœŸçœ‹ç©ºï¼šäº¤æ˜“æ‰€æµå…¥æ¿€å¢"

**è¯¦ç»†åˆ†æ**ï¼ˆMarkdownæ ¼å¼ï¼‰ï¼š
\`\`\`markdown
## åˆ†ææ‘˜è¦
{ä¸€æ®µè¯æ€»ç»“ï¼Œ100å­—å·¦å³}

## æ ¸å¿ƒè§‚ç‚¹
- **æ–¹å‘**ï¼š{çœ‹å¤š/çœ‹ç©º/ä¸­æ€§}
- **ç½®ä¿¡åº¦**ï¼š{ç™¾åˆ†æ¯”}
- **æ—¶é—´æ¡†æ¶**ï¼š{å…·ä½“æ—¶é—´}
- **å…³é”®ä½**ï¼šæ”¯æ’‘ {ä»·æ ¼} / é˜»åŠ› {ä»·æ ¼}

## åˆ†ç»´åº¦åˆ†æ

### ğŸ“Š é“¾ä¸Šæ•°æ®ï¼ˆ{ä¿¡å·} {ç½®ä¿¡åº¦}ï¼‰
{è¯¦ç»†åˆ†æï¼Œ150-200å­—}

**å…³é”®æŒ‡æ ‡**ï¼š
- äº¤æ˜“æ‰€å‡€æµå…¥ï¼š+12,400 BTC (+35%)
- å¤§æˆ·åœ°å€ï¼ˆ>1000 BTCï¼‰ï¼šå‡æŒ 3.2%
- MVRVæ¯”ç‡ï¼š2.1ï¼ˆæ¥è¿‘å†å²é«˜ä½ï¼‰

### ğŸ“ˆ æŠ€æœ¯é¢ï¼ˆ{ä¿¡å·} {ç½®ä¿¡åº¦}ï¼‰
{è¯¦ç»†åˆ†æ}

**æŠ€æœ¯æŒ‡æ ‡**ï¼š
- RSI(14)ï¼š72ï¼ˆè¶…ä¹°åŒºåŸŸï¼‰
- MACDï¼šæ­»å‰ä¿¡å·
- å¸ƒæ—å¸¦ï¼šä»·æ ¼è§¦åŠä¸Šè½¨

**å…³é”®ä½**ï¼š
- æ”¯æ’‘ï¼š\$67,200 / \$64,800
- é˜»åŠ›ï¼š\$69,800

### ğŸŒ å®è§‚ç¯å¢ƒï¼ˆ{ä¿¡å·} {ç½®ä¿¡åº¦}ï¼‰
{è¯¦ç»†åˆ†æ}

**å…³æ³¨äº‹ä»¶**ï¼š
- 2æœˆ10æ—¥ CPIæ•°æ®å…¬å¸ƒï¼ˆé¢„æœŸè¶…æ ‡æ¦‚ç‡60%ï¼‰
- ç¾è”å‚¨3æœˆä¼šè®®é¢„æœŸç»´æŒåˆ©ç‡

### ğŸ’­ å¸‚åœºæƒ…ç»ªï¼ˆ{ä¿¡å·} {ç½®ä¿¡åº¦}ï¼‰
{è¯¦ç»†åˆ†æ}

**æƒ…ç»ªæŒ‡æ ‡**ï¼š
- ææƒ§è´ªå©ªæŒ‡æ•°ï¼š38ï¼ˆææƒ§ï¼‰
- Twitteræƒ…ç»ªåˆ†æ•°ï¼š-0.25ï¼ˆåç©ºï¼‰

## æ“ä½œå»ºè®®
{æ ¹æ®åˆ†æç»™å‡ºå…·ä½“å»ºè®®ï¼Œä½†é™„åŠ å…è´£å£°æ˜}

**å…è´£å£°æ˜**ï¼šä»¥ä¸Šåˆ†æä»…ä¸ºä¸ªäººè§‚ç‚¹ï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚
\`\`\`

### 6. è¾“å‡ºJSON

æœ€ç»ˆè¾“å‡ºä¸¥æ ¼çš„JSONæ ¼å¼ï¼š
\`\`\`json
{
  "analysis_data": {
    "asset": "BTC/USD",
    "signal": "bearish",
    "confidence": 0.72,
    "timeframe": "48h",
    "dimensions": {
      "on_chain": {
        "signal": "bearish",
        "confidence": 0.78,
        "summary": "äº¤æ˜“æ‰€å‡€æµå…¥+12,400 BTCï¼ŒæŠ›å‹å¢åŠ ",
        "key_metrics": [...]
      },
      "technical": {...},
      "macro": {...},
      "sentiment": {...}
    },
    "key_levels": {
      "support": [67200, 64800],
      "resistance": [69800]
    },
    "reasoning": "ç»¼åˆé“¾ä¸Šæ•°æ®æ˜¾ç¤ºäº¤æ˜“æ‰€æµå…¥æ¿€å¢ï¼Œç»“åˆæŠ€æœ¯é¢RSIè¶…ä¹°å’Œå®è§‚CPIé£é™©ï¼ŒçŸ­æœŸçœ‹ç©ºæ¦‚ç‡è¾ƒé«˜ã€‚ä½†æŠ€æœ¯æ”¯æ’‘ä½å°šåœ¨ï¼Œéœ€è§‚å¯Ÿ\$67,200èƒ½å¦å®ˆä½ã€‚"
  },
  "title": "BTCçŸ­æœŸçœ‹ç©ºï¼šäº¤æ˜“æ‰€æµå…¥æ¿€å¢+æŠ€æœ¯è¶…ä¹°",
  "content": "{ä¸Šé¢çš„Markdownå†…å®¹}",
  "chart_config": {
    "type": "candlestick",
    "asset": "BTC/USD",
    "timeframe": "1h",
    "range": "7d",
    "layers": ["price", "volume", "support_resistance", "ai_annotations"],
    "annotations": [
      {
        "type": "horizontal_line",
        "price": 67200,
        "label": "å…³é”®æ”¯æ’‘",
        "color": "#22c55e"
      },
      {
        "type": "vertical_zone",
        "start_time": "2026-02-10T14:30:00Z",
        "end_time": "2026-02-10T15:00:00Z",
        "label": "CPIå…¬å¸ƒ",
        "color": "rgba(239, 68, 68, 0.1)"
      }
    ]
  }
}
\`\`\`

## æ³¨æ„äº‹é¡¹
- å¦‚æœç”¨æˆ·è¾“å…¥ä¿¡æ¯ä¸è¶³ï¼Œä¸è¦ç¼–é€ æ•°æ®ï¼Œè€Œæ˜¯æ ‡æ³¨ä¸º"å¾…è¡¥å……"
- ç½®ä¿¡åº¦è¯„ä¼°è¦ä¿å®ˆï¼Œä¸ç¡®å®šçš„äº‹æƒ…ä¸è¦ç»™é«˜ç½®ä¿¡åº¦
- æŠ€æœ¯æŒ‡æ ‡çš„è§£è¯»è¦å‡†ç¡®ï¼ˆå¦‚RSI>70æ˜¯è¶…ä¹°è€Œéè¶…å–ï¼‰
- æ—¶é—´æ¡†æ¶è¦å…·ä½“ï¼ˆä¸è¦åªè¯´"çŸ­æœŸ"ï¼Œè¦ç»™å‡ºå°æ—¶æ•°æˆ–å¤©æ•°ï¼‰
- æ‰€æœ‰æ•°æ®æ¥æºè¦å¯è¿½æº¯ï¼ˆæœ€å¥½èƒ½é“¾æ¥åˆ°å…·ä½“APIæˆ–å›¾è¡¨ï¼‰
\`\`\`

#### 7.2.3 æŠ•ç¥¨API

**POST /api/posts/:postId/vote**

è¯·æ±‚ä½“ï¼š
\`\`\`json
{
  "vote_type": "agree",
  "own_signal": "bearish",
  "confidence": 0.65,
  "reasoning": "æˆ‘ä¹Ÿçœ‹åˆ°äº†äº¤æ˜“æ‰€æµå…¥æ•°æ®ï¼ŒåŒæ„åˆ†æ"
}
\`\`\`

é€»è¾‘ï¼š
\`\`\`javascript
async function voteOnPost(postId, userId, voteData) {
  // 1. æ£€æŸ¥æ˜¯å¦å·²æŠ•ç¥¨ï¼ˆæ›´æ–°è€Œéé‡å¤ï¼‰
  const existing = await db.post_votes.findOne({ post_id: postId, user_id: userId });
  
  if (existing) {
    // æ›´æ–°æŠ•ç¥¨
    await db.post_votes.update(existing.id, {
      vote_type: voteData.vote_type,
      vote_data: {
        own_signal: voteData.own_signal,
        confidence: voteData.confidence,
        reasoning: voteData.reasoning
      },
      updated_at: new Date()
    });
  } else {
    // æ–°æŠ•ç¥¨
    await db.post_votes.create({
      post_id: postId,
      user_id: userId,
      vote_type: voteData.vote_type,
      vote_data: {
        own_signal: voteData.own_signal,
        confidence: voteData.confidence,
        reasoning: voteData.reasoning
      }
    });
    
    // æ›´æ–°å¸–å­ç»Ÿè®¡
    if (voteData.vote_type === 'upvote' || voteData.vote_type === 'agree') {
      await db.group_posts.increment(postId, 'upvotes', 1);
    } else if (voteData.vote_type === 'downvote' || voteData.vote_type === 'disagree') {
      await db.group_posts.increment(postId, 'downvotes', 1);
    }
  }
  
  // 2. æ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘å…±è¯†æŠ¥å‘Šç”Ÿæˆ
  const post = await db.group_posts.findById(postId);
  const voteCount = await db.post_votes.count({ post_id: postId });
  const group = await db.groups.findById(post.group_id);
  
  // å¦‚æœè¶…è¿‡50%æˆå‘˜æŠ•ç¥¨ï¼Œè§¦å‘å…±è¯†æŠ¥å‘Šç”Ÿæˆ
  if (voteCount >= group.member_count * 0.5) {
    await scheduleConsensusReport(post.group_id, post.id);
  }
  
  return { success: true };
}
\`\`\`

#### 7.2.4 ç”Ÿæˆå…±è¯†æŠ¥å‘Š

**POST /api/groups/:groupId/consensus-reports/generate**

è¯·æ±‚ä½“ï¼š
\`\`\`json
{
  "report_type": "daily",
  "period_start": "2026-02-07T00:00:00Z",
  "period_end": "2026-02-08T00:00:00Z",
  "asset": "BTC/USD"
}
\`\`\`

AIç”Ÿæˆé€»è¾‘ï¼š
\`\`\`javascript
async function generateConsensusReport(groupId, params) {
  // 1. è·å–æ—¶é—´èŒƒå›´å†…çš„æ‰€æœ‰åˆ†æå’ŒæŠ•ç¥¨
  const posts = await db.group_posts.find({
    group_id: groupId,
    created_at: { \$gte: params.period_start, \$lte: params.period_end },
    ...(params.asset && { 'analysis_data.asset': params.asset })
  });
  
  const postIds = posts.map(p => p.id);
  const votes = await db.post_votes.find({ post_id: { \$in: postIds } });
  const comments = await db.post_comments.find({ post_id: { \$in: postIds } });
  
  // 2. ç»Ÿè®¡åˆ†æ
  const stats = {
    total_posts: posts.length,
    total_participants: new Set(posts.map(p => p.author_id)).size,
    total_votes: votes.length,
    
    signal_distribution: {
      bullish: posts.filter(p => p.analysis_data.signal === 'bullish').length,
      bearish: posts.filter(p => p.analysis_data.signal === 'bearish').length,
      neutral: posts.filter(p => p.analysis_data.signal === 'neutral').length
    },
    
    avg_confidence: posts.reduce((sum, p) => sum + p.analysis_data.confidence, 0) / posts.length,
    
    dimension_breakdown: {},
    most_cited_data: [],
    divergence_points: [],
    key_levels_consensus: {}
  };
  
  // 3. ç»´åº¦åˆ†è§£ç»Ÿè®¡
  ['on_chain', 'technical', 'macro', 'sentiment'].forEach(dim => {
    stats.dimension_breakdown[dim] = {
      bullish: posts.filter(p => p.analysis_data.dimensions[dim]?.signal === 'bullish').length,
      bearish: posts.filter(p => p.analysis_data.dimensions[dim]?.signal === 'bearish').length,
      neutral: posts.filter(p => p.analysis_data.dimensions[dim]?.signal === 'neutral').length
    };
  });
  
  // 4. å…³é”®ä½å…±è¯†ï¼ˆå–ä¼—æ•°ï¼‰
  const allSupport = posts.flatMap(p => p.analysis_data.key_levels?.support || []);
  const allResistance = posts.flatMap(p => p.analysis_data.key_levels?.resistance || []);
  stats.key_levels_consensus = {
    support: findMostCommonLevels(allSupport, 2),
    resistance: findMostCommonLevels(allResistance, 2)
  };
  
  // 5. æ‰¾å‡ºåˆ†æ­§ç‚¹
  Object.entries(stats.dimension_breakdown).forEach(([dim, signals]) => {
    const total = signals.bullish + signals.bearish + signals.neutral;
    const bullishRatio = signals.bullish / total;
    const bearishRatio = signals.bearish / total;
    
    // å¦‚æœçœ‹å¤šçœ‹ç©ºæ¯”ä¾‹éƒ½åœ¨30-70%ä¹‹é—´ï¼Œè¯´æ˜æœ‰åˆ†æ­§
    if (bullishRatio >= 0.3 && bullishRatio <= 0.7 && bearishRatio >= 0.3 && bearishRatio <= 0.7) {
      stats.divergence_points.push({
        dimension: dim,
        description: \`\${dim}ç»´åº¦å‡ºç°æ˜æ˜¾åˆ†æ­§\`,
        bullish_ratio: bullishRatio,
        bearish_ratio: bearishRatio
      });
    }
  });
  
  // 6. è·å–å…¬åŸŸæ•°æ®å¯¹æ¯”
  const publicSignals = await fetchPublicSignals(params.asset, params.period_start, params.period_end);
  const publicStats = aggregatePublicSignals(publicSignals);
  
  stats.public_comparison = {
    public_signal: publicStats.signal,
    public_confidence: publicStats.confidence,
    group_signal: stats.signal_distribution.bearish > stats.signal_distribution.bullish ? 'bearish' : 'bullish',
    group_confidence: stats.avg_confidence,
    agreement_level: calculateAgreementLevel(publicStats, stats),
    unique_insights: findUniqueInsights(posts, publicSignals)
  };
  
  // 7. è°ƒç”¨AIç”Ÿæˆæ‘˜è¦
  const aiPrompt = buildConsensusReportPrompt(posts, votes, comments, stats);
  const aiSummary = await callGroupCreatorAI(groupId, aiPrompt);
  
  // 8. ä¿å­˜æŠ¥å‘Š
  const report = await db.consensus_reports.create({
    group_id: groupId,
    report_type: params.report_type,
    asset: params.asset,
    period_start: params.period_start,
    period_end: params.period_end,
    stats,
    summary: aiSummary,
    public_comparison: stats.public_comparison,
    ai_model: 'gpt-4',
    generated_at: new Date()
  });
  
  // 9. é€šçŸ¥å°ç»„æˆå‘˜
  await notifyGroupMembers(groupId, {
    type: 'consensus_report_ready',
    report_id: report.id,
    asset: params.asset
  });
  
  return report;
}

function buildConsensusReportPrompt(posts, votes, comments, stats) {
  return \`ä½ æ˜¯FinVerseå¹³å°çš„å…±è¯†æŠ¥å‘Šç”ŸæˆåŠ©æ‰‹ã€‚æ ¹æ®å°ç»„æˆå‘˜çš„åˆ†æå’Œè®¨è®ºï¼Œç”Ÿæˆä¸€ä»½å…±è¯†æŠ¥å‘Šã€‚

## æ—¶é—´èŒƒå›´
\${stats.period_start} è‡³ \${stats.period_end}

## æ•°æ®æ±‡æ€»
- æ€»åˆ†ææ•°ï¼š\${stats.total_posts}
- å‚ä¸äººæ•°ï¼š\${stats.total_participants}
- æ€»æŠ•ç¥¨æ•°ï¼š\${stats.total_votes}

## è§‚ç‚¹åˆ†å¸ƒ
- çœ‹å¤šï¼š\${stats.signal_distribution.bullish} (\${(stats.signal_distribution.bullish/stats.total_posts*100).toFixed(0)}%)
- çœ‹ç©ºï¼š\${stats.signal_distribution.bearish} (\${(stats.signal_distribution.bearish/stats.total_posts*100).toFixed(0)}%)
- ä¸­æ€§ï¼š\${stats.signal_distribution.neutral} (\${(stats.signal_distribution.neutral/stats.total_posts*100).toFixed(0)}%)
- å¹³å‡ç½®ä¿¡åº¦ï¼š\${(stats.avg_confidence*100).toFixed(0)}%

## ç»´åº¦åˆ†è§£
\${Object.entries(stats.dimension_breakdown).map(([dim, signals]) => \`
### \${dim}
- çœ‹å¤šï¼š\${signals.bullish}
- çœ‹ç©ºï¼š\${signals.bearish}
- ä¸­æ€§ï¼š\${signals.neutral}
\`).join('\\n')}

## åˆ†æ­§ç‚¹
\${stats.divergence_points.map(d => \`- \${d.description}ï¼šçœ‹å¤š\${(d.bullish_ratio*100).toFixed(0)}% vs çœ‹ç©º\${(d.bearish_ratio*100).toFixed(0)}%\`).join('\\n')}

## å…³é”®ä½å…±è¯†
- æ”¯æ’‘ï¼š\${stats.key_levels_consensus.support.join(', ')}
- é˜»åŠ›ï¼š\${stats.key_levels_consensus.resistance.join(', ')}

## å…¬åŸŸå¯¹æ¯”
- å…¬åŸŸè§‚ç‚¹ï¼š\${stats.public_comparison.public_signal}ï¼ˆç½®ä¿¡åº¦\${(stats.public_comparison.public_confidence*100).toFixed(0)}%ï¼‰
- å°ç»„è§‚ç‚¹ï¼š\${stats.public_comparison.group_signal}ï¼ˆç½®ä¿¡åº¦\${(stats.public_comparison.group_confidence*100).toFixed(0)}%ï¼‰
- ä¸€è‡´æ€§ï¼š\${stats.public_comparison.agreement_level}

## åŸå§‹åˆ†ææ‘˜è¦
\${posts.map(p => \`
**\${p.title}** (ä½œè€…ï¼š\${p.author_id})
- è§‚ç‚¹ï¼š\${p.analysis_data.signal}ï¼ˆç½®ä¿¡åº¦\${(p.analysis_data.confidence*100).toFixed(0)}%ï¼‰
- æ ¸å¿ƒç†ç”±ï¼š\${p.analysis_data.reasoning.substring(0, 100)}...
\`).join('\\n')}

---

è¯·ç”Ÿæˆä¸€ä»½Markdownæ ¼å¼çš„å…±è¯†æŠ¥å‘Šï¼ŒåŒ…å«ï¼š

# \${params.asset} å…±è¯†æŠ¥å‘Šï¼ˆ\${formatDate(params.period_start)} - \${formatDate(params.period_end)}ï¼‰

## ğŸ“Š è§‚ç‚¹æ¦‚è§ˆ
{ä¸€å¥è¯æ€»ç»“å°ç»„å…±è¯†ï¼Œå¦‚"å°ç»„72%æˆå‘˜çœ‹ç©ºBTCçŸ­æœŸèµ°åŠ¿"}

## ğŸ¯ æ ¸å¿ƒå…±è¯†
- **æ–¹å‘**ï¼š{å¤šæ•°è§‚ç‚¹}
- **ç½®ä¿¡åº¦**ï¼š{å¹³å‡ç½®ä¿¡åº¦}
- **å…³é”®ä½**ï¼šæ”¯æ’‘ {ä»·æ ¼} / é˜»åŠ› {ä»·æ ¼}
- **æ—¶é—´æ¡†æ¶**ï¼š{ç»¼åˆæ—¶é—´æ¡†æ¶}

## ğŸ” åˆ†ç»´åº¦åˆ†æ

### é“¾ä¸Šæ•°æ®ï¼ˆ{å…±è¯†/åˆ†æ­§}ï¼‰
{æ€»ç»“é“¾ä¸Šç»´åº¦çš„å…±è¯†æˆ–åˆ†æ­§ç‚¹ï¼Œ150å­—å·¦å³}

### æŠ€æœ¯é¢ï¼ˆ{å…±è¯†/åˆ†æ­§}ï¼‰
{æ€»ç»“æŠ€æœ¯é¢çš„å…±è¯†æˆ–åˆ†æ­§ç‚¹}

### å®è§‚ç¯å¢ƒï¼ˆ{å…±è¯†/åˆ†æ­§}ï¼‰
{æ€»ç»“å®è§‚ç»´åº¦çš„å…±è¯†æˆ–åˆ†æ­§ç‚¹}

### å¸‚åœºæƒ…ç»ªï¼ˆ{å…±è¯†/åˆ†æ­§}ï¼‰
{æ€»ç»“æƒ…ç»ªç»´åº¦çš„å…±è¯†æˆ–åˆ†æ­§ç‚¹}

## âš¡ ä¸»è¦åˆ†æ­§ç‚¹
{è¯¦ç»†è¯´æ˜å°ç»„å†…çš„ä¸»è¦åˆ†æ­§åœ¨å“ªé‡Œï¼Œä¸ºä»€ä¹ˆä¼šæœ‰åˆ†æ­§}

## ğŸŒ ä¸å…¬åŸŸå¯¹æ¯”
å°ç»„è§‚ç‚¹ä¸å…¬åŸŸAgentå…±è¯†çš„å¯¹æ¯”ï¼š
- **ä¸€è‡´æ€§**ï¼š{é«˜/ä¸­/ä½}
- **å°ç»„ç‹¬ç‰¹è§è§£**ï¼š{åˆ—å‡ºå°ç»„å…³æ³¨ä½†å…¬åŸŸå¿½è§†çš„ç‚¹}
- **å…¬åŸŸç‹¬ç‰¹è§è§£**ï¼š{åˆ—å‡ºå…¬åŸŸå…³æ³¨ä½†å°ç»„å¿½è§†çš„ç‚¹}

## ğŸ’¡ å…³é”®æ´å¯Ÿ
{3-5æ¡ä»è®¨è®ºä¸­æç‚¼çš„å…³é”®æ´å¯Ÿ}

## âš ï¸ é£é™©æç¤º
{åŸºäºåˆ†æ­§ç‚¹å’Œæ•°æ®ï¼Œåˆ—å‡ºéœ€è¦è­¦æƒ•çš„é£é™©}

---
*æœ¬æŠ¥å‘Šç”±AIè‡ªåŠ¨ç”Ÿæˆï¼Œæ±‡æ€»å°ç»„æˆå‘˜åˆ†æã€‚ä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚*
\`;
}
\`\`\`

---

### 7.3 å‰ç«¯ç»„ä»¶è®¾è®¡

#### 7.3.1 å°ç»„ä¸»é¡µï¼ˆGroupHomePage.tsxï¼‰

**å¸ƒå±€ç»“æ„**ï¼š
\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Header: å°ç»„åç§° + æˆå‘˜æ•° + åŠ å…¥/é€€å‡ºæŒ‰é’®          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Tabs: æœ€æ–°åˆ†æ | å…±è¯†æŠ¥å‘Š | æˆå‘˜ | è®¾ç½®           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ä¾§è¾¹æ      â”‚  â”‚   ä¸»å†…å®¹åŒº                â”‚   â”‚
â”‚  â”‚            â”‚  â”‚                          â”‚   â”‚
â”‚  â”‚  ç­›é€‰å™¨     â”‚  â”‚   [åˆ†æå¡ç‰‡åˆ—è¡¨]          â”‚   â”‚
â”‚  â”‚  - èµ„äº§     â”‚  â”‚                          â”‚   â”‚
â”‚  â”‚  - ä¿¡å·     â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  - æ—¶é—´     â”‚  â”‚   â”‚  AnalysisCard    â”‚  â”‚   â”‚
â”‚  â”‚            â”‚  â”‚   â”‚  AnalysisCard    â”‚  â”‚   â”‚
â”‚  â”‚  å¿«æ·æ“ä½œ   â”‚  â”‚   â”‚  AnalysisCard    â”‚  â”‚   â”‚
â”‚  â”‚  [å‘å¸ƒåˆ†æ] â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚            â”‚  â”‚                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

**ç»„ä»¶ä»£ç æ¡†æ¶**ï¼š
\`\`\`tsx
// GroupHomePage.tsx
import React, { useState, useEffect } from 'react';
import { useParams } from 'react-router-dom';
import { GroupHeader } from './GroupHeader';
import { GroupSidebar } from './GroupSidebar';
import { AnalysisCard } from './AnalysisCard';
import { ConsensusReport } from './ConsensusReport';
import { api } from '@/lib/api';

export function GroupHomePage() {
  const { groupId } = useParams<{ groupId: string }>();
  const [group, setGroup] = useState(null);
  const [posts, setPosts] = useState([]);
  const [activeTab, setActiveTab] = useState('latest');
  const [filters, setFilters] = useState({
    asset: null,
    signal: null,
    timeRange: '7d'
  });

  useEffect(() => {
    loadGroup();
    loadPosts();
  }, [groupId, filters]);

  async function loadGroup() {
    const data = await api.get(\`/groups/\${groupId}\`);
    setGroup(data);
  }

  async function loadPosts() {
    const data = await api.get(\`/groups/\${groupId}/posts\`, { params: filters });
    setPosts(data);
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <GroupHeader group={group} />

      {/* Tabs */}
      <div className="border-b border-gray-200 bg-white">
        <div className="max-w-7xl mx-auto px-4">
          <nav className="flex space-x-8">
            {['æœ€æ–°åˆ†æ', 'å…±è¯†æŠ¥å‘Š', 'æˆå‘˜', 'è®¾ç½®'].map(tab => (
              <button
                key={tab}
                onClick={() => setActiveTab(tab)}
                className={\`py-4 px-1 border-b-2 font-medium text-sm \${
                  activeTab === tab
                    ? 'border-blue-500 text-blue-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700'
                }\`}
              >
                {tab}
              </button>
            ))}
          </nav>
        </div>
      </div>

      {/* Main Content */}
      <div className="max-w-7xl mx-auto px-4 py-6">
        <div className="grid grid-cols-12 gap-6">
          {/* Sidebar */}
          <div className="col-span-3">
            <GroupSidebar
              filters={filters}
              onFilterChange={setFilters}
              onNewPost={() => {/* æ‰“å¼€å‘å¸ƒå¯¹è¯æ¡† */}}
            />
          </div>

          {/* Main Area */}
          <div className="col-span-9">
            {activeTab === 'æœ€æ–°åˆ†æ' && (
              <div className="space-y-4">
                {posts.map(post => (
                  <AnalysisCard key={post.id} post={post} />
                ))}
              </div>
            )}

            {activeTab === 'å…±è¯†æŠ¥å‘Š' && (
              <ConsensusReportList groupId={groupId} />
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
\`\`\`

#### 7.3.2 åˆ†æå¡ç‰‡ï¼ˆAnalysisCard.tsxï¼‰

**UIè§„æ ¼**ï¼š
- å®½åº¦ï¼š100%ï¼ˆå“åº”å¼ï¼‰
- èƒŒæ™¯ï¼š#FFFFFF
- è¾¹æ¡†ï¼š1px solid #E5E7EBï¼Œåœ†è§’8px
- å†…è¾¹è·ï¼š24px
- æ‚¬åœæ•ˆæœï¼šé˜´å½± 0 4px 6px rgba(0, 0, 0, 0.1)
- åŠ¨ç”»ï¼šhoveræ—¶ä¸Šç§»2pxï¼Œè¿‡æ¸¡0.2s

**å¸ƒå±€**ï¼š
\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‘¤ ä½œè€…å  |  ğŸ“… 2å°æ—¶å‰  |  ğŸ·ï¸ BTC/USD          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ## æ ‡é¢˜ï¼ˆå­—å·18pxï¼Œå­—é‡600ï¼Œé¢œè‰²#111827ï¼‰          â”‚
â”‚                                                  â”‚
â”‚  [ä¿¡å·æŒ‡ç¤ºå™¨]  çœ‹ç©º â¬‡ï¸  ç½®ä¿¡åº¦ 72%                 â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”          â”‚
â”‚  é“¾ä¸Š â¬‡ï¸ 78%  |  æŠ€æœ¯ â†’ 50%  |  å®è§‚ â¬‡ï¸ 72%  ...  â”‚
â”‚                                                  â”‚
â”‚  ã€åˆ†ææ‘˜è¦ï¼Œ2-3è¡Œï¼Œé¢œè‰²#4B5563ã€‘                   â”‚
â”‚                                                  â”‚
â”‚  [å›¾è¡¨é¢„è§ˆç¼©ç•¥å›¾ï¼Œå¦‚æœæœ‰]                          â”‚
â”‚                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ‘ 12  ğŸ‘ 2  ğŸ’¬ 5  ğŸ‘ï¸ 89  |  [æŸ¥çœ‹è¯¦æƒ…]  [æŠ•ç¥¨]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

**ç»„ä»¶ä»£ç **ï¼š
\`\`\`tsx
// AnalysisCard.tsx
import React from 'react';
import { TrendingDown, TrendingUp, Minus } from 'lucide-react';

interface AnalysisCardProps {
  post: {
    id: string;
    title: string;
    author: { name: string; avatar: string };
    created_at: string;
    analysis_data: {
      asset: string;
      signal: 'bullish' | 'bearish' | 'neutral';
      confidence: number;
      dimensions: Record<string, { signal: string; confidence: number }>;
      reasoning: string;
    };
    upvotes: number;
    downvotes: number;
    comment_count: number;
    view_count: number;
    attachments: any[];
  };
}

export function AnalysisCard({ post }: AnalysisCardProps) {
  const { analysis_data: data } = post;

  const signalConfig = {
    bullish: { icon: TrendingUp, color: '#22c55e', label: 'çœ‹å¤š', emoji: 'â¬†ï¸' },
    bearish: { icon: TrendingDown, color: '#ef4444', label: 'çœ‹ç©º', emoji: 'â¬‡ï¸' },
    neutral: { icon: Minus, color: '#6b7280', label: 'ä¸­æ€§', emoji: 'â†’' }
  };

  const config = signalConfig[data.signal];
  const SignalIcon = config.icon;

  return (
    <div className="bg-white rounded-lg border border-gray-200 p-6 hover:shadow-lg hover:-translate-y-0.5 transition-all duration-200 cursor-pointer">
      {/* Header */}
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center space-x-3">
          <img src={post.author.avatar} className="w-8 h-8 rounded-full" />
          <span className="font-medium text-sm text-gray-900">{post.author.name}</span>
          <span className="text-gray-400 text-sm">Â·</span>
          <span className="text-gray-500 text-sm">{formatTimeAgo(post.created_at)}</span>
        </div>
        <span className="px-3 py-1 bg-blue-50 text-blue-700 rounded-full text-sm font-medium">
          {data.asset}
        </span>
      </div>

      {/* Title */}
      <h3 className="text-lg font-semibold text-gray-900 mb-3">
        {post.title}
      </h3>

      {/* Signal Indicator */}
      <div className="mb-4">
        <div className="flex items-center space-x-4 mb-2">
          <div className="flex items-center space-x-2">
            <SignalIcon className="w-5 h-5" style={{ color: config.color }} />
            <span className="font-semibold" style={{ color: config.color }}>
              {config.label} {config.emoji}
            </span>
          </div>
          <div className="text-gray-600">
            ç½®ä¿¡åº¦ <span className="font-semibold">{(data.confidence * 100).toFixed(0)}%</span>
          </div>
        </div>

        {/* Dimension Breakdown */}
        <div className="flex items-center space-x-4 text-sm">
          {Object.entries(data.dimensions).map(([dim, dimData]) => {
            const dimConfig = signalConfig[dimData.signal];
            return (
              <div key={dim} className="flex items-center space-x-1">
                <span className="text-gray-600">{dimNameMap[dim]}</span>
                <span style={{ color: dimConfig.color }}>
                  {dimConfig.emoji} {(dimData.confidence * 100).toFixed(0)}%
                </span>
              </div>
            );
          })}
        </div>
      </div>

      {/* Reasoning Preview */}
      <p className="text-gray-600 text-sm mb-4 line-clamp-2">
        {data.reasoning}
      </p>

      {/* Chart Preview */}
      {post.attachments.length > 0 && (
        <div className="mb-4 rounded-lg overflow-hidden">
          <img
            src={post.attachments[0].thumbnail_url}
            className="w-full h-32 object-cover"
          />
        </div>
      )}

      {/* Footer */}
      <div className="flex items-center justify-between pt-4 border-t border-gray-100">
        <div className="flex items-center space-x-4 text-sm text-gray-500">
          <span className="flex items-center space-x-1">
            <span>ğŸ‘</span>
            <span>{post.upvotes}</span>
          </span>
          <span className="flex items-center space-x-1">
            <span>ğŸ‘</span>
            <span>{post.downvotes}</span>
          </span>
          <span className="flex items-center space-x-1">
            <span>ğŸ’¬</span>
            <span>{post.comment_count}</span>
          </span>
          <span className="flex items-center space-x-1">
            <span>ğŸ‘ï¸</span>
            <span>{post.view_count}</span>
          </span>
        </div>

        <div className="flex items-center space-x-2">
          <button className="px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 rounded-lg transition">
            æŸ¥çœ‹è¯¦æƒ…
          </button>
          <button className="px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition">
            æŠ•ç¥¨
          </button>
        </div>
      </div>
    </div>
  );
}

const dimNameMap = {
  on_chain: 'é“¾ä¸Š',
  technical: 'æŠ€æœ¯',
  macro: 'å®è§‚',
  sentiment: 'æƒ…ç»ª'
};

function formatTimeAgo(timestamp: string): string {
  const now = Date.now();
  const then = new Date(timestamp).getTime();
  const diff = now - then;

  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);

  if (minutes < 60) return \`\${minutes}åˆ†é’Ÿå‰\`;
  if (hours < 24) return \`\${hours}å°æ—¶å‰\`;
  return \`\${days}å¤©å‰\`;
}
\`\`\`

#### 7.3.3 æŠ•ç¥¨ç»„ä»¶ï¼ˆVoteModal.tsxï¼‰

**UIè§„æ ¼**ï¼š
- æ¨¡æ€æ¡†å°ºå¯¸ï¼š600px x 500px
- èƒŒæ™¯ï¼š#FFFFFF
- åœ†è§’ï¼š12px
- é®ç½©ï¼šrgba(0, 0, 0, 0.5)
- åŠ¨ç”»ï¼šæ·¡å…¥ + ç¼©æ”¾ï¼Œ0.3s ease-out

**å¸ƒå±€**ï¼š
\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŠ•ç¥¨ï¼šBTCçŸ­æœŸçœ‹ç©ºåˆ†æ                 [X]         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  ä½ çš„è§‚ç‚¹ï¼š                                       â”‚
â”‚  â—‹ åŒæ„ï¼ˆçœ‹ç©ºï¼‰  â—‹ ä¸åŒæ„ï¼ˆçœ‹å¤šï¼‰  â—‹ ä¸­æ€§          â”‚
â”‚                                                  â”‚
â”‚  ä½ çš„ç½®ä¿¡åº¦ï¼š                                     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”¤  65%                       â”‚
â”‚                                                  â”‚
â”‚  ä½ çš„ç†ç”±ï¼ˆå¯é€‰ï¼ŒAIä¼šå¸®ä½ ç»“æ„åŒ–ï¼‰ï¼š                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æˆ‘ä¹Ÿçœ‹åˆ°äº†äº¤æ˜“æ‰€æµå…¥æ•°æ®...                  â”‚ â”‚
â”‚  â”‚                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                  â”‚
â”‚  [AIè¾…åŠ©æ‰©å±•]  [ç›´æ¥æäº¤]                         â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

**ç»„ä»¶ä»£ç **ï¼š
\`\`\`tsx
// VoteModal.tsx
import React, { useState } from 'react';
import { X } from 'lucide-react';
import { api } from '@/lib/api';

interface VoteModalProps {
  post: any;
  onClose: () => void;
  onVoteSuccess: () => void;
}

export function VoteModal({ post, onClose, onVoteSuccess }: VoteModalProps) {
  const [voteType, setVoteType] = useState<'agree' | 'disagree' | 'neutral'>('agree');
  const [confidence, setConfidence] = useState(65);
  const [reasoning, setReasoning] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleSubmit = async () => {
    setIsSubmitting(true);
    try {
      await api.post(\`/posts/\${post.id}/vote\`, {
        vote_type: voteType,
        own_signal: voteType === 'agree' ? post.analysis_data.signal : (voteType === 'disagree' ? oppositeSignal(post.analysis_data.signal) : 'neutral'),
        confidence: confidence / 100,
        reasoning
      });
      onVoteSuccess();
      onClose();
    } catch (error) {
      console.error('æŠ•ç¥¨å¤±è´¥:', error);
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      {/* Overlay */}
      <div className="absolute inset-0 bg-black bg-opacity-50" onClick={onClose} />

      {/* Modal */}
      <div className="relative bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 animate-modal-in">
        {/* Header */}
        <div className="flex items-center justify-between mb-6">
          <h2 className="text-xl font-semibold text-gray-900">
            æŠ•ç¥¨ï¼š{post.title}
          </h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* Vote Type */}
        <div className="mb-6">
          <label className="block text-sm font-medium text-gray-700 mb-3">
            ä½ çš„è§‚ç‚¹ï¼š
          </label>
          <div className="flex space-x-4">
            {[
              { value: 'agree', label: \`åŒæ„ï¼ˆ\${post.analysis_data.signal === 'bullish' ? 'çœ‹å¤š' : 'çœ‹ç©º'}ï¼‰\`, color: 'blue' },
              { value: 'disagree', label: \`ä¸åŒæ„ï¼ˆ\${post.analysis_data.signal === 'bullish' ? 'çœ‹ç©º' : 'çœ‹å¤š'}ï¼‰\`, color: 'red' },
              { value: 'neutral', label: 'ä¸­æ€§', color: 'gray' }
            ].map(option => (
              <button
                key={option.value}
                onClick={() => setVoteType(option.value as any)}
                className={\`flex-1 py-3 px-4 rounded-lg border-2 transition \${
                  voteType === option.value
                    ? \`border-\${option.color}-500 bg-\${option.color}-50 text-\${option.color}-700\`
                    : 'border-gray-200 text-gray-600 hover:border-gray-300'
                }\`}
              >
                {option.label}
              </button>
            ))}
          </div>
        </div>

        {/* Confidence Slider */}
        <div className="mb-6">
          <label className="block text-sm font-medium text-gray-700 mb-3">
            ä½ çš„ç½®ä¿¡åº¦ï¼š<span className="text-blue-600 font-semibold">{confidence}%</span>
          </label>
          <input
            type="range"
            min="0"
            max="100"
            value={confidence}
            onChange={(e) => setConfidence(Number(e.target.value))}
            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
          />
          <div className="flex justify-between text-xs text-gray-500 mt-1">
            <span>å®Œå…¨ä¸ç¡®å®š</span>
            <span>éå¸¸ç¡®å®š</span>
          </div>
        </div>

        {/* Reasoning */}
        <div className="mb-6">
          <label className="block text-sm font-medium text-gray-700 mb-3">
            ä½ çš„ç†ç”±ï¼ˆå¯é€‰ï¼‰ï¼š
          </label>
          <textarea
            value={reasoning}
            onChange={(e) => setReasoning(e.target.value)}
            placeholder="ç®€å•è¯´è¯´ä½ çš„æƒ³æ³•ï¼ŒAIä¼šå¸®ä½ ç»“æ„åŒ–..."
            className="w-full h-32 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
          />
        </div>

        {/* Actions */}
        <div className="flex justify-end space-x-3">
          <button
            onClick={onClose}
            className="px-6 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition"
          >
            å–æ¶ˆ
          </button>
          <button
            onClick={handleSubmit}
            disabled={isSubmitting}
            className="px-6 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition disabled:opacity-50"
          >
            {isSubmitting ? 'æäº¤ä¸­...' : 'æäº¤æŠ•ç¥¨'}
          </button>
        </div>
      </div>
    </div>
  );
}

function oppositeSignal(signal: string): string {
  return signal === 'bullish' ? 'bearish' : 'bullish';
}
\`\`\`

#### 7.3.4 å…±è¯†æŠ¥å‘Šé¡µï¼ˆConsensusReportPage.tsxï¼‰

**UIè§„æ ¼**ï¼š
- æ•´ä½“èƒŒæ™¯ï¼š#F9FAFB
- å¡ç‰‡èƒŒæ™¯ï¼š#FFFFFF
- æ ‡é¢˜å­—å·ï¼š28pxï¼Œå­—é‡700ï¼Œé¢œè‰²#111827
- å‰¯æ ‡é¢˜å­—å·ï¼š16pxï¼Œå­—é‡400ï¼Œé¢œè‰²#6B7280
- é—´è·ï¼šå„sectionä¹‹é—´32px

**å¸ƒå±€**ï¼š
\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BTC/USD å…±è¯†æŠ¥å‘Š                                 â”‚
â”‚  2026å¹´2æœˆ7æ—¥ - 2æœˆ8æ—¥                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  ğŸ“Š è§‚ç‚¹æ¦‚è§ˆ                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å°ç»„72%æˆå‘˜çœ‹ç©ºBTCçŸ­æœŸèµ°åŠ¿                 â”‚  â”‚
â”‚  â”‚                                           â”‚  â”‚
â”‚  â”‚  [é¥¼å›¾] çœ‹å¤š 12% | çœ‹ç©º 72% | ä¸­æ€§ 16%      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  ğŸ¯ æ ¸å¿ƒå…±è¯†                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æ–¹å‘ï¼šçœ‹ç©º â¬‡ï¸                              â”‚  â”‚
â”‚  â”‚  ç½®ä¿¡åº¦ï¼š68%                                â”‚  â”‚
â”‚  â”‚  å…³é”®ä½ï¼šæ”¯æ’‘ \$67,200 / é˜»åŠ› \$69,800       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  ğŸ” åˆ†ç»´åº¦åˆ†æ                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ é“¾ä¸Š     â”‚ æŠ€æœ¯     â”‚ å®è§‚     â”‚ æƒ…ç»ª    â”‚  â”‚
â”‚  â”‚ å…±è¯†â¬‡ï¸   â”‚ åˆ†æ­§     â”‚ å…±è¯†â¬‡ï¸   â”‚ å…±è¯†â¬‡ï¸  â”‚  â”‚
â”‚  â”‚ 78%      â”‚ 50%      â”‚ 72%      â”‚ 65%     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  [è¯¦ç»†åˆ†æå†…å®¹...]                                â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

---

### 7.4 å†å²å¤ç›˜è¿½è¸ªç®—æ³•

#### 7.4.1 å¤ç›˜è§¦å‘é€»è¾‘

\`\`\`javascript
// retrospective-tracker.js

/**
 * å®šæœŸæ£€æŸ¥éœ€è¦å¤ç›˜çš„åˆ†æï¼ˆCronä»»åŠ¡ï¼Œæ¯å¤©è¿è¡Œï¼‰
 */
async function checkAnalysesForRetrospective() {
  const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
  
  // æŸ¥æ‰¾7å¤©å‰å‘å¸ƒä¸”æœªå¤ç›˜çš„åˆ†æ
  const posts = await db.group_posts.find({
    created_at: { \$lte: sevenDaysAgo },
    evaluated_at: null,
    is_published: true
  });
  
  for (const post of posts) {
    await evaluatePostAccuracy(post);
  }
}

/**
 * è¯„ä¼°å•ä¸ªåˆ†æçš„å‡†ç¡®æ€§
 */
async function evaluatePostAccuracy(post) {
  const { analysis_data } = post;
  const asset = analysis_data.asset;
  const timeframe = parseTimeframe(analysis_data.timeframe); // "48h" -> 48å°æ—¶
  
  // 1. è·å–å®é™…ä»·æ ¼æ•°æ®
  const predictionTime = new Date(post.created_at);
  const evaluationTime = new Date(predictionTime.getTime() + timeframe * 60 * 60 * 1000);
  
  const priceAtPrediction = await fetchHistoricalPrice(asset, predictionTime);
  const priceAtEvaluation = await fetchHistoricalPrice(asset, evaluationTime);
  
  const priceChangePct = ((priceAtEvaluation - priceAtPrediction) / priceAtPrediction) * 100;
  
  // 2. åˆ¤æ–­å®é™…èµ°åŠ¿
  let actualSignal = 'neutral';
  if (priceChangePct > 2) actualSignal = 'bullish';
  else if (priceChangePct < -2) actualSignal = 'bearish';
  
  // 3. è®¡ç®—å‡†ç¡®ç‡
  const predictionCorrect = actualSignal === analysis_data.signal;
  const accuracy = predictionCorrect ? 
    (1 - Math.abs(priceChangePct - getPredictedChange(analysis_data)) / 100) : 
    0;
  
  // 4. æ£€æŸ¥å…³é”®ä½æ˜¯å¦è¢«è§¦åŠ
  const hitSupport = analysis_data.key_levels.support?.some(level => 
    checkIfPriceHitLevel(asset, predictionTime, evaluationTime, level, 'below')
  );
  
  const hitResistance = analysis_data.key_levels.resistance?.some(level => 
    checkIfPriceHitLevel(asset, predictionTime, evaluationTime, level, 'above')
  );
  
  // 5. ä¿å­˜å¤ç›˜ç»“æœ
  const outcomeData = {
    actual_signal: actualSignal,
    prediction_accuracy: accuracy,
    evaluated_at: new Date().toISOString(),
    price_change_pct: priceChangePct,
    price_at_prediction: priceAtPrediction,
    price_at_evaluation: priceAtEvaluation,
    hit_support: hitSupport,
    hit_resistance: hitResistance,
    timeframe_hours: timeframe
  };
  
  await db.group_posts.update(post.id, {
    outcome_data: outcomeData,
    evaluated_at: new Date()
  });
  
  // 6. æ›´æ–°ç”¨æˆ·çš„ä¸ªäººç»Ÿè®¡ï¼ˆåªç»™ç”¨æˆ·è‡ªå·±çœ‹ï¼‰
  await updateUserAccuracyStats(post.author_id, {
    asset,
    signal: analysis_data.signal,
    correct: predictionCorrect,
    confidence: analysis_data.confidence,
    accuracy
  });
  
  // 7. é€šçŸ¥ç”¨æˆ·ï¼ˆç§å¯†ï¼Œä¸åœ¨å°ç»„å…¬å¼€ï¼‰
  await notifyUser(post.author_id, {
    type: 'retrospective_ready',
    post_id: post.id,
    accuracy,
    prediction_correct: predictionCorrect
  });
}

/**
 * æ£€æŸ¥ä»·æ ¼æ˜¯å¦è§¦åŠæŸä¸ªå…³é”®ä½
 */
async function checkIfPriceHitLevel(asset, startTime, endTime, level, direction) {
  const ohlcData = await fetchOHLCData(asset, '1h', startTime, endTime);
  
  for (const candle of ohlcData) {
    if (direction === 'below' && candle.low <= level) return true;
    if (direction === 'above' && candle.high >= level) return true;
  }
  
  return false;
}

/**
 * æ›´æ–°ç”¨æˆ·ä¸ªäººå‡†ç¡®ç‡ç»Ÿè®¡
 */
async function updateUserAccuracyStats(userId, predictionData) {
  const stats = await db.user_stats.findOne({ user_id: userId }) || {
    user_id: userId,
    total_predictions: 0,
    correct_predictions: 0,
    by_asset: {},
    by_signal: {},
    by_dimension: {},
    confidence_calibration: []
  };
  
  // æ€»ä½“ç»Ÿè®¡
  stats.total_predictions += 1;
  if (predictionData.correct) stats.correct_predictions += 1;
  
  // æŒ‰èµ„äº§ç»Ÿè®¡
  if (!stats.by_asset[predictionData.asset]) {
    stats.by_asset[predictionData.asset] = { total: 0, correct: 0 };
  }
  stats.by_asset[predictionData.asset].total += 1;
  if (predictionData.correct) stats.by_asset[predictionData.asset].correct += 1;
  
  // æŒ‰ä¿¡å·ç±»å‹ç»Ÿè®¡
  if (!stats.by_signal[predictionData.signal]) {
    stats.by_signal[predictionData.signal] = { total: 0, correct: 0 };
  }
  stats.by_signal[predictionData.signal].total += 1;
  if (predictionData.correct) stats.by_signal[predictionData.signal].correct += 1;
  
  // ç½®ä¿¡åº¦æ ¡å‡†ï¼ˆæ£€æŸ¥ç”¨æˆ·çš„ç½®ä¿¡åº¦æ˜¯å¦å’Œå®é™…å‡†ç¡®ç‡åŒ¹é…ï¼‰
  stats.confidence_calibration.push({
    confidence: predictionData.confidence,
    accuracy: predictionData.accuracy,
    timestamp: new Date()
  });
  
  // åªä¿ç•™æœ€è¿‘100æ¡è®°å½•
  if (stats.confidence_calibration.length > 100) {
    stats.confidence_calibration = stats.confidence_calibration.slice(-100);
  }
  
  await db.user_stats.upsert({ user_id: userId }, stats);
}
\`\`\`

#### 7.4.2 ä¸ªäººå¤ç›˜ä»ªè¡¨æ¿ï¼ˆåªç»™ç”¨æˆ·è‡ªå·±çœ‹ï¼‰

**UIè§„æ ¼**ï¼š
- èƒŒæ™¯ï¼šæ¸å˜ from-blue-50 to-purple-50
- å¡ç‰‡ï¼šç™½è‰²ï¼Œåœ†è§’12pxï¼Œé˜´å½± 0 4px 20px rgba(0,0,0,0.08)

**å¸ƒå±€**ï¼š
\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¯ æˆ‘çš„åˆ†æå¤ç›˜                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  æ€»ä½“å‡†ç¡®ç‡                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                           â”‚  â”‚
â”‚  â”‚      68%                                  â”‚  â”‚
â”‚  â”‚   â”â”â”â”â”â”â”â”â”â”â”                            â”‚  â”‚
â”‚  â”‚   23/34 æ¬¡é¢„æµ‹æ­£ç¡®                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  æŒ‰èµ„äº§åˆ†ç±»                                       â”‚
â”‚  BTC/USD: 72% (18/25)  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘              â”‚
â”‚  ETH/USD: 60% (3/5)    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘              â”‚
â”‚  SOL/USD: 50% (2/4)    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘              â”‚
â”‚                                                  â”‚
â”‚  æŒ‰ä¿¡å·ç±»å‹                                       â”‚
â”‚  çœ‹å¤š: 65% (11/17)                               â”‚
â”‚  çœ‹ç©º: 71% (12/17)                               â”‚
â”‚                                                  â”‚
â”‚  ç½®ä¿¡åº¦æ ¡å‡†                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [æ•£ç‚¹å›¾]                                  â”‚  â”‚
â”‚  â”‚  Xè½´ï¼šä½ çš„ç½®ä¿¡åº¦                            â”‚  â”‚
â”‚  â”‚  Yè½´ï¼šå®é™…å‡†ç¡®ç‡                            â”‚  â”‚
â”‚  â”‚  ç†æƒ³æƒ…å†µï¼šæ•£ç‚¹åœ¨å¯¹è§’çº¿ä¸Š                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  ğŸ’¡ æ”¹è¿›å»ºè®®                                     â”‚
â”‚  Â· ä½ åœ¨BTCåˆ†æä¸Šè¡¨ç°æœ€å¥½ï¼Œå»ºè®®ç»§ç»­æ·±è€•            â”‚
â”‚  Â· ä½ çš„ç½®ä¿¡åº¦ç•¥é«˜äºå®é™…å‡†ç¡®ç‡ï¼Œå»ºè®®æ›´è°¨æ…         â”‚
â”‚  Â· çœ‹ç©ºåˆ¤æ–­æ¯”çœ‹å¤šåˆ¤æ–­æ›´å‡†ï¼Œå¯èƒ½ä½ æ›´æ“…é•¿é£é™©è¯†åˆ«   â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

**ç»„ä»¶ä»£ç **ï¼š
\`\`\`tsx
// MyRetrospectiveDashboard.tsx
import React, { useEffect, useState } from 'react';
import { ScatterChart, Scatter, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import { api } from '@/lib/api';

export function MyRetrospectiveDashboard() {
  const [stats, setStats] = useState(null);

  useEffect(() => {
    loadStats();
  }, []);

  async function loadStats() {
    const data = await api.get('/me/retrospective-stats');
    setStats(data);
  }

  if (!stats) return <div>åŠ è½½ä¸­...</div>;

  const overallAccuracy = (stats.correct_predictions / stats.total_predictions) * 100;

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-8">
      <div className="max-w-6xl mx-auto">
        <h1 className="text-3xl font-bold text-gray-900 mb-8">ğŸ¯ æˆ‘çš„åˆ†æå¤ç›˜</h1>

        {/* Overall Accuracy */}
        <div className="bg-white rounded-xl shadow-lg p-8 mb-6">
          <h2 className="text-xl font-semibold mb-4">æ€»ä½“å‡†ç¡®ç‡</h2>
          <div className="text-center">
            <div className="text-6xl font-bold text-blue-600 mb-2">
              {overallAccuracy.toFixed(0)}%
            </div>
            <div className="text-gray-600">
              {stats.correct_predictions} / {stats.total_predictions} æ¬¡é¢„æµ‹æ­£ç¡®
            </div>
            <div className="w-full bg-gray-200 rounded-full h-3 mt-4">
              <div
                className="bg-blue-600 h-3 rounded-full transition-all duration-1000"
                style={{ width: \`\${overallAccuracy}%\` }}
              />
            </div>
          </div>
        </div>

        {/* By Asset */}
        <div className="bg-white rounded-xl shadow-lg p-8 mb-6">
          <h2 className="text-xl font-semibold mb-4">æŒ‰èµ„äº§åˆ†ç±»</h2>
          {Object.entries(stats.by_asset).map(([asset, assetStats]) => {
            const accuracy = (assetStats.correct / assetStats.total) * 100;
            return (
              <div key={asset} className="mb-3">
                <div className="flex justify-between mb-1">
                  <span className="font-medium">{asset}</span>
                  <span className="text-gray-600">
                    {accuracy.toFixed(0)}% ({assetStats.correct}/{assetStats.total})
                  </span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2">
                  <div
                    className={\`h-2 rounded-full \${accuracy >= 70 ? 'bg-green-500' : accuracy >= 50 ? 'bg-yellow-500' : 'bg-red-500'}\`}
                    style={{ width: \`\${accuracy}%\` }}
                  />
                </div>
              </div>
            );
          })}
        </div>

        {/* By Signal Type */}
        <div className="bg-white rounded-xl shadow-lg p-8 mb-6">
          <h2 className="text-xl font-semibold mb-4">æŒ‰ä¿¡å·ç±»å‹</h2>
          <div className="grid grid-cols-2 gap-4">
            {Object.entries(stats.by_signal).map(([signal, signalStats]) => {
              const accuracy = (signalStats.correct / signalStats.total) * 100;
              return (
                <div key={signal} className="text-center p-4 bg-gray-50 rounded-lg">
                  <div className="text-2xl font-bold text-gray-900 mb-1">
                    {accuracy.toFixed(0)}%
                  </div>
                  <div className="text-gray-600">
                    {signal === 'bullish' ? 'çœ‹å¤š' : signal === 'bearish' ? 'çœ‹ç©º' : 'ä¸­æ€§'}
                  </div>
                  <div className="text-sm text-gray-500">
                    ({signalStats.correct}/{signalStats.total})
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        {/* Confidence Calibration */}
        <div className="bg-white rounded-xl shadow-lg p-8">
          <h2 className="text-xl font-semibold mb-4">ç½®ä¿¡åº¦æ ¡å‡†</h2>
          <ResponsiveContainer width="100%" height={300}>
            <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: 20 }}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis
                type="number"
                dataKey="confidence"
                name="ä½ çš„ç½®ä¿¡åº¦"
                unit="%"
                domain={[0, 100]}
              />
              <YAxis
                type="number"
                dataKey="accuracy"
                name="å®é™…å‡†ç¡®ç‡"
                unit="%"
                domain={[0, 100]}
              />
              <Tooltip cursor={{ strokeDasharray: '3 3' }} />
              <Scatter
                name="é¢„æµ‹è®°å½•"
                data={stats.confidence_calibration.map(c => ({
                  confidence: c.confidence * 100,
                  accuracy: c.accuracy * 100
                }))}
                fill="#3b82f6"
              />
              {/* Ideal line */}
              <Scatter
                name="ç†æƒ³çº¿"
                data={[{ confidence: 0, accuracy: 0 }, { confidence: 100, accuracy: 100 }]}
                fill="#22c55e"
                line
                lineType="fitting"
              />
            </ScatterChart>
          </ResponsiveContainer>
          <p className="text-sm text-gray-600 mt-4">
            ğŸ’¡ ç†æƒ³æƒ…å†µä¸‹ï¼Œæ•£ç‚¹åº”è¯¥åœ¨ç»¿è‰²å¯¹è§’çº¿ä¸Šï¼ˆä½ çš„ç½®ä¿¡åº¦ = å®é™…å‡†ç¡®ç‡ï¼‰
          </p>
        </div>

        {/* Insights */}
        <div className="bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl shadow-lg p-8 mt-6 text-white">
          <h2 className="text-xl font-semibold mb-4">ğŸ’¡ AI æ”¹è¿›å»ºè®®</h2>
          <ul className="space-y-2">
            {generateInsights(stats).map((insight, i) => (
              <li key={i} className="flex items-start">
                <span className="mr-2">Â·</span>
                <span>{insight}</span>
              </li>
            ))}
          </ul>
        </div>
      </div>
    </div>
  );
}

function generateInsights(stats) {
  const insights = [];
  
  // æœ€ä½³èµ„äº§
  const bestAsset = Object.entries(stats.by_asset).reduce((best, [asset, assetStats]) => {
    const accuracy = assetStats.correct / assetStats.total;
    return (!best || accuracy > best.accuracy) ? { asset, accuracy } : best;
  }, null);
  
  if (bestAsset) {
    insights.push(\`ä½ åœ¨ \${bestAsset.asset} åˆ†æä¸Šè¡¨ç°æœ€å¥½ï¼ˆ\${(bestAsset.accuracy*100).toFixed(0)}%ï¼‰ï¼Œå»ºè®®ç»§ç»­æ·±è€•\`);
  }
  
  // ç½®ä¿¡åº¦æ ¡å‡†
  const avgConfidence = stats.confidence_calibration.reduce((sum, c) => sum + c.confidence, 0) / stats.confidence_calibration.length;
  const avgAccuracy = stats.confidence_calibration.reduce((sum, c) => sum + c.accuracy, 0) / stats.confidence_calibration.length;
  
  if (avgConfidence > avgAccuracy + 0.1) {
    insights.push('ä½ çš„ç½®ä¿¡åº¦ç•¥é«˜äºå®é™…å‡†ç¡®ç‡ï¼Œå»ºè®®æ›´è°¨æ…åœ°è¯„ä¼°ç¡®å®šæ€§');
  } else if (avgAccuracy > avgConfidence + 0.1) {
    insights.push('ä½ çš„å®é™…è¡¨ç°æ¯”ä½ çš„ç½®ä¿¡åº¦æ›´å¥½ï¼Œå¯ä»¥æ›´è‡ªä¿¡ä¸€äº›');
  }
  
  // ä¿¡å·ç±»å‹å¯¹æ¯”
  const bullishAcc = stats.by_signal.bullish ? stats.by_signal.bullish.correct / stats.by_signal.bullish.total : 0;
  const bearishAcc = stats.by_signal.bearish ? stats.by_signal.bearish.correct / stats.by_signal.bearish.total : 0;
  
  if (bearishAcc > bullishAcc + 0.15) {
    insights.push('çœ‹ç©ºåˆ¤æ–­æ¯”çœ‹å¤šåˆ¤æ–­æ›´å‡†ï¼Œå¯èƒ½ä½ æ›´æ“…é•¿é£é™©è¯†åˆ«');
  } else if (bullishAcc > bearishAcc + 0.15) {
    insights.push('çœ‹å¤šåˆ¤æ–­æ¯”çœ‹ç©ºåˆ¤æ–­æ›´å‡†ï¼Œå¯èƒ½ä½ æ›´æ“…é•¿æ•æ‰æœºä¼š');
  }
  
  return insights;
}
\`\`\`

---

## å…«ã€èŠå¤©è½¯ä»¶åˆ†å·¥

### 8.1 Telegram Bot æ¶ˆæ¯æ¨¡æ¿

#### 8.1.1 æ¯æ—¥æ‘˜è¦æ¨é€

**æ¶ˆæ¯æ ¼å¼**ï¼š
\`\`\`
ğŸ“‹ **ä»Šæ—¥å¸‚åœºæ‘˜è¦** Â· 2026-02-08

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**BTC/USD** \$67,450 â¬‡ï¸ -2.3%
ğŸ”´ çœ‹ç©ºä¿¡å·ï¼ˆç½®ä¿¡åº¦ 72%ï¼‰
â”œ é“¾ä¸Šï¼šäº¤æ˜“æ‰€æµå…¥+12.4K BTC â¬‡ï¸
â”œ æŠ€æœ¯ï¼šRSI 72 è¶…ä¹° â¬‡ï¸  
â”œ å®è§‚ï¼šCPIé£é™© â¬‡ï¸
â”” æƒ…ç»ªï¼šææƒ§æŒ‡æ•° 38 â¬‡ï¸

å…³é”®ä½ï¼šæ”¯æ’‘ \$67,200 | é˜»åŠ› \$69,800

**ETH/USD** \$3,580 â†’ +0.5%
ğŸŸ¡ ä¸­æ€§ä¿¡å·ï¼ˆç½®ä¿¡åº¦ 55%ï¼‰
éœ‡è¡æ•´ç†ä¸­ï¼Œç­‰å¾…æ–¹å‘é€‰æ‹©

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸš¨ **ä»Šæ—¥å…³æ³¨**
Â· 21:30 ç¾å›½CPIæ•°æ®å…¬å¸ƒ
Â· BTCé“¾ä¸Šå¤§é¢è½¬è´¦å¢åŠ 
Â· å°ç»„"åŠ å¯†çŸ­çº¿æŠ€æœ¯æ´¾"æ–°åˆ†æ 3 æ¡

[æŸ¥çœ‹è¯¦ç»†çœ‹æ¿] [è°ƒæ•´åå¥½]
\`\`\`

**Telegram Botä»£ç **ï¼š
\`\`\`javascript
// telegram-bot.js
const TelegramBot = require('node-telegram-bot-api');
const { formatCurrency, formatPercentage } = require('./utils');

class FinVerseTelegramBot {
  constructor(token) {
    this.bot = new TelegramBot(token, { polling: true });
    this.setupHandlers();
  }

  setupHandlers() {
    // å¯åŠ¨å‘½ä»¤
    this.bot.onText(/\\/start/, this.handleStart.bind(this));
    
    // è‡ªç„¶è¯­è¨€æŸ¥è¯¢
    this.bot.on('message', this.handleMessage.bind(this));
  }

  async sendDailySummary(userId, summaryData) {
    const { assets, alerts, groups } = summaryData;

    let message = \`ğŸ“‹ **ä»Šæ—¥å¸‚åœºæ‘˜è¦** Â· \${formatDate(new Date())}\\n\\n\`;
    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n';

    // ä¸»è¦èµ„äº§
    for (const asset of assets) {
      message += this.formatAssetSummary(asset);
      message += '\\n\\n';
    }

    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n';

    // ä»Šæ—¥å…³æ³¨
    if (alerts.length > 0) {
      message += 'ğŸš¨ **ä»Šæ—¥å…³æ³¨**\\n';
      alerts.forEach(alert => {
        message += \`Â· \${alert.description}\\n\`;
      });
      message += '\\n';
    }

    // å°ç»„åŠ¨æ€
    if (groups.length > 0) {
      groups.forEach(group => {
        message += \`Â· å°ç»„"\${group.name}"æ–°åˆ†æ \${group.new_posts} æ¡\\n\`;
      });
      message += '\\n';
    }

    // Inline keyboard
    const keyboard = {
      inline_keyboard: [
        [
          { text: 'æŸ¥çœ‹è¯¦ç»†çœ‹æ¿', url: \`https://finverse.app/dashboard\` },
          { text: 'è°ƒæ•´åå¥½', callback_data: 'settings' }
        ]
      ]
    };

    await this.bot.sendMessage(userId, message, {
      parse_mode: 'Markdown',
      reply_markup: keyboard
    });
  }

  formatAssetSummary(asset) {
    const { symbol, price, change_pct, signal, confidence, dimensions, key_levels } = asset;

    const signalEmoji = {
      bullish: 'ğŸŸ¢',
      bearish: 'ğŸ”´',
      neutral: 'ğŸŸ¡'
    };

    const signalLabel = {
      bullish: 'çœ‹å¤š',
      bearish: 'çœ‹ç©º',
      neutral: 'ä¸­æ€§'
    };

    const signalIcon = {
      bullish: 'â¬†ï¸',
      bearish: 'â¬‡ï¸',
      neutral: 'â†’'
    };

    let msg = \`**\${symbol}** \${formatCurrency(price)} \${signalIcon[signal]} \${formatPercentage(change_pct)}\\n\`;
    msg += \`\${signalEmoji[signal]} \${signalLabel[signal]}ä¿¡å·ï¼ˆç½®ä¿¡åº¦ \${Math.round(confidence * 100)}%ï¼‰\\n\`;

    // ç»´åº¦åˆ†è§£
    Object.entries(dimensions).forEach(([dim, data], index) => {
      const prefix = index === Object.keys(dimensions).length - 1 ? 'â””' : 'â”œ';
      msg += \`\${prefix} \${dimNameMap[dim]}ï¼š\${data.summary} \${signalIcon[data.signal]}\\n\`;
    });

    // å…³é”®ä½
    if (key_levels.support.length > 0 || key_levels.resistance.length > 0) {
      msg += \`\\nå…³é”®ä½ï¼šæ”¯æ’‘ \${key_levels.support.map(formatCurrency).join(', ')} | é˜»åŠ› \${key_levels.resistance.map(formatCurrency).join(', ')}\`;
    }

    return msg;
  }

  async sendAlert(userId, alertData) {
    const { type, asset, message: alertMessage, severity, url } = alertData;

    const severityEmoji = {
      high: 'ğŸš¨',
      medium: 'âš ï¸',
      low: 'â„¹ï¸'
    };

    let message = \`\${severityEmoji[severity]} **\${asset} å¼‚å¸¸é¢„è­¦**\\n\\n\`;
    message += alertMessage;

    const keyboard = url ? {
      inline_keyboard: [[
        { text: 'æŸ¥çœ‹è¯¦æƒ…', url }
      ]]
    } : null;

    await this.bot.sendMessage(userId, message, {
      parse_mode: 'Markdown',
      reply_markup: keyboard
    });
  }

  async sendGroupNotification(userId, notification) {
    const { type, group_name, post_title, author_name, url } = notification;

    let message = '';

    if (type === 'new_post') {
      message = \`ğŸ“Š å°ç»„"**\${group_name}**"æ–°åˆ†æ\\n\\n\`;
      message += \`**\${post_title}**\\n\`;
      message += \`ä½œè€…ï¼š\${author_name}\`;
    } else if (type === 'consensus_report_ready') {
      message = \`ğŸ“‹ å°ç»„"**\${group_name}**"å…±è¯†æŠ¥å‘Šå·²ç”Ÿæˆ\`;
    } else if (type === 'new_comment') {
      message = \`ğŸ’¬ \${author_name} è¯„è®ºäº†ä½ çš„åˆ†æ\\n\\n\`;
      message += \`"\${post_title}"\`;
    }

    const keyboard = {
      inline_keyboard: [[
        { text: 'æŸ¥çœ‹', url }
      ]]
    };

    await this.bot.sendMessage(userId, message, {
      parse_mode: 'Markdown',
      reply_markup: keyboard
    });
  }

  async handleMessage(msg) {
    const userId = msg.from.id;
    const text = msg.text;

    // è·³è¿‡å‘½ä»¤
    if (text.startsWith('/')) return;

    // å‘é€"æ­£åœ¨æ€è€ƒ"æŒ‡ç¤ºå™¨
    await this.bot.sendChatAction(userId, 'typing');

    // è°ƒç”¨ç”¨æˆ·çš„Agentå¤„ç†è‡ªç„¶è¯­è¨€æŸ¥è¯¢
    try {
      const response = await this.callUserAgent(userId, text);

      if (response.type === 'text') {
        await this.bot.sendMessage(userId, response.content, {
          parse_mode: 'Markdown'
        });
      } else if (response.type === 'chart') {
        // å‘é€å›¾è¡¨ï¼ˆå…ˆå‘å›¾ï¼Œå†å‘åˆ†æï¼‰
        await this.bot.sendPhoto(userId, response.chart_url);
        await this.bot.sendMessage(userId, response.content, {
          parse_mode: 'Markdown'
        });
      } else if (response.type === 'redirect') {
        // å¤æ‚åˆ†æï¼Œå¼•å¯¼ç”¨æˆ·å»ç½‘ç«™æŸ¥çœ‹
        const keyboard = {
          inline_keyboard: [[
            { text: 'åœ¨ç½‘ç«™æŸ¥çœ‹è¯¦ç»†åˆ†æ', url: response.url }
          ]]
        };
        await this.bot.sendMessage(userId, response.content, {
          parse_mode: 'Markdown',
          reply_markup: keyboard
        });
      }
    } catch (error) {
      console.error('å¤„ç†æ¶ˆæ¯å¤±è´¥:', error);
      await this.bot.sendMessage(userId, 'æŠ±æ­‰ï¼Œå¤„ç†ä½ çš„è¯·æ±‚æ—¶å‡ºé”™äº†ã€‚è¯·ç¨åå†è¯•ã€‚');
    }
  }

  async callUserAgent(userId, query) {
    // è°ƒç”¨FinVerse APIï¼Œè§¦å‘ç”¨æˆ·çš„Agent
    const response = await fetch(\`\${process.env.FINVERSE_API}/agent/query\`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: userId, query })
    });

    return await response.json();
  }
}

const dimNameMap = {
  on_chain: 'é“¾ä¸Š',
  technical: 'æŠ€æœ¯',
  macro: 'å®è§‚',
  sentiment: 'æƒ…ç»ª'
};
\`\`\`

#### 8.1.2 Inline å›¾ç‰‡å¡ç‰‡æ ¼å¼

å½“Agentç”Ÿæˆå›¾è¡¨æ—¶ï¼Œåœ¨Telegramä¸­ä»¥å›¾ç‰‡+è¯´æ˜çš„å½¢å¼å‘é€ï¼š

**å›¾ç‰‡ç”Ÿæˆ**ï¼ˆä½¿ç”¨Canvasæˆ–Puppeteerï¼‰ï¼š
\`\`\`javascript
// chart-image-generator.js
const { createCanvas } = require('canvas');

async function generateChartImage(chartData) {
  const width = 800;
  const height = 600;
  const canvas = createCanvas(width, height);
  const ctx = canvas.getContext('2d');

  // èƒŒæ™¯
  ctx.fillStyle = '#FFFFFF';
  ctx.fillRect(0, 0, width, height);

  // æ ‡é¢˜
  ctx.fillStyle = '#111827';
  ctx.font = 'bold 24px Arial';
  ctx.fillText(chartData.title, 20, 40);

  // å‰¯æ ‡é¢˜
  ctx.fillStyle = '#6B7280';
  ctx.font = '16px Arial';
  ctx.fillText(chartData.subtitle, 20, 70);

  // ç»˜åˆ¶Kçº¿å›¾ï¼ˆç®€åŒ–ç‰ˆï¼‰
  const candles = chartData.candles;
  const chartHeight = 400;
  const chartTop = 100;
  const chartWidth = width - 40;
  const candleWidth = chartWidth / candles.length;

  const prices = candles.flatMap(c => [c.high, c.low]);
  const maxPrice = Math.max(...prices);
  const minPrice = Math.min(...prices);
  const priceRange = maxPrice - minPrice;

  candles.forEach((candle, i) => {
    const x = 20 + i * candleWidth;
    const openY = chartTop + ((maxPrice - candle.open) / priceRange) * chartHeight;
    const closeY = chartTop + ((maxPrice - candle.close) / priceRange) * chartHeight;
    const highY = chartTop + ((maxPrice - candle.high) / priceRange) * chartHeight;
    const lowY = chartTop + ((maxPrice - candle.low) / priceRange) * chartHeight;

    // èœ¡çƒ›é¢œè‰²
    ctx.fillStyle = candle.close >= candle.open ? '#22c55e' : '#ef4444';
    ctx.strokeStyle = ctx.fillStyle;

    // å½±çº¿
    ctx.beginPath();
    ctx.moveTo(x + candleWidth / 2, highY);
    ctx.lineTo(x + candleWidth / 2, lowY);
    ctx.stroke();

    // å®ä½“
    const bodyTop = Math.min(openY, closeY);
    const bodyHeight = Math.abs(closeY - openY) || 1;
    ctx.fillRect(x + 2, bodyTop, candleWidth - 4, bodyHeight);
  });

  // AIæ ‡æ³¨ï¼ˆå¦‚æœæœ‰ï¼‰
  if (chartData.annotations) {
    chartData.annotations.forEach(annotation => {
      if (annotation.type === 'horizontal_line') {
        const y = chartTop + ((maxPrice - annotation.price) / priceRange) * chartHeight;
        ctx.strokeStyle = annotation.color;
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        ctx.moveTo(20, y);
        ctx.lineTo(width - 20, y);
        ctx.stroke();
        ctx.setLineDash([]);

        // æ ‡ç­¾
        ctx.fillStyle = annotation.color;
        ctx.font = 'bold 14px Arial';
        ctx.fillText(\`\${annotation.label} \$\${annotation.price}\`, width - 180, y - 5);
      }
    });
  }

  // åº•éƒ¨ä¿¡æ¯
  ctx.fillStyle = '#6B7280';
  ctx.font = '12px Arial';
  ctx.fillText('FinVerse Â· AIé©±åŠ¨çš„é‡‘èåˆ†æå¹³å°', 20, height - 20);

  return canvas.toBuffer('image/png');
}
\`\`\`

**å‘é€å¸¦å›¾è¡¨çš„æ¶ˆæ¯**ï¼š
\`\`\`javascript
async function sendChartAnalysis(userId, analysis) {
  // 1. ç”Ÿæˆå›¾è¡¨å›¾ç‰‡
  const chartImage = await generateChartImage(analysis.chart_data);

  // 2. å‘é€å›¾ç‰‡
  await bot.sendPhoto(userId, chartImage, {
    caption: \`ğŸ“Š \${analysis.asset} åˆ†æå›¾è¡¨\`
  });

  // 3. å‘é€æ–‡å­—åˆ†æ
  let message = \`**\${analysis.title}**\\n\\n\`;
  message += \`\${analysis.summary}\\n\\n\`;
  message += \`[æŸ¥çœ‹å®Œæ•´åˆ†æ](\${analysis.url})\`;

  await bot.sendMessage(userId, message, {
    parse_mode: 'Markdown',
    disable_web_page_preview: true
  });
}
\`\`\`

### 8.2 æ¨é€è§¦å‘é€»è¾‘

#### 8.2.1 è§¦å‘æ¡ä»¶çŸ©é˜µ

| äº‹ä»¶ | è§¦å‘æ¡ä»¶ | æ¨é€æ—¶æœº | å†…å®¹ |
|------|---------|---------|------|
| æ¯æ—¥æ‘˜è¦ | ç”¨æˆ·è®¢é˜… | ç”¨æˆ·èµ·åºŠæ—¶é—´ï¼ˆå­¦ä¹ å¾—å‡ºï¼‰| å¸‚åœºæ€»è§ˆ+å…³æ³¨èµ„äº§ |
| å¼‚å¸¸é¢„è­¦ | ç›‘æ§è„šæœ¬æ£€æµ‹åˆ°å¼‚å¸¸ | ç«‹å³ | å…·ä½“å¼‚å¸¸+AIåˆ†æ |
| å¼€ç›˜æé†’ | ç”¨æˆ·å…³æ³¨çš„å¸‚åœºå¼€ç›˜ | å¼€ç›˜å‰30åˆ†é’Ÿ | å¼€ç›˜å‰æ™¯å±•æœ› |
| æ”¶ç›˜å¤ç›˜ | å¸‚åœºæ”¶ç›˜ | æ”¶ç›˜å1å°æ—¶ | å½“æ—¥å›é¡¾+æ˜æ—¥å±•æœ› |
| å°ç»„æ–°åˆ†æ | å°ç»„æˆå‘˜å‘å¸ƒ | ç«‹å³ï¼ˆå¯è®¾ç½®å…æ‰“æ‰°ï¼‰ | åˆ†ææ‘˜è¦+é“¾æ¥ |
| å…±è¯†æŠ¥å‘Š | æŠ¥å‘Šç”Ÿæˆå®Œæˆ | ç«‹å³ | æŠ¥å‘Šæ‘˜è¦+é“¾æ¥ |
| è¯„è®º/@ | æœ‰äººè¯„è®ºæˆ–@ç”¨æˆ· | ç«‹å³ | è¯„è®ºå†…å®¹+é“¾æ¥ |
| ä»·æ ¼ç©¿è¶Šå…³é”®ä½ | ä»·æ ¼è§¦åŠç”¨æˆ·å…³æ³¨çš„ä½ | ç«‹å³ | ç©¿è¶Šæé†’+å½“å‰åˆ†æ |

#### 8.2.2 é€šçŸ¥ä¼˜å…ˆçº§å’Œé¢‘ç‡æ§åˆ¶

\`\`\`javascript
// notification-manager.js

class NotificationManager {
  constructor() {
    this.priorityLevels = {
      critical: 1,   // å¼‚å¸¸é¢„è­¦ã€ä»·æ ¼ç©¿è¶Š
      high: 2,       // å°ç»„@ã€è¯„è®ºå›å¤
      medium: 3,     // å°ç»„æ–°åˆ†æã€å…±è¯†æŠ¥å‘Š
      low: 4         // æ¯æ—¥æ‘˜è¦ã€å¸‚åœºå¼€é—­ç›˜
    };

    this.cooldowns = new Map(); // ç”¨æˆ·ID -> æœ€åæ¨é€æ—¶é—´
  }

  async shouldSendNotification(userId, notification) {
    const { priority, type } = notification;

    // 1. æ£€æŸ¥ç”¨æˆ·é€šçŸ¥è®¾ç½®
    const userSettings = await db.user_settings.findOne({ user_id: userId });
    if (userSettings.notifications_disabled) return false;

    // 2. æ£€æŸ¥å…æ‰“æ‰°æ—¶æ®µ
    const userTimezone = userSettings.timezone;
    const currentHour = new Date().toLocaleString('en-US', {
      timeZone: userTimezone,
      hour: 'numeric',
      hour12: false
    });

    if (currentHour >= 23 || currentHour < 8) {
      // æ·±å¤œ/å‡Œæ™¨ï¼Œåªå‘criticalçº§åˆ«
      if (priority !== 'critical') return false;
    }

    // 3. æ£€æŸ¥é¢‘ç‡é™åˆ¶ï¼ˆé˜²æ­¢åˆ·å±ï¼‰
    const lastSent = this.cooldowns.get(userId);
    if (lastSent) {
      const timeSinceLastMinutes = (Date.now() - lastSent) / 1000 / 60;

      if (priority === 'critical') {
        // Criticalå¯ä»¥è¿ç»­å‘ï¼Œä½†è‡³å°‘é—´éš”2åˆ†é’Ÿ
        if (timeSinceLastMinutes < 2) return false;
      } else if (priority === 'high') {
        // Highè‡³å°‘é—´éš”5åˆ†é’Ÿ
        if (timeSinceLastMinutes < 5) return false;
      } else {
        // Medium/Lowè‡³å°‘é—´éš”30åˆ†é’Ÿ
        if (timeSinceLastMinutes < 30) return false;
      }
    }

    // 4. æ£€æŸ¥ç”¨æˆ·å¯¹æ­¤ç±»é€šçŸ¥çš„è®¢é˜…
    if (userSettings.notification_types[type] === false) return false;

    return true;
  }

  async sendNotification(userId, notification) {
    if (!await this.shouldSendNotification(userId, notification)) {
      console.log(\`è·³è¿‡é€šçŸ¥: \${userId} - \${notification.type}\`);
      return;
    }

    // å‘é€é€šçŸ¥
    const user = await db.users.findById(userId);
    const channel = user.preferred_channel; // telegram, whatsapp, discord, etc.

    if (channel === 'telegram') {
      await this.sendTelegramNotification(user.telegram_id, notification);
    } else if (channel === 'whatsapp') {
      await this.sendWhatsAppNotification(user.whatsapp_number, notification);
    }
    // ... å…¶ä»–æ¸ é“

    // æ›´æ–°cooldown
    this.cooldowns.set(userId, Date.now());

    // è®°å½•æ—¥å¿—
    await db.notification_logs.create({
      user_id: userId,
      notification_type: notification.type,
      priority: notification.priority,
      sent_at: new Date()
    });
  }

  async sendTelegramNotification(telegramId, notification) {
    switch (notification.type) {
      case 'daily_summary':
        await telegramBot.sendDailySummary(telegramId, notification.data);
        break;
      case 'alert':
        await telegramBot.sendAlert(telegramId, notification.data);
        break;
      case 'group_new_post':
      case 'group_consensus_report':
      case 'group_comment':
        await telegramBot.sendGroupNotification(telegramId, notification.data);
        break;
      default:
        console.warn(\`æœªçŸ¥é€šçŸ¥ç±»å‹: \${notification.type}\`);
    }
  }
}
\`\`\`

### 8.3 é“¾æ¥ç”Ÿæˆï¼ˆè·³è½¬åˆ°ç½‘ç«™ï¼‰

æ‰€æœ‰ä»èŠå¤©è½¯ä»¶æ¨é€çš„æ¶ˆæ¯ï¼Œéœ€è¦æ·±åº¦æŸ¥çœ‹æ—¶éƒ½åº”è¯¥é™„å¸¦é“¾æ¥ï¼Œè·³è½¬åˆ°ç½‘ç«™å¯¹åº”é¡µé¢ã€‚

**é“¾æ¥æ ¼å¼**ï¼š
\`\`\`
https://finverse.app/dashboard
https://finverse.app/groups/{groupId}
https://finverse.app/groups/{groupId}/posts/{postId}
https://finverse.app/groups/{groupId}/consensus-reports/{reportId}
https://finverse.app/assets/{asset}
https://finverse.app/retrospective
\`\`\`

**é“¾æ¥ç”Ÿæˆå·¥å…·**ï¼š
\`\`\`javascript
// url-builder.js

class URLBuilder {
  constructor(baseURL = 'https://finverse.app') {
    this.baseURL = baseURL;
  }

  dashboard(userId) {
    return \`\${this.baseURL}/dashboard?user=\${userId}\`;
  }

  group(groupId) {
    return \`\${this.baseURL}/groups/\${groupId}\`;
  }

  groupPost(groupId, postId) {
    return \`\${this.baseURL}/groups/\${groupId}/posts/\${postId}\`;
  }

  consensusReport(groupId, reportId) {
    return \`\${this.baseURL}/groups/\${groupId}/consensus-reports/\${reportId}\`;
  }

  asset(asset) {
    return \`\${this.baseURL}/assets/\${encodeURIComponent(asset)}\`;
  }

  retrospective(userId) {
    return \`\${this.baseURL}/retrospective?user=\${userId}\`;
  }

  // å¸¦è®¤è¯tokençš„é“¾æ¥ï¼ˆç”¨äºä»èŠå¤©è½¯ä»¶ç›´æ¥ç™»å½•ï¼‰
  withAuth(url, userId) {
    const token = generateAuthToken(userId, '1h');
    const separator = url.includes('?') ? '&' : '?';
    return \`\${url}\${separator}auth_token=\${token}\`;
  }
}

function generateAuthToken(userId, expiresIn) {
  const jwt = require('jsonwebtoken');
  return jwt.sign({ user_id: userId }, process.env.JWT_SECRET, {
    expiresIn
  });
}
\`\`\`

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
\`\`\`javascript
const urlBuilder = new URLBuilder();

// å°ç»„æ–°åˆ†æé€šçŸ¥
const notification = {
  type: 'group_new_post',
  data: {
    group_name: 'åŠ å¯†çŸ­çº¿æŠ€æœ¯æ´¾',
    post_title: 'BTCçŸ­æœŸçœ‹ç©ºï¼šäº¤æ˜“æ‰€æµå…¥æ¿€å¢',
    author_name: 'Alice',
    url: urlBuilder.withAuth(
      urlBuilder.groupPost(groupId, postId),
      userId
    )
  }
};
\`\`\`

---

## ä¹ã€å¯è§†åŒ–â€”â€”ä¸‰ç§å‘ˆç°æ¨¡å¼

### 9.1 æ‘˜è¦æ¨¡å¼ï¼ˆSummary Modeï¼‰

**è®¾è®¡ç†å¿µ**ï¼š1ç§’çœ‹å®Œï¼ŒçŸ¥é“è¯¥å…³æ³¨ä»€ä¹ˆã€‚æç®€ã€ä¿¡æ¯å¯†åº¦ä½ã€å…³é”®ä¿¡æ¯çªå‡ºã€‚

#### 9.1.1 æ•´ä½“å¸ƒå±€

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Header: æ‘˜è¦æ¨¡å¼ | å›¾è¡¨æ¨¡å¼ | æ•°æ®æ¨¡å¼             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  [BTC/USD]  [ETH/USD]  [SOL/USD]  [+ æ·»åŠ èµ„äº§]   â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”     â”‚
â”‚                                                  â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘  BTC/USD                                  â•‘  â”‚
â”‚  â•‘                                            â•‘  â”‚
â”‚  â•‘  \$67,450  â¬‡ï¸ -2.3%                         â•‘  â”‚
â”‚  â•‘  çœ‹ç©º ğŸ”´ ç½®ä¿¡åº¦ 72%                         â•‘  â”‚
â”‚  â•‘                                            â•‘  â”‚
â”‚  â•‘  äº¤æ˜“æ‰€æµå…¥æ¿€å¢ï¼ŒæŠ€æœ¯é¢è¶…ä¹°ï¼Œå…³æ³¨æ”¯æ’‘\$67,200  â•‘  â”‚
â”‚  â•‘                                            â•‘  â”‚
â”‚  â•‘  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”      â•‘  â”‚
â”‚  â•‘  é“¾ä¸Š  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 78% â¬‡ï¸                   â•‘  â”‚
â”‚  â•‘  æŠ€æœ¯  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘ 50% â†’                    â•‘  â”‚
â”‚  â•‘  å®è§‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘ 72% â¬‡ï¸                   â•‘  â”‚
â”‚  â•‘  æƒ…ç»ª  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 65% â¬‡ï¸                   â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                  â”‚
â”‚  ğŸš¨ å¼‚å¸¸é¢„è­¦ (2)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ âš ï¸  BTC é“¾ä¸Šå¤§é¢è½¬è´¦  15 åˆ†é’Ÿå‰             â”‚â”‚
â”‚  â”‚ â„¹ï¸  ETH Gasè´¹é£™å‡     1 å°æ—¶å‰              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                  â”‚
â”‚  ğŸ“Š å°ç»„å…±è¯†                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ "åŠ å¯†çŸ­çº¿æŠ€æœ¯æ´¾"  72%çœ‹ç©º  [æŸ¥çœ‹æŠ¥å‘Š]        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

#### 9.1.2 UIè§„æ ¼è¯¦ç»†å‚æ•°

**èµ„äº§å¡ç‰‡ï¼ˆAssetSummaryCardï¼‰**ï¼š
- å¤–æ¡†ï¼š2px solidï¼Œæ ¹æ®ä¿¡å·é¢œè‰²ï¼ˆçœ‹å¤š#22c55e / çœ‹ç©º#ef4444 / ä¸­æ€§#6b7280ï¼‰
- èƒŒæ™¯ï¼šæ¸å˜ï¼Œfrom-white to-{signal-color}-50/10
- åœ†è§’ï¼š16px
- å†…è¾¹è·ï¼š32px
- å®½åº¦ï¼š100%ï¼ˆæœ€å°800pxï¼‰
- é˜´å½±ï¼š0 8px 32px rgba(0, 0, 0, 0.12)
- æ‚¬åœæ•ˆæœï¼šé˜´å½±å¢å¼º 0 12px 48px rgba(0, 0, 0, 0.18)ï¼Œè¿‡æ¸¡0.3s

**ä»·æ ¼æ˜¾ç¤º**ï¼š
- å­—å·ï¼š48px
- å­—é‡ï¼š700
- é¢œè‰²ï¼š#111827
- è¡Œé«˜ï¼š1.2

**æ¶¨è·Œå¹…**ï¼š
- å­—å·ï¼š24px
- å­—é‡ï¼š600
- é¢œè‰²ï¼šæ¶¨#22c55e / è·Œ#ef4444
- åŒ…å«emojiç®­å¤´ï¼ˆâ¬†ï¸ / â¬‡ï¸ï¼‰

**ä¿¡å·æ ‡ç­¾**ï¼š
- èƒŒæ™¯ï¼šä¿¡å·é¢œè‰²ï¼Œ50%é€æ˜åº¦
- æ–‡å­—ï¼šä¿¡å·é¢œè‰²ï¼ŒåŠ ç²—
- å†…è¾¹è·ï¼š12px 24px
- åœ†è§’ï¼š24pxï¼ˆèƒ¶å›Šå½¢ï¼‰
- å­—å·ï¼š18px
- å­—é‡ï¼š600

**ä¸€å¥è¯ç»“è®º**ï¼š
- å­—å·ï¼š18px
- å­—é‡ï¼š400
- é¢œè‰²ï¼š#4B5563
- è¡Œé«˜ï¼š1.6
- æœ€å¤§2è¡Œï¼Œè¶…å‡ºçœç•¥

**å¤šç»´ä¿¡å·æ¡**ï¼š
- é«˜åº¦ï¼šæ¯æ¡ 32px
- é—´è·ï¼š12px
- èƒŒæ™¯æ¡ï¼š#E5E7EB
- å¡«å……æ¡ï¼šæ¸å˜ï¼Œfrom-{signal-color}-400 to-{signal-color}-600
- åœ†è§’ï¼š8px
- æ–‡å­—ï¼šå·¦ä¾§ç»´åº¦åï¼ˆ14pxï¼Œ#6B7280ï¼‰ï¼Œå³ä¾§ç™¾åˆ†æ¯”+emojiï¼ˆ14pxï¼Œä¿¡å·é¢œè‰²ï¼Œboldï¼‰
- åŠ¨ç”»ï¼šå¡«å……æ¡åŠ è½½æ—¶ä»0å®½åº¦animateåˆ°ç›®æ ‡å®½åº¦ï¼Œ1s ease-out

**å¼‚å¸¸é¢„è­¦å¡ç‰‡**ï¼š
- èƒŒæ™¯ï¼šæ ¹æ®ä¸¥é‡åº¦ï¼ˆhigh: #FEF2F2 / medium: #FEF3C7 / low: #F0F9FFï¼‰
- è¾¹æ¡†ï¼šå·¦ä¾§4px solidï¼Œä¸¥é‡åº¦é¢œè‰²ï¼ˆhigh: #EF4444 / medium: #F59E0B / low: #3B82F6ï¼‰
- å†…è¾¹è·ï¼š16px 20px
- åœ†è§’ï¼š8px
- emojiå¤§å°ï¼š20px
- æ–‡å­—ï¼š14pxï¼Œ#374151
- æ—¶é—´ï¼š12pxï¼Œ#9CA3AFï¼Œå³ä¸Šè§’

**å°ç»„å…±è¯†æ¡**ï¼š
- èƒŒæ™¯ï¼š#F3F4F6
- å†…è¾¹è·ï¼š20px
- åœ†è§’ï¼š12px
- å°ç»„åï¼š16pxï¼Œ#111827ï¼Œbold
- å…±è¯†æ–‡å­—ï¼š16pxï¼Œ#4B5563
- æŒ‰é’®ï¼šè“è‰²é“¾æ¥ï¼Œ14px

**ç»„ä»¶ä»£ç **ï¼š
\`\`\`tsx
// SummaryMode.tsx
import React from 'react';
import { TrendingUp, TrendingDown, AlertTriangle, Info } from 'lucide-react';

interface SummaryModeProps {
  assets: Array<{
    symbol: string;
    price: number;
    change_pct: number;
    signal: 'bullish' | 'bearish' | 'neutral';
    confidence: number;
    summary: string;
    dimensions: Record<string, { signal: string; confidence: number; summary: string }>;
  }>;
  alerts: Array<{
    severity: 'high' | 'medium' | 'low';
    message: string;
    timestamp: string;
  }>;
  groupConsensus: Array<{
    group_name: string;
    signal: string;
    percentage: number;
    report_url: string;
  }>;
}

export function SummaryMode({ assets, alerts, groupConsensus }: SummaryModeProps) {
  return (
    <div className="min-h-screen bg-gray-50 p-8">
      {/* Asset Tabs */}
      <div className="mb-8 flex space-x-4 border-b-2 border-gray-200">
        {assets.map(asset => (
          <button
            key={asset.symbol}
            className="pb-4 px-4 font-semibold text-gray-700 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600 transition"
          >
            {asset.symbol}
          </button>
        ))}
        <button className="pb-4 px-4 text-gray-400 hover:text-blue-600">
          + æ·»åŠ èµ„äº§
        </button>
      </div>

      {/* Main Asset Card */}
      {assets.map(asset => (
        <AssetSummaryCard key={asset.symbol} asset={asset} />
      ))}

      {/* Alerts */}
      {alerts.length > 0 && (
        <div className="mt-8">
          <h2 className="text-xl font-semibold text-gray-900 mb-4">
            ğŸš¨ å¼‚å¸¸é¢„è­¦ ({alerts.length})
          </h2>
          <div className="space-y-3">
            {alerts.map((alert, i) => (
              <AlertCard key={i} alert={alert} />
            ))}
          </div>
        </div>
      )}

      {/* Group Consensus */}
      {groupConsensus.length > 0 && (
        <div className="mt-8">
          <h2 className="text-xl font-semibold text-gray-900 mb-4">
            ğŸ“Š å°ç»„å…±è¯†
          </h2>
          <div className="space-y-3">
            {groupConsensus.map((consensus, i) => (
              <GroupConsensusBar key={i} consensus={consensus} />
            ))}
          </div>
        </div>
      )}
    </div>
  );
}

function AssetSummaryCard({ asset }) {
  const signalConfig = {
    bullish: { color: '#22c55e', bg: 'from-white to-green-50', border: 'border-green-500', emoji: 'â¬†ï¸' },
    bearish: { color: '#ef4444', bg: 'from-white to-red-50', border: 'border-red-500', emoji: 'â¬‡ï¸' },
    neutral: { color: '#6b7280', bg: 'from-white to-gray-50', border: 'border-gray-500', emoji: 'â†’' }
  };

  const config = signalConfig[asset.signal];

  return (
    <div
      className={\`bg-gradient-to-br \${config.bg} border-2 \${config.border} rounded-2xl p-8 shadow-xl hover:shadow-2xl transition-all duration-300 mb-6\`}
    >
      {/* Header: Symbol */}
      <h1 className="text-2xl font-bold text-gray-900 mb-4">{asset.symbol}</h1>

      {/* Price and Change */}
      <div className="flex items-baseline space-x-4 mb-4">
        <div className="text-5xl font-bold text-gray-900">
          \${asset.price.toLocaleString()}
        </div>
        <div
          className="text-2xl font-semibold flex items-center"
          style={{ color: asset.change_pct >= 0 ? '#22c55e' : '#ef4444' }}
        >
          {asset.change_pct >= 0 ? <TrendingUp className="w-6 h-6 mr-1" /> : <TrendingDown className="w-6 h-6 mr-1" />}
          {asset.change_pct >= 0 ? '+' : ''}{asset.change_pct.toFixed(2)}%
        </div>
      </div>

      {/* Signal Badge */}
      <div className="mb-6">
        <span
          className="inline-block px-6 py-3 rounded-full font-semibold text-lg"
          style={{ backgroundColor: \`\${config.color}20\`, color: config.color }}
        >
          {asset.signal === 'bullish' ? 'çœ‹å¤š' : asset.signal === 'bearish' ? 'çœ‹ç©º' : 'ä¸­æ€§'} {config.emoji} ç½®ä¿¡åº¦ {Math.round(asset.confidence * 100)}%
        </span>
      </div>

      {/* Summary */}
      <p className="text-lg text-gray-600 mb-6 leading-relaxed">
        {asset.summary}
      </p>

      {/* Dimension Bars */}
      <div className="space-y-3">
        {Object.entries(asset.dimensions).map(([dim, data]) => (
          <DimensionBar key={dim} dimension={dim} data={data} />
        ))}
      </div>
    </div>
  );
}

function DimensionBar({ dimension, data }) {
  const dimNames = {
    on_chain: 'é“¾ä¸Š',
    technical: 'æŠ€æœ¯',
    macro: 'å®è§‚',
    sentiment: 'æƒ…ç»ª'
  };

  const signalConfig = {
    bullish: { color: '#22c55e', emoji: 'â¬†ï¸' },
    bearish: { color: '#ef4444', emoji: 'â¬‡ï¸' },
    neutral: { color: '#6b7280', emoji: 'â†’' }
  };

  const config = signalConfig[data.signal];
  const percentage = Math.round(data.confidence * 100);

  return (
    <div>
      <div className="flex justify-between mb-1">
        <span className="text-sm font-medium text-gray-700">{dimNames[dimension]}</span>
        <span className="text-sm font-bold" style={{ color: config.color }}>
          {percentage}% {config.emoji}
        </span>
      </div>
      <div className="w-full bg-gray-200 rounded-lg h-8 overflow-hidden">
        <div
          className="h-8 rounded-lg transition-all duration-1000 ease-out"
          style={{
            width: \`\${percentage}%\`,
            background: \`linear-gradient(to right, \${config.color}, \${config.color}dd)\`
          }}
        />
      </div>
    </div>
  );
}

function AlertCard({ alert }) {
  const severityConfig = {
    high: { bg: '#FEF2F2', border: '#EF4444', icon: AlertTriangle, text: '#DC2626' },
    medium: { bg: '#FEF3C7', border: '#F59E0B', icon: Info, text: '#D97706' },
    low: { bg: '#F0F9FF', border: '#3B82F6', icon: Info, text: '#2563EB' }
  };

  const config = severityConfig[alert.severity];
  const Icon = config.icon;

  return (
    <div
      className="rounded-lg p-4 flex items-start space-x-3"
      style={{ backgroundColor: config.bg, borderLeft: \`4px solid \${config.border}\` }}
    >
      <Icon className="w-5 h-5 flex-shrink-0 mt-0.5" style={{ color: config.text }} />
      <div className="flex-1">
        <p className="text-sm text-gray-800">{alert.message}</p>
      </div>
      <span className="text-xs text-gray-400">{formatTimeAgo(alert.timestamp)}</span>
    </div>
  );
}

function GroupConsensusBar({ consensus }) {
  return (
    <div className="bg-gray-100 rounded-xl p-5 flex items-center justify-between">
      <div>
        <span className="font-semibold text-gray-900">"{consensus.group_name}"</span>
        <span className="ml-3 text-gray-600">
          {consensus.percentage}%{consensus.signal === 'bullish' ? 'çœ‹å¤š' : 'çœ‹ç©º'}
        </span>
      </div>
      <a
        href={consensus.report_url}
        className="text-blue-600 hover:text-blue-700 font-medium text-sm"
      >
        æŸ¥çœ‹æŠ¥å‘Š â†’
      </a>
    </div>
  );
}

function formatTimeAgo(timestamp) {
  const now = Date.now();
  const then = new Date(timestamp).getTime();
  const diffMinutes = Math.floor((now - then) / 60000);
  
  if (diffMinutes < 60) return \`\${diffMinutes} åˆ†é’Ÿå‰\`;
  const diffHours = Math.floor(diffMinutes / 60);
  if (diffHours < 24) return \`\${diffHours} å°æ—¶å‰\`;
  const diffDays = Math.floor(diffHours / 24);
  return \`\${diffDays} å¤©å‰\`;
}
\`\`\`

---

### 9.2 å›¾è¡¨æ¨¡å¼ï¼ˆChart Modeï¼‰

**è®¾è®¡ç†å¿µ**ï¼šæŠ€æœ¯æ´¾çš„æœ€çˆ±ã€‚å¤šå›¾å±‚å åŠ ï¼ŒAIæ ‡æ³¨ï¼Œæ¨ç†é“¾å¯è§†åŒ–ã€‚

#### 9.2.1 æ•´ä½“å¸ƒå±€

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [BTC/USD] 1h | 4h | 1d | 1w     \$67,450 â¬‡ï¸-2.3% â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  å›¾å±‚æ§åˆ¶          â”‚  â”‚   ä¸»å›¾è¡¨åŒº            â”‚ â”‚
â”‚  â”‚                   â”‚  â”‚                      â”‚ â”‚
â”‚  â”‚  â˜‘ ä»·æ ¼           â”‚  â”‚   [Kçº¿å›¾ + å›¾å±‚]      â”‚ â”‚
â”‚  â”‚  â˜‘ æˆäº¤é‡         â”‚  â”‚                      â”‚ â”‚
â”‚  â”‚  â˜‘ AIæ ‡æ³¨         â”‚  â”‚   [å¯äº¤äº’]           â”‚ â”‚
â”‚  â”‚  â˜‘ æ”¯æ’‘é˜»åŠ›       â”‚  â”‚                      â”‚ â”‚
â”‚  â”‚  â˜‘ å®è§‚äº‹ä»¶       â”‚  â”‚                      â”‚ â”‚
â”‚  â”‚  â˜‘ é“¾ä¸Šæ•°æ®       â”‚  â”‚                      â”‚ â”‚
â”‚  â”‚  â˜ å¼‚å¸¸çƒ­åŠ›å›¾     â”‚  â”‚                      â”‚ â”‚
â”‚  â”‚  â˜ å†å²å å½±       â”‚  â”‚                      â”‚ â”‚
â”‚  â”‚                   â”‚  â”‚                      â”‚ â”‚
â”‚  â”‚  [å›¾å±‚æ ·å¼è®¾ç½®]   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                  â”‚
â”‚  AIæ¨ç†é“¾ï¼ˆç‚¹å‡»æ ‡æ³¨ç‚¹å±•å¼€ï¼‰                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â‘  é“¾ä¸Šæ•°æ®å¼‚å¸¸ â†’ æƒé‡ 30%                  â”‚ â”‚
â”‚  â”‚     äº¤æ˜“æ‰€æµå…¥ +12,400 BTC                  â”‚ â”‚
â”‚  â”‚  â‘¡ å®è§‚ç¯å¢ƒåˆ©ç©º â†’ æƒé‡ 35%                  â”‚ â”‚
â”‚  â”‚     CPIè¶…é¢„æœŸæ¦‚ç‡ 60%                        â”‚ â”‚
â”‚  â”‚  â‘¢ æŠ€æœ¯é¢æ”¯æ’‘å°šåœ¨ â†’ æƒé‡ 20%                â”‚ â”‚
â”‚  â”‚     \$67,200 æ”¯æ’‘æœªç ´                         â”‚ â”‚
â”‚  â”‚  â‘£ å†å²å½¢æ€ç›¸ä¼¼åº¦ â†’ æƒé‡ 15%                â”‚ â”‚
â”‚  â”‚     ä¸ 2024-08 èµ°åŠ¿ç›¸ä¼¼åº¦ 78%                â”‚ â”‚
â”‚  â”‚                                             â”‚ â”‚
â”‚  â”‚  ç»¼åˆè¯„åˆ†ï¼šåç©º 72%                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

#### 9.2.2 å›¾å±‚ç³»ç»Ÿå®ç°ï¼ˆCanvas/WebGLï¼‰

ä½¿ç”¨ **lightweight-charts** åº“ä½œä¸ºåŸºç¡€ï¼ˆé«˜æ€§èƒ½ï¼Œæ”¯æŒå¤§æ•°æ®é‡ï¼‰ï¼š

\`\`\`bash
npm install lightweight-charts
\`\`\`

**ç»„ä»¶æ¶æ„**ï¼š
\`\`\`tsx
// ChartMode.tsx
import React, { useRef, useEffect, useState } from 'react';
import { createChart, CrosshairMode } from 'lightweight-charts';

export function ChartMode({ asset, timeframe }) {
  const chartContainerRef = useRef(null);
  const [chart, setChart] = useState(null);
  const [layers, setLayers] = useState({
    price: true,
    volume: true,
    ai_annotations: true,
    support_resistance: true,
    macro_events: true,
    on_chain: true,
    heatmap: false,
    historical_overlay: false
  });

  useEffect(() => {
    if (!chartContainerRef.current) return;

    // åˆ›å»ºå›¾è¡¨
    const newChart = createChart(chartContainerRef.current, {
      width: chartContainerRef.current.clientWidth,
      height: 600,
      layout: {
        background: { color: '#FFFFFF' },
        textColor: '#333',
      },
      grid: {
        vertLines: { color: '#F0F0F0' },
        horzLines: { color: '#F0F0F0' },
      },
      crosshair: {
        mode: CrosshairMode.Normal,
      },
      timeScale: {
        borderColor: '#D1D4DC',
        timeVisible: true,
        secondsVisible: false,
      },
      priceScale: {
        borderColor: '#D1D4DC',
      },
    });

    setChart(newChart);

    // å“åº”å¼
    const handleResize = () => {
      newChart.applyOptions({
        width: chartContainerRef.current.clientWidth,
      });
    };
    window.addEventListener('resize', handleResize);

    return () => {
      window.removeEventListener('resize', handleResize);
      newChart.remove();
    };
  }, []);

  useEffect(() => {
    if (!chart) return;

    // åŠ è½½æ•°æ®å¹¶ç»˜åˆ¶å›¾å±‚
    loadChartData(asset, timeframe).then(data => {
      renderLayers(chart, data, layers);
    });
  }, [chart, asset, timeframe, layers]);

  return (
    <div className="flex h-screen bg-gray-50">
      {/* Sidebar: Layer Controls */}
      <div className="w-64 bg-white border-r border-gray-200 p-4">
        <h2 className="text-lg font-semibold mb-4">å›¾å±‚æ§åˆ¶</h2>
        <div className="space-y-2">
          {Object.entries(layers).map(([key, enabled]) => (
            <label key={key} className="flex items-center space-x-2 cursor-pointer">
              <input
                type="checkbox"
                checked={enabled}
                onChange={() => setLayers(prev => ({ ...prev, [key]: !enabled }))}
                className="w-4 h-4 text-blue-600 rounded"
              />
              <span className="text-sm text-gray-700">{layerNames[key]}</span>
            </label>
          ))}
        </div>
      </div>

      {/* Main Chart */}
      <div className="flex-1 p-6">
        <div ref={chartContainerRef} className="w-full" />
        <AIReasoningChain asset={asset} />
      </div>
    </div>
  );
}

const layerNames = {
  price: 'ä»·æ ¼',
  volume: 'æˆäº¤é‡',
  ai_annotations: 'AIæ ‡æ³¨',
  support_resistance: 'æ”¯æ’‘é˜»åŠ›',
  macro_events: 'å®è§‚äº‹ä»¶',# FinVerse å¼€å‘æç¤ºè¯ Part Cï¼šç¬¬ 13-18 ç« 

> **æç»†é¢—ç²’åº¦å¯æ‰§è¡Œå¼€å‘æŒ‡å—**  
> è¦†ç›–ï¼šå¸‚åœºæ¥å…¥ | é£é™©å¯¹ç­– | Agent è°ƒåº¦å™¨ | è·¯çº¿å›¾ | æŠ€æœ¯æ ˆ | åˆå§‹åŒ–

---

## åä¸‰ã€è¦†ç›–å¸‚åœº - æ•°æ®æ¥å…¥å±‚å¼€å‘æç¤ºè¯

### 13.1 æ•°æ®æ ‡å‡†åŒ– Schema

**åˆ›å»ºæ–‡ä»¶ï¼š\`packages/data-schema/src/types/market-data.ts\`**

\`\`\`typescript
/**
 * ç»Ÿä¸€å¸‚åœºæ•°æ®æ¥å£
 * æ‰€æœ‰æ•°æ®æºé€‚é…å™¨å¿…é¡»è¾“å‡ºæ­¤æ ¼å¼
 */

// åŸºç¡€æ—¶é—´åºåˆ—æ•°æ®ç‚¹
export interface PriceDataPoint {
  timestamp: number;           // Unix timestamp (ms)
  open: number;
  high: number;
  low: number;
  close: number;
  volume: number;
  source: DataSource;
  reliability: number;         // 0-1, æ•°æ®å¯é æ€§è¯„åˆ†
}

// èµ„äº§æ ‡è¯†ç¬¦
export interface AssetIdentifier {
  symbol: string;              // ç»Ÿä¸€ç¬¦å· (BTC/USD, AAPL, EUR/USD)
  exchange?: string;           // äº¤æ˜“æ‰€/æ¥æº
  type: AssetType;
  category: MarketCategory;
}

export enum AssetType {
  STOCK = 'stock',
  CRYPTO = 'crypto',
  FOREX = 'forex',
  COMMODITY = 'commodity',
  INDEX = 'index',
  OPTION = 'option',
  ETF = 'etf'
}

export enum MarketCategory {
  US_EQUITY = 'us_equity',
  CRYPTO_SPOT = 'crypto_spot',
  CRYPTO_FUTURES = 'crypto_futures',
  FOREX_MAJOR = 'forex_major',
  FOREX_CROSS = 'forex_cross',
  PRECIOUS_METAL = 'precious_metal',
  GLOBAL_INDEX = 'global_index'
}

export enum DataSource {
  COINGECKO = 'coingecko',
  YAHOO_FINANCE = 'yahoo_finance',
  TWELVE_DATA = 'twelve_data',
  GLASSNODE = 'glassnode',
  POLYGON = 'polygon',
  OANDA = 'oanda',
  FRED = 'fred'
}

// é“¾ä¸Šæ•°æ® (ä»…åŠ å¯†è´§å¸)
export interface OnChainData {
  timestamp: number;
  exchange_inflow: number;     // BTC æµå…¥äº¤æ˜“æ‰€
  exchange_outflow: number;
  whale_transactions: number;   // å¤§é¢è½¬è´¦æ¬¡æ•°
  active_addresses: number;
  total_value_locked?: number;  // DeFi TVL
  miner_revenue?: number;
  source: DataSource.GLASSNODE | DataSource.CRYPTOQUANT;
}

// å®è§‚ç»æµæ•°æ®
export interface MacroData {
  timestamp: number;
  indicator: MacroIndicator;
  value: number;
  country: string;             // ISO å›½å®¶ä»£ç 
  source: DataSource;
}

export enum MacroIndicator {
  CPI = 'cpi',                 // æ¶ˆè´¹è€…ç‰©ä»·æŒ‡æ•°
  UNEMPLOYMENT = 'unemployment',
  INTEREST_RATE = 'interest_rate',
  GDP = 'gdp',
  NFP = 'nfp'                  // éå†œå°±ä¸š
}

// ç»Ÿä¸€é”™è¯¯ç±»å‹
export class DataFetchError extends Error {
  constructor(
    public source: DataSource,
    public code: ErrorCode,
    message: string,
    public retryable: boolean = true
  ) {
    super(\`[\${source}] \${code}: \${message}\`);
  }
}

export enum ErrorCode {
  RATE_LIMIT = 'rate_limit',
  API_KEY_INVALID = 'api_key_invalid',
  NETWORK_ERROR = 'network_error',
  DATA_NOT_FOUND = 'data_not_found',
  PARSE_ERROR = 'parse_error'
}
\`\`\`

---

### 13.2 CoinGecko é€‚é…å™¨å®ç°

**åˆ›å»ºæ–‡ä»¶ï¼š\`packages/data-adapters/src/coingecko/adapter.ts\`**

\`\`\`typescript
import axios, { AxiosInstance } from 'axios';
import { PriceDataPoint, DataSource, AssetIdentifier, DataFetchError, ErrorCode } from '@finverse/data-schema';
import { RateLimiter } from '../utils/rate-limiter';

/**
 * CoinGecko API é€‚é…å™¨
 * å…è´¹é™åˆ¶: 10-30 calls/min
 * æ–‡æ¡£: https://docs.coingecko.com/v3.0.1/reference/introduction
 */
export class CoinGeckoAdapter {
  private client: AxiosInstance;
  private rateLimiter: RateLimiter;
  private coinIdCache: Map<string, string> = new Map(); // symbol -> coin_id

  constructor(
    private apiKey?: string // Pro API key (å¯é€‰)
  ) {
    this.client = axios.create({
      baseURL: apiKey 
        ? 'https://pro-api.coingecko.com/api/v3'
        : 'https://api.coingecko.com/api/v3',
      headers: apiKey ? { 'x-cg-pro-api-key': apiKey } : {},
      timeout: 15000
    });

    // å…è´¹ç‰ˆ: 10 calls/min, Pro: 500 calls/min
    this.rateLimiter = new RateLimiter(apiKey ? 500 : 10, 60000);
  }

  /**
   * è·å–å†å²ä»·æ ¼æ•°æ®
   * @param asset èµ„äº§æ ‡è¯†ç¬¦
   * @param from Unix timestamp (ç§’)
   * @param to Unix timestamp (ç§’)
   * @returns æ ‡å‡†åŒ–ä»·æ ¼æ•°æ®ç‚¹æ•°ç»„
   */
  async getHistoricalPrices(
    asset: AssetIdentifier,
    from: number,
    to: number
  ): Promise<PriceDataPoint[]> {
    await this.rateLimiter.acquire();

    try {
      const coinId = await this.resolveCoinId(asset.symbol);
      
      const response = await this.client.get(\`/coins/\${coinId}/market_chart/range\`, {
        params: {
          vs_currency: 'usd',
          from,
          to
        }
      });

      // CoinGecko è¿”å›æ ¼å¼: { prices: [[timestamp, price], ...], ... }
      return this.transformToStandard(response.data, coinId);
    } catch (error) {
      throw this.handleError(error);
    }
  }

  /**
   * è·å–å®æ—¶ä»·æ ¼
   */
  async getCurrentPrice(asset: AssetIdentifier): Promise<PriceDataPoint> {
    await this.rateLimiter.acquire();

    try {
      const coinId = await this.resolveCoinId(asset.symbol);
      
      const response = await this.client.get(\`/simple/price\`, {
        params: {
          ids: coinId,
          vs_currencies: 'usd',
          include_24hr_vol: true,
          include_24hr_change: true,
          include_last_updated_at: true
        }
      });

      const data = response.data[coinId];
      return {
        timestamp: data.last_updated_at * 1000,
        open: data.usd * (1 - data.usd_24h_change / 100), // è¿‘ä¼¼å€¼
        high: data.usd * 1.01, // éœ€è¦ä»å…¶ä»–ç«¯ç‚¹è·å–ç²¾ç¡®å€¼
        low: data.usd * 0.99,
        close: data.usd,
        volume: data.usd_24h_vol,
        source: DataSource.COINGECKO,
        reliability: 0.95 // CoinGecko ä¿¡èª‰è¯„åˆ†
      };
    } catch (error) {
      throw this.handleError(error);
    }
  }

  /**
   * ç¬¦å·è½¬ CoinGecko coin_id
   * ç¼“å­˜æ˜ å°„ä»¥å‡å°‘ API è°ƒç”¨
   */
  private async resolveCoinId(symbol: string): Promise<string> {
    const normalized = symbol.replace(/\\/USD\$/, '').toLowerCase();
    
    if (this.coinIdCache.has(normalized)) {
      return this.coinIdCache.get(normalized)!;
    }

    // å¸¸è§æ˜ å°„
    const commonMappings: Record<string, string> = {
      'btc': 'bitcoin',
      'eth': 'ethereum',
      'usdt': 'tether',
      'bnb': 'binancecoin',
      'sol': 'solana',
      'xrp': 'ripple',
      'ada': 'cardano',
      'doge': 'dogecoin'
    };

    if (commonMappings[normalized]) {
      const coinId = commonMappings[normalized];
      this.coinIdCache.set(normalized, coinId);
      return coinId;
    }

    // åŠ¨æ€æŸ¥è¯¢ (æ¶ˆè€— API è°ƒç”¨)
    await this.rateLimiter.acquire();
    const response = await this.client.get('/coins/list');
    const coin = response.data.find((c: any) => c.symbol.toLowerCase() === normalized);
    
    if (!coin) {
      throw new DataFetchError(
        DataSource.COINGECKO,
        ErrorCode.DATA_NOT_FOUND,
        \`Coin not found: \${symbol}\`,
        false
      );
    }

    this.coinIdCache.set(normalized, coin.id);
    return coin.id;
  }

  /**
   * è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼
   */
  private transformToStandard(data: any, coinId: string): PriceDataPoint[] {
    const prices = data.prices || [];
    const volumes = data.total_volumes || [];

    return prices.map((pricePoint: [number, number], index: number) => {
      const [timestamp, close] = pricePoint;
      const volume = volumes[index]?.[1] || 0;

      return {
        timestamp,
        open: close, // CoinGecko å…è´¹ç‰ˆæ—  OHLC,ä½¿ç”¨ close è¿‘ä¼¼
        high: close,
        low: close,
        close,
        volume,
        source: DataSource.COINGECKO,
        reliability: 0.85 // æ— çœŸå® OHLC æ•°æ®,å¯é æ€§é™ä½
      };
    });
  }

  /**
   * ç»Ÿä¸€é”™è¯¯å¤„ç†
   */
  private handleError(error: any): DataFetchError {
    if (axios.isAxiosError(error)) {
      const status = error.response?.status;
      
      if (status === 429) {
        return new DataFetchError(
          DataSource.COINGECKO,
          ErrorCode.RATE_LIMIT,
          'Rate limit exceeded',
          true
        );
      }
      
      if (status === 401 || status === 403) {
        return new DataFetchError(
          DataSource.COINGECKO,
          ErrorCode.API_KEY_INVALID,
          'Invalid API key',
          false
        );
      }

      if (status === 404) {
        return new DataFetchError(
          DataSource.COINGECKO,
          ErrorCode.DATA_NOT_FOUND,
          'Data not found',
          false
        );
      }
    }

    return new DataFetchError(
      DataSource.COINGECKO,
      ErrorCode.NETWORK_ERROR,
      error.message || 'Unknown error',
      true
    );
  }
}
\`\`\`

**åˆ›å»ºé…å¥—å·¥å…·ï¼š\`packages/data-adapters/src/utils/rate-limiter.ts\`**

\`\`\`typescript
/**
 * ç®€å•çš„æ»‘åŠ¨çª—å£é€Ÿç‡é™åˆ¶å™¨
 */
export class RateLimiter {
  private timestamps: number[] = [];

  constructor(
    private maxRequests: number,
    private windowMs: number
  ) {}

  /**
   * è·å–è®¸å¯,å¦‚æœè¶…é™åˆ™ç­‰å¾…
   */
  async acquire(): Promise<void> {
    const now = Date.now();
    
    // ç§»é™¤çª—å£å¤–çš„æ—¶é—´æˆ³
    this.timestamps = this.timestamps.filter(
      ts => now - ts < this.windowMs
    );

    if (this.timestamps.length >= this.maxRequests) {
      // è®¡ç®—éœ€è¦ç­‰å¾…çš„æ—¶é—´
      const oldestInWindow = this.timestamps[0];
      const waitTime = this.windowMs - (now - oldestInWindow) + 100; // +100ms buffer
      
      await new Promise(resolve => setTimeout(resolve, waitTime));
      return this.acquire(); // é€’å½’é‡è¯•
    }

    this.timestamps.push(now);
  }
}
\`\`\`

---

### 13.3 Yahoo Finance é€‚é…å™¨å®ç°

**åˆ›å»ºæ–‡ä»¶ï¼š\`packages/data-adapters/src/yahoo-finance/adapter.ts\`**

\`\`\`typescript
import yahooFinance from 'yahoo-finance2';
import { PriceDataPoint, DataSource, AssetIdentifier } from '@finverse/data-schema';

/**
 * Yahoo Finance é€‚é…å™¨
 * ä¼˜åŠ¿: å…è´¹ã€æ—  API keyã€ç¾è‚¡æ•°æ®å…¨
 * é™åˆ¶: æ— å®˜æ–¹ API,ä½¿ç”¨ç¤¾åŒºåº“
 */
export class YahooFinanceAdapter {
  constructor() {
    // yahoo-finance2 ä¼šè‡ªåŠ¨å¤„ç† rate limiting
  }

  /**
   * è·å–å†å²æ•°æ®
   */
  async getHistoricalPrices(
    asset: AssetIdentifier,
    from: Date,
    to: Date,
    interval: '1d' | '1h' | '5m' = '1d'
  ): Promise<PriceDataPoint[]> {
    try {
      const symbol = this.normalizeSymbol(asset.symbol);
      
      const result = await yahooFinance.historical(symbol, {
        period1: from,
        period2: to,
        interval
      });

      return result.map(candle => ({
        timestamp: candle.date.getTime(),
        open: candle.open,
        high: candle.high,
        low: candle.low,
        close: candle.close,
        volume: candle.volume,
        source: DataSource.YAHOO_FINANCE,
        reliability: 0.98 // Yahoo Finance æ•°æ®è´¨é‡é«˜
      }));
    } catch (error: any) {
      throw new DataFetchError(
        DataSource.YAHOO_FINANCE,
        this.mapErrorCode(error),
        error.message,
        true
      );
    }
  }

  /**
   * è·å–å®æ—¶æŠ¥ä»·
   */
  async getCurrentPrice(asset: AssetIdentifier): Promise<PriceDataPoint> {
    const symbol = this.normalizeSymbol(asset.symbol);
    
    const quote = await yahooFinance.quote(symbol);

    return {
      timestamp: Date.now(),
      open: quote.regularMarketOpen || quote.regularMarketPrice,
      high: quote.regularMarketDayHigh || quote.regularMarketPrice,
      low: quote.regularMarketDayLow || quote.regularMarketPrice,
      close: quote.regularMarketPrice,
      volume: quote.regularMarketVolume || 0,
      source: DataSource.YAHOO_FINANCE,
      reliability: 0.98
    };
  }

  /**
   * æ ‡å‡†åŒ–è‚¡ç¥¨ä»£ç 
   * AAPL -> AAPL (ä¸å˜)
   * BRK.B -> BRK-B (Yahoo ä½¿ç”¨ -)
   */
  private normalizeSymbol(symbol: string): string {
    return symbol.replace(/\\./g, '-');
  }

  private mapErrorCode(error: any): ErrorCode {
    const message = error.message?.toLowerCase() || '';
    
    if (message.includes('not found') || message.includes('invalid')) {
      return ErrorCode.DATA_NOT_FOUND;
    }
    
    if (message.includes('rate limit')) {
      return ErrorCode.RATE_LIMIT;
    }
    
    return ErrorCode.NETWORK_ERROR;
  }
}
\`\`\`

---

### 13.4 Glassnode é€‚é…å™¨ (ä»˜è´¹é“¾ä¸Šæ•°æ®)

**åˆ›å»ºæ–‡ä»¶ï¼š\`packages/data-adapters/src/glassnode/adapter.ts\`**

\`\`\`typescript
import axios, { AxiosInstance } from 'axios';
import { OnChainData, DataSource } from '@finverse/data-schema';

/**
 * Glassnode API é€‚é…å™¨
 * ä»˜è´¹æœåŠ¡,ç”¨æˆ·æä¾›è‡ªå·±çš„ API key
 * æ–‡æ¡£: https://docs.glassnode.com/api/
 */
export class GlassnodeAdapter {
  private client: AxiosInstance;

  constructor(private apiKey: string) {
    this.client = axios.create({
      baseURL: 'https://api.glassnode.com/v1/metrics',
      params: { api_key: apiKey },
      timeout: 20000
    });
  }

  /**
   * è·å–äº¤æ˜“æ‰€æµå…¥æµå‡º
   */
  async getExchangeFlows(
    asset: 'BTC' | 'ETH',
    since: number, // Unix timestamp
    until: number
  ): Promise<OnChainData[]> {
    try {
      const [inflowData, outflowData] = await Promise.all([
        this.client.get('/transactions/transfers_volume_exchanges_net', {
          params: { a: asset, s: since, u: until, i: '24h' }
        }),
        this.client.get('/transactions/transfers_volume_from_exchanges', {
          params: { a: asset, s: since, u: until, i: '24h' }
        })
      ]);

      // åˆå¹¶æ•°æ®
      return inflowData.data.map((point: any, index: number) => ({
        timestamp: point.t * 1000,
        exchange_inflow: Math.abs(point.v),
        exchange_outflow: outflowData.data[index]?.v || 0,
        whale_transactions: 0, // éœ€è¦é¢å¤–ç«¯ç‚¹
        active_addresses: 0,   // éœ€è¦é¢å¤–ç«¯ç‚¹
        source: DataSource.GLASSNODE
      }));
    } catch (error) {
      throw this.handleError(error);
    }
  }

  /**
   * è·å–æ´»è·ƒåœ°å€æ•°
   */
  async getActiveAddresses(asset: 'BTC' | 'ETH', since: number, until: number): Promise<any[]> {
    const response = await this.client.get('/addresses/active_count', {
      params: { a: asset, s: since, u: until, i: '24h' }
    });
    
    return response.data;
  }

  private handleError(error: any): DataFetchError {
    if (axios.isAxiosError(error)) {
      const status = error.response?.status;
      
      if (status === 402) { // Glassnode ç”¨ 402 è¡¨ç¤ºè®¢é˜…ä¸è¶³
        return new DataFetchError(
          DataSource.GLASSNODE,
          ErrorCode.API_KEY_INVALID,
          'Insufficient subscription tier',
          false
        );
      }
    }
    
    return new DataFetchError(
      DataSource.GLASSNODE,
      ErrorCode.NETWORK_ERROR,
      error.message,
      true
    );
  }
}
\`\`\`

---

### 13.5 å®šæ—¶æ•°æ®æ‹‰å– Cron é…ç½®

**åˆ›å»ºæ–‡ä»¶ï¼š\`packages/data-scheduler/src/cron-jobs.ts\`**

\`\`\`typescript
import cron from 'node-cron';
import { DataAggregator } from './aggregator';
import { logger } from '@finverse/logger';

/**
 * æ•°æ®æ‹‰å–å®šæ—¶ä»»åŠ¡é…ç½®
 */
export class DataScheduler {
  private jobs: Map<string, cron.ScheduledTask> = new Map();

  constructor(private aggregator: DataAggregator) {}

  /**
   * å¯åŠ¨æ‰€æœ‰å®šæ—¶ä»»åŠ¡
   */
  start() {
    // æ¯ 5 åˆ†é’Ÿæ‹‰å–å®æ—¶ä»·æ ¼ (å…è´¹æ•°æ®æº)
    this.scheduleJob('realtime-prices', '*/5 * * * *', async () => {
      await this.aggregator.fetchRealtimePrices(['BTC/USD', 'ETH/USD', 'AAPL', 'TSLA']);
    });

    // æ¯å°æ—¶æ‹‰å–é“¾ä¸Šæ•°æ® (ä»˜è´¹,ä»…è®¢é˜…ç”¨æˆ·)
    this.scheduleJob('onchain-data', '0 * * * *', async () => {
      await this.aggregator.fetchOnChainData(['BTC', 'ETH']);
    });

    // æ¯å¤© UTC 00:00 æ‹‰å–å‰ä¸€æ—¥å®Œæ•´æ•°æ®
    this.scheduleJob('daily-aggregation', '0 0 * * *', async () => {
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      yesterday.setHours(0, 0, 0, 0);
      
      await this.aggregator.fetchDailyData(yesterday);
    });

    // å®è§‚æ•°æ®: æ¯å‘¨ä¸€ UTC 10:00 (è¦†ç›–ä¸»è¦ç»æµæ•°æ®å‘å¸ƒ)
    this.scheduleJob('macro-data', '0 10 * * 1', async () => {
      await this.aggregator.fetchMacroData();
    });

    logger.info(\`Started \${this.jobs.size} data cron jobs\`);
  }

  /**
   * åœæ­¢æ‰€æœ‰ä»»åŠ¡
   */
  stop() {
    this.jobs.forEach(job => job.stop());
    this.jobs.clear();
    logger.info('Stopped all data cron jobs');
  }

  private scheduleJob(name: string, schedule: string, task: () => Promise<void>) {
    const job = cron.schedule(schedule, async () => {
      logger.info(\`[Cron] Running: \${name}\`);
      try {
        await task();
        logger.info(\`[Cron] Completed: \${name}\`);
      } catch (error: any) {
        logger.error(\`[Cron] Failed: \${name}\`, { error: error.message });
        
        // å¯é‡è¯•é”™è¯¯: 5 åˆ†é’Ÿåé‡è¯•ä¸€æ¬¡
        if (error.retryable) {
          setTimeout(() => {
            logger.info(\`[Cron] Retrying: \${name}\`);
            task().catch(e => logger.error(\`[Cron] Retry failed: \${name}\`, e));
          }, 5 * 60 * 1000);
        }
      }
    });

    this.jobs.set(name, job);
  }
}
\`\`\`

**åˆ›å»ºæ•°æ®èšåˆå™¨ï¼š\`packages/data-scheduler/src/aggregator.ts\`**

\`\`\`typescript
import { CoinGeckoAdapter } from '@finverse/data-adapters/coingecko';
import { YahooFinanceAdapter } from '@finverse/data-adapters/yahoo-finance';
import { GlassnodeAdapter } from '@finverse/data-adapters/glassnode';
import { PriceDataPoint, OnChainData } from '@finverse/data-schema';
import { db } from '@finverse/database';

/**
 * ç»Ÿä¸€æ•°æ®èšåˆå™¨
 * ä»å¤šä¸ªæ•°æ®æºæ‹‰å–å¹¶å­˜å‚¨åˆ°æ•°æ®åº“
 */
export class DataAggregator {
  private coinGecko: CoinGeckoAdapter;
  private yahooFinance: YahooFinanceAdapter;
  private glassnode?: GlassnodeAdapter;

  constructor(config: {
    coinGeckoKey?: string;
    glassnodeKey?: string;
  }) {
    this.coinGecko = new CoinGeckoAdapter(config.coinGeckoKey);
    this.yahooFinance = new YahooFinanceAdapter();
    
    if (config.glassnodeKey) {
      this.glassnode = new GlassnodeAdapter(config.glassnodeKey);
    }
  }

  async fetchRealtimePrices(symbols: string[]): Promise<void> {
    const results = await Promise.allSettled(
      symbols.map(async (symbol) => {
        const isCrypto = symbol.includes('/');
        const adapter = isCrypto ? this.coinGecko : this.yahooFinance;
        
        const asset = {
          symbol,
          type: isCrypto ? 'crypto' : 'stock',
          category: isCrypto ? 'crypto_spot' : 'us_equity'
        };

        const price = await adapter.getCurrentPrice(asset as any);
        
        // å­˜å‚¨åˆ° Redis (å®æ—¶) + PostgreSQL (å†å²)
        await Promise.all([
          db.redis.setex(\`price:\${symbol}:latest\`, 300, JSON.stringify(price)),
          db.postgres.query(
            \`INSERT INTO price_data (symbol, timestamp, open, high, low, close, volume, source)
             VALUES (\$1, \$2, \$3, \$4, \$5, \$6, \$7, \$8)
             ON CONFLICT (symbol, timestamp) DO UPDATE SET close = \$6, volume = \$7\`,
            [symbol, new Date(price.timestamp), price.open, price.high, price.low, price.close, price.volume, price.source]
          )
        ]);
      })
    );

    const failed = results.filter(r => r.status === 'rejected');
    if (failed.length > 0) {
      logger.warn(\`Failed to fetch \${failed.length}/\${symbols.length} prices\`);
    }
  }

  async fetchOnChainData(assets: ('BTC' | 'ETH')[]): Promise<void> {
    if (!this.glassnode) {
      logger.warn('Glassnode not configured, skipping on-chain data');
      return;
    }

    const now = Math.floor(Date.now() / 1000);
    const oneDayAgo = now - 86400;

    for (const asset of assets) {
      try {
        const flows = await this.glassnode.getExchangeFlows(asset, oneDayAgo, now);
        
        for (const data of flows) {
          await db.postgres.query(
            \`INSERT INTO onchain_data (asset, timestamp, exchange_inflow, exchange_outflow, source)
             VALUES (\$1, \$2, \$3, \$4, \$5)
             ON CONFLICT (asset, timestamp) DO NOTHING\`,
            [asset, new Date(data.timestamp), data.exchange_inflow, data.exchange_outflow, data.source]
          );
        }
      } catch (error: any) {
        logger.error(\`Failed to fetch on-chain data for \${asset}:\`, error.message);
      }
    }
  }

  async fetchDailyData(date: Date): Promise<void> {
    // æ‹‰å–å‰ä¸€æ—¥å®Œæ•´ OHLCV æ•°æ®
    logger.info(\`Fetching daily data for \${date.toISOString().split('T')[0]}\`);
    
    // å®ç°çœç•¥,ä¸ fetchRealtimePrices ç±»ä¼¼ä½†ä½¿ç”¨ getHistoricalPrices
  }

  async fetchMacroData(): Promise<void> {
    // ä» FRED API æ‹‰å–å®è§‚æ•°æ®
    logger.info('Fetching macro economic data');
    
    // å®ç°çœç•¥
  }
}
\`\`\`

---

### 13.6 é”™è¯¯å¤„ç†ä¸é‡è¯•æœºåˆ¶

**åˆ›å»ºæ–‡ä»¶ï¼š\`packages/data-adapters/src/utils/retry.ts\`**

\`\`\`typescript
import { DataFetchError } from '@finverse/data-schema';
import { logger } from '@finverse/logger';

/**
 * æŒ‡æ•°é€€é¿é‡è¯•
 */
export async function retryWithBackoff<T>(
  fn: () => Promise<T>,
  options: {
    maxRetries?: number;
    initialDelayMs?: number;
    maxDelayMs?: number;
    shouldRetry?: (error: any) => boolean;
  } = {}
): Promise<T> {
  const {
    maxRetries = 3,
    initialDelayMs = 1000,
    maxDelayMs = 30000,
    shouldRetry = (error) => error instanceof DataFetchError && error.retryable
  } = options;

  let lastError: any;
  
  for (let attempt = 0; attempt <= maxRetries; attempt++) {
    try {
      return await fn();
    } catch (error) {
      lastError = error;
      
      if (!shouldRetry(error) || attempt === maxRetries) {
        throw error;
      }

      const delay = Math.min(
        initialDelayMs * Math.pow(2, attempt),
        maxDelayMs
      );

      logger.warn(\`Retry attempt \${attempt + 1}/\${maxRetries} after \${delay}ms\`, {
        error: error instanceof Error ? error.message : String(error)
      });

      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }

  throw lastError;
}

/**
 * æ–­è·¯å™¨æ¨¡å¼
 * é˜²æ­¢æŒç»­è°ƒç”¨å¤±è´¥çš„æœåŠ¡
 */
export class CircuitBreaker {
  private failureCount = 0;
  private lastFailureTime = 0;
  private state: 'closed' | 'open' | 'half-open' = 'closed';

  constructor(
    private threshold: number = 5,          // å¤±è´¥æ¬¡æ•°é˜ˆå€¼
    private timeoutMs: number = 60000,      // æ–­è·¯å™¨æ‰“å¼€æ—¶é•¿
    private halfOpenAttempts: number = 3    // åŠå¼€çŠ¶æ€æµ‹è¯•æ¬¡æ•°
  ) {}

  async execute<T>(fn: () => Promise<T>): Promise<T> {
    if (this.state === 'open') {
      if (Date.now() - this.lastFailureTime > this.timeoutMs) {
        this.state = 'half-open';
        logger.info('Circuit breaker entering half-open state');
      } else {
        throw new Error('Circuit breaker is OPEN');
      }
    }

    try {
      const result = await fn();
      this.onSuccess();
      return result;
    } catch (error) {
      this.onFailure();
      throw error;
    }
  }

  private onSuccess() {
    this.failureCount = 0;
    if (this.state === 'half-open') {
      this.state = 'closed';
      logger.info('Circuit breaker closed');
    }
  }

  private onFailure() {
    this.failureCount++;
    this.lastFailureTime = Date.now();

    if (this.failureCount >= this.threshold) {
      this.state = 'open';
      logger.error('Circuit breaker OPENED', { failureCount: this.failureCount });
    }
  }

  getState() {
    return this.state;
  }
}
\`\`\`

---

## åå››ã€å·²çŸ¥é£é™©ä¸å¯¹ç­– - å®‰å…¨ä¸ä¿¡èª‰ç³»ç»Ÿå¼€å‘æç¤ºè¯

### 14.1 Agent ä¿¡èª‰è¯„åˆ†ç®—æ³•

**åˆ›å»ºæ–‡ä»¶ï¼š\`packages/reputation/src/scoring.ts\`**

\`\`\`typescript
/**
 * Agent ä¿¡èª‰è¯„åˆ†ç³»ç»Ÿ
 * 
 * è¯„åˆ†ç»´åº¦:
 * 1. å†å²ä¿¡å·å‡†ç¡®ç‡ (40%)
 * 2. ä¿¡å·é¢‘ç‡ç¨³å®šæ€§ (20%)
 * 3. è´¦æˆ·å¹´é¾„ (15%)
 * 4. ç¤¾åŒºåé¦ˆ (15%)
 * 5. å¼‚å¸¸è¡Œä¸ºæƒ©ç½š (10%)
 */

export interface SignalHistory {
  agentId: string;
  timestamp: number;
  asset: string;
  signal: 'bullish' | 'bearish' | 'neutral';
  confidence: number;       // 0-1
  timeframe: string;        // '24h', '48h', '1w'
  actualOutcome?: 'correct' | 'incorrect' | 'pending';
}

export interface ReputationScore {
  agentId: string;
  totalScore: number;       // 0-100
  breakdown: {
    accuracy: number;       // 0-40
    stability: number;      // 0-20
    age: number;           // 0-15
    community: number;      // 0-15
    penalty: number;        // 0 to -10
  };
  tier: 'novice' | 'reliable' | 'expert' | 'master';
  lastUpdated: Date;
}

export class ReputationEngine {
  /**
   * è®¡ç®— Agent ä¿¡èª‰è¯„åˆ†
   */
  async calculateScore(agentId: string): Promise<ReputationScore> {
    const [signals, account, feedback, anomalies] = await Promise.all([
      this.getSignalHistory(agentId, 90), // æœ€è¿‘ 90 å¤©
      this.getAccountInfo(agentId),
      this.getCommunityFeedback(agentId),
      this.getAnomalyFlags(agentId)
    ]);

    const accuracy = this.calculateAccuracy(signals);
    const stability = this.calculateStability(signals);
    const age = this.calculateAgeScore(account.createdAt);
    const community = this.calculateCommunityScore(feedback);
    const penalty = this.calculatePenalty(anomalies);

    const totalScore = Math.max(0, Math.min(100,
      accuracy + stability + age + community + penalty
    ));

    return {
      agentId,
      totalScore,
      breakdown: { accuracy, stability, age, community, penalty },
      tier: this.getTier(totalScore),
      lastUpdated: new Date()
    };
  }

  /**
   * å‡†ç¡®ç‡è¯„åˆ† (0-40 åˆ†)
   * 
   * å…¬å¼:
   * - è®¡ç®—æœ€è¿‘ N ä¸ªå·²éªŒè¯ä¿¡å·çš„å‡†ç¡®ç‡
   * - æ ¹æ® confidence åŠ æƒ (é«˜ç½®ä¿¡åº¦é”™è¯¯æƒ©ç½šæ›´é‡)
   * - æ—¶é—´è¡°å‡ (è¶Šè¿‘çš„ä¿¡å·æƒé‡è¶Šé«˜)
   */
  private calculateAccuracy(signals: SignalHistory[]): number {
    const verified = signals.filter(s => s.actualOutcome !== 'pending');
    
    if (verified.length === 0) {
      return 20; // æ–° Agent é»˜è®¤ä¸­ç­‰åˆ†
    }

    let weightedCorrect = 0;
    let totalWeight = 0;

    verified.forEach((signal, index) => {
      // æ—¶é—´è¡°å‡: æœ€æ–°çš„ä¿¡å·æƒé‡ 1.0, æœ€æ—§çš„ 0.5
      const recencyWeight = 0.5 + 0.5 * (index / verified.length);
      
      // ç½®ä¿¡åº¦æƒé‡: é«˜ç½®ä¿¡åº¦ä¿¡å·æƒé‡æ›´å¤§
      const confidenceWeight = 0.5 + signal.confidence * 0.5;
      
      const weight = recencyWeight * confidenceWeight;
      totalWeight += weight;

      if (signal.actualOutcome === 'correct') {
        weightedCorrect += weight;
      }
    });

    const accuracyRate = weightedCorrect / totalWeight;
    
    // æ˜ å°„åˆ° 0-40 åˆ†
    // 50% å‡†ç¡®ç‡ = 10 åˆ† (éšæœºçŒœæµ‹)
    // 70% å‡†ç¡®ç‡ = 28 åˆ†
    // 90% å‡†ç¡®ç‡ = 40 åˆ†
    return Math.max(0, (accuracyRate - 0.5) * 80);
  }

  /**
   * ç¨³å®šæ€§è¯„åˆ† (0-20 åˆ†)
   * 
   * è¯„ä¼°ä¿¡å·å‘å¸ƒé¢‘ç‡çš„ç¨³å®šæ€§
   * - è¿‡äºé¢‘ç¹ (åˆ·åˆ†) -> ä½åˆ†
   * - è¿‡äºç¨€ç– (ä¸æ´»è·ƒ) -> ä½åˆ†
   * - ç¨³å®šå‘¨æœŸæ€§ -> é«˜åˆ†
   */
  private calculateStability(signals: SignalHistory[]): number {
    if (signals.length < 10) {
      return 10; // æ ·æœ¬ä¸è¶³,ç»™ä¸­ç­‰åˆ†
    }

    // è®¡ç®—ä¿¡å·é—´éš”çš„æ ‡å‡†å·®
    const intervals: number[] = [];
    for (let i = 1; i < signals.length; i++) {
      intervals.push(signals[i].timestamp - signals[i - 1].timestamp);
    }

    const mean = intervals.reduce((a, b) => a + b, 0) / intervals.length;
    const variance = intervals.reduce((sum, interval) => 
      sum + Math.pow(interval - mean, 2), 0) / intervals.length;
    const stdDev = Math.sqrt(variance);

    // å˜å¼‚ç³»æ•° (CV) = stdDev / mean
    const cv = stdDev / mean;

    // CV è¶Šå°è¶Šç¨³å®š
    // CV < 0.3 -> 20 åˆ†
    // CV = 1.0 -> 10 åˆ†
    // CV > 2.0 -> 0 åˆ†
    if (cv < 0.3) return 20;
    if (cv > 2.0) return 0;
    return 20 - (cv - 0.3) / 1.7 * 20;
  }

  /**
   * è´¦æˆ·å¹´é¾„è¯„åˆ† (0-15 åˆ†)
   * 
   * - æ–°æ³¨å†Œ: 0 åˆ†
   * - 1 ä¸ªæœˆ: 5 åˆ†
   * - 3 ä¸ªæœˆ: 10 åˆ†
   * - 6+ ä¸ªæœˆ: 15 åˆ†
   */
  private calculateAgeScore(createdAt: Date): number {
    const ageInDays = (Date.now() - createdAt.getTime()) / (1000 * 60 * 60 * 24);
    
    if (ageInDays < 30) return ageInDays / 30 * 5;
    if (ageInDays < 90) return 5 + (ageInDays - 30) / 60 * 5;
    if (ageInDays < 180) return 10 + (ageInDays - 90) / 90 * 5;
    return 15;
  }

  /**
   * ç¤¾åŒºåé¦ˆè¯„åˆ† (0-15 åˆ†)
   * 
   * åŸºäºå…¶ä»–ç”¨æˆ·å¯¹è¯¥ Agent ä¿¡å·çš„åé¦ˆ
   * - ç‚¹èµ/ç‚¹è¸©æ¯”ä¾‹
   * - è¯„è®ºè´¨é‡
   */
  private calculateCommunityScore(feedback: any): number {
    const { upvotes = 0, downvotes = 0, totalViews = 0 } = feedback;
    
    if (totalViews === 0) return 7.5; // é»˜è®¤ä¸­ç­‰åˆ†

    const ratio = upvotes / (upvotes + downvotes + 1); // +1 é¿å…é™¤é›¶
    const engagement = (upvotes + downvotes) / totalViews;

    // é«˜ç‚¹èµç‡ + é«˜å‚ä¸åº¦ -> é«˜åˆ†
    const ratioScore = ratio * 10;
    const engagementScore = Math.min(engagement * 100, 5);

    return ratioScore + engagementScore;
  }

  /**
   * å¼‚å¸¸è¡Œä¸ºæƒ©ç½š (0 to -10 åˆ†)
   * 
   * æ£€æµ‹:
   * - çŸ­æ—¶é—´å¤§é‡å‘å¸ƒç›¸åŒä¿¡å·
   * - ä¿¡å·ä¸å¸‚åœºæ•°æ®ä¸¥é‡çŸ›ç›¾
   * - ç–‘ä¼¼æ“çºµè¡Œä¸º
   */
  private calculatePenalty(anomalies: AnomalyFlag[]): number {
    let penalty = 0;

    anomalies.forEach(flag => {
      switch (flag.type) {
        case 'spam':
          penalty -= 3;
          break;
        case 'contradiction':
          penalty -= 2;
          break;
        case 'manipulation':
          penalty -= 5;
          break;
      }
    });

    return Math.max(-10, penalty);
  }

  /**
   * æ˜ å°„åˆ°ç­‰çº§
   */
  private getTier(score: number): 'novice' | 'reliable' | 'expert' | 'master' {
    if (score >= 80) return 'master';
    if (score >= 65) return 'expert';
    if (score >= 50) return 'reliable';
    return 'novice';
  }

  // æ•°æ®åº“æŸ¥è¯¢æ–¹æ³• (å®ç°çœç•¥)
  private async getSignalHistory(agentId: string, days: number): Promise<SignalHistory[]> {
    // ä»æ•°æ®åº“æŸ¥è¯¢
    return [];
  }

  private async getAccountInfo(agentId: string): Promise<any> {
    return { createdAt: new Date() };
  }

  private async getCommunityFeedback(agentId: string): Promise<any> {
    return {};
  }

  private async getAnomalyFlags(agentId: string): Promise<AnomalyFlag[]> {
    return [];
  }
}

interface AnomalyFlag {
  type: 'spam' | 'contradiction' | 'manipulation';
  timestamp: Date;
  details: string;
}
\`\`\`

---

### 14.2 å¼‚å¸¸æ£€æµ‹è§„åˆ™

**åˆ›å»ºæ–‡ä»¶ï¼š\`packages/reputation/src/anomaly-detector.ts\`**

\`\`\`typescript
import { SignalHistory } from './scoring';
import { db } from '@finverse/database';
import { logger } from '@finverse/logger';

/**
 * å¼‚å¸¸è¡Œä¸ºæ£€æµ‹å™¨
 */
export class AnomalyDetector {
  /**
   * æ£€æµ‹åƒåœ¾ä¿¡å· (Spam)
   * 
   * è§„åˆ™:
   * - 1 å°æ—¶å†…å‘å¸ƒ > 10 ä¸ªä¿¡å·
   * - è¿ç»­ 5+ ä¸ªä¿¡å·å®Œå…¨ç›¸åŒ
   */
  async detectSpam(agentId: string): Promise<boolean> {
    const oneHourAgo = Date.now() - 3600000;
    const recentSignals = await db.query<SignalHistory>(
      'SELECT * FROM signals WHERE agent_id = \$1 AND timestamp > \$2 ORDER BY timestamp DESC',
      [agentId, oneHourAgo]
    );

    // æ£€æŸ¥æ•°é‡
    if (recentSignals.length > 10) {
      await this.flagAnomaly(agentId, 'spam', \`\${recentSignals.length} signals in 1 hour\`);
      return true;
    }

    // æ£€æŸ¥é‡å¤
    const duplicates = this.findConsecutiveDuplicates(recentSignals, 5);
    if (duplicates) {
      await this.flagAnomaly(agentId, 'spam', 'Consecutive duplicate signals');
      return true;
    }

    return false;
  }

  /**
   * æ£€æµ‹çŸ›ç›¾ä¿¡å·
   * 
   * è§„åˆ™:
   * - ä¿¡å·æ–¹å‘ä¸å®é™…ä»·æ ¼èµ°åŠ¿å®Œå…¨ç›¸å
   * - ä¾‹: å‘å¸ƒ "bullish" ä¿¡å·æ—¶ä»·æ ¼æš´è·Œ -5%
   */
  async detectContradiction(signal: SignalHistory): Promise<boolean> {
    // è·å–ä¿¡å·å‘å¸ƒåçš„å®é™…ä»·æ ¼å˜åŠ¨
    const actualChange = await this.getPriceChange(
      signal.asset,
      signal.timestamp,
      signal.timeframe
    );

    const expectedDirection = signal.signal === 'bullish' ? 1 : -1;
    const actualDirection = Math.sign(actualChange);

    // é«˜ç½®ä¿¡åº¦ä¿¡å· + ç›¸åèµ°åŠ¿ + å˜åŠ¨å¹…åº¦ > 3%
    if (
      signal.confidence > 0.7 &&
      expectedDirection !== actualDirection &&
      Math.abs(actualChange) > 0.03
    ) {
      await this.flagAnomaly(
        signal.agentId,
        'contradiction',
        \`Signal: \${signal.signal}, Actual: \${actualChange.toFixed(2)}%\`
      );
      return true;
    }

    return false;
  }

  /**
   * æ£€æµ‹æ“çºµè¡Œä¸º
   * 
   * è§„åˆ™:
   * - ä¸å…¶ä»– Agent é«˜åº¦ååŒ (ç–‘ä¼¼åƒµå°¸ç½‘ç»œ)
   * - åœ¨å°å¸‚å€¼å¸ç§ä¸Šå‘å¸ƒæç«¯ä¿¡å·
   */
  async detectManipulation(agentId: string): Promise<boolean> {
    // æ£€æµ‹ä¸å…¶ä»– Agent çš„ç›¸å…³æ€§
    const correlatedAgents = await this.findCorrelatedAgents(agentId);
    
    if (correlatedAgents.length > 5) {
      // ä¸ 5+ ä¸ª Agent é«˜åº¦åŒæ­¥ (>90% ç›¸åŒä¿¡å·)
      await this.flagAnomaly(
        agentId,
        'manipulation',
        \`Correlated with \${correlatedAgents.length} agents\`
      );
      return true;
    }

    return false;
  }

  /**
   * æŸ¥æ‰¾è¿ç»­é‡å¤ä¿¡å·
   */
  private findConsecutiveDuplicates(signals: SignalHistory[], threshold: number): boolean {
    for (let i = 0; i < signals.length - threshold + 1; i++) {
      const slice = signals.slice(i, i + threshold);
      const first = slice[0];
      
      const allSame = slice.every(s =>
        s.asset === first.asset &&
        s.signal === first.signal &&
        Math.abs(s.confidence - first.confidence) < 0.05
      );

      if (allSame) return true;
    }
    return false;
  }

  /**
   * è®¡ç®—ä»·æ ¼å˜åŠ¨
   */
  private async getPriceChange(asset: string, fromTimestamp: number, timeframe: string): Promise<number> {
    const duration = this.parseTimeframe(timeframe);
    const toTimestamp = fromTimestamp + duration;

    const [startPrice, endPrice] = await Promise.all([
      db.queryOne<number>('SELECT close FROM price_data WHERE asset = \$1 AND timestamp >= \$2 ORDER BY timestamp ASC LIMIT 1', [asset, fromTimestamp]),
      db.queryOne<number>('SELECT close FROM price_data WHERE asset = \$1 AND timestamp <= \$2 ORDER BY timestamp DESC LIMIT 1', [asset, toTimestamp])
    ]);

    if (!startPrice || !endPrice) return 0;
    return (endPrice - startPrice) / startPrice;
  }

  private parseTimeframe(timeframe: string): number {
    const match = timeframe.match(/(\\d+)([hd])/);
    if (!match) return 86400000; // é»˜è®¤ 24h

    const [, num, unit] = match;
    const multiplier = unit === 'h' ? 3600000 : 86400000;
    return parseInt(num) * multiplier;
  }

  /**
   * æŸ¥æ‰¾ç›¸å…³ Agent
   */
  private async findCorrelatedAgents(agentId: string): Promise<string[]> {
    // å¤æ‚ç®—æ³•,çœç•¥å®ç°
    // æ€è·¯: è®¡ç®—ä¿¡å·å‘å¸ƒæ—¶é—´å’Œå†…å®¹çš„çš®å°”é€Šç›¸å…³ç³»æ•°
    return [];
  }

  /**
   * è®°å½•å¼‚å¸¸æ ‡è®°
   */
  private async flagAnomaly(agentId: string, type: string, details: string): Promise<void> {
    await db.query(
      'INSERT INTO anomaly_flags (agent_id, type, details, timestamp) VALUES (\$1, \$2, \$3, \$4)',
      [agentId, type, details, Date.now()]
    );

    logger.warn(\`Anomaly detected: \${agentId} - \${type}\`, { details });
  }
}
\`\`\`

---

### 14.3 API Key åŠ å¯†æ–¹æ¡ˆ (AES-256-GCM)

**åˆ›å»ºæ–‡ä»¶ï¼š\`packages/security/src/encryption.ts\`**

\`\`\`typescript
import crypto from 'crypto';

/**
 * API Key åŠ å¯†æœåŠ¡
 * 
 * ä½¿ç”¨ AES-256-GCM (Galois/Counter Mode)
 * - è®¤è¯åŠ å¯† (Authenticated Encryption)
 * - é˜²æ­¢ç¯¡æ”¹
 * - æ¯ä¸ª key ä½¿ç”¨å”¯ä¸€ IV (åˆå§‹åŒ–å‘é‡)
 */
export class EncryptionService {
  private algorithm = 'aes-256-gcm';
  private masterKey: Buffer;

  constructor(masterKeyHex: string) {
    // ä¸»å¯†é’¥ä»ç¯å¢ƒå˜é‡è¯»å– (32 å­—èŠ‚ = 256 ä½)
    this.masterKey = Buffer.from(masterKeyHex, 'hex');
    
    if (this.masterKey.length !== 32) {
      throw new Error('Master key must be 32 bytes (256 bits)');
    }
  }

  /**
   * åŠ å¯† API key
   * 
   * @returns æ ¼å¼: iv:authTag:ciphertext (å…¨éƒ¨ hex ç¼–ç )
   */
  encrypt(apiKey: string): string {
    // ç”Ÿæˆéšæœº IV (12 å­—èŠ‚æ¨èç”¨äº GCM)
    const iv = crypto.randomBytes(12);
    
    const cipher = crypto.createCipheriv(this.algorithm, this.masterKey, iv);
    
    let ciphertext = cipher.update(apiKey, 'utf8', 'hex');
    ciphertext += cipher.final('hex');
    
    // GCM æ¨¡å¼æä¾›è®¤è¯æ ‡ç­¾
    const authTag = cipher.getAuthTag();

    // ç»„åˆ: iv:authTag:ciphertext
    return [
      iv.toString('hex'),
      authTag.toString('hex'),
      ciphertext
    ].join(':');
  }

  /**
   * è§£å¯† API key
   */
  decrypt(encrypted: string): string {
    const [ivHex, authTagHex, ciphertext] = encrypted.split(':');
    
    if (!ivHex || !authTagHex || !ciphertext) {
      throw new Error('Invalid encrypted format');
    }

    const iv = Buffer.from(ivHex, 'hex');
    const authTag = Buffer.from(authTagHex, 'hex');

    const decipher = crypto.createDecipheriv(this.algorithm, this.masterKey, iv);
    decipher.setAuthTag(authTag);

    let plaintext = decipher.update(ciphertext, 'hex', 'utf8');
    plaintext += decipher.final('utf8');

    return plaintext;
  }

  /**
   * ç”Ÿæˆæ–°çš„ä¸»å¯†é’¥ (ä»…ç”¨äºåˆå§‹åŒ–)
   */
  static generateMasterKey(): string {
    return crypto.randomBytes(32).toString('hex');
  }
}

/**
 * ä½¿ç”¨ç¤ºä¾‹
 */
// const encryption = new EncryptionService(process.env.MASTER_KEY!);
// const encrypted = encryption.encrypt('sk-abc123...');
// console.log(encrypted); // è¾“å‡º: 3a7b...f2:8c1d...a9:d4e6...
// const decrypted = encryption.decrypt(encrypted);
// console.log(decrypted); // è¾“å‡º: sk-abc123...
\`\`\`

**æ•°æ®åº“å­˜å‚¨æ–¹æ¡ˆï¼š\`migrations/001_api_keys.sql\`**

\`\`\`sql
CREATE TABLE user_api_keys (
  user_id UUID NOT NULL,
  service VARCHAR(50) NOT NULL,  -- 'openai', 'anthropic', 'glassnode', etc.
  encrypted_key TEXT NOT NULL,    -- åŠ å¯†åçš„ key
  created_at TIMESTAMPTZ DEFAULT NOW(),
  last_used_at TIMESTAMPTZ,
  
  PRIMARY KEY (user_id, service)
);

-- ç´¢å¼•
CREATE INDEX idx_api_keys_user ON user_api_keys(user_id);

-- å®¡è®¡æ—¥å¿—
CREATE TABLE api_key_audit (
  id SERIAL PRIMARY KEY,
  user_id UUID NOT NULL,
  service VARCHAR(50) NOT NULL,
  action VARCHAR(20) NOT NULL,  -- 'created', 'updated', 'deleted', 'decrypted'
  ip_address INET,
  timestamp TIMESTAMPTZ DEFAULT NOW()
);
\`\`\`

**ä½¿ç”¨ API Key æ—¶çš„å®‰å…¨æµç¨‹ï¼š**

\`\`\`typescript
// packages/agent-runtime/src/api-key-manager.ts
import { EncryptionService } from '@finverse/security';
import { db } from '@finverse/database';

export class ApiKeyManager {
  constructor(private encryption: EncryptionService) {}

  /**
   * å­˜å‚¨ç”¨æˆ· API key
   */
  async storeKey(userId: string, service: string, apiKey: string): Promise<void> {
    const encrypted = this.encryption.encrypt(apiKey);
    
    await db.query(
      \`INSERT INTO user_api_keys (user_id, service, encrypted_key)
       VALUES (\$1, \$2, \$3)
       ON CONFLICT (user_id, service) DO UPDATE SET encrypted_key = \$3\`,
      [userId, service, encrypted]
    );

    // å®¡è®¡æ—¥å¿—
    await db.query(
      'INSERT INTO api_key_audit (user_id, service, action) VALUES (\$1, \$2, \$3)',
      [userId, service, 'created']
    );
  }

  /**
   * è·å–è§£å¯†åçš„ API key (ä»…åœ¨ Agent å®¹å™¨å†…è°ƒç”¨)
   */
  async getKey(userId: string, service: string): Promise<string | null> {
    const result = await db.queryOne<{ encrypted_key: string }>(
      'SELECT encrypted_key FROM user_api_keys WHERE user_id = \$1 AND service = \$2',
      [userId, service]
    );

    if (!result) return null;

    const decrypted = this.encryption.decrypt(result.encrypted_key);

    // æ›´æ–°æœ€åä½¿ç”¨æ—¶é—´
    await db.query(
      'UPDATE user_api_keys SET last_used_at = NOW() WHERE user_id = \$1 AND service = \$2',
      [userId, service]
    );

    return decrypted;
  }

  /**
   * åˆ é™¤ API key
   */
  async deleteKey(userId: string, service: string): Promise<void> {
    await db.query(
      'DELETE FROM user_api_keys WHERE user_id = \$1 AND service = \$2',
      [userId, service]
    );

    await db.query(
      'INSERT INTO api_key_audit (user_id, service, action) VALUES (\$1, \$2, \$3)',
      [userId, service, 'deleted']
    );
  }
}
\`\`\`

---

### 14.4 å…è´£å£°æ˜ç»„ä»¶

**åˆ›å»ºæ–‡ä»¶ï¼š\`packages/ui/src/components/DisclaimerBanner.tsx\`**

\`\`\`tsx
import React, { useState, useEffect } from 'react';
import { AlertTriangle, X } from 'lucide-react';

/**
 * å…è´£å£°æ˜æ¨ªå¹…
 * 
 * ä½ç½®:
 * - æ¯ä¸ª AI åˆ†æç»“æœä¸‹æ–¹
 * - ä¿¡å·å‘å¸ƒé¡µé¢é¡¶éƒ¨
 * - å°ç»„åˆ†æé¡µé¢
 */
export const DisclaimerBanner: React.FC<{
  variant?: 'default' | 'compact';
  dismissible?: boolean;
}> = ({ variant = 'default', dismissible = false }) => {
  const [dismissed, setDismissed] = useState(false);

  useEffect(() => {
    // æ£€æŸ¥æœ¬åœ°å­˜å‚¨æ˜¯å¦å·²æ°¸ä¹…å…³é—­
    const permanentlyDismissed = localStorage.getItem('disclaimer_dismissed');
    if (permanentlyDismissed === 'true') {
      setDismissed(true);
    }
  }, []);

  if (dismissed) return null;

  const handleDismiss = () => {
    setDismissed(true);
    if (dismissible) {
      localStorage.setItem('disclaimer_dismissed', 'true');
    }
  };

  if (variant === 'compact') {
    return (
      <div className="flex items-center gap-2 px-3 py-2 bg-yellow-50 border-l-4 border-yellow-400 text-sm text-yellow-800">
        <AlertTriangle size={16} />
        <span>AI åˆ†æä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®</span>
      </div>
    );
  }

  return (
    <div className="relative bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200 rounded-lg p-4 shadow-sm">
      {dismissible && (
        <button
          onClick={handleDismiss}
          className="absolute top-2 right-2 text-yellow-600 hover:text-yellow-800"
          aria-label="å…³é—­"
        >
          <X size={20} />
        </button>
      )}
      
      <div className="flex items-start gap-3">
        <AlertTriangle className="text-yellow-600 flex-shrink-0 mt-1" size={24} />
        
        <div className="flex-1">
          <h3 className="font-semibold text-yellow-900 mb-2">æŠ•èµ„é£é™©æç¤º</h3>
          
          <ul className="space-y-1 text-sm text-yellow-800">
            <li>â€¢ æ‰€æœ‰åˆ†æå‡ç”± AI ç”Ÿæˆï¼Œ<strong>ä¸æ„æˆæŠ•èµ„å»ºè®®</strong></li>
            <li>â€¢ FinVerse ä¸æä¾›é‡‘èå’¨è¯¢æœåŠ¡ï¼Œä¸æ‰¿æ‹…ä»»ä½•æŠ•èµ„æŸå¤±è´£ä»»</li>
            <li>â€¢ AI å¯èƒ½äº§ç”Ÿé”™è¯¯ã€åè§æˆ–è¿‡æ—¶çš„ä¿¡æ¯</li>
            <li>â€¢ è¯·åŸºäºæ‚¨è‡ªå·±çš„ç ”ç©¶å’Œé£é™©æ‰¿å—èƒ½åŠ›åšå‡ºæŠ•èµ„å†³ç­–</li>
            <li>â€¢ è¿‡å¾€è¡¨ç°ä¸ä»£è¡¨æœªæ¥æ”¶ç›Š</li>
          </ul>

          <p className="mt-3 text-xs text-yellow-700">
            ä½¿ç”¨æœ¬å¹³å°å³è¡¨ç¤ºæ‚¨åŒæ„ <a href="/terms" className="underline">æœåŠ¡æ¡æ¬¾</a> å’Œ <a href="/risk" className="underline">é£é™©å£°æ˜</a>
          </p>
        </div>
      </div>
    </div>
  );
};

/**
 * AI åˆ†æå¡ç‰‡åŒ…è£…å™¨
 * è‡ªåŠ¨åœ¨åˆ†æä¸‹æ–¹é™„åŠ å…è´£å£°æ˜
 */
export const AIAnalysisCard: React.FC<{
  children: React.ReactNode;
  showDisclaimer?: boolean;
}> = ({ children, showDisclaimer = true }) => {
  return (
    <div className="space-y-3">
      <div className="bg-white rounded-lg border border-gray-200 p-4">
        {children}
      </div>
      
      {showDisclaimer && <DisclaimerBanner variant="compact" />}
    </div>
  );
};
\`\`\`

**æ³•å¾‹æ–‡æœ¬ï¼š\`public/legal/risk-disclosure.md\`**

\`\`\`markdown
# é£é™©æŠ«éœ²å£°æ˜

**æœ€åæ›´æ–°: 2026-02-07**

## 1. æœåŠ¡æ€§è´¨

FinVerse æ˜¯ä¸€ä¸ªæŠ€æœ¯å¹³å°ï¼Œæä¾›ä»¥ä¸‹æœåŠ¡ï¼š
- AI Agent æ‰˜ç®¡å’Œè¿è¡Œç¯å¢ƒ
- æ•°æ®å¯è§†åŒ–å·¥å…·
- ç¤¾åŒºåä½œåŠŸèƒ½

FinVerse **ä¸æ˜¯**ï¼š
- æŒç‰Œé‡‘èé¡¾é—®
- æŠ•èµ„å»ºè®®æä¾›å•†
- ç»çºªå•†æˆ–äº¤æ˜“å¹³å°

## 2. AI ç”Ÿæˆå†…å®¹çš„é™åˆ¶

å¹³å°ä¸Šæ‰€æœ‰ AI ç”Ÿæˆçš„åˆ†æã€ä¿¡å·ã€é¢„æµ‹å‡å­˜åœ¨ä»¥ä¸‹é™åˆ¶ï¼š

- **éç¡®å®šæ€§**: AI æ¨¡å‹åŸºäºæ¦‚ç‡ï¼Œè¾“å‡ºå¯èƒ½ä¸å‡†ç¡®
- **æ•°æ®å»¶è¿Ÿ**: å®æ—¶æ•°æ®å¯èƒ½æœ‰å»¶è¿Ÿï¼Œå½±å“åˆ†ææ—¶æ•ˆæ€§
- **æ¨¡å‹åè§**: AI å¯èƒ½ç»§æ‰¿è®­ç»ƒæ•°æ®ä¸­çš„åè§
- **ä¸å¯é¢„æµ‹**: é‡‘èå¸‚åœºå—å¤æ‚å› ç´ å½±å“ï¼ŒAI æ— æ³•é¢„æµ‹æ‰€æœ‰æƒ…å†µ

## 3. ç”¨æˆ·è´£ä»»

æ‚¨ç†è§£å¹¶åŒæ„ï¼š

- æ‚¨å¯¹è‡ªå·±çš„æŠ•èµ„å†³ç­–å®Œå…¨è´Ÿè´£
- æ‚¨åº”è¯¥è¿›è¡Œç‹¬ç«‹ç ”ç©¶å’Œå°½èŒè°ƒæŸ¥
- æ‚¨åº”è¯¥å’¨è¯¢æŒç‰Œä¸“ä¸šäººå£«ï¼ˆå¦‚æœ‰éœ€è¦ï¼‰
- æ‚¨ç†è§£æŠ•èµ„å­˜åœ¨æœ¬é‡‘æŸå¤±é£é™©

## 4. å…è´£æ¡æ¬¾

åœ¨æ³•å¾‹å…è®¸çš„æœ€å¤§èŒƒå›´å†…ï¼ŒFinVerse åŠå…¶å…³è”æ–¹ï¼š

- ä¸å¯¹ä»»ä½•æŠ•èµ„æŸå¤±è´Ÿè´£
- ä¸ä¿è¯å¹³å°æœåŠ¡çš„å‡†ç¡®æ€§ã€å®Œæ•´æ€§ã€åŠæ—¶æ€§
- ä¸ä¿è¯ AI åˆ†æçš„è´¨é‡æˆ–å¯é æ€§
- ä¸å¯¹ç¬¬ä¸‰æ–¹æ•°æ®æºçš„é”™è¯¯è´Ÿè´£

## 5. åˆè§„å£°æ˜

FinVerse åœ¨ä¸åŒå¸æ³•ç®¡è¾–åŒºå¯èƒ½å—ä¸åŒç›‘ç®¡ï¼š

- ç¾å›½: ä¸æä¾› SEC/FINRA ç›‘ç®¡çš„æŠ•èµ„å»ºè®®
- æ¬§ç›Ÿ: éµå®ˆ MiFID II å’Œ GDPR
- ä¸­å›½: ä¸é¢å‘ä¸­å›½å¤§é™†å±…æ°‘æä¾›æœåŠ¡

è¯·ç¡®ä¿æ‚¨æ‰€åœ¨åœ°åŒºå…è®¸ä½¿ç”¨æ­¤ç±»æœåŠ¡ã€‚

## 6. åŒæ„ç¡®è®¤

ä½¿ç”¨ FinVerse å³è¡¨ç¤ºæ‚¨å·²é˜…è¯»ã€ç†è§£å¹¶åŒæ„æœ¬é£é™©æŠ«éœ²å£°æ˜ã€‚

å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»: legal@finverse.ai
\`\`\`

---

## åäº”ã€Agent è°ƒåº¦å™¨ - å®¹å™¨ç¼–æ’å¼€å‘æç¤ºè¯

### 15.1 Docker Compose å®Œæ•´é…ç½®

**åˆ›å»ºæ–‡ä»¶ï¼š\`docker-compose.yml\`**

\`\`\`yaml
version: '3.9'

services:
  # ============================================
  # æ ¸å¿ƒæœåŠ¡
  # ============================================
  
  postgres:
    image: postgres:16-alpine
    container_name: finverse-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: finverse
      POSTGRES_USER: finverse
      POSTGRES_PASSWORD: \${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U finverse"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - finverse-network

  redis:
    image: redis:7-alpine
    container_name: finverse-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass \${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - finverse-network

  # ============================================
  # FinVerse åº”ç”¨å±‚
  # ============================================

  api:
    build:
      context: .
      dockerfile: ./apps/api/Dockerfile
    container_name: finverse-api
    restart: unless-stopped
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://finverse:\${POSTGRES_PASSWORD}@postgres:5432/finverse
      REDIS_URL: redis://:\${REDIS_PASSWORD}@redis:6379
      JWT_SECRET: \${JWT_SECRET}
      MASTER_ENCRYPTION_KEY: \${MASTER_ENCRYPTION_KEY}
    ports:
      - "3001:3001"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - finverse-network
    volumes:
      - ./logs:/app/logs

  web:
    build:
      context: .
      dockerfile: ./apps/web/Dockerfile
    container_name: finverse-web
    restart: unless-stopped
    environment:
      NEXT_PUBLIC_API_URL: \${API_URL}
    ports:
      - "3000:3000"
    depends_on:
      - api
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - finverse-network

  # ============================================
  # Agent è°ƒåº¦å™¨
  # ============================================

  agent-orchestrator:
    build:
      context: .
      dockerfile: ./apps/agent-orchestrator/Dockerfile
    container_name: finverse-orchestrator
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://finverse:\${POSTGRES_PASSWORD}@postgres:5432/finverse
      REDIS_URL: redis://:\${REDIS_PASSWORD}@redis:6379
      DOCKER_HOST: unix:///var/run/docker.sock
      MAX_AGENTS: \${MAX_AGENTS:-1000}
      AGENT_IMAGE: finverse/agent:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # Docker-in-Docker
      - agent_data:/app/data
    depends_on:
      - postgres
      - redis
    networks:
      - finverse-network
      - agent-network  # ç‹¬ç«‹ç½‘ç»œç”¨äº Agent å®¹å™¨

  # ============================================
  # ç›‘æ§ä¸æ—¥å¿—
  # ============================================

  prometheus:
    image: prom/prometheus:latest
    container_name: finverse-prometheus
    restart: unless-stopped
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    ports:
      - "9090:9090"
    networks:
      - finverse-network

  grafana:
    image: grafana/grafana:latest
    container_name: finverse-grafana
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_PASSWORD: \${GRAFANA_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
    ports:
      - "3003:3000"
    depends_on:
      - prometheus
    networks:
      - finverse-network

  # ============================================
  # åå‘ä»£ç† (ç”Ÿäº§ç¯å¢ƒ)
  # ============================================

  nginx:
    image: nginx:alpine
    container_name: finverse-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
      - ./nginx/logs:/var/log/nginx
    depends_on:
      - web
      - api
    networks:
      - finverse-network

volumes:
  postgres_data:
  redis_data:
  agent_data:
  prometheus_data:
  grafana_data:

networks:
  finverse-network:
    driver: bridge
  agent-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
\`\`\`

---

### 15.2 Agent å®¹å™¨ Dockerfile

**åˆ›å»ºæ–‡ä»¶ï¼š\`apps/agent-runtime/Dockerfile\`**

\`\`\`dockerfile
# ============================================
# Stage 1: æ„å»º OpenClaw
# ============================================
FROM node:22-alpine AS builder

WORKDIR /build

# å¤åˆ¶ package files
COPY package*.json ./
COPY packages/openclaw/package*.json ./packages/openclaw/

# å®‰è£…ä¾èµ–
RUN npm ci --production=false

# å¤åˆ¶æºä»£ç 
COPY packages/openclaw ./packages/openclaw
COPY apps/agent-runtime ./apps/agent-runtime

# æ„å»º
RUN npm run build

# ============================================
# Stage 2: è¿è¡Œæ—¶é•œåƒ
# ============================================
FROM node:22-alpine

# å®‰å…¨æ€§: é root ç”¨æˆ·è¿è¡Œ
RUN addgroup -g 1001 -S agentuser && \\
    adduser -S agentuser -u 1001

WORKDIR /app

# åªå¤åˆ¶å¿…è¦çš„æ–‡ä»¶
COPY --from=builder --chown=agentuser:agentuser /build/node_modules ./node_modules
COPY --from=builder --chown=agentuser:agentuser /build/packages/openclaw/dist ./openclaw
COPY --from=builder --chown=agentuser:agentuser /build/apps/agent-runtime/dist ./runtime

# å®‰è£…ç³»ç»Ÿä¾èµ– (Python for æ•°æ®åˆ†æè„šæœ¬)
RUN apk add --no-cache python3 py3-pip curl

# Agent å·¥ä½œç›®å½•
RUN mkdir -p /app/workspace && chown -R agentuser:agentuser /app/workspace

# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER agentuser

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \\
  CMD node -e "require('http').get('http://localhost:3100/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"

# æš´éœ²ç«¯å£ (å†…éƒ¨å¥åº·æ£€æŸ¥)
EXPOSE 3100

# å¯åŠ¨å‘½ä»¤
CMD ["node", "runtime/index.js"]
\`\`\`

---

### 15.3 Agent è°ƒåº¦å™¨å®ç°

**åˆ›å»ºæ–‡ä»¶ï¼š\`apps/agent-orchestrator/src/orchestrator.ts\`**

\`\`\`typescript
import Docker from 'dockerode';
import { EventEmitter } from 'events';
import { db } from '@finverse/database';
import { logger } from '@finverse/logger';

/**
 * Agent ç”Ÿå‘½å‘¨æœŸçŠ¶æ€
 */
export enum AgentState {
  CREATING = 'creating',
  ACTIVE = 'active',
  STANDBY = 'standby',
  HIBERNATED = 'hibernated',
  STOPPING = 'stopping',
  STOPPED = 'stopped',
  ERROR = 'error'
}

interface AgentConfig {
  userId: string;
  apiKeys: Record<string, string>;  // service -> encrypted key
  preferences: any;
  chatChannels: string[];
}

/**
 * Agent è°ƒåº¦å™¨
 * 
 * èŒè´£:
 * - åˆ›å»º/é”€æ¯ Agent å®¹å™¨
 * - å¥åº·æ£€æŸ¥
 * - è‡ªåŠ¨æ‰©ç¼©å®¹
 * - æ•…éšœæ¢å¤
 */
export class AgentOrchestrator extends EventEmitter {
  private docker: Docker;
  private agents: Map<string, AgentInstance> = new Map();
  private healthCheckInterval: NodeJS.Timeout | null = null;

  constructor() {
    super();
    this.docker = new Docker({ socketPath: '/var/run/docker.sock' });
  }

  /**
   * å¯åŠ¨è°ƒåº¦å™¨
   */
  async start(): Promise<void> {
    logger.info('Starting Agent Orchestrator');

    // æ¢å¤å·²å­˜åœ¨çš„ Agent å®¹å™¨
    await this.recoverExistingAgents();

    // å¯åŠ¨å¥åº·æ£€æŸ¥å¾ªç¯
    this.startHealthCheck();

    // å¯åŠ¨çŠ¶æ€æœºå¾ªç¯
    this.startStateMachine();

    logger.info('Agent Orchestrator started');
  }

  /**
   * åˆ›å»ºæ–° Agent
   */
  async createAgent(config: AgentConfig): Promise<AgentInstance> {
    const { userId } = config;

    logger.info(\`Creating agent for user \${userId}\`);

    try {
      // 1. åˆ›å»ºä¸“ç”¨ç½‘ç»œ (å¯é€‰,ç”¨äºéš”ç¦»)
      // const network = await this.docker.createNetwork({
      //   Name: \`agent-\${userId}\`,
      //   Driver: 'bridge'
      // });

      // 2. åˆ›å»ºå®¹å™¨
      const container = await this.docker.createContainer({
        Image: 'finverse/agent:latest',
        name: \`agent-\${userId}\`,
        
        Env: [
          \`USER_ID=\${userId}\`,
          \`API_KEYS=\${JSON.stringify(config.apiKeys)}\`,
          \`PREFERENCES=\${JSON.stringify(config.preferences)}\`,
          \`CHAT_CHANNELS=\${config.chatChannels.join(',')}\`
        ],

        // èµ„æºé™åˆ¶
        HostConfig: {
          Memory: 512 * 1024 * 1024,      // 512 MB
          MemorySwap: 1024 * 1024 * 1024, // 1 GB (å« swap)
          NanoCpus: 1 * 1e9,              // 1 CPU core
          CpuShares: 1024,                 // CPU æƒé‡
          
          // å­˜å‚¨å·
          Binds: [
            \`agent-\${userId}-data:/app/workspace\`
          ],

          // ç½‘ç»œéš”ç¦»
          NetworkMode: 'agent-network',

          // æ—¥å¿—é™åˆ¶
          LogConfig: {
            Type: 'json-file',
            Config: {
              'max-size': '10m',
              'max-file': '3'
            }
          },

          // å®‰å…¨æ€§
          SecurityOpt: ['no-new-privileges'],
          ReadonlyRootfs: false,  // Agent éœ€è¦å†™å…¥å·¥ä½œç›®å½•
          
          // é‡å¯ç­–ç•¥
          RestartPolicy: {
            Name: 'unless-stopped'
          }
        },

        Labels: {
          'finverse.agent': 'true',
          'finverse.user_id': userId,
          'finverse.created_at': new Date().toISOString()
        }
      });

      // 3. å¯åŠ¨å®¹å™¨
      await container.start();

      // 4. ç­‰å¾…å¥åº·æ£€æŸ¥é€šè¿‡
      const healthy = await this.waitForHealthy(container, 30000);
      if (!healthy) {
        throw new Error('Agent failed health check');
      }

      // 5. åˆ›å»º Agent å®ä¾‹è®°å½•
      const instance: AgentInstance = {
        userId,
        containerId: container.id,
        state: AgentState.ACTIVE,
        createdAt: new Date(),
        lastActiveAt: new Date(),
        resources: {
          memoryMB: 512,
          cpuCores: 1
        }
      };

      this.agents.set(userId, instance);

      // 6. ä¿å­˜åˆ°æ•°æ®åº“
      await db.query(
        \`INSERT INTO agent_instances (user_id, container_id, state, created_at)
         VALUES (\$1, \$2, \$3, \$4)\`,
        [userId, container.id, AgentState.ACTIVE, instance.createdAt]
      );

      logger.info(\`Agent created for user \${userId}: \${container.id}\`);
      this.emit('agent:created', instance);

      return instance;

    } catch (error: any) {
      logger.error(\`Failed to create agent for user \${userId}:\`, error);
      throw error;
    }
  }

  /**
   * åœæ­¢ Agent
   */
  async stopAgent(userId: string, graceful: boolean = true): Promise<void> {
    const instance = this.agents.get(userId);
    if (!instance) {
      throw new Error(\`Agent not found: \${userId}\`);
    }

    logger.info(\`Stopping agent for user \${userId}\`);

    try {
      const container = this.docker.getContainer(instance.containerId);

      if (graceful) {
        // ä¼˜é›…åœæ­¢: å‘é€ SIGTERM,ç­‰å¾… 10 ç§’
        await container.stop({ t: 10 });
      } else {
        // å¼ºåˆ¶åœæ­¢
        await container.kill();
      }

      instance.state = AgentState.STOPPED;
      this.agents.delete(userId);

      await db.query(
        'UPDATE agent_instances SET state = \$1, stopped_at = NOW() WHERE user_id = \$2',
        [AgentState.STOPPED, userId]
      );

      this.emit('agent:stopped', instance);

    } catch (error: any) {
      logger.error(\`Failed to stop agent for user \${userId}:\`, error);
      throw error;
    }
  }

  /**
   * ä¼‘çœ  Agent (é™ä½èµ„æºå ç”¨)
   */
  async hibernateAgent(userId: string): Promise<void> {
    const instance = this.agents.get(userId);
    if (!instance) return;

    logger.info(\`Hibernating agent for user \${userId}\`);

    try {
      const container = this.docker.getContainer(instance.containerId);
      
      // æš‚åœå®¹å™¨ (freeze cgroup)
      await container.pause();

      instance.state = AgentState.HIBERNATED;

      await db.query(
        'UPDATE agent_instances SET state = \$1 WHERE user_id = \$2',
        [AgentState.HIBERNATED, userId]
      );

      this.emit('agent:hibernated', instance);

    } catch (error: any) {
      logger.error(\`Failed to hibernate agent for user \${userId}:\`, error);
    }
  }

  /**
   * å”¤é†’ä¼‘çœ çš„ Agent
   */
  async wakeAgent(userId: string): Promise<void> {
    const instance = this.agents.get(userId);
    if (!instance || instance.state !== AgentState.HIBERNATED) return;

    logger.info(\`Waking agent for user \${userId}\`);

    try {
      const container = this.docker.getContainer(instance.containerId);
      
      await container.unpause();

      instance.state = AgentState.ACTIVE;
      instance.lastActiveAt = new Date();

      await db.query(
        'UPDATE agent_instances SET state = \$1, last_active_at = NOW() WHERE user_id = \$2',
        [AgentState.ACTIVE, userId]
      );

      this.emit('agent:woken', instance);

    } catch (error: any) {
      logger.error(\`Failed to wake agent for user \${userId}:\`, error);
    }
  }

  /**
   * å¥åº·æ£€æŸ¥å¾ªç¯
   */
  private startHealthCheck(): void {
    this.healthCheckInterval = setInterval(async () => {
      for (const [userId, instance] of this.agents.entries()) {
        try {
          const container = this.docker.getContainer(instance.containerId);
          const inspect = await container.inspect();

          // æ£€æŸ¥å®¹å™¨çŠ¶æ€
          if (!inspect.State.Running) {
            logger.warn(\`Agent container not running: \${userId}\`);
            await this.handleUnhealthyAgent(userId, 'not_running');
            continue;
          }

          // æ£€æŸ¥å¥åº·æ£€æŸ¥çŠ¶æ€
          if (inspect.State.Health?.Status === 'unhealthy') {
            logger.warn(\`Agent health check failed: \${userId}\`);
            await this.handleUnhealthyAgent(userId, 'health_check_failed');
          }

        } catch (error: any) {
          logger.error(\`Health check error for \${userId}:\`, error);
          await this.handleUnhealthyAgent(userId, 'error');
        }
      }
    }, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
  }

  /**
   * çŠ¶æ€æœºå¾ªç¯ (è‡ªåŠ¨æ‰©ç¼©å®¹)
   */
  private startStateMachine(): void {
    setInterval(async () => {
      const now = Date.now();
      const ONE_HOUR = 3600000;
      const ONE_DAY = 86400000;
      const ONE_WEEK = 604800000;

      for (const [userId, instance] of this.agents.entries()) {
        const inactiveTime = now - instance.lastActiveAt.getTime();

        // çŠ¶æ€è½¬æ¢è§„åˆ™
        if (instance.state === AgentState.ACTIVE && inactiveTime > ONE_HOUR) {
          // æ´»è·ƒ -> å¾…æœº (1 å°æ—¶æ— æ´»åŠ¨)
          instance.state = AgentState.STANDBY;
          logger.info(\`Agent \${userId} moved to STANDBY\`);
        }
        else if (instance.state === AgentState.STANDBY && inactiveTime > ONE_DAY) {
          // å¾…æœº -> ä¼‘çœ  (1 å¤©æ— æ´»åŠ¨)
          await this.hibernateAgent(userId);
        }
        else if (instance.state === AgentState.HIBERNATED && inactiveTime > ONE_WEEK) {
          // ä¼‘çœ  -> åœæ­¢ (1 å‘¨æ— æ´»åŠ¨,å¯é€‰)
          // await this.stopAgent(userId, true);
        }
      }
    }, 300000); // æ¯ 5 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  }

  /**
   * å¤„ç†ä¸å¥åº·çš„ Agent
   */
  private async handleUnhealthyAgent(userId: string, reason: string): Promise<void> {
    logger.error(\`Handling unhealthy agent \${userId}: \${reason}\`);

    const instance = this.agents.get(userId);
    if (!instance) return;

    instance.state = AgentState.ERROR;

    // å°è¯•é‡å¯
    try {
      await this.stopAgent(userId, false);
      
      // ç­‰å¾… 5 ç§’
      await new Promise(resolve => setTimeout(resolve, 5000));

      // é‡æ–°åˆ›å»º
      const config = await this.loadAgentConfig(userId);
      await this.createAgent(config);

      logger.info(\`Successfully restarted agent \${userId}\`);
    } catch (error: any) {
      logger.error(\`Failed to restart agent \${userId}:\`, error);
      
      // é€šçŸ¥ç”¨æˆ·
      this.emit('agent:failed', { userId, reason, error: error.message });
    }
  }

  /**
   * ç­‰å¾…å®¹å™¨å¥åº·æ£€æŸ¥é€šè¿‡
   */
  private async waitForHealthy(container: Docker.Container, timeoutMs: number): Promise<boolean> {
    const startTime = Date.now();

    while (Date.now() - startTime < timeoutMs) {
      try {
        const inspect = await container.inspect();
        
        if (inspect.State.Health?.Status === 'healthy') {
          return true;
        }

        await new Promise(resolve => setTimeout(resolve, 2000)); // æ¯ 2 ç§’æ£€æŸ¥ä¸€æ¬¡
      } catch (error) {
        // å®¹å™¨å¯èƒ½è¿˜åœ¨å¯åŠ¨ä¸­
        await new Promise(resolve => setTimeout(resolve, 2000));
      }
    }

    return false;
  }

  /**
   * æ¢å¤å·²å­˜åœ¨çš„å®¹å™¨
   */
  private async recoverExistingAgents(): Promise<void> {
    const containers = await this.docker.listContainers({
      all: true,
      filters: { label: ['finverse.agent=true'] }
    });

    for (const containerInfo of containers) {
      const userId = containerInfo.Labels['finverse.user_id'];
      
      const instance: AgentInstance = {
        userId,
        containerId: containerInfo.Id,
        state: containerInfo.State === 'running' ? AgentState.ACTIVE : AgentState.STOPPED,
        createdAt: new Date(containerInfo.Created * 1000),
        lastActiveAt: new Date(),
        resources: { memoryMB: 512, cpuCores: 1 }
      };

      this.agents.set(userId, instance);
      logger.info(\`Recovered agent: \${userId}\`);
    }
  }

  /**
   * ä»æ•°æ®åº“åŠ è½½ Agent é…ç½®
   */
  private async loadAgentConfig(userId: string): Promise<AgentConfig> {
    const result = await db.queryOne<any>(
      'SELECT api_keys, preferences, chat_channels FROM users WHERE id = \$1',
      [userId]
    );

    return {
      userId,
      apiKeys: result.api_keys,
      preferences: result.preferences,
      chatChannels: result.chat_channels
    };
  }

  /**
   * åœæ­¢è°ƒåº¦å™¨
   */
  async stop(): Promise<void> {
    if (this.healthCheckInterval) {
      clearInterval(this.healthCheckInterval);
    }

    // ä¼˜é›…åœæ­¢æ‰€æœ‰ Agent
    const promises = Array.from(this.agents.keys()).map(userId =>
      this.stopAgent(userId, true).catch(err => 
        logger.error(\`Failed to stop agent \${userId}:\`, err)
      )
    );

    await Promise.all(promises);
    logger.info('Agent Orchestrator stopped');
  }
}

interface AgentInstance {
  userId: string;
  containerId: string;
  state: AgentState;
  createdAt: Date;
  lastActiveAt: Date;
  resources: {
    memoryMB: number;
    cpuCores: number;
  };
}
\`\`\`

---

### 15.4 å¥åº·æ£€æŸ¥ API å®ç°

**åˆ›å»ºæ–‡ä»¶ï¼š\`apps/agent-runtime/src/health.ts\`**

\`\`\`typescript
import http from 'http';
import { db } from '@finverse/database';

/**
 * Agent å®¹å™¨å†…å¥åº·æ£€æŸ¥æœåŠ¡
 * 
 * Docker HEALTHCHECK ä¼šå®šæœŸè°ƒç”¨æ­¤ç«¯ç‚¹
 */
export function startHealthCheckServer(port: number = 3100): http.Server {
  const server = http.createServer(async (req, res) => {
    if (req.url === '/health') {
      try {
        // æ£€æŸ¥ 1: æ•°æ®åº“è¿æ¥
        await db.query('SELECT 1');

        // æ£€æŸ¥ 2: Redis è¿æ¥
        await db.redis.ping();

        // æ£€æŸ¥ 3: å†…å­˜ä½¿ç”¨
        const memUsage = process.memoryUsage();
        const heapUsedMB = memUsage.heapUsed / 1024 / 1024;
        
        if (heapUsedMB > 400) { // è¶…è¿‡ 400 MB æŠ¥è­¦
          throw new Error(\`High memory usage: \${heapUsedMB.toFixed(2)} MB\`);
        }

        // æ£€æŸ¥ 4: OpenClaw è¿›ç¨‹å­˜æ´»
        if (!global.openclawInstance || !global.openclawInstance.isAlive()) {
          throw new Error('OpenClaw instance not alive');
        }

        res.writeHead(200, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({
          status: 'healthy',
          timestamp: new Date().toISOString(),
          memory: {
            heapUsed: \`\${heapUsedMB.toFixed(2)} MB\`,
            rss: \`\${(memUsage.rss / 1024 / 1024).toFixed(2)} MB\`
          }
        }));

      } catch (error: any) {
        res.writeHead(503, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({
          status: 'unhealthy',
          error: error.message,
          timestamp: new Date().toISOString()
        }));
      }
    } else {
      res.writeHead(404);
      res.end();
    }
  });

  server.listen(port, () => {
    console.log(\`Health check server listening on port \${port}\`);
  });

  return server;
}
\`\`\`

---

### 15.5 ç°åº¦å‘å¸ƒè„šæœ¬

**åˆ›å»ºæ–‡ä»¶ï¼š\`scripts/rolling-update.sh\`**

\`\`\`bash
#!/bin/bash
# ============================================
# Agent å®¹å™¨æ»šåŠ¨å‡çº§è„šæœ¬
# 
# ç”¨æ³•: ./rolling-update.sh <new-image-tag> [batch-size] [delay-seconds]
# ä¾‹å­: ./rolling-update.sh v1.2.0 10 30
# ============================================

set -euo pipefail

NEW_IMAGE_TAG="\${1:-latest}"
BATCH_SIZE="\${2:-10}"
DELAY_SECONDS="\${3:-30}"

echo "ğŸš€ Starting rolling update to finverse/agent:\${NEW_IMAGE_TAG}"
echo "   Batch size: \${BATCH_SIZE}"
echo "   Delay between batches: \${DELAY_SECONDS}s"

# 1. æ‹‰å–æ–°é•œåƒ
echo "ğŸ“¥ Pulling new image..."
docker pull "finverse/agent:\${NEW_IMAGE_TAG}"

# 2. è·å–æ‰€æœ‰ Agent å®¹å™¨
AGENTS=\$(docker ps --filter "label=finverse.agent=true" --format "{{.ID}}" | sort)
TOTAL=\$(echo "\$AGENTS" | wc -l | tr -d ' ')

echo "ğŸ“Š Found \${TOTAL} agent containers"

if [ "\$TOTAL" -eq 0 ]; then
  echo "âœ… No agents to update"
  exit 0
fi

# 3. æ‰¹é‡å‡çº§
BATCH_NUM=1
COUNT=0

for CONTAINER_ID in \$AGENTS; do
  COUNT=\$((COUNT + 1))
  
  # è·å–ç”¨æˆ· ID
  USER_ID=\$(docker inspect "\$CONTAINER_ID" --format '{{index .Config.Labels "finverse.user_id"}}')
  
  echo "ğŸ”„ [\$COUNT/\$TOTAL] Updating agent for user \$USER_ID (\$CONTAINER_ID)"
  
  # è·å–å½“å‰é…ç½®
  CURRENT_ENV=\$(docker inspect "\$CONTAINER_ID" --format '{{json .Config.Env}}')
  CURRENT_VOLUMES=\$(docker inspect "\$CONTAINER_ID" --format '{{json .HostConfig.Binds}}')
  
  # åœæ­¢æ—§å®¹å™¨
  echo "   â¸  Stopping old container..."
  docker stop "\$CONTAINER_ID" >/dev/null 2>&1 || true
  
  # å¯åŠ¨æ–°å®¹å™¨ (ä½¿ç”¨ç›¸åŒé…ç½®)
  echo "   â–¶ï¸  Starting new container..."
  NEW_CONTAINER_ID=\$(docker run -d \\
    --name "agent-\${USER_ID}-new" \\
    --label "finverse.agent=true" \\
    --label "finverse.user_id=\${USER_ID}" \\
    --env-file <(echo "\$CURRENT_ENV" | jq -r '.[]') \\
    --volume "agent-\${USER_ID}-data:/app/workspace" \\
    --network agent-network \\
    --memory 512m \\
    --cpus 1 \\
    "finverse/agent:\${NEW_IMAGE_TAG}")
  
  # ç­‰å¾…å¥åº·æ£€æŸ¥
  echo "   ğŸ¥ Waiting for health check..."
  MAX_RETRIES=15
  RETRY=0
  
  while [ \$RETRY -lt \$MAX_RETRIES ]; do
    HEALTH=\$(docker inspect "\$NEW_CONTAINER_ID" --format '{{.State.Health.Status}}' 2>/dev/null || echo "starting")
    
    if [ "\$HEALTH" = "healthy" ]; then
      echo "   âœ… Agent healthy"
      break
    fi
    
    RETRY=\$((RETRY + 1))
    sleep 2
  done
  
  if [ "\$HEALTH" != "healthy" ]; then
    echo "   âŒ Health check failed, rolling back..."
    docker stop "\$NEW_CONTAINER_ID" >/dev/null 2>&1 || true
    docker rm "\$NEW_CONTAINER_ID" >/dev/null 2>&1 || true
    docker start "\$CONTAINER_ID" >/dev/null 2>&1
    
    echo "   âš ï¸  Rollback completed for \$USER_ID"
    continue
  fi
  
  # åˆ é™¤æ—§å®¹å™¨
  docker rm "\$CONTAINER_ID" >/dev/null 2>&1 || true
  
  # é‡å‘½åæ–°å®¹å™¨
  docker rename "\$NEW_CONTAINER_ID" "agent-\${USER_ID}" >/dev/null 2>&1 || true
  
  # æ‰¹æ¬¡å»¶è¿Ÿ
  if [ \$((COUNT % BATCH_SIZE)) -eq 0 ] && [ \$COUNT -lt \$TOTAL ]; then
    echo "â³ Batch \${BATCH_NUM} completed. Waiting \${DELAY_SECONDS}s before next batch..."
    sleep "\$DELAY_SECONDS"
    BATCH_NUM=\$((BATCH_NUM + 1))
  fi
done

echo ""
echo "ğŸ‰ Rolling update completed!"
echo "   Total agents: \${TOTAL}"
echo "   New image: finverse/agent:\${NEW_IMAGE_TAG}"
\`\`\`

---

## åå…­ã€è·¯çº¿å›¾ - Sprint ä»»åŠ¡æ‹†è§£

### Month 1: æ ¸å¿ƒåŸºç¡€

#### Sprint 1.1: ç”¨æˆ·ç³»ç»Ÿä¸è®¤è¯ (Week 1)

**ä»»åŠ¡ 1.1.1: ç”¨æˆ·æ³¨å†Œä¸ç™»å½•**
- å®ç° JWT è®¤è¯
- å¯†ç å“ˆå¸Œ (bcrypt)
- Email éªŒè¯æµç¨‹
- OAuth ç™»å½• (Google/GitHub)

*éªŒæ”¶æ ‡å‡†*:
- [ ] ç”¨æˆ·å¯é€šè¿‡ email/password æ³¨å†Œ
- [ ] ç™»å½•è¿”å›æœ‰æ•ˆ JWT token (30 å¤©è¿‡æœŸ)
- [ ] æ³¨å†Œé‚®ä»¶å‘é€æˆåŠŸç‡ > 95%
- [ ] OAuth ç™»å½•æµç¨‹å®Œæ•´ (é‡å®šå‘æ­£ç¡®)

**ä»»åŠ¡ 1.1.2: API Key ç®¡ç†**
- åŠ å¯†å­˜å‚¨å®ç° (AES-256-GCM)
- CRUD API ç«¯ç‚¹
- API key éªŒè¯ä¸­é—´ä»¶

*éªŒæ”¶æ ‡å‡†*:
- [ ] ç”¨æˆ·å¯æ·»åŠ  OpenAI/Anthropic/DeepSeek API key
- [ ] å­˜å‚¨çš„ key å·²åŠ å¯† (æ•°æ®åº“ä¸­ä¸å¯è§æ˜æ–‡)
- [ ] è§£å¯†åçš„ key å¯æˆåŠŸè°ƒç”¨å¯¹åº” API
- [ ] æ”¯æŒæ›´æ–°/åˆ é™¤ key

**ä»»åŠ¡ 1.1.3: åå¥½æµ‹è¯•ç³»ç»Ÿ**
- è®¾è®¡ 8-10 ä¸ªæƒ…æ™¯é¢˜
- å‰ç«¯äº¤äº’ç•Œé¢ (æ¸¸æˆåŒ–)
- æ ‡ç­¾ç®—æ³•å®ç°

*éªŒæ”¶æ ‡å‡†*:
- [ ] æµ‹è¯•æ—¶é•¿ < 3 åˆ†é’Ÿ
- [ ] ç”Ÿæˆè‡³å°‘ 5 ä¸ªå‡†ç¡®æ ‡ç­¾ (trading_style, risk_preference, etc.)
- [ ] æ ‡ç­¾ä¿å­˜åˆ°ç”¨æˆ· profile
- [ ] UI ä½“éªŒæµç•…,æ— å¡é¡¿

---

#### Sprint 1.2: OpenClaw Agent å®ä¾‹åŒ– (Week 2)

**ä»»åŠ¡ 1.2.1: Agent è°ƒåº¦å™¨åŸºç¡€**
- Docker API é›†æˆ
- å®¹å™¨åˆ›å»º/åœæ­¢é€»è¾‘
- Agent å®ä¾‹æ•°æ®åº“è¡¨

*éªŒæ”¶æ ‡å‡†*:
- [ ] å¯é€šè¿‡ API è§¦å‘åˆ›å»º Agent å®¹å™¨
- [ ] å®¹å™¨æˆåŠŸå¯åŠ¨å¹¶é€šè¿‡å¥åº·æ£€æŸ¥
- [ ] æ•°æ®åº“è®°å½• Agent çŠ¶æ€ (user_id, container_id, state)
- [ ] å®¹å™¨èµ„æºé™åˆ¶ç”Ÿæ•ˆ (512MB memory, 1 CPU)

**ä»»åŠ¡ 1.2.2: Agent åˆå§‹åŒ–æµç¨‹**
- ç”Ÿæˆ SOUL.md (åŸºäºç”¨æˆ·æ ‡ç­¾)
- æ³¨å…¥ API keys (ç¯å¢ƒå˜é‡)
- Cron ä»»åŠ¡é¢„é…ç½®

*éªŒæ”¶æ ‡å‡†*:
- [ ] SOUL.md åŒ…å«ç”¨æˆ·åå¥½ (ä»æ ‡ç­¾ç”Ÿæˆ)
- [ ] Agent å¯æˆåŠŸè°ƒç”¨ç”¨æˆ·çš„ AI API
- [ ] é¢„è®¾ cron ä»»åŠ¡å·²é…ç½® (daily-summary, market-scan)

**ä»»åŠ¡ 1.2.3: èŠå¤©è½¯ä»¶è¿æ¥ (Telegram)**
- Telegram Bot API é›†æˆ
- ç”¨æˆ·æ‰«ç ç»‘å®šæµç¨‹
- æ¶ˆæ¯è·¯ç”± (Telegram <-> Agent)

*éªŒæ”¶æ ‡å‡†*:
- [ ] ç”¨æˆ·æ‰«ç åæ”¶åˆ° Agent æ¬¢è¿æ¶ˆæ¯
- [ ] å¯åœ¨ Telegram å‘é€æ¶ˆæ¯ä¸ Agent å¯¹è¯
- [ ] Agent å›å¤å»¶è¿Ÿ < 5 ç§’
- [ ] æ”¯æŒ inline keyboard (å¿«æ·æ“ä½œ)

---

#### Sprint 1.3: åŸºç¡€æ•°æ®æ¥å…¥ (Week 3)

**ä»»åŠ¡ 1.3.1: CoinGecko é€‚é…å™¨**
- å®ç° \`getHistoricalPrices()\`
- å®ç° \`getCurrentPrice()\`
- é€Ÿç‡é™åˆ¶å™¨
- é”™è¯¯å¤„ç†ä¸é‡è¯•

*éªŒæ”¶æ ‡å‡†*:
- [ ] å¯è·å– BTC/ETH å†å²ä»·æ ¼ (æœ€è¿‘ 90 å¤©)
- [ ] å®æ—¶ä»·æ ¼å»¶è¿Ÿ < 10 ç§’
- [ ] é€Ÿç‡é™åˆ¶ç”Ÿæ•ˆ (å…è´¹ç‰ˆ 10 calls/min)
- [ ] ç½‘ç»œé”™è¯¯è‡ªåŠ¨é‡è¯• (æœ€å¤š 3 æ¬¡)

**ä»»åŠ¡ 1.3.2: Yahoo Finance é€‚é…å™¨**
- ä½¿ç”¨ \`yahoo-finance2\` åº“
- è·å–ç¾è‚¡æ•°æ® (AAPL, TSLA, SPY, etc.)
- æ•°æ®æ ‡å‡†åŒ–

*éªŒæ”¶æ ‡å‡†*:
- [ ] å¯è·å– AAPL å†å² OHLCV æ•°æ®
- [ ] æ•°æ®æ ¼å¼ç¬¦åˆ \`PriceDataPoint\` schema
- [ ] æ”¯æŒ 1d/1h æ—¶é—´ç²’åº¦

**ä»»åŠ¡ 1.3.3: å®šæ—¶æ•°æ®æ‹‰å–**
- Cron ä»»åŠ¡é…ç½® (æ¯ 5 åˆ†é’Ÿå®æ—¶ä»·æ ¼)
- æ•°æ®å­˜å‚¨ (PostgreSQL + Redis)
- ç›‘æ§ä¸æ—¥å¿—

*éªŒæ”¶æ ‡å‡†*:
- [ ] Cron å‡†æ—¶æ‰§è¡Œ (è¯¯å·® < 10 ç§’)
- [ ] æ•°æ®æˆåŠŸå†™å…¥ PostgreSQL
- [ ] Redis ç¼“å­˜æœ€æ–°ä»·æ ¼ (5 åˆ†é’Ÿ TTL)
- [ ] å¤±è´¥æ—¶æœ‰æ—¥å¿—è®°å½•

---

#### Sprint 1.4: å¯è§†åŒ–ç•Œé¢ (Week 4)

**ä»»åŠ¡ 1.4.1: æ‘˜è¦æ¨¡å¼**
- è®¾è®¡ UI (Figma/ç›´æ¥ä»£ç )
- å®ç°ä¸€å¥è¯ç»“è®ºå¡ç‰‡
- å¤šç»´ä¿¡å·æ¡ (é“¾ä¸Š/å®è§‚/æŠ€æœ¯/æƒ…ç»ª)
- å¼‚å¸¸é¢„è­¦å¡ç‰‡

*éªŒæ”¶æ ‡å‡†*:
- [ ] æ‰“å¼€é¡µé¢ 1 ç§’å†…çœ‹åˆ°æ ¸å¿ƒä¿¡æ¯
- [ ] ä¿¡å·æ¡é¢œè‰²æ­£ç¡® (çº¢=çœ‹è·Œ,ç»¿=çœ‹æ¶¨,é»„=ä¸­æ€§)
- [ ] å¼‚å¸¸é¢„è­¦æŒ‰ä¸¥é‡ç¨‹åº¦æ’åº
- [ ] ç§»åŠ¨ç«¯è‡ªé€‚åº”

**ä»»åŠ¡ 1.4.2: å›¾è¡¨æ¨¡å¼ (åŸºç¡€)**
- é›†æˆ \`lightweight-charts\`
- æ˜¾ç¤º K çº¿å›¾
- åŸºç¡€äº¤äº’ (ç¼©æ”¾,å¹³ç§»)

*éªŒæ”¶æ ‡å‡†*:
- [ ] K çº¿å›¾æ¸²æŸ“æµç•… (60fps)
- [ ] æ”¯æŒ 1000+ æ•°æ®ç‚¹ä¸å¡é¡¿
- [ ] å¯åˆ‡æ¢æ—¶é—´ç²’åº¦ (1d/1h/5m)
- [ ] åå­—å…‰æ ‡æ˜¾ç¤º OHLCV æ•°æ®

**ä»»åŠ¡ 1.4.3: æ•°æ®æ¨¡å¼**
- é«˜å¯†åº¦æ•°å­—é¢æ¿
- å®æ—¶ä»·æ ¼æ›´æ–° (WebSocket)

*éªŒæ”¶æ ‡å‡†*:
- [ ] æ˜¾ç¤ºè‡³å°‘ 20 ä¸ªæ•°æ®ç‚¹ (ä»·æ ¼/æˆäº¤é‡/æŒä»“/è´¹ç‡ç­‰)
- [ ] WebSocket è¿æ¥ç¨³å®š
- [ ] ä»·æ ¼å˜åŠ¨æ—¶æ•°å­—é—ªçƒæç¤º
- [ ] å»¶è¿Ÿ < 2 ç§’

---

### Month 2: å…¬åŸŸ + å¼‚å¸¸æ£€æµ‹

#### Sprint 2.1: ä¿¡å·ç³»ç»Ÿ (Week 5)

**ä»»åŠ¡ 2.1.1: ä¿¡å·æ ‡å‡†æ ¼å¼**
- å®šä¹‰ JSON Schema
- éªŒè¯å™¨å®ç°
- æ•°æ®åº“è¡¨è®¾è®¡

*éªŒæ”¶æ ‡å‡†*:
- [ ] Schema åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µ (agent_id, asset, signal, confidence, dimensions)
- [ ] æ— æ•ˆä¿¡å·ä¼šè¢«æ‹’ç» (éªŒè¯å™¨)
- [ ] æ•°æ®åº“ç´¢å¼•ä¼˜åŒ– (æŒ‰ asset + timestamp æŸ¥è¯¢)

**ä»»åŠ¡ 2.1.2: ä¿¡å·å‘å¸ƒ API**
- POST \`/api/signals\` ç«¯ç‚¹
- Agent è°ƒç”¨ç¤ºä¾‹
- é€Ÿç‡é™åˆ¶ (é˜²åˆ·åˆ†)

*éªŒæ”¶æ ‡å‡†*:
- [ ] Agent å¯æˆåŠŸå‘å¸ƒä¿¡å·
- [ ] ä¿¡å·å­˜å‚¨åˆ°æ•°æ®åº“
- [ ] é€Ÿç‡é™åˆ¶: æ¯ Agent æœ€å¤š 10 signals/hour
- [ ] API å“åº”æ—¶é—´ < 500ms

**ä»»åŠ¡ 2.1.3: ä¿¡å·è®¢é˜…ä¸èšåˆ**
- è®¢é˜…é€»è¾‘ (æŒ‰ç”¨æˆ·åå¥½)
- ä¿¡å·èšåˆç®—æ³• (åŠ æƒå¹³å‡)
- å…±è¯†çƒ­åŠ›å›¾è®¡ç®—

*éªŒæ”¶æ ‡å‡†*:
- [ ] Agent å¯è·å–ç›¸å…³èµ„äº§çš„ä¿¡å· (top 20)
- [ ] èšåˆç»“æœå‡†ç¡® (æ‰‹åŠ¨éªŒè¯ 3 ä¸ªæ¡ˆä¾‹)
- [ ] çƒ­åŠ›å›¾æ•°æ®æ ¼å¼æ­£ç¡® (percentage, tieråˆ†å¸ƒ)

---

#### Sprint 2.2: å¼‚å¸¸æ£€æµ‹ (Week 6)

**ä»»åŠ¡ 2.2.1: Spam æ£€æµ‹**
- 1 å°æ—¶å†…ä¿¡å·æ•°é‡æ£€æµ‹
- è¿ç»­é‡å¤æ£€æµ‹

*éªŒæ”¶æ ‡å‡†*:
- [ ] 1 å°æ—¶ > 10 ä¿¡å·è§¦å‘ anomaly flag
- [ ] è¿ç»­ 5 ä¸ªç›¸åŒä¿¡å·è§¦å‘ flag
- [ ] Flag è®°å½•åˆ°æ•°æ®åº“ (anomaly_flags è¡¨)

**ä»»åŠ¡ 2.2.2: çŸ›ç›¾æ£€æµ‹**
- ä¿¡å· vs å®é™…èµ°åŠ¿æ¯”å¯¹
- ç½®ä¿¡åº¦æƒ©ç½š

*éªŒæ”¶æ ‡å‡†*:
- [ ] é«˜ç½®ä¿¡åº¦é”™è¯¯ä¿¡å·è¢«æ ‡è®°
- [ ] æ£€æµ‹å»¶è¿Ÿ < 5 åˆ†é’Ÿ (ä¿¡å·å‘å¸ƒå)

**ä»»åŠ¡ 2.2.3: ä¿¡èª‰è¯„åˆ† v1**
- å®ç° \`ReputationEngine\`
- å‡†ç¡®ç‡è®¡ç®—
- ç­‰çº§åˆ’åˆ† (novice/reliable/expert/master)

*éªŒæ”¶æ ‡å‡†*:
- [ ] è¯„åˆ†ç®—æ³•é€šè¿‡å•å…ƒæµ‹è¯• (10+ test cases)
- [ ] æ–° Agent é»˜è®¤ 50 åˆ†
- [ ] å‡†ç¡®ç‡ 90% Agent è¯„åˆ† > 80

---

#### Sprint 2.3: AI æ¨ç†é“¾å¯è§†åŒ– (Week 7)

**ä»»åŠ¡ 2.3.1: å¤šå›¾å±‚ç³»ç»Ÿ**
- AI æ ‡æ³¨å±‚
- å®è§‚äº‹ä»¶å±‚
- é“¾ä¸Šæ•°æ®å±‚

*éªŒæ”¶æ ‡å‡†*:
- [ ] æ¯ä¸ªå›¾å±‚å¯ç‹¬ç«‹å¼€å…³
- [ ] æ ‡æ³¨ç‚¹æ‚¬åœæ˜¾ç¤ºè¯¦æƒ…
- [ ] å›¾å±‚å åŠ ä¸å½±å“æ€§èƒ½ (60fps)

**ä»»åŠ¡ 2.3.2: æ¨ç†é“¾å±•ç¤º**
- æ­¥éª¤åˆ†è§£ UI
- æƒé‡å¯è§†åŒ–

*éªŒæ”¶æ ‡å‡†*:
- [ ] ç‚¹å‡»æ ‡æ³¨ç‚¹å±•å¼€æ¨ç†æ­¥éª¤
- [ ] æ˜¾ç¤ºæ¯æ­¥æƒé‡ç™¾åˆ†æ¯”
- [ ] æƒé‡æ€»å’Œ = 100%

---

#### Sprint 2.4: ç›‘æ§è„šæœ¬åŸºç¡€è®¾æ–½ (Week 8)

**ä»»åŠ¡ 2.4.1: Python ç›‘æ§è„šæœ¬**
- ä»·æ ¼å¼‚å¸¸æ£€æµ‹ (>5% çªå˜)
- æˆäº¤é‡å¼‚å¸¸
- é“¾ä¸Šå¼‚å¸¸ (éœ€ Glassnode)

*éªŒæ”¶æ ‡å‡†*:
- [ ] è„šæœ¬æŒç»­è¿è¡Œ (systemd service)
- [ ] æ£€æµ‹åˆ°å¼‚å¸¸ < 1 åˆ†é’Ÿ
- [ ] å¼‚å¸¸è®°å½•åˆ° Redis

**ä»»åŠ¡ 2.4.2: Agent å”¤é†’æœºåˆ¶**
- ç›‘æ§è„šæœ¬ -> è°ƒåº¦å™¨ API
- è°ƒåº¦å™¨å”¤é†’å¯¹åº” Agent
- Agent åˆ†æ -> æ¨é€ç”¨æˆ·

*éªŒæ”¶æ ‡å‡†*:
- [ ] å¼‚å¸¸è§¦å‘åˆ°ç”¨æˆ·æ”¶åˆ°é€šçŸ¥ < 3 åˆ†é’Ÿ
- [ ] åªå”¤é†’ç›¸å…³ Agent (æŒ‰æŒä»“/å…³æ³¨åˆ—è¡¨)
- [ ] é€šçŸ¥å†…å®¹åŒ…å«å¼‚å¸¸è¯¦æƒ…

---

### Month 3: ç§åŸŸ + å¸‚åœºæ‰©å±•

#### Sprint 3.1: å¼‚æ­¥åˆ†æå°ç»„ (Week 9-10)

**ä»»åŠ¡ 3.1.1: å°ç»„åŠŸèƒ½åŸºç¡€**
- æ•°æ®åº“è®¾è®¡ (groups, group_members, analyses)
- CRUD API
- æƒé™æ§åˆ¶ (åˆ›å»ºè€…/æˆå‘˜/å…¬å¼€)

*éªŒæ”¶æ ‡å‡†*:
- [ ] ç”¨æˆ·å¯åˆ›å»ºå°ç»„ (åç§°/æè¿°/å…¬å¼€æ€§)
- [ ] å¯é‚€è¯·æˆå‘˜ (via invite link)
- [ ] Pro ç”¨æˆ·å¯åˆ›å»ºç§å¯†å°ç»„
- [ ] å…è´¹ç”¨æˆ·åªèƒ½åŠ å…¥å…¬å¼€å°ç»„

**ä»»åŠ¡ 3.1.2: AI è¾…åŠ©åˆ†æå‘å¸ƒ**
- è‡ªç„¶è¯­è¨€è¾“å…¥
- Agent ç»“æ„åŒ–å‘ˆç°
- å›¾è¡¨è‡ªåŠ¨ç”Ÿæˆ

*éªŒæ”¶æ ‡å‡†*:
- [ ] ç”¨æˆ·è¯´ "æˆ‘è§‰å¾— BTC è¦è·Œ" -> Agent ç”Ÿæˆå®Œæ•´åˆ†æ
- [ ] åˆ†æåŒ…å«: æ ‡é¢˜/æ‘˜è¦/æ•°æ®æ”¯æ’‘/å›¾è¡¨/ç»“è®º
- [ ] ç”Ÿæˆæ—¶é—´ < 10 ç§’

**ä»»åŠ¡ 3.1.3: è¯„è®ºä¸åé¦ˆ**
- ç‚¹èµ/ç‚¹è¸©
- è¯„è®º (AI è¾…åŠ©)
- @æåŠ

*éªŒæ”¶æ ‡å‡†*:
- [ ] å¯å¯¹åˆ†æç‚¹èµ/ç‚¹è¸©
- [ ] è¯„è®ºæ”¯æŒ markdown
- [ ] @member å‘é€é€šçŸ¥

**ä»»åŠ¡ 3.1.4: å…±è¯†æŠ¥å‘Š**
- æ¯æ—¥/æ¯ä¸»é¢˜è‡ªåŠ¨ç”Ÿæˆ
- æ±‡æ€»çœ‹å¤š/çœ‹ç©ºæ¯”ä¾‹
- åˆ†æ­§ç‚¹åˆ†æ

*éªŒæ”¶æ ‡å‡†*:
- [ ] æ¯å¤© UTC 00:00 è‡ªåŠ¨ç”ŸæˆæŠ¥å‘Š
- [ ] æŠ¥å‘Šå‡†ç¡®åæ˜ å°ç»„å…±è¯†
- [ ] æ¨é€åˆ°æ‰€æœ‰æˆå‘˜ (Telegram/ç½‘ç«™)

---

#### Sprint 3.2: å†å²å¤ç›˜ (Week 11)

**ä»»åŠ¡ 3.2.1: åˆ¤æ–­å‡†ç¡®ç‡è¿½è¸ª**
- ä¿¡å·éªŒè¯é€»è¾‘ (24h/48h/1w å)
- ä¸ªäººå‡†ç¡®ç‡ç»Ÿè®¡
- å¯è§†åŒ–è¶‹åŠ¿å›¾

*éªŒæ”¶æ ‡å‡†*:
- [ ] ç”¨æˆ·å¯æŸ¥çœ‹è‡ªå·±çš„å‡†ç¡®ç‡ (æŒ‰æ—¶é—´æ¡†æ¶)
- [ ] æ˜¾ç¤ºæœ€è¿‘ 30 å¤©è¶‹åŠ¿å›¾
- [ ] æ•°æ®éšç§ (åªæ˜¾ç¤ºç»™è‡ªå·±)

**ä»»åŠ¡ 3.2.2: ç»´åº¦åˆ†æ**
- å“ªäº›ç»´åº¦æœ€æœ‰æ•ˆ
- é”™è¯¯æ¡ˆä¾‹å›é¡¾

*éªŒæ”¶æ ‡å‡†*:
- [ ] æ˜¾ç¤º "ä½ çš„é“¾ä¸Šåˆ†æå‡†ç¡®ç‡ 72%,æŠ€æœ¯åˆ†æ 58%"
- [ ] åˆ—å‡º 3 ä¸ªæœ€å¤§å¤±è¯¯æ¡ˆä¾‹

---

#### Sprint 3.3: å¸‚åœºæ‰©å±• (Week 12)

**ä»»åŠ¡ 3.3.1: ç¾è‚¡æ•°æ®**
- Polygon.io é€‚é…å™¨ (ä»˜è´¹,ç”¨æˆ· key)
- æ‰©å±•åˆ° 500+ è‚¡ç¥¨
- æœŸæƒæ•°æ® (å¯é€‰)

*éªŒæ”¶æ ‡å‡†*:
- [ ] æ”¯æŒ SPY/QQQ/AAPL/TSLA ç­‰ä¸»æµè‚¡ç¥¨
- [ ] æ•°æ®å»¶è¿Ÿ < 15 åˆ†é’Ÿ (å…è´¹ tier)
- [ ] ç”¨æˆ·å¯æ·»åŠ  Polygon.io key è·å–å®æ—¶æ•°æ®

**ä»»åŠ¡ 3.3.2: å¤–æ±‡æ•°æ®**
- Twelve Data é€‚é…å™¨
- ä¸»æµè´§å¸å¯¹ (EUR/USD, GBP/USD, etc.)

*éªŒæ”¶æ ‡å‡†*:
- [ ] æ”¯æŒ 10+ è´§å¸å¯¹
- [ ] æ•°æ®ç²’åº¦: 1h/4h/1d

**ä»»åŠ¡ 3.3.3: è´µé‡‘å±**
- é»„é‡‘/ç™½é“¶æ•°æ®
- Kitco API (å…è´¹)

*éªŒæ”¶æ ‡å‡†*:
- [ ] æ˜¾ç¤º XAU/USD, XAG/USD å®æ—¶ä»·æ ¼
- [ ] å†å²æ•°æ®è‡³å°‘ 1 å¹´

---

#### Sprint 3.4: Pro ç‰ˆè®¢é˜… (Week 12)

**ä»»åŠ¡ 3.4.1: Stripe é›†æˆ**
- è®¢é˜…è®¡åˆ’é…ç½® (\$29/æœˆ)
- æ”¯ä»˜æµç¨‹
- Webhook å¤„ç†

*éªŒæ”¶æ ‡å‡†*:
- [ ] ç”¨æˆ·å¯æˆåŠŸè®¢é˜… Pro ç‰ˆ
- [ ] æ”¯ä»˜æˆåŠŸåç«‹å³è§£é”åŠŸèƒ½
- [ ] å–æ¶ˆè®¢é˜…æµç¨‹æ­£å¸¸

**ä»»åŠ¡ 3.4.2: åŠŸèƒ½é—¨æ§**
- å°ç»„æ•°é‡é™åˆ¶
- é«˜çº§å¯è§†åŒ–
- Agent è‡ªå®šä¹‰

*éªŒæ”¶æ ‡å‡†*:
- [ ] å…è´¹ç”¨æˆ·: 1 ä¸ªå°ç»„,åŸºç¡€å›¾è¡¨
- [ ] Pro ç”¨æˆ·: æ— é™å°ç»„,é«˜çº§å›¾å±‚,è‡ªå®šä¹‰ SOUL.md

---

## åä¸ƒã€æŠ€æœ¯æ ˆ - å®Œæ•´é…ç½®

### 17.1 æŠ€æœ¯é€‰å‹ä¸ç‰ˆæœ¬

\`\`\`json
{
  "frontend": {
    "framework": "Next.js 15.1.0",
    "runtime": "React 19.0.0",
    "language": "TypeScript 5.7.0",
    "styling": "Tailwind CSS 4.0.0",
    "charts": "lightweight-charts 4.2.0",
    "state": "Zustand 5.0.0",
    "forms": "React Hook Form 7.54.0",
    "http": "Axios 1.7.0"
  },
  "backend": {
    "runtime": "Node.js 22.22.0",
    "framework": "Fastify 5.2.0",
    "language": "TypeScript 5.7.0",
    "validation": "Zod 3.24.0",
    "orm": "Drizzle ORM 0.37.0"
  },
  "database": {
    "primary": "PostgreSQL 16.3",
    "cache": "Redis 7.4",
    "search": "MeiliSearch 1.11.0 (å¯é€‰)"
  },
  "agent": {
    "runtime": "OpenClaw (latest)",
    "base": "Node.js 22.22.0",
    "scripting": "Python 3.12.0"
  },
  "infrastructure": {
    "containerization": "Docker 27.4.0",
    "orchestration": "Docker Compose 2.31.0",
    "proxy": "Nginx 1.27.3",
    "monitoring": "Prometheus 3.0.0 + Grafana 11.4.0"
  }
}
\`\`\`

---

### 17.2 package.json ä¾èµ–åˆ—è¡¨

**åˆ›å»ºæ–‡ä»¶ï¼š\`package.json\` (monorepo root)**

\`\`\`json
{
  "name": "finverse",
  "version": "1.0.0",
  "private": true,
  "workspaces": [
    "apps/*",
    "packages/*"
  ],
  "scripts": {
    "dev": "turbo run dev",
    "build": "turbo run build",
    "test": "turbo run test",
    "lint": "turbo run lint",
    "format": "prettier --write \\"**/*.{ts,tsx,js,jsx,json,md}\\"",
    "docker:build": "docker-compose build",
    "docker:up": "docker-compose up -d",
    "docker:down": "docker-compose down",
    "migrate": "drizzle-kit migrate",
    "migrate:generate": "drizzle-kit generate"
  },
  "devDependencies": {
    "@types/node": "^22.10.0",
    "turbo": "^2.3.0",
    "prettier": "^3.4.0",
    "typescript": "^5.7.0",
    "drizzle-kit": "^0.29.0"
  }
}
\`\`\`

**åˆ›å»ºæ–‡ä»¶ï¼š\`apps/web/package.json\`**

\`\`\`json
{
  "name": "@finverse/web",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "next": "^15.1.0",
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "typescript": "^5.7.0",
    "@types/react": "^19.0.0",
    "@types/node": "^22.10.0",
    "tailwindcss": "^4.0.0",
    "autoprefixer": "^10.4.20",
    "postcss": "^8.4.49",
    "lightweight-charts": "^4.2.0",
    "zustand": "^5.0.0",
    "react-hook-form": "^7.54.0",
    "zod": "^3.24.0",
    "axios": "^1.7.0",
    "lucide-react": "^0.468.0",
    "date-fns": "^4.1.0",
    "@radix-ui/react-dialog": "^1.1.2",
    "@radix-ui/react-dropdown-menu": "^2.1.2",
    "@radix-ui/react-tabs": "^1.1.1"
  }
}
\`\`\`

**åˆ›å»ºæ–‡ä»¶ï¼š\`apps/api/package.json\`**

\`\`\`json
{
  "name": "@finverse/api",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "tsx watch src/index.ts",
    "build": "tsc",
    "start": "node dist/index.js"
  },
  "dependencies": {
    "fastify": "^5.2.0",
    "@fastify/cors": "^10.0.1",
    "@fastify/jwt": "^9.0.1",
    "@fastify/websocket": "^11.0.1",
    "drizzle-orm": "^0.37.0",
    "postgres": "^3.4.5",
    "ioredis": "^5.4.1",
    "zod": "^3.24.0",
    "bcrypt": "^5.1.1",
    "@types/bcrypt": "^5.0.2",
    "nanoid": "^5.0.9",
    "pino": "^9.5.0",
    "pino-pretty": "^13.0.0"
  },
  "devDependencies": {
    "tsx": "^4.19.2",
    "typescript": "^5.7.0",
    "@types/node": "^22.10.0"
  }
}
\`\`\`

**åˆ›å»ºæ–‡ä»¶ï¼š\`packages/data-adapters/package.json\`**

\`\`\`json
{
  "name": "@finverse/data-adapters",
  "version": "1.0.0",
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  "scripts": {
    "build": "tsc",
    "test": "vitest"
  },
  "dependencies": {
    "axios": "^1.7.0",
    "yahoo-finance2": "^2.13.2",
    "@finverse/data-schema": "workspace:*"
  },
  "devDependencies": {
    "typescript": "^5.7.0",
    "vitest": "^2.1.0"
  }
}
\`\`\`

---

### 17.3 Dockerfile é…ç½®

**åˆ›å»ºæ–‡ä»¶ï¼š\`apps/api/Dockerfile\`**

\`\`\`dockerfile
# ============================================
# Multi-stage build for production API
# ============================================

FROM node:22-alpine AS base
RUN apk add --no-cache libc6-compat
WORKDIR /app

# ============================================
# Dependencies stage
# ============================================
FROM base AS deps
COPY package*.json ./
COPY apps/api/package*.json ./apps/api/
COPY packages/*/package*.json ./packages/

RUN npm ci --production=false

# ============================================
# Builder stage
# ============================================
FROM base AS builder
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# Build API and shared packages
RUN npm run build --workspace=@finverse/api

# ============================================
# Production runner
# ============================================
FROM base AS runner

ENV NODE_ENV=production

RUN addgroup -g 1001 -S nodejs && \\
    adduser -S apiuser -u 1001

COPY --from=builder --chown=apiuser:nodejs /app/apps/api/dist ./dist
COPY --from=builder --chown=apiuser:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=apiuser:nodejs /app/package.json ./

USER apiuser

EXPOSE 3001

HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \\
  CMD node -e "require('http').get('http://localhost:3001/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"

CMD ["node", "dist/index.js"]
\`\`\`

**åˆ›å»ºæ–‡ä»¶ï¼š\`apps/web/Dockerfile\`**

\`\`\`dockerfile
FROM node:22-alpine AS base

# ============================================
# Dependencies
# ============================================
FROM base AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app

COPY package*.json ./
COPY apps/web/package*.json ./apps/web/
RUN npm ci

# ============================================
# Builder
# ============================================
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

ARG NEXT_PUBLIC_API_URL
ENV NEXT_PUBLIC_API_URL=\$NEXT_PUBLIC_API_URL

RUN npm run build --workspace=@finverse/web

# ============================================
# Runner
# ============================================
FROM base AS runner
WORKDIR /app

ENV NODE_ENV=production

RUN addgroup -g 1001 -S nodejs && \\
    adduser -S nextjs -u 1001

COPY --from=builder /app/apps/web/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/.next/static ./.next/static

USER nextjs

EXPOSE 3000

ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

CMD ["node", "server.js"]
\`\`\`

---

### 17.4 Nginx é…ç½®

**åˆ›å»ºæ–‡ä»¶ï¼š\`nginx/nginx.conf\`**

\`\`\`nginx
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 2048;
    use epoll;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '\$remote_addr - \$remote_user [\$time_local] "\$request" '
                    '\$status \$body_bytes_sent "\$http_referer" '
                    '"\$http_user_agent" "\$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 20M;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss;

    # Rate limiting
    limit_req_zone \$binary_remote_addr zone=api_limit:10m rate=10r/s;
    limit_req_zone \$binary_remote_addr zone=login_limit:10m rate=5r/m;

    # Upstream servers
    upstream api_backend {
        least_conn;
        server api:3001 max_fails=3 fail_timeout=30s;
    }

    upstream web_backend {
        least_conn;
        server web:3000 max_fails=3 fail_timeout=30s;
    }

    # HTTP -> HTTPS redirect
    server {
        listen 80;
        server_name finverse.ai www.finverse.ai;

        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        location / {
            return 301 https://\$server_name\$request_uri;
        }
    }

    # HTTPS server
    server {
        listen 443 ssl http2;
        server_name finverse.ai www.finverse.ai;

        # SSL certificates (Let's Encrypt)
        ssl_certificate /etc/nginx/ssl/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/privkey.pem;
        ssl_session_timeout 1d;
        ssl_session_cache shared:SSL:50m;
        ssl_session_tickets off;

        # Modern SSL configuration
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers off;

        # HSTS
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # API routes
        location /api/ {
            limit_req zone=api_limit burst=20 nodelay;
            
            proxy_pass http://api_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade \$http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host \$host;
            proxy_set_header X-Real-IP \$remote_addr;
            proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto \$scheme;
            proxy_cache_bypass \$http_upgrade;
            
            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # WebSocket for real-time data
        location /ws {
            proxy_pass http://api_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade \$http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host \$host;
            proxy_set_header X-Real-IP \$remote_addr;
            proxy_read_timeout 86400;
        }

        # Login endpoint (stricter rate limit)
        location /api/auth/login {
            limit_req zone=login_limit burst=3 nodelay;
            
            proxy_pass http://api_backend;
            proxy_set_header Host \$host;
            proxy_set_header X-Real-IP \$remote_addr;
            proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        }

        # Next.js frontend
        location / {
            proxy_pass http://web_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade \$http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host \$host;
            proxy_cache_bypass \$http_upgrade;
        }

        # Next.js static files (cache aggressively)
        location /_next/static/ {
            proxy_pass http://web_backend;
            proxy_cache_valid 200 365d;
            add_header Cache-Control "public, max-age=31536000, immutable";
        }

        # Public assets
        location /assets/ {
            proxy_pass http://web_backend;
            expires 7d;
            add_header Cache-Control "public, max-age=604800";
        }
    }
}
\`\`\`

---

### 17.5 SSL è¯ä¹¦é…ç½® (Let's Encrypt)

**åˆ›å»ºæ–‡ä»¶ï¼š\`scripts/setup-ssl.sh\`**

\`\`\`bash
#!/bin/bash
# ============================================
# Let's Encrypt SSL è¯ä¹¦è‡ªåŠ¨é…ç½®
# 
# å‰æ:
# - åŸŸåå·²è§£æåˆ°æœåŠ¡å™¨ IP
# - 80/443 ç«¯å£å¼€æ”¾
# ============================================

set -euo pipefail

DOMAIN="finverse.ai"
EMAIL="admin@finverse.ai"

echo "ğŸ”’ Setting up SSL for \${DOMAIN}"

# 1. å®‰è£… Certbot
if ! command -v certbot &> /dev/null; then
    echo "ğŸ“¦ Installing Certbot..."
    apt-get update
    apt-get install -y certbot python3-certbot-nginx
fi

# 2. è·å–è¯ä¹¦
echo "ğŸ“œ Obtaining SSL certificate..."
certbot certonly --nginx \\
    -d "\${DOMAIN}" \\
    -d "www.\${DOMAIN}" \\
    --email "\${EMAIL}" \\
    --agree-tos \\
    --non-interactive

# 3. å¤åˆ¶è¯ä¹¦åˆ° Nginx ç›®å½•
mkdir -p ./nginx/ssl
cp /etc/letsencrypt/live/\${DOMAIN}/fullchain.pem ./nginx/ssl/
cp /etc/letsencrypt/live/\${DOMAIN}/privkey.pem ./nginx/ssl/

echo "âœ… SSL certificate installed"

# 4. è®¾ç½®è‡ªåŠ¨ç»­æœŸ
echo "â° Setting up auto-renewal..."
(crontab -l 2>/dev/null; echo "0 0 * * * certbot renew --quiet --deploy-hook 'docker exec finverse-nginx nginx -s reload'") | crontab -

echo "ğŸ‰ SSL setup complete!"
echo "   Certificate: \${DOMAIN}"
echo "   Expiry: 90 days"
echo "   Auto-renewal: enabled"
\`\`\`

---

### 17.6 é¡¹ç›®åˆå§‹åŒ–å®Œæ•´å‘½ä»¤åºåˆ—

**åˆ›å»ºæ–‡ä»¶ï¼š\`scripts/init-project.sh\`**

\`\`\`bash
#!/bin/bash
# ============================================
# FinVerse é¡¹ç›®å®Œæ•´åˆå§‹åŒ–è„šæœ¬
# 
# ä»é›¶å¼€å§‹åˆ°ç¬¬ä¸€æ¬¡éƒ¨ç½²çš„æ‰€æœ‰å‘½ä»¤
# ============================================

set -euo pipefail

echo "ğŸš€ Initializing FinVerse project..."

# ============================================
# 1. Git åˆå§‹åŒ–
# ============================================
echo "ğŸ“¦ [1/10] Initializing Git repository..."
git init
git add .
git commit -m "Initial commit: FinVerse project structure"

# åˆ›å»º .gitignore
cat > .gitignore << 'EOF'
# Dependencies
node_modules/
.pnp
.pnp.js

# Build outputs
dist/
build/
.next/
out/

# Environment variables
.env
.env.local
.env.*.local

# Logs
logs/
*.log
npm-debug.log*

# OS files
.DS_Store
Thumbs.db

# IDE
.vscode/
.idea/
*.swp

# Docker
.dockerignore

# SSL
nginx/ssl/*.pem
EOF

git add .gitignore
git commit -m "Add .gitignore"

# ============================================
# 2. ç¯å¢ƒå˜é‡é…ç½®
# ============================================
echo "ğŸ” [2/10] Setting up environment variables..."

# ç”Ÿæˆä¸»åŠ å¯†å¯†é’¥
MASTER_KEY=\$(openssl rand -hex 32)

cat > .env << EOF
# Database
POSTGRES_PASSWORD=\$(openssl rand -base64 32)
REDIS_PASSWORD=\$(openssl rand -base64 32)

# Application
JWT_SECRET=\$(openssl rand -base64 64)
MASTER_ENCRYPTION_KEY=\${MASTER_KEY}
API_URL=https://api.finverse.ai

# Monitoring
GRAFANA_PASSWORD=\$(openssl rand -base64 16)

# Agent Orchestrator
MAX_AGENTS=1000

# Optional: Production settings
# NODE_ENV=production
# DATABASE_URL=postgresql://...
# REDIS_URL=redis://...
EOF

echo "âœ… .env file created with secure random values"
echo "âš ï¸  IMPORTANT: Back up your MASTER_ENCRYPTION_KEY securely!"

# ============================================
# 3. å®‰è£…ä¾èµ–
# ============================================
echo "ğŸ“¥ [3/10] Installing dependencies..."
npm install

# ============================================
# 4. æ•°æ®åº“åˆå§‹åŒ–
# ============================================
echo "ğŸ—„ï¸  [4/10] Setting up database schema..."

# åˆ›å»ºè¿ç§»æ–‡ä»¶ç›®å½•
mkdir -p migrations

# ç”Ÿæˆæ•°æ®åº“ schema
cat > migrations/001_initial_schema.sql << 'EOSQL'
-- Users
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_users_email ON users(email);

-- User profiles
CREATE TABLE user_profiles (
  user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  preferences JSONB DEFAULT '{}'::jsonb,
  tags TEXT[] DEFAULT ARRAY[]::TEXT[],
  chat_channels TEXT[] DEFAULT ARRAY[]::TEXT[],
  subscription_tier VARCHAR(20) DEFAULT 'free',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- API keys (encrypted)
CREATE TABLE user_api_keys (
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  service VARCHAR(50) NOT NULL,
  encrypted_key TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  last_used_at TIMESTAMPTZ,
  PRIMARY KEY (user_id, service)
);

-- Agent instances
CREATE TABLE agent_instances (
  user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  container_id VARCHAR(255) NOT NULL,
  state VARCHAR(20) NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  last_active_at TIMESTAMPTZ DEFAULT NOW(),
  stopped_at TIMESTAMPTZ
);

CREATE INDEX idx_agents_state ON agent_instances(state);

-- Price data
CREATE TABLE price_data (
  symbol VARCHAR(20) NOT NULL,
  timestamp TIMESTAMPTZ NOT NULL,
  open NUMERIC(20, 8),
  high NUMERIC(20, 8),
  low NUMERIC(20, 8),
  close NUMERIC(20, 8) NOT NULL,
  volume NUMERIC(30, 8),
  source VARCHAR(50) NOT NULL,
  PRIMARY KEY (symbol, timestamp, source)
);

CREATE INDEX idx_price_symbol_time ON price_data(symbol, timestamp DESC);

-- On-chain data
CREATE TABLE onchain_data (
  asset VARCHAR(10) NOT NULL,
  timestamp TIMESTAMPTZ NOT NULL,
  exchange_inflow NUMERIC(20, 8),
  exchange_outflow NUMERIC(20, 8),
  whale_transactions INT,
  active_addresses INT,
  source VARCHAR(50) NOT NULL,
  PRIMARY KEY (asset, timestamp)
);

-- Signals
CREATE TABLE signals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  agent_id UUID NOT NULL REFERENCES users(id),
  asset VARCHAR(20) NOT NULL,
  signal VARCHAR(10) NOT NULL CHECK (signal IN ('bullish', 'bearish', 'neutral')),
  confidence NUMERIC(3, 2) NOT NULL CHECK (confidence >= 0 AND confidence <= 1),
  dimensions JSONB NOT NULL,
  timeframe VARCHAR(10) NOT NULL,
  timestamp TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_signals_asset_time ON signals(asset, timestamp DESC);
CREATE INDEX idx_signals_agent ON signals(agent_id);

-- Anomaly flags
CREATE TABLE anomaly_flags (
  id SERIAL PRIMARY KEY,
  agent_id UUID NOT NULL REFERENCES users(id),
  type VARCHAR(50) NOT NULL,
  details TEXT,
  timestamp TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_anomaly_agent ON anomaly_flags(agent_id);

-- Reputation scores
CREATE TABLE reputation_scores (
  agent_id UUID PRIMARY KEY REFERENCES users(id),
  total_score NUMERIC(5, 2) NOT NULL,
  breakdown JSONB NOT NULL,
  tier VARCHAR(20) NOT NULL,
  last_updated TIMESTAMPTZ DEFAULT NOW()
);

-- Groups
CREATE TABLE groups (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  description TEXT,
  creator_id UUID NOT NULL REFERENCES users(id),
  is_public BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_groups_public ON groups(is_public) WHERE is_public = true;

-- Group members
CREATE TABLE group_members (
  group_id UUID NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  role VARCHAR(20) DEFAULT 'member',
  joined_at TIMESTAMPTZ DEFAULT NOW(),
  PRIMARY KEY (group_id, user_id)
);

-- Analyses
CREATE TABLE analyses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  group_id UUID NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
  author_id UUID NOT NULL REFERENCES users(id),
  title VARCHAR(200) NOT NULL,
  content JSONB NOT NULL,
  upvotes INT DEFAULT 0,
  downvotes INT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_analyses_group_time ON analyses(group_id, created_at DESC);

-- Audit log
CREATE TABLE api_key_audit (
  id SERIAL PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES users(id),
  service VARCHAR(50) NOT NULL,
  action VARCHAR(20) NOT NULL,
  ip_address INET,
  timestamp TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_audit_user_time ON api_key_audit(user_id, timestamp DESC);
EOSQL

echo "âœ… Database schema created"

# ============================================
# 5. æ„å»º Docker é•œåƒ
# ============================================
echo "ğŸ³ [5/10] Building Docker images..."
docker-compose build

# ============================================
# 6. å¯åŠ¨åŸºç¡€æœåŠ¡
# ============================================
echo "â–¶ï¸  [6/10] Starting core services..."
docker-compose up -d postgres redis

# ç­‰å¾…æ•°æ®åº“å°±ç»ª
echo "â³ Waiting for PostgreSQL..."
until docker exec finverse-postgres pg_isready -U finverse > /dev/null 2>&1; do
  sleep 1
done

# è¿è¡Œè¿ç§»
echo "ğŸ”„ Running database migrations..."
docker exec -i finverse-postgres psql -U finverse -d finverse < migrations/001_initial_schema.sql

# ============================================
# 7. å¯åŠ¨åº”ç”¨æœåŠ¡
# ============================================
echo "ğŸš€ [7/10] Starting application services..."
docker-compose up -d api web agent-orchestrator

# ============================================
# 8. SSL è¯ä¹¦è®¾ç½® (å¯é€‰,ç”Ÿäº§ç¯å¢ƒ)
# ============================================
read -p "ğŸ“œ Setup SSL certificate? (y/N): " -n 1 -r
echo
if [[ \$REPLY =~ ^[Yy]\$ ]]; then
    echo "ğŸ”’ [8/10] Setting up SSL..."
    ./scripts/setup-ssl.sh
else
    echo "â­ï¸  [8/10] Skipped SSL setup"
fi

# ============================================
# 9. å¯åŠ¨ Nginx
# ============================================
echo "ğŸŒ [9/10] Starting Nginx..."
docker-compose up -d nginx

# ============================================
# 10. å¥åº·æ£€æŸ¥
# ============================================
echo "ğŸ¥ [10/10] Running health checks..."

services=("postgres" "redis" "api" "web")
for service in "\${services[@]}"; do
  echo -n "   Checking \$service... "
  
  max_attempts=30
  attempt=0
  
  while [ \$attempt -lt \$max_attempts ]; do
    if docker-compose ps | grep "\$service" | grep -q "Up"; then
      echo "âœ…"
      break
    fi
    
    attempt=\$((attempt + 1))
    sleep 1
  done
  
  if [ \$attempt -eq \$max_attempts ]; then
    echo "âŒ Failed"
  fi
done

# ============================================
# å®Œæˆ
# ============================================
echo ""
echo "ğŸ‰ FinVerse initialization complete!"
echo ""
echo "ğŸ“‹ Next steps:"
echo "   1. Review .env file and update any necessary values"
echo "   2. Access the web app: http://localhost:3000"
echo "   3. Access API: http://localhost:3001"
echo "   4. Grafana monitoring: http://localhost:3003 (admin / [from .env])"
echo ""
echo "ğŸ“š Useful commands:"
echo "   View logs:        docker-compose logs -f [service]"
echo "   Stop all:         docker-compose down"
echo "   Restart service:  docker-compose restart [service]"
echo "   Run migrations:   docker exec -i finverse-postgres psql -U finverse -d finverse < migrations/[file].sql"
echo ""
echo "âš ï¸  IMPORTANT: Backup your .env file securely!"
\`\`\`

**ä½¿ç”¨æ–¹å¼ï¼š**

\`\`\`bash
# 1. å…‹éš†ä»“åº“æˆ–åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir finverse && cd finverse

# 2. å¤åˆ¶æ‰€æœ‰é¡¹ç›®æ–‡ä»¶åˆ°æ­¤ç›®å½•

# 3. èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
chmod +x scripts/*.sh

# 4. è¿è¡Œåˆå§‹åŒ–
./scripts/init-project.sh

# 5. é¦–æ¬¡éƒ¨ç½²å®Œæˆï¼
\`\`\`

---

## åå…«ã€ä¸€å¥è¯æ€»ç»“ - é¡¹ç›®æ ¸å¿ƒä»·å€¼ä¸»å¼ 

### 18.1 æŠ€æœ¯è§†è§’æ€»ç»“

> **FinVerse æ˜¯åŸºäº OpenClaw Agent è¿è¡Œæ—¶çš„é‡‘èæ•°æ®å¯è§†åŒ–ä¸åä½œå¹³å°ã€‚ç”¨æˆ·è‡ªå¸¦ AI å’Œæ•°æ®çš„é’¥åŒ™ï¼ˆAPI keysï¼‰ï¼Œå¹³å°æä¾›é›¶æˆæœ¬çš„ Agent æ‰˜ç®¡ã€ç»“æ„åŒ–ä¿¡å·å¹¿æ’­ã€å¼‚æ­¥åˆ†æå°ç»„å’Œå¤šç»´å¯è§†åŒ–ç•Œé¢ã€‚åœ¨ AI ä¸ªæ€§åŒ–ç•Œé¢åˆ°æ¥ä¹‹å‰çš„ 5-10 å¹´çª—å£æœŸï¼ŒæŠ“ä½ã€Œä¿¡æ¯å‘ˆç°è®¾è®¡ã€è¿™ä¸ªæ ¸å¿ƒä¸å¯æ›¿ä»£ä»·å€¼ã€‚**

### 18.2 å•†ä¸šè§†è§’æ€»ç»“

> **å¹³å°æ¨¡å¼ + ç”¨æˆ·è‡ªè´¹ AI = è¶…ä½è¾¹é™…æˆæœ¬ã€‚ä¸å–æ•°æ®ã€ä¸å– AIï¼Œå–çš„æ˜¯è¿æ¥ã€å‘ˆç°å’Œç¤¾åŒºã€‚ä»åŠ å¯†è´§å¸åˆ‡å…¥ï¼ˆç›‘ç®¡å®½æ¾ï¼‰ï¼Œé€æ­¥æ‰©å±•åˆ°ç¾è‚¡ã€å¤–æ±‡ã€è´µé‡‘å±ã€‚å…è´¹ç‰ˆå¸å¼•ç”¨æˆ·ï¼ŒPro ç‰ˆï¼ˆ\$29/æœˆï¼‰å˜ç°ï¼Œå›¢é˜Ÿç‰ˆï¼ˆ\$79/æœˆï¼‰æœåŠ¡ä¸“ä¸šäº¤æ˜“è€…ã€‚**

### 18.3 ç”¨æˆ·è§†è§’æ€»ç»“

> **æˆ‘çš„ AI Agent æ´»åœ¨ Telegram é‡Œï¼Œæ¯å¤©æ¨é€å¸‚åœºæ‘˜è¦å’Œå¼‚å¸¸é¢„è­¦ã€‚æƒ³æ·±å…¥åˆ†ææ—¶ï¼Œç‚¹é“¾æ¥è·³åˆ°ç½‘ç«™çœ‹å¯è§†åŒ–å›¾è¡¨å’Œ AI æ¨ç†é“¾ã€‚åŠ å…¥å°ç»„ä¸åŒé£æ ¼çš„äººå¼‚æ­¥åä½œï¼ŒAI å¸®æˆ‘æŠŠæƒ³æ³•å˜æˆç»“æ„åŒ–åˆ†æã€‚æ¯å‘¨è‡ªåŠ¨å¤ç›˜æˆ‘çš„åˆ¤æ–­å‡†ç¡®ç‡ï¼Œå¸®åŠ©æˆ‘æŒç»­è¿›æ­¥ã€‚**

### 18.4 æŠ€æœ¯æ¶æ„æ€»ç»“

\`\`\`
ç”¨æˆ· API key (è‡ªè´¹ AI)
    â†“
OpenClaw Agent å®¹å™¨ (512MB/1CPU,è‡ªåŠ¨æ‰©ç¼©å®¹)
    â†“
å¤šæ•°æ®æºèšåˆ (CoinGecko/Yahoo/Glassnode/...)
    â†“
ç»“æ„åŒ–ä¿¡å·æ±  (Agent é—´å¹¿æ’­è®¢é˜…)
    â†“
å¯è§†åŒ–å±‚ (æ‘˜è¦/å›¾è¡¨/æ•°æ®ä¸‰æ¨¡å¼ + å¤šå›¾å±‚æ¨ç†é“¾)
    â†“
å¼‚æ­¥åä½œå°ç»„ (AI è¾…åŠ©å‘å¸ƒ + å…±è¯†æŠ¥å‘Š + å†å²å¤ç›˜)
    â†“
ç”¨æˆ·èŠå¤©è½¯ä»¶ (Telegram/WhatsApp/Discord)
\`\`\`

### 18.5 å·®å¼‚åŒ–ç«äº‰æ€»ç»“

| ç»´åº¦ | ä¼ ç»Ÿé‡‘èç½‘ç«™ | FinVerse |
|------|-------------|---------|
| æ•°æ®æ¥æº | è‡ªæœ‰/ä¹°æ–­ | ç”¨æˆ·è‡ªå¸¦ API key |
| AI åˆ†æ | æ— æˆ–å¹³å°ç»Ÿä¸€ | æ¯ç”¨æˆ·ä¸“å± Agent |
| æˆæœ¬ç»“æ„ | é«˜ï¼ˆæ•°æ®+AIï¼‰ | ä½ï¼ˆä»…åŸºç¡€è®¾æ–½ï¼‰ |
| ç¤¾åŒºå½¢æ€ | è®ºå›/è¯„è®º | AI é©±åŠ¨çš„ç»“æ„åŒ–åä½œ |
| å¯è§†åŒ– | é™æ€å›¾è¡¨ | AI æ¨ç†é“¾ + å¤šå›¾å±‚å åŠ  |
| ä¸ªæ€§åŒ– | æœ‰é™ | å®Œå…¨ï¼ˆAgent è®°å¿†ç”¨æˆ·åå¥½ï¼‰ |

### 18.6 é£é™©ä¸å¯¹ç­–æ€»ç»“

| é£é™© | æ¦‚ç‡ | å½±å“ | å¯¹ç­– |
|------|------|------|------|
| AI äº’ç›¸æ¬ºéª— | ä¸­ | é«˜ | ä¿¡èª‰ç³»ç»Ÿ + å¼‚å¸¸æ£€æµ‹ + äº¤å‰éªŒè¯ |
| åˆè§„é›·åŒº | é«˜ | æé«˜ | ä»åŠ å¯†åˆ‡å…¥ + å…è´£å£°æ˜ + ä¸åšæŠ•é¡¾ |
| å†·å¯åŠ¨ | é«˜ | ä¸­ | å®˜æ–¹ Agent ä¿åº• + å…¬åŸŸä¿¡å·è´¨é‡å…ˆè¡Œ |
| ç¤¾äº¤ä»ä¼—äºé’± | ä¸­ | é«˜ | AI å»æƒ…ç»ªåŒ– + å¤šæ–¹è§‚ç‚¹å‘ˆç° + å¤ç›˜åæ€ |
| API key æ³„éœ² | ä½ | æé«˜ | AES-256-GCM åŠ å¯† + å®¡è®¡æ—¥å¿— |

### 18.7 æˆåŠŸæ ‡å‡†ï¼ˆ3ä¸ªæœˆMVPï¼‰

- **æŠ€æœ¯æŒ‡æ ‡**:
  - [ ] Agent åˆ›å»ºæˆåŠŸç‡ > 99%
  - [ ] å¥åº·æ£€æŸ¥é€šè¿‡ç‡ > 99.5%
  - [ ] API å“åº”æ—¶é—´ p95 < 500ms
  - [ ] æ•°æ®æ‹‰å–æˆåŠŸç‡ > 98%

- **äº§å“æŒ‡æ ‡**:
  - [ ] æ³¨å†Œåˆ°é¦–æ¬¡ Agent äº¤äº’ < 5 åˆ†é’Ÿ
  - [ ] å¯è§†åŒ–é¡µé¢åŠ è½½ < 2 ç§’
  - [ ] å¼‚å¸¸æ£€æµ‹åˆ°ç”¨æˆ·é€šçŸ¥ < 3 åˆ†é’Ÿ
  - [ ] å°ç»„åˆ†æå‘å¸ƒ < 10 ç§’

- **ç”¨æˆ·æŒ‡æ ‡**:
  - [ ] 100+ Beta æµ‹è¯•ç”¨æˆ·
  - [ ] æ—¥æ´» Agent > 50 ä¸ª
  - [ ] å…¬åŸŸä¿¡å· > 1000 æ¡/å¤©
  - [ ] è‡³å°‘ 10 ä¸ªæ´»è·ƒå°ç»„

- **å•†ä¸šæŒ‡æ ‡**:
  - [ ] Pro ç‰ˆè½¬åŒ–ç‡ > 5%
  - [ ] ç”¨æˆ·ç•™å­˜ï¼ˆ7å¤©ï¼‰> 40%
  - [ ] NPS > 50

---

## é™„å½•ï¼šå¿«é€Ÿå‚è€ƒ

### å…³é”®å‘½ä»¤é€ŸæŸ¥

\`\`\`bash
# é¡¹ç›®åˆå§‹åŒ–
./scripts/init-project.sh

# å¼€å‘ç¯å¢ƒ
npm run dev                    # å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
docker-compose up -d           # å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ

# æ•°æ®åº“
npm run migrate                # è¿è¡Œè¿ç§»
npm run migrate:generate       # ç”Ÿæˆè¿ç§»æ–‡ä»¶

# Docker ç®¡ç†
docker-compose logs -f api     # æŸ¥çœ‹ API æ—¥å¿—
docker-compose restart web     # é‡å¯å‰ç«¯
docker ps | grep agent-        # æŸ¥çœ‹æ‰€æœ‰ Agent å®¹å™¨

# Agent ç®¡ç†
./scripts/rolling-update.sh v1.2.0 10 30  # æ»šåŠ¨å‡çº§ Agent

# ç›‘æ§
http://localhost:9090          # Prometheus
http://localhost:3003          # Grafana
\`\`\`

### é‡è¦æ–‡ä»¶è·¯å¾„

\`\`\`
finverse/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ api/                  # åç«¯ API
â”‚   â”œâ”€â”€ web/                  # å‰ç«¯åº”ç”¨
â”‚   â”œâ”€â”€ agent-runtime/        # Agent è¿è¡Œæ—¶
â”‚   â””â”€â”€ agent-orchestrator/   # Agent è°ƒåº¦å™¨
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ data-schema/          # æ•°æ®ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ data-adapters/        # æ•°æ®æºé€‚é…å™¨
â”‚   â”œâ”€â”€ security/             # åŠ å¯†æœåŠ¡
â”‚   â””â”€â”€ reputation/           # ä¿¡èª‰ç³»ç»Ÿ
â”œâ”€â”€ migrations/               # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ nginx/                    # Nginx é…ç½®
â”œâ”€â”€ scripts/                  # è¿ç»´è„šæœ¬
â””â”€â”€ docker-compose.yml        # å®¹å™¨ç¼–æ’
\`\`\`

### ç¯å¢ƒå˜é‡æ¸…å•

\`\`\`bash
# å¿…éœ€
POSTGRES_PASSWORD=xxx
REDIS_PASSWORD=xxx
JWT_SECRET=xxx
MASTER_ENCRYPTION_KEY=xxx  # 32 å­—èŠ‚ hex

# ç”Ÿäº§ç¯å¢ƒ
API_URL=https://api.finverse.ai
NODE_ENV=production

# å¯é€‰
MAX_AGENTS=1000
GRAFANA_PASSWORD=xxx
\`\`\`

---

## æ€»ç»“

æœ¬å¼€å‘æç¤ºè¯æ–‡æ¡£æ¶µç›–äº† FinVerse é¡¹ç›®ç¬¬ 13-18 ç« çš„**æç»†é¢—ç²’åº¦å¯æ‰§è¡Œå¼€å‘æŒ‡å—**ï¼ŒåŒ…æ‹¬ï¼š

âœ… **ç¬¬åä¸‰ç« **ï¼š6 ä¸ªæ•°æ®æºé€‚é…å™¨çš„å®Œæ•´å®ç°ä»£ç ï¼ˆCoinGecko/Yahoo Finance/Glassnodeç­‰ï¼‰  
âœ… **ç¬¬åå››ç« **ï¼šä¿¡èª‰è¯„åˆ†ç®—æ³•å…¬å¼ã€å¼‚å¸¸æ£€æµ‹è§„åˆ™ã€AES-256-GCM åŠ å¯†ã€å…è´£å£°æ˜ç»„ä»¶  
âœ… **ç¬¬åäº”ç« **ï¼šDocker Compose é…ç½®ã€Agent è°ƒåº¦å™¨å®Œæ•´å®ç°ã€å¥åº·æ£€æŸ¥ã€ç°åº¦å‘å¸ƒè„šæœ¬  
âœ… **ç¬¬åå…­ç« **ï¼š3 ä¸ªæœˆ 12 ä¸ª sprint ä»»åŠ¡æ‹†è§£ï¼Œæ¯ä¸ªä»»åŠ¡å«éªŒæ”¶æ ‡å‡†  
âœ… **ç¬¬åä¸ƒç« **ï¼šå®Œæ•´æŠ€æœ¯æ ˆç‰ˆæœ¬ã€package.jsonã€Dockerfileã€Nginx é…ç½®ã€SSL è®¾ç½®ã€é¡¹ç›®åˆå§‹åŒ–è„šæœ¬  
âœ… **ç¬¬åå…«ç« **ï¼šå¤šè§†è§’æ€»ç»“ã€å·®å¼‚åŒ–ç«äº‰ã€é£é™©å¯¹ç­–ã€æˆåŠŸæ ‡å‡†

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼š
1. æ‰§è¡Œ \`./scripts/init-project.sh\` å®Œæˆé¡¹ç›®åˆå§‹åŒ–
2. å¼€å§‹ Sprint 1.1 å¼€å‘ï¼ˆç”¨æˆ·ç³»ç»Ÿä¸è®¤è¯ï¼‰
3. æ¯å‘¨è¿›è¡Œ sprint review å’ŒéªŒæ”¶æ ‡å‡†æ£€æŸ¥

**æ–‡æ¡£å·²å®Œæˆï¼å‡†å¤‡å¥½å¼€å§‹æ„å»º FinVerse äº†ã€‚** ğŸš€# FinVerse å¼€å‘æç¤ºè¯ - é—æ¼ç« èŠ‚è¡¥å…¨

> è¡¥å…¨ Part A/B/C ä¸­é—æ¼æˆ–ä¸å®Œæ•´çš„ç« èŠ‚
> ç”Ÿæˆæ—¶é—´ï¼š2026-02-08

---

## ç« èŠ‚å…­ï¼šå…¬åŸŸï¼ˆä¿¡å·ç³»ç»Ÿï¼‰- è¡¥å…¨éƒ¨åˆ†

### 6.1 ä¿¡å·æ± æ•°æ®åº“å®Œæ•´è®¾è®¡

#### 6.1.1 ä¿¡å·è¡¨ï¼ˆæ‰©å±•ç‰ˆï¼‰

\`\`\`sql
-- å…¬åŸŸä¿¡å·è¡¨ï¼ˆæ‰©å±• Part C çš„åŸºç¡€ç‰ˆæœ¬ï¼‰
CREATE TABLE public_signals (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    agent_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    asset VARCHAR(20) NOT NULL,
    signal VARCHAR(10) NOT NULL CHECK (signal IN ('bullish', 'bearish', 'neutral')),
    confidence NUMERIC(3, 2) NOT NULL CHECK (confidence >= 0 AND confidence <= 1),
    
    -- å¤šç»´åˆ†æ
    dimensions JSONB NOT NULL,
    /* æ ¼å¼:
    {
        "on_chain": {"signal": "bearish", "confidence": 0.78, "summary": "...", "key_metrics": [...]},
        "technical": {...},
        "macro": {...},
        "sentiment": {...}
    }
    */
    
    -- å…³é”®ä½
    key_levels JSONB,
    /* {"support": [67200, 64800], "resistance": [69800]} */
    
    -- æ—¶é—´æ¡†æ¶
    timeframe VARCHAR(10) NOT NULL, -- '1h', '4h', '24h', '48h', '1w'
    
    -- æ¨ç†è¿‡ç¨‹
    reasoning TEXT NOT NULL,
    
    -- æ•°æ®æ¥æº
    data_sources JSONB,
    /* ["CoinGecko", "Glassnode", "TradingView"] */
    
    -- éªŒè¯çŠ¶æ€ï¼ˆäº‹åéªŒè¯ï¼‰
    verified BOOLEAN DEFAULT FALSE,
    actual_outcome VARCHAR(10), -- å®é™…èµ°åŠ¿ï¼š'bullish'/'bearish'/'neutral'
    accuracy_score NUMERIC(3, 2), -- 0-1ï¼Œå‡†ç¡®åº¦è¯„åˆ†
    verified_at TIMESTAMP,
    
    -- è®¢é˜…ç›¸å…³
    view_count INTEGER DEFAULT 0,
    subscriber_count INTEGER DEFAULT 0, -- æœ‰å¤šå°‘ Agent è®¢é˜…äº†è¿™ä¸ªä¿¡å·
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT NOW(),
    expires_at TIMESTAMP, -- ä¿¡å·è¿‡æœŸæ—¶é—´ï¼ˆåŸºäº timeframe è®¡ç®—ï¼‰
    
    -- ç´¢å¼•
    CONSTRAINT valid_timeframe CHECK (timeframe IN ('1h', '4h', '24h', '48h', '1w', '1m'))
);

CREATE INDEX idx_public_signals_asset_time ON public_signals(asset, created_at DESC);
CREATE INDEX idx_public_signals_agent ON public_signals(agent_id);
CREATE INDEX idx_public_signals_expires ON public_signals(expires_at) WHERE expires_at IS NOT NULL;
CREATE INDEX idx_public_signals_verified ON public_signals(verified, asset);

-- ä¿¡å·è®¢é˜…è¡¨
CREATE TABLE signal_subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    subscriber_agent_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- è®¢é˜…æ¡ä»¶
    assets TEXT[] DEFAULT '{}', -- ['BTC/USD', 'ETH/USD'] æˆ– ç©ºæ•°ç»„ = è®¢é˜…æ‰€æœ‰
    min_confidence NUMERIC(3, 2) DEFAULT 0.6, -- æœ€ä½ç½®ä¿¡åº¦é˜ˆå€¼
    timeframes TEXT[] DEFAULT '{"24h", "48h"}', -- å…³æ³¨çš„æ—¶é—´æ¡†æ¶
    
    -- è®¢é˜…çš„ Agentï¼ˆå¯é€‰ï¼Œç©º = è®¢é˜…æ‰€æœ‰ï¼‰
    publisher_agent_ids UUID[] DEFAULT NULL,
    
    -- è®¢é˜…çš„ä¿¡èª‰ç­‰çº§ï¼ˆå¯é€‰ï¼‰
    min_reputation_tier VARCHAR(20), -- 'reliable', 'expert', 'master'
    
    -- é€šçŸ¥è®¾ç½®
    notify_on_publish BOOLEAN DEFAULT TRUE,
    notify_on_consensus_change BOOLEAN DEFAULT TRUE, -- å…±è¯†å˜åŒ–æ—¶é€šçŸ¥
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(subscriber_agent_id) -- æ¯ä¸ª Agent åªæœ‰ä¸€ä¸ªè®¢é˜…é…ç½®
);

CREATE INDEX idx_subscriptions_assets ON signal_subscriptions USING GIN(assets);

-- ä¿¡å·äº¤äº’è¡¨ï¼ˆAgent å¯¹ä¿¡å·çš„åé¦ˆï¼‰
CREATE TABLE signal_interactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    signal_id UUID NOT NULL REFERENCES public_signals(id) ON DELETE CASCADE,
    agent_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    interaction_type VARCHAR(20) NOT NULL, -- 'view', 'agree', 'disagree', 'use_in_analysis'
    
    -- å¦‚æœæ˜¯ agree/disagreeï¼Œå¯ä»¥é™„åŠ è‡ªå·±çš„è§‚ç‚¹
    own_signal VARCHAR(10), -- 'bullish', 'bearish', 'neutral'
    own_confidence NUMERIC(3, 2),
    comment TEXT,
    
    created_at TIMESTAMP DEFAULT NOW(),
    
    CONSTRAINT valid_interaction CHECK (interaction_type IN ('view', 'agree', 'disagree', 'use_in_analysis'))
);

CREATE INDEX idx_interactions_signal ON signal_interactions(signal_id);
CREATE INDEX idx_interactions_agent ON signal_interactions(agent_id);

-- å…±è¯†å¿«ç…§è¡¨ï¼ˆæ¯å°æ—¶èšåˆä¸€æ¬¡ï¼‰
CREATE TABLE signal_consensus_snapshots (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    asset VARCHAR(20) NOT NULL,
    timeframe VARCHAR(10) NOT NULL,
    snapshot_time TIMESTAMP NOT NULL,
    
    -- ç»Ÿè®¡æ•°æ®
    total_signals INTEGER NOT NULL,
    bullish_count INTEGER NOT NULL,
    bearish_count INTEGER NOT NULL,
    neutral_count INTEGER NOT NULL,
    
    -- åŠ æƒå…±è¯†ï¼ˆæŒ‰ä¿¡èª‰è¯„åˆ†åŠ æƒï¼‰
    weighted_consensus VARCHAR(10) NOT NULL, -- 'bullish', 'bearish', 'neutral'
    weighted_confidence NUMERIC(3, 2) NOT NULL,
    
    -- åˆ†ä½æ•°æ•°æ®
    confidence_percentiles JSONB, -- {"p25": 0.65, "p50": 0.72, "p75": 0.85}
    
    -- åˆ†æ­§åº¦ï¼ˆæ ‡å‡†å·®ï¼‰
    divergence_score NUMERIC(4, 3), -- 0-1ï¼Œè¶Šé«˜è¶Šåˆ†æ­§
    
    -- å‚ä¸ Agent ä¿¡èª‰åˆ†å¸ƒ
    reputation_distribution JSONB,
    /* {"novice": 5, "reliable": 12, "expert": 8, "master": 3} */
    
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(asset, timeframe, snapshot_time)
);

CREATE INDEX idx_consensus_snapshots_asset_time ON signal_consensus_snapshots(asset, snapshot_time DESC);
\`\`\`

---

### 6.2 ä¿¡å·èšåˆç®—æ³•å®ç°

**åˆ›å»ºæ–‡ä»¶ï¼š\`packages/signal-aggregator/src/aggregator.ts\`**

\`\`\`typescript
import { db } from '@finverse/database';

/**
 * ä¿¡å·èšåˆå™¨
 * 
 * èŒè´£ï¼š
 * - ä»å…¬åŸŸä¿¡å·æ± ä¸­èšåˆå¤šä¸ª Agent çš„ä¿¡å·
 * - æŒ‰èµ„äº§å’Œæ—¶é—´æ¡†æ¶åˆ†ç»„
 * - è®¡ç®—åŠ æƒå…±è¯†ï¼ˆåŸºäºä¿¡èª‰è¯„åˆ†ï¼‰
 * - ç”Ÿæˆå…±è¯†çƒ­åŠ›å›¾æ•°æ®
 */
export class SignalAggregator {
  
  /**
   * èšåˆæŒ‡å®šèµ„äº§çš„ä¿¡å·
   */
  async aggregateSignals(
    asset: string,
    timeframe: string,
    since: Date = new Date(Date.now() - 3600000) // é»˜è®¤æœ€è¿‘ 1 å°æ—¶
  ): Promise<AggregatedSignal> {
    // 1. è·å–æ—¶é—´èŒƒå›´å†…çš„æ‰€æœ‰ä¿¡å·
    const signals = await db.query<Signal>(
      \`SELECT s.*, r.total_score as agent_reputation
       FROM public_signals s
       LEFT JOIN reputation_scores r ON s.agent_id = r.agent_id
       WHERE s.asset = \$1 
         AND s.timeframe = \$2
         AND s.created_at >= \$3
         AND s.expires_at > NOW()
       ORDER BY s.created_at DESC\`,
      [asset, timeframe, since]
    );

    if (signals.length === 0) {
      return {
        asset,
        timeframe,
        total_signals: 0,
        consensus: 'neutral',
        confidence: 0.5,
        divergence: 0,
        signals: []
      };
    }

    // 2. ç»Ÿè®¡åŸºç¡€åˆ†å¸ƒ
    const distribution = {
      bullish: signals.filter(s => s.signal === 'bullish').length,
      bearish: signals.filter(s => s.signal === 'bearish').length,
      neutral: signals.filter(s => s.signal === 'neutral').length
    };

    // 3. è®¡ç®—åŠ æƒå…±è¯†ï¼ˆæŒ‰ä¿¡èª‰è¯„åˆ†åŠ æƒï¼‰
    let weightedBullish = 0;
    let weightedBearish = 0;
    let weightedNeutral = 0;
    let totalWeight = 0;

    signals.forEach(signal => {
      // ä¿¡èª‰è¯„åˆ†ä½œä¸ºæƒé‡ï¼ˆ0-100 -> 0-1ï¼‰
      const reputationWeight = (signal.agent_reputation || 50) / 100;
      
      // ç½®ä¿¡åº¦ä¹Ÿä½œä¸ºæƒé‡
      const confidenceWeight = signal.confidence;
      
      // ç»¼åˆæƒé‡
      const weight = reputationWeight * confidenceWeight;
      totalWeight += weight;

      if (signal.signal === 'bullish') {
        weightedBullish += weight;
      } else if (signal.signal === 'bearish') {
        weightedBearish += weight;
      } else {
        weightedNeutral += weight;
      }
    });

    // å½’ä¸€åŒ–
    weightedBullish /= totalWeight;
    weightedBearish /= totalWeight;
    weightedNeutral /= totalWeight;

    // 4. ç¡®å®šåŠ æƒå…±è¯†
    let consensus: 'bullish' | 'bearish' | 'neutral';
    let confidence: number;

    if (weightedBullish > 0.6) {
      consensus = 'bullish';
      confidence = weightedBullish;
    } else if (weightedBearish > 0.6) {
      consensus = 'bearish';
      confidence = weightedBearish;
    } else {
      consensus = 'neutral';
      confidence = 1 - Math.abs(weightedBullish - weightedBearish); // è¶Šæ¥è¿‘è¯´æ˜è¶Šä¸­æ€§
    }

    // 5. è®¡ç®—åˆ†æ­§åº¦ï¼ˆä½¿ç”¨æ ‡å‡†å·®ï¼‰
    const confidences = signals.map(s => s.confidence);
    const mean = confidences.reduce((a, b) => a + b, 0) / confidences.length;
    const variance = confidences.reduce((sum, c) => sum + Math.pow(c - mean, 2), 0) / confidences.length;
    const divergence = Math.sqrt(variance);

    // 6. è®¡ç®—ä¿¡èª‰åˆ†å¸ƒ
    const reputationDistribution = signals.reduce((acc, signal) => {
      const tier = this.getReputationTier(signal.agent_reputation || 50);
      acc[tier] = (acc[tier] || 0) + 1;
      return acc;
    }, {} as Record<string, number>);

    return {
      asset,
      timeframe,
      total_signals: signals.length,
      distribution,
      consensus,
      confidence,
      divergence,
      reputation_distribution: reputationDistribution,
      signals: signals.slice(0, 20), // è¿”å›å‰ 20 ä¸ªæœ€æ–°ä¿¡å·
      aggregated_at: new Date()
    };
  }

  /**
   * ç”Ÿæˆå…±è¯†çƒ­åŠ›å›¾æ•°æ®
   */
  async generateConsensusHeatmap(
    assets: string[],
    timeframe: string = '24h'
  ): Promise<HeatmapData> {
    const heatmapData: HeatmapData = {
      assets: [],
      timeframe,
      generated_at: new Date()
    };

    for (const asset of assets) {
      const aggregated = await this.aggregateSignals(asset, timeframe);
      
      heatmapData.assets.push({
        asset,
        consensus: aggregated.consensus,
        confidence: aggregated.confidence,
        signal_count: aggregated.total_signals,
        divergence: aggregated.divergence,
        color: this.getHeatmapColor(aggregated.consensus, aggregated.confidence)
      });
    }

    return heatmapData;
  }

  /**
   * ä¿å­˜å…±è¯†å¿«ç…§ï¼ˆå®šæ—¶ä»»åŠ¡ï¼Œæ¯å°æ—¶æ‰§è¡Œï¼‰
   */
  async saveConsensusSnapshot(): Promise<void> {
    const assets = ['BTC/USD', 'ETH/USD', 'SOL/USD', 'AAPL', 'TSLA']; // ä¸»è¦èµ„äº§
    const timeframes = ['24h', '48h', '1w'];

    for (const asset of assets) {
      for (const timeframe of timeframes) {
        const aggregated = await this.aggregateSignals(asset, timeframe);

        await db.query(
          \`INSERT INTO signal_consensus_snapshots 
           (asset, timeframe, snapshot_time, total_signals, bullish_count, bearish_count, neutral_count,
            weighted_consensus, weighted_confidence, divergence_score, reputation_distribution)
           VALUES (\$1, \$2, NOW(), \$3, \$4, \$5, \$6, \$7, \$8, \$9, \$10)
           ON CONFLICT (asset, timeframe, snapshot_time) DO UPDATE SET
             total_signals = EXCLUDED.total_signals,
             weighted_consensus = EXCLUDED.weighted_consensus,
             weighted_confidence = EXCLUDED.weighted_confidence\`,
          [
            asset,
            timeframe,
            aggregated.total_signals,
            aggregated.distribution.bullish,
            aggregated.distribution.bearish,
            aggregated.distribution.neutral,
            aggregated.consensus,
            aggregated.confidence,
            aggregated.divergence,
            JSON.stringify(aggregated.reputation_distribution)
          ]
        );
      }
    }
  }

  /**
   * Agent è®¢é˜…ä¿¡å·æ¨é€
   */
  async pushSignalsToSubscribers(signal: Signal): Promise<void> {
    // æŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„è®¢é˜…è€…
    const subscribers = await db.query<Subscription>(
      \`SELECT * FROM signal_subscriptions
       WHERE (assets = '{}' OR \$1 = ANY(assets))
         AND (timeframes = '{}' OR \$2 = ANY(timeframes))
         AND min_confidence <= \$3
         AND (publisher_agent_ids IS NULL OR \$4 = ANY(publisher_agent_ids))
         AND notify_on_publish = true\`,
      [signal.asset, signal.timeframe, signal.confidence, signal.agent_id]
    );

    // æ¨é€ç»™æ¯ä¸ªè®¢é˜…è€…çš„ Agent
    for (const subscriber of subscribers) {
      await this.notifyAgent(subscriber.subscriber_agent_id, {
        type: 'new_signal',
        signal_id: signal.id,
        signal: {
          asset: signal.asset,
          consensus: signal.signal,
          confidence: signal.confidence,
          timeframe: signal.timeframe,
          summary: signal.reasoning.substring(0, 200)
        }
      });
    }
  }

  private getReputationTier(score: number): string {
    if (score >= 80) return 'master';
    if (score >= 65) return 'expert';
    if (score >= 50) return 'reliable';
    return 'novice';
  }

  private getHeatmapColor(consensus: string, confidence: number): string {
    if (consensus === 'bullish') {
      return confidence > 0.8 ? '#16a34a' : confidence > 0.6 ? '#22c55e' : '#86efac';
    } else if (consensus === 'bearish') {
      return confidence > 0.8 ? '#dc2626' : confidence > 0.6 ? '#ef4444' : '#fca5a5';
    } else {
      return '#9ca3af';
    }
  }

  private async notifyAgent(agentId: string, notification: any): Promise<void> {
    // è°ƒç”¨ Agent é€šçŸ¥ API
    // å®ç°çœç•¥
  }
}

interface Signal {
  id: string;
  agent_id: string;
  asset: string;
  signal: 'bullish' | 'bearish' | 'neutral';
  confidence: number;
  dimensions: any;
  key_levels: any;
  timeframe: string;
  reasoning: string;
  agent_reputation: number;
  created_at: Date;
}

interface AggregatedSignal {
  asset: string;
  timeframe: string;
  total_signals: number;
  distribution?: {
    bullish: number;
    bearish: number;
    neutral: number;
  };
  consensus: 'bullish' | 'bearish' | 'neutral';
  confidence: number;
  divergence: number;
  reputation_distribution?: Record<string, number>;
  signals: Signal[];
  aggregated_at: Date;
}

interface HeatmapData {
  assets: Array<{
    asset: string;
    consensus: string;
    confidence: number;
    signal_count: number;
    divergence: number;
    color: string;
  }>;
  timeframe: string;
  generated_at: Date;
}

interface Subscription {
  subscriber_agent_id: string;
  assets: string[];
  timeframes: string[];
  min_confidence: number;
  publisher_agent_ids: string[] | null;
}
\`\`\`

---

### 6.3 å…±è¯†çƒ­åŠ›å›¾å‰ç«¯ç»„ä»¶

**åˆ›å»ºæ–‡ä»¶ï¼š\`components/signals/ConsensusHeatmap.tsx\`**

\`\`\`typescript
import React, { useEffect, useState } from 'react';
import { motion } from 'framer-motion';

interface HeatmapData {
  assets: Array<{
    asset: string;
    consensus: 'bullish' | 'bearish' | 'neutral';
    confidence: number;
    signal_count: number;
    divergence: number;
    color: string;
  }>;
  timeframe: string;
}

export const ConsensusHeatmap: React.FC<{
  timeframe?: string;
}> = ({ timeframe = '24h' }) => {
  const [heatmapData, setHeatmapData] = useState<HeatmapData | null>(null);

  useEffect(() => {
    loadHeatmapData();
  }, [timeframe]);

  async function loadHeatmapData() {
    const response = await fetch(\`/api/signals/consensus-heatmap?timeframe=\${timeframe}\`);
    const data = await response.json();
    setHeatmapData(data);
  }

  if (!heatmapData) return <div>åŠ è½½ä¸­...</div>;

  return (
    <div className="bg-white rounded-xl p-6 shadow-lg">
      <div className="flex justify-between items-center mb-6">
        <h2 className="text-2xl font-bold">ç¤¾åŒºå…±è¯†çƒ­åŠ›å›¾</h2>
        <select
          value={timeframe}
          onChange={(e) => setTimeframe(e.target.value)}
          className="px-4 py-2 border rounded-lg"
        >
          <option value="1h">1å°æ—¶</option>
          <option value="4h">4å°æ—¶</option>
          <option value="24h">24å°æ—¶</option>
          <option value="48h">48å°æ—¶</option>
          <option value="1w">1å‘¨</option>
        </select>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
        {heatmapData.assets.map((assetData, index) => (
          <motion.div
            key={assetData.asset}
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ delay: index * 0.05 }}
            whileHover={{ scale: 1.05 }}
            className="rounded-lg p-4 cursor-pointer transition-all"
            style={{
              backgroundColor: assetData.color,
              color: assetData.consensus === 'neutral' ? '#1f2937' : 'white'
            }}
          >
            {/* èµ„äº§åç§° */}
            <div className="font-bold text-lg mb-2">{assetData.asset}</div>

            {/* å…±è¯† */}
            <div className="text-sm mb-1">
              {assetData.consensus === 'bullish' ? 'çœ‹å¤š' : assetData.consensus === 'bearish' ? 'çœ‹ç©º' : 'ä¸­æ€§'}
            </div>

            {/* ç½®ä¿¡åº¦ */}
            <div className="text-2xl font-bold mb-1">
              {Math.round(assetData.confidence * 100)}%
            </div>

            {/* ä¿¡å·æ•°é‡ */}
            <div className="text-xs opacity-80">
              {assetData.signal_count} ä¸ªä¿¡å·
            </div>

            {/* åˆ†æ­§åº¦æŒ‡ç¤ºå™¨ */}
            {assetData.divergence > 0.3 && (
              <div className="mt-2 text-xs flex items-center gap-1">
                <span>âš ï¸</span>
                <span>åˆ†æ­§è¾ƒå¤§</span>
              </div>
            )}
          </motion.div>
        ))}
      </div>

      {/* å›¾ä¾‹ */}
      <div className="mt-6 flex items-center justify-center gap-6 text-sm">
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 rounded" style={{ backgroundColor: '#16a34a' }} />
          <span>å¼ºçƒˆçœ‹å¤š</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 rounded" style={{ backgroundColor: '#9ca3af' }} />
          <span>ä¸­æ€§</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 rounded" style={{ backgroundColor: '#dc2626' }} />
          <span>å¼ºçƒˆçœ‹ç©º</span>
        </div>
      </div>
    </div>
  );
};
\`\`\`

---

## ç« èŠ‚ä¹ï¼šå¯è§†åŒ– - è¡¥å…¨éƒ¨åˆ†

### 9.2 å›¾è¡¨æ¨¡å¼ - å›¾å±‚ç³»ç»Ÿå®Œæ•´å®ç°

**ç»§ç»­ Part B è¢«æˆªæ–­çš„éƒ¨åˆ†ï¼Œè¡¥å…¨å›¾å±‚ç³»ç»Ÿ**

\`\`\`typescript
// ChartMode.tsx (ç»­)

const layerNames = {
  price: 'ä»·æ ¼',
  volume: 'æˆäº¤é‡',
  ai_annotations: 'AIæ ‡æ³¨',
  support_resistance: 'æ”¯æ’‘é˜»åŠ›',
  macro_events: 'å®è§‚äº‹ä»¶',
  on_chain: 'é“¾ä¸Šæ•°æ®',
  heatmap: 'å¼‚å¸¸çƒ­åŠ›å›¾',
  historical_overlay: 'å†å²å å½±'
};

/**
 * æ¸²æŸ“æ‰€æœ‰å›¾å±‚
 */
async function renderLayers(
  chart: IChartApi,
  data: ChartData,
  enabledLayers: Record<string, boolean>
) {
  // æ¸…é™¤æ‰€æœ‰ç°æœ‰ç³»åˆ—
  chart.timeScale().fitContent();

  // 1. ä»·æ ¼ï¼ˆKçº¿å›¾ï¼‰
  if (enabledLayers.price) {
    const candlestickSeries = chart.addCandlestickSeries({
      upColor: '#22c55e',
      downColor: '#ef4444',
      borderVisible: false,
      wickUpColor: '#22c55e',
      wickDownColor: '#ef4444'
    });

    candlestickSeries.setData(data.ohlc);
  }

  // 2. æˆäº¤é‡
  if (enabledLayers.volume) {
    const volumeSeries = chart.addHistogramSeries({
      color: '#60a5fa',
      priceFormat: {
        type: 'volume',
      },
      priceScaleId: 'volume',
      scaleMargins: {
        top: 0.8,
        bottom: 0,
      },
    });

    volumeSeries.setData(data.volume);
  }

  // 3. AI æ ‡æ³¨
  if (enabledLayers.ai_annotations && data.ai_annotations) {
    data.ai_annotations.forEach(annotation => {
      if (annotation.type === 'horizontal_line') {
        // æ”¯æ’‘/é˜»åŠ›çº¿
        const priceLine = candlestickSeries.createPriceLine({
          price: annotation.price,
          color: annotation.color,
          lineWidth: 2,
          lineStyle: 2, // è™šçº¿
          axisLabelVisible: true,
          title: annotation.label
        });
      } else if (annotation.type === 'marker') {
        // ç‚¹æ ‡æ³¨
        candlestickSeries.setMarkers([
          {
            time: annotation.time,
            position: annotation.position, // 'aboveBar' | 'belowBar'
            color: annotation.color,
            shape: 'circle',
            text: annotation.text,
            size: 1
          }
        ]);
      }
    });
  }

  // 4. å®è§‚äº‹ä»¶æ ‡è®°
  if (enabledLayers.macro_events && data.macro_events) {
    const markers = data.macro_events.map(event => ({
      time: event.timestamp,
      position: 'aboveBar' as const,
      color: '#f59e0b',
      shape: 'circle' as const,
      text: event.name,
      size: 1
    }));

    candlestickSeries.setMarkers(markers);
  }

  // 5. é“¾ä¸Šæ•°æ®ï¼ˆå åŠ åœ¨ä¸»å›¾ä¸Šï¼‰
  if (enabledLayers.on_chain && data.on_chain) {
    const onChainSeries = chart.addLineSeries({
      color: '#8b5cf6',
      lineWidth: 2,
      priceScaleId: 'onchain',
      scaleMargins: {
        top: 0.1,
        bottom: 0.7,
      },
    });

    onChainSeries.setData(data.on_chain);
  }

  // 6. å¼‚å¸¸çƒ­åŠ›å›¾ï¼ˆèƒŒæ™¯æ¸å˜ï¼‰
  if (enabledLayers.heatmap && data.anomalies) {
    // ä½¿ç”¨ Canvas overlay å®ç°çƒ­åŠ›å›¾
    renderHeatmapOverlay(chart, data.anomalies);
  }

  // 7. å†å²å å½±
  if (enabledLayers.historical_overlay && data.historical_pattern) {
    const historicalSeries = chart.addLineSeries({
      color: '#9ca3af',
      lineWidth: 1,
      lineStyle: 2,
      priceScaleId: 'right',
      lastValueVisible: false,
      priceLineVisible: false,
      opacity: 0.5
    });

    historicalSeries.setData(data.historical_pattern);
  }
}

/**
 * çƒ­åŠ›å›¾å åŠ å±‚
 */
function renderHeatmapOverlay(
  chart: IChartApi,
  anomalies: Array<{ time: number; severity: number }>
) {
  const container = chart.chartElement();
  const canvas = document.createElement('canvas');
  canvas.style.position = 'absolute';
  canvas.style.top = '0';
  canvas.style.left = '0';
  canvas.style.pointerEvents = 'none';
  canvas.width = container.clientWidth;
  canvas.height = container.clientHeight;
  
  container.appendChild(canvas);

  const ctx = canvas.getContext('2d')!;

  anomalies.forEach(anomaly => {
    const x = chart.timeScale().timeToCoordinate(anomaly.time);
    if (!x) return;

    const gradient = ctx.createRadialGradient(x, canvas.height / 2, 0, x, canvas.height / 2, 50);
    gradient.addColorStop(0, \`rgba(239, 68, 68, \${anomaly.severity})\`);
    gradient.addColorStop(1, 'rgba(239, 68, 68, 0)');

    ctx.fillStyle = gradient;
    ctx.fillRect(x - 50, 0, 100, canvas.height);
  });
}
\`\`\`

---

### 9.3 æ•°æ®æ¨¡å¼ï¼ˆå®Œæ•´å®ç°ï¼‰

**åˆ›å»ºæ–‡ä»¶ï¼š\`components/visualization/DataMode.tsx\`**

\`\`\`typescript
import React, { useEffect, useState } from 'react';
import { motion } from 'framer-motion';

interface DataModeProps {
  asset: string;
}

interface MarketData {
  price: {
    current: number;
    open: number;
    high: number;
    low: number;
    change_pct: number;
    change_24h: number;
  };
  volume: {
    current: number;
    avg_24h: number;
    change_pct: number;
  };
  onchain?: {
    exchange_inflow: number;
    exchange_outflow: number;
    active_addresses: number;
    whale_transactions: number;
  };
  derivatives?: {
    open_interest: number;
    funding_rate: number;
    long_short_ratio: number;
  };
  indicators: {
    rsi: number;
    macd: { value: number; signal: number; histogram: number };
    bollinger: { upper: number; middle: number; lower: number };
    ema_20: number;
    ema_50: number;
    ema_200: number;
  };
  sentiment: {
    fear_greed_index: number;
    social_volume: number;
    social_sentiment: number;
  };
}

export const DataMode: React.FC<DataModeProps> = ({ asset }) => {
  const [data, setData] = useState<MarketData | null>(null);
  const [blinkingFields, setBlinkingFields] = useState<Set<string>>(new Set());

  useEffect(() => {
    loadData();
    
    // WebSocket è¿æ¥å®æ—¶æ›´æ–°
    const ws = new WebSocket(\`wss://api.finverse.ai/ws/realtime?asset=\${asset}\`);
    
    ws.onmessage = (event) => {
      const newData = JSON.parse(event.data);
      
      // æ£€æµ‹å˜åŒ–çš„å­—æ®µå¹¶é—ªçƒ
      if (data) {
        const changedFields = detectChangedFields(data, newData);
        setBlinkingFields(changedFields);
        setTimeout(() => setBlinkingFields(new Set()), 500); // é—ªçƒ 0.5 ç§’
      }
      
      setData(newData);
    };

    return () => ws.close();
  }, [asset]);

  async function loadData() {
    const response = await fetch(\`/api/market-data/\${asset}/full\`);
    const data = await response.json();
    setData(data);
  }

  if (!data) return <div>åŠ è½½ä¸­...</div>;

  return (
    <div className="min-h-screen bg-gray-900 text-gray-100 p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="mb-6 flex items-center justify-between">
          <h1 className="text-3xl font-bold">{asset} æ•°æ®é¢æ¿</h1>
          <div className="text-sm text-gray-400">
            å®æ—¶æ›´æ–° Â· æœ€åæ›´æ–°: {new Date().toLocaleTimeString()}
          </div>
        </div>

        {/* Price Section */}
        <DataSection title="ä»·æ ¼" color="#6366f1">
          <DataGrid>
            <DataCell
              label="å½“å‰ä»·æ ¼"
              value={formatCurrency(data.price.current)}
              isBlinking={blinkingFields.has('price.current')}
              size="large"
            />
            <DataCell label="å¼€ç›˜ä»·" value={formatCurrency(data.price.open)} />
            <DataCell label="æœ€é«˜ä»·" value={formatCurrency(data.price.high)} color="#22c55e" />
            <DataCell label="æœ€ä½ä»·" value={formatCurrency(data.price.low)} color="#ef4444" />
            <DataCell
              label="24h æ¶¨è·Œ"
              value={formatPercentage(data.price.change_24h)}
              color={data.price.change_24h >= 0 ? '#22c55e' : '#ef4444'}
              isBlinking={blinkingFields.has('price.change_24h')}
            />
          </DataGrid>
        </DataSection>

        {/* Volume Section */}
        <DataSection title="æˆäº¤é‡" color="#8b5cf6">
          <DataGrid>
            <DataCell
              label="å½“å‰æˆäº¤é‡"
              value={formatVolume(data.volume.current)}
              isBlinking={blinkingFields.has('volume.current')}
            />
            <DataCell label="24h å¹³å‡" value={formatVolume(data.volume.avg_24h)} />
            <DataCell
              label="ç›¸å¯¹å¹³å‡"
              value={formatPercentage(data.volume.change_pct)}
              color={data.volume.change_pct > 50 ? '#f59e0b' : '#6b7280'}
            />
          </DataGrid>
        </DataSection>

        {/* On-Chain Section (ä»…åŠ å¯†è´§å¸) */}
        {data.onchain && (
          <DataSection title="é“¾ä¸Šæ•°æ®" color="#10b981">
            <DataGrid>
              <DataCell
                label="äº¤æ˜“æ‰€æµå…¥"
                value={\`\${data.onchain.exchange_inflow.toLocaleString()} BTC\`}
                isBlinking={blinkingFields.has('onchain.exchange_inflow')}
              />
              <DataCell
                label="äº¤æ˜“æ‰€æµå‡º"
                value={\`\${data.onchain.exchange_outflow.toLocaleString()} BTC\`}
              />
              <DataCell
                label="å‡€æµå…¥"
                value={\`\${(data.onchain.exchange_inflow - data.onchain.exchange_outflow).toLocaleString()} BTC\`}
                color={
                  data.onchain.exchange_inflow > data.onchain.exchange_outflow
                    ? '#ef4444' // æµå…¥å¤š = æŠ›å‹
                    : '#22c55e' // æµå‡ºå¤š = çœ‹å¥½
                }
              />
              <DataCell
                label="æ´»è·ƒåœ°å€"
                value={data.onchain.active_addresses.toLocaleString()}
              />
              <DataCell
                label="å¤§é¢è½¬è´¦"
                value={data.onchain.whale_transactions.toString()}
                color={data.onchain.whale_transactions > 10 ? '#f59e0b' : '#6b7280'}
              />
            </DataGrid>
          </DataSection>
        )}

        {/* Derivatives Section */}
        {data.derivatives && (
          <DataSection title="è¡ç”Ÿå“æ•°æ®" color="#f59e0b">
            <DataGrid>
              <DataCell
                label="æŒä»“é‡"
                value={formatVolume(data.derivatives.open_interest)}
              />
              <DataCell
                label="èµ„é‡‘è´¹ç‡"
                value={formatPercentage(data.derivatives.funding_rate * 100)}
                color={data.derivatives.funding_rate > 0.01 ? '#22c55e' : data.derivatives.funding_rate < -0.01 ? '#ef4444' : '#6b7280'}
              />
              <DataCell
                label="å¤šç©ºæ¯”"
                value={data.derivatives.long_short_ratio.toFixed(2)}
                color={data.derivatives.long_short_ratio > 1 ? '#22c55e' : '#ef4444'}
              />
            </DataGrid>
          </DataSection>
        )}

        {/* Technical Indicators */}
        <DataSection title="æŠ€æœ¯æŒ‡æ ‡" color="#ec4899">
          <DataGrid>
            <DataCell
              label="RSI (14)"
              value={data.indicators.rsi.toFixed(2)}
              color={
                data.indicators.rsi > 70 ? '#ef4444' : 
                data.indicators.rsi < 30 ? '#22c55e' : 
                '#6b7280'
              }
            />
            <DataCell
              label="MACD"
              value={data.indicators.macd.value.toFixed(2)}
              color={data.indicators.macd.histogram > 0 ? '#22c55e' : '#ef4444'}
            />
            <DataCell
              label="MACD Signal"
              value={data.indicators.macd.signal.toFixed(2)}
            />
            <DataCell
              label="å¸ƒæ—å¸¦ä¸Šè½¨"
              value={formatCurrency(data.indicators.bollinger.upper)}
            />
            <DataCell
              label="å¸ƒæ—å¸¦ä¸­è½¨"
              value={formatCurrency(data.indicators.bollinger.middle)}
            />
            <DataCell
              label="å¸ƒæ—å¸¦ä¸‹è½¨"
              value={formatCurrency(data.indicators.bollinger.lower)}
            />
            <DataCell
              label="EMA 20"
              value={formatCurrency(data.indicators.ema_20)}
            />
            <DataCell
              label="EMA 50"
              value={formatCurrency(data.indicators.ema_50)}
            />
            <DataCell
              label="EMA 200"
              value={formatCurrency(data.indicators.ema_200)}
            />
          </DataGrid>
        </DataSection>

        {/* Sentiment */}
        <DataSection title="å¸‚åœºæƒ…ç»ª" color="#06b6d4">
          <DataGrid>
            <DataCell
              label="ææƒ§è´ªå©ªæŒ‡æ•°"
              value={data.sentiment.fear_greed_index.toString()}
              color={
                data.sentiment.fear_greed_index > 75 ? '#ef4444' :
                data.sentiment.fear_greed_index < 25 ? '#22c55e' :
                '#6b7280'
              }
            />
            <DataCell
              label="ç¤¾äº¤å£°é‡"
              value={data.sentiment.social_volume.toLocaleString()}
            />
            <DataCell
              label="ç¤¾äº¤æƒ…ç»ª"
              value={formatPercentage(data.sentiment.social_sentiment)}
              color={data.sentiment.social_sentiment > 0 ? '#22c55e' : '#ef4444'}
            />
          </DataGrid>
        </DataSection>
      </div>
    </div>
  );
};

// ============================================
// å­ç»„ä»¶
// ============================================

const DataSection: React.FC<{
  title: string;
  color: string;
  children: React.ReactNode;
}> = ({ title, color, children }) => (
  <div className="mb-6">
    <h2
      className="text-xl font-bold mb-4 pb-2 border-b-2"
      style={{ borderColor: color, color }}
    >
      {title}
    </h2>
    {children}
  </div>
);

const DataGrid: React.FC<{ children: React.ReactNode }> = ({ children }) => (
  <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
    {children}
  </div>
);

const DataCell: React.FC<{
  label: string;
  value: string;
  color?: string;
  size?: 'normal' | 'large';
  isBlinking?: boolean;
}> = ({ label, value, color = '#d1d5db', size = 'normal', isBlinking = false }) => (
  <motion.div
    animate={{
      backgroundColor: isBlinking ? 'rgba(99, 102, 241, 0.2)' : 'rgba(0, 0, 0, 0)'
    }}
    transition={{ duration: 0.5 }}
    className="bg-gray-800 rounded-lg p-4"
  >
    <div className="text-xs text-gray-400 mb-1">{label}</div>
    <div
      className={\`font-mono font-bold \${size === 'large' ? 'text-2xl' : 'text-lg'}\`}
      style={{ color }}
    >
      {value}
    </div>
  </motion.div>
);

// ============================================
// å·¥å…·å‡½æ•°
// ============================================

function formatCurrency(value: number): string {
  return \`\$\${value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\`;
}

function formatPercentage(value: number): string {
  return \`\${value >= 0 ? '+' : ''}\${value.toFixed(2)}%\`;
}

function formatVolume(value: number): string {
  if (value > 1e9) return \`\${(value / 1e9).toFixed(2)}B\`;
  if (value > 1e6) return \`\${(value / 1e6).toFixed(2)}M\`;
  if (value > 1e3) return \`\${(value / 1e3).toFixed(2)}K\`;
  return value.toFixed(2);
}

function detectChangedFields(oldData: MarketData, newData: MarketData): Set<string> {
  const changed = new Set<string>();
  
  // é€’å½’æ¯”è¾ƒå¯¹è±¡
  function compare(oldObj: any, newObj: any, path: string = '') {
    for (const key in newObj) {
      const currentPath = path ? \`\${path}.\${key}\` : key;
      
      if (typeof newObj[key] === 'object' && newObj[key] !== null) {
        compare(oldObj[key], newObj[key], currentPath);
      } else if (oldObj[key] !== newObj[key]) {
        changed.add(currentPath);
      }
    }
  }
  
  compare(oldData, newData);
  return changed;
}
\`\`\`

---

### 9.4 AI æ¨ç†é“¾å¯è§†åŒ–ç»„ä»¶ï¼ˆå®Œæ•´ç‰ˆï¼‰

**åˆ›å»ºæ–‡ä»¶ï¼š\`components/visualization/AIReasoningChain.tsx\`**

\`\`\`typescript
import React, { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';

interface ReasoningStep {
  step: number;
  dimension: string;
  signal: 'bullish' | 'bearish' | 'neutral';
  confidence: number;
  weight: number;
  summary: string;
  keyMetrics: Array<{
    name: string;
    value: string | number;
    change?: string;
  }>;
  supporting_data: string[];
}

interface AIReasoningChainProps {
  asset: string;
  analysisId?: string;
}

export const AIReasoningChain: React.FC<AIReasoningChainProps> = ({ asset, analysisId }) => {
  const [expanded, setExpanded] = useState(false);
  const [steps, setSteps] = useState<ReasoningStep[]>([]);

  useEffect(() => {
    loadReasoningSteps();
  }, [asset, analysisId]);

  async function loadReasoningSteps() {
    const response = await fetch(\`/api/analysis/\${analysisId}/reasoning-chain\`);
    const data = await response.json();
    setSteps(data.steps);
  }

  if (steps.length === 0) return null;

  const dimensionNames = {
    on_chain: 'é“¾ä¸Šæ•°æ®',
    technical: 'æŠ€æœ¯åˆ†æ',
    macro: 'å®è§‚å› ç´ ',
    sentiment: 'å¸‚åœºæƒ…ç»ª'
  };

  const signalIcons = {
    bullish: 'â¬†ï¸',
    bearish: 'â¬‡ï¸',
    neutral: 'â†’'
  };

  const signalColors = {
    bullish: '#22c55e',
    bearish: '#ef4444',
    neutral: '#6b7280'
  };

  return (
    <div className="mt-8 bg-white rounded-xl shadow-lg p-6">
      <button
        onClick={() => setExpanded(!expanded)}
        className="w-full flex items-center justify-between text-left"
      >
        <h3 className="text-xl font-bold text-gray-900">
          ğŸ¤– AI æ¨ç†é“¾
        </h3>
        <motion.div
          animate={{ rotate: expanded ? 180 : 0 }}
          transition={{ duration: 0.3 }}
        >
          â–¼
        </motion.div>
      </button>

      <AnimatePresence>
        {expanded && (
          <motion.div
            initial={{ height: 0, opacity: 0 }}
            animate={{ height: 'auto', opacity: 1 }}
            exit={{ height: 0, opacity: 0 }}
            transition={{ duration: 0.4 }}
            className="mt-6 space-y-4"
          >
            {steps.map((step, index) => (
              <ReasoningStepCard
                key={index}
                step={step}
                dimensionName={dimensionNames[step.dimension]}
                signalIcon={signalIcons[step.signal]}
                signalColor={signalColors[step.signal]}
                isLast={index === steps.length - 1}
              />
            ))}

            {/* Final Score */}
            <div className="mt-6 p-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border-2 border-blue-300">
              <h4 className="text-lg font-bold text-blue-900 mb-2">ç»¼åˆè¯„åˆ†</h4>
              <div className="flex items-center gap-4">
                <div className="text-4xl font-bold text-blue-600">
                  {calculateFinalScore(steps)}
                </div>
                <div className="flex-1">
                  <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
                    <motion.div
                      initial={{ width: 0 }}
                      animate={{ width: \`\${calculateFinalScore(steps)}%\` }}
                      transition={{ duration: 1, delay: 0.5 }}
                      className="h-full bg-gradient-to-r from-blue-500 to-purple-600"
                    />
                  </div>
                </div>
              </div>
              <p className="mt-2 text-sm text-gray-600">
                {getScoreInterpretation(calculateFinalScore(steps))}
              </p>
            </div>

            {/* Disclaimer */}
            <div className="mt-4 p-4 bg-yellow-50 border-l-4 border-yellow-400 text-sm text-yellow-800">
              âš ï¸ æ­¤ä¸º AI åˆ†ææ¨ç†è¿‡ç¨‹ï¼Œä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
};

const ReasoningStepCard: React.FC<{
  step: ReasoningStep;
  dimensionName: string;
  signalIcon: string;
  signalColor: string;
  isLast: boolean;
}> = ({ step, dimensionName, signalIcon, signalColor, isLast }) => {
  const [detailsExpanded, setDetailsExpanded] = useState(false);

  return (
    <motion.div
      initial={{ x: -20, opacity: 0 }}
      animate={{ x: 0, opacity: 1 }}
      transition={{ delay: step.step * 0.1 }}
      className="relative"
    >
      {/* Connection line */}
      {!isLast && (
        <div className="absolute left-6 top-16 w-0.5 h-full bg-gray-300" />
      )}

      <div className="bg-gray-50 rounded-lg p-5 border border-gray-200 hover:shadow-md transition">
        <div className="flex items-start gap-4">
          {/* Step number */}
          <div
            className="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg z-10"
            style={{ backgroundColor: signalColor }}
          >
            {step.step}
          </div>

          <div className="flex-1">
            {/* Header */}
            <div className="flex items-center justify-between mb-2">
              <h4 className="font-bold text-gray-900">{dimensionName}</h4>
              <div className="flex items-center gap-2">
                <span className="text-2xl">{signalIcon}</span>
                <span className="font-semibold" style={{ color: signalColor }}>
                  {step.signal === 'bullish' ? 'çœ‹å¤š' : step.signal === 'bearish' ? 'çœ‹ç©º' : 'ä¸­æ€§'}
                </span>
              </div>
            </div>

            {/* Summary */}
            <p className="text-gray-700 mb-3">{step.summary}</p>

            {/* Metrics */}
            <div className="flex flex-wrap gap-3 mb-3">
              <MetricBadge label="ç½®ä¿¡åº¦" value={\`\${Math.round(step.confidence * 100)}%\`} />
              <MetricBadge label="æƒé‡" value={\`\${Math.round(step.weight * 100)}%\`} color={signalColor} />
            </div>

            {/* Key Metrics */}
            {step.keyMetrics.length > 0 && (
              <div className="mb-3">
                <div className="text-xs font-semibold text-gray-500 mb-2">å…³é”®æŒ‡æ ‡ï¼š</div>
                <div className="flex flex-wrap gap-2">
                  {step.keyMetrics.map((metric, i) => (
                    <div key={i} className="px-3 py-1 bg-white rounded-full text-xs border border-gray-200">
                      <span className="font-medium">{metric.name}:</span>{' '}
                      <span className="font-bold">{metric.value}</span>
                      {metric.change && (
                        <span className={metric.change.startsWith('+') ? 'text-green-600' : 'text-red-600'}>
                          {' '}({metric.change})
                        </span>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Toggle details */}
            <button
              onClick={() => setDetailsExpanded(!detailsExpanded)}
              className="text-sm text-blue-600 hover:text-blue-700 font-medium"
            >
              {detailsExpanded ? 'æ”¶èµ·è¯¦æƒ… â–²' : 'æŸ¥çœ‹è¯¦æƒ… â–¼'}
            </button>

            {/* Expanded details */}
            {detailsExpanded && (
              <motion.div
                initial={{ height: 0, opacity: 0 }}
                animate={{ height: 'auto', opacity: 1 }}
                className="mt-3 p-4 bg-white rounded-lg border border-gray-200"
              >
                <div className="text-sm text-gray-600 space-y-2">
                  {step.supporting_data.map((data, i) => (
                    <div key={i} className="flex items-start gap-2">
                      <span className="text-blue-500">â€¢</span>
                      <span>{data}</span>
                    </div>
                  ))}
                </div>
              </motion.div>
            )}
          </div>
        </div>
      </div>
    </motion.div>
  );
};

const MetricBadge: React.FC<{
  label: string;
  value: string;
  color?: string;
}> = ({ label, value, color = '#6b7280' }) => (
  <div className="flex items-center gap-2 px-3 py-1 bg-white rounded-full border border-gray-200">
    <span className="text-xs text-gray-500">{label}</span>
    <span className="font-bold text-sm" style={{ color }}>
      {value}
    </span>
  </div>
);

function calculateFinalScore(steps: ReasoningStep[]): number {
  // åŠ æƒè¯„åˆ†
  let score = 0;
  steps.forEach(step => {
    const signalValue = step.signal === 'bullish' ? 1 : step.signal === 'bearish' ? -1 : 0;
    score += signalValue * step.confidence * step.weight;
  });

  // è½¬æ¢åˆ° 0-100
  return Math.round(((score + 1) / 2) * 100);
}

function getScoreInterpretation(score: number): string {
  if (score >= 75) return 'å¼ºçƒˆçœ‹å¤šä¿¡å·';
  if (score >= 60) return 'åå¤šä¿¡å·';
  if (score >= 40) return 'ä¸­æ€§åå¤š';
  if (score >= 25) return 'ä¸­æ€§åç©º';
  return 'å¼ºçƒˆçœ‹ç©ºä¿¡å·';
}
\`\`\`

---

## ç« èŠ‚åï¼šç”¨æˆ·åˆ†ç±»ä¸åŒ¹é…ç³»ç»Ÿ - å®Œæ•´å®ç°

### 10.1 å¤šç»´æ ‡ç­¾æ•°æ®åº“è®¾è®¡

\`\`\`sql
-- æ ‡ç­¾å®šä¹‰è¡¨
CREATE TABLE tags (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    category VARCHAR(50) NOT NULL, -- 'trading_style', 'analysis_preference', 'asset_preference', 'risk_preference'
    tag_key VARCHAR(50) NOT NULL, -- 'day_trading', 'swing', 'technical', 'onchain', 'btc', 'aggressive'
    display_name VARCHAR(100) NOT NULL,
    description TEXT,
    icon VARCHAR(50), -- emoji æˆ– icon name
    weight NUMERIC(3, 2) DEFAULT 1.0, -- åŒ¹é…æƒé‡
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(category, tag_key)
);

-- åˆå§‹åŒ–æ ‡ç­¾æ•°æ®
INSERT INTO tags (category, tag_key, display_name, description, icon, weight) VALUES
-- Trading Style
('trading_style', 'day_trading', 'æ—¥å†…äº¤æ˜“', 'å…³æ³¨çŸ­æœŸä»·æ ¼æ³¢åŠ¨ï¼Œé¢‘ç¹äº¤æ˜“', 'âš¡', 1.5),
('trading_style', 'swing', 'æ³¢æ®µäº¤æ˜“', 'æŒä»“æ•°å¤©åˆ°æ•°å‘¨ï¼Œå…³æ³¨ä¸­æœŸè¶‹åŠ¿', 'ğŸ“ˆ', 1.2),
('trading_style', 'long_term', 'é•¿çº¿æŠ•èµ„', 'æŒä»“æ•°æœˆåˆ°æ•°å¹´ï¼Œå…³æ³¨åŸºæœ¬é¢', 'ğŸ¯', 1.0),
('trading_style', 'scalping', 'è¶…çŸ­çº¿', 'æŒä»“æ•°åˆ†é’Ÿåˆ°æ•°å°æ—¶', 'âš¡âš¡', 1.8),
('trading_style', 'quantitative', 'é‡åŒ–äº¤æ˜“', 'ç¨‹åºåŒ–äº¤æ˜“ï¼Œæ•°æ®é©±åŠ¨', 'ğŸ¤–', 1.3),

-- Analysis Preference
('analysis_preference', 'technical', 'æŠ€æœ¯åˆ†æ', 'å›¾è¡¨å½¢æ€ã€æŒ‡æ ‡ã€è¶‹åŠ¿çº¿', 'ğŸ“Š', 1.2),
('analysis_preference', 'fundamental', 'åŸºæœ¬é¢åˆ†æ', 'è´¢åŠ¡æ•°æ®ã€è¡Œä¸šè¶‹åŠ¿ã€ä¼°å€¼', 'ğŸ“š', 1.0),
('analysis_preference', 'onchain', 'é“¾ä¸Šåˆ†æ', 'åŒºå—é“¾æ•°æ®ã€åœ°å€è¡Œä¸ºã€æµåŠ¨æ€§', 'â›“ï¸', 1.5),
('analysis_preference', 'macro', 'å®è§‚åˆ†æ', 'ç»æµæŒ‡æ ‡ã€è´§å¸æ”¿ç­–ã€åœ°ç¼˜æ”¿æ²»', 'ğŸŒ', 1.1),
('analysis_preference', 'sentiment', 'æƒ…ç»ªåˆ†æ', 'ç¤¾äº¤åª’ä½“ã€æ–°é—»ã€å¸‚åœºæƒ…ç»ª', 'ğŸ’­', 1.0),

-- Asset Preference
('asset_preference', 'crypto', 'åŠ å¯†è´§å¸', 'BTC, ETH, DeFi, NFT', 'â‚¿', 1.5),
('asset_preference', 'stocks', 'ç¾è‚¡', 'ç§‘æŠ€è‚¡ã€ä»·å€¼è‚¡ã€æˆé•¿è‚¡', 'ğŸ“ˆ', 1.2),
('asset_preference', 'forex', 'å¤–æ±‡', 'ä¸»è¦è´§å¸å¯¹ã€äº¤å‰ç›˜', 'ğŸ’±', 1.0),
('asset_preference', 'commodities', 'è´µé‡‘å±', 'é»„é‡‘ã€ç™½é“¶ã€åŸæ²¹', 'ğŸ¥‡', 1.0),
('asset_preference', 'options', 'æœŸæƒ', 'è¡ç”Ÿå“äº¤æ˜“', 'ğŸ“Š', 1.3),

-- Risk Preference
('risk_preference', 'conservative', 'ä¿å®ˆå‹', 'ä½é£é™©ï¼Œç¨³å®šæ”¶ç›Š', 'ğŸ›¡ï¸', 1.0),
('risk_preference', 'balanced', 'ç¨³å¥å‹', 'å¹³è¡¡é£é™©ä¸æ”¶ç›Š', 'âš–ï¸', 1.0),
('risk_preference', 'aggressive', 'æ¿€è¿›å‹', 'è¿½æ±‚é«˜æ”¶ç›Šï¼Œæ‰¿å—é«˜é£é™©', 'ğŸš€', 1.5);

-- ç”¨æˆ·æ ‡ç­¾å…³è”è¡¨
CREATE TABLE user_tags (
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    tag_id UUID NOT NULL REFERENCES tags(id) ON DELETE CASCADE,
    source VARCHAR(50) NOT NULL, -- 'onboarding', 'inferred', 'manual'
    confidence NUMERIC(3, 2) DEFAULT 1.0, -- 0-1ï¼Œæ ‡ç­¾çš„ç½®ä¿¡åº¦
    assigned_at TIMESTAMP DEFAULT NOW(),
    
    PRIMARY KEY (user_id, tag_id)
);

CREATE INDEX idx_user_tags_user ON user_tags(user_id);
CREATE INDEX idx_user_tags_tag ON user_tags(tag_id);

-- æ ‡ç­¾ç›¸ä¼¼åº¦çŸ©é˜µï¼ˆé¢„è®¡ç®—ï¼‰
CREATE TABLE tag_similarity_matrix (
    tag_a_id UUID NOT NULL REFERENCES tags(id),
    tag_b_id UUID NOT NULL REFERENCES tags(id),
    similarity_score NUMERIC(3, 2) NOT NULL, -- 0-1
    
    PRIMARY KEY (tag_a_id, tag_b_id),
    CHECK (tag_a_id < tag_b_id) -- é¿å…é‡å¤
);

-- åˆå§‹åŒ–ç›¸ä¼¼åº¦æ•°æ®ï¼ˆç¤ºä¾‹ï¼‰
INSERT INTO tag_similarity_matrix (tag_a_id, tag_b_id, similarity_score)
SELECT 
    t1.id, 
    t2.id, 
    CASE 
        WHEN t1.category = t2.category THEN 0.6
        WHEN (t1.tag_key = 'day_trading' AND t2.tag_key = 'technical') THEN 0.8
        WHEN (t1.tag_key = 'long_term' AND t2.tag_key = 'fundamental') THEN 0.9
        WHEN (t1.tag_key = 'crypto' AND t2.tag_key = 'onchain') THEN 0.95
        ELSE 0.3
    END
FROM tags t1
CROSS JOIN tags t2
WHERE t1.id < t2.id;
\`\`\`

---

### 10.2 åŒ¹é…ç®—æ³•å®ç°

**åˆ›å»ºæ–‡ä»¶ï¼š\`packages/matching/src/matcher.ts\`**

\`\`\`typescript
import { db } from '@finverse/database';

/**
 * ç”¨æˆ·åŒ¹é…å™¨
 * 
 * åŸºäºå¤šç»´æ ‡ç­¾ç›¸ä¼¼åº¦è®¡ç®—ç”¨æˆ·ä¹‹é—´çš„åŒ¹é…åˆ†æ•°
 */
export class UserMatcher {
  
  /**
   * è®¡ç®—ä¸¤ä¸ªç”¨æˆ·ä¹‹é—´çš„ç›¸ä¼¼åº¦
   */
  async calculateSimilarity(userA: string, userB: string): Promise<number> {
    // 1. è·å–ä¸¤ä¸ªç”¨æˆ·çš„æ ‡ç­¾
    const [tagsA, tagsB] = await Promise.all([
      this.getUserTags(userA),
      this.getUserTags(userB)
    ]);

    if (tagsA.length === 0 || tagsB.length === 0) {
      return 0;
    }

    // 2. è®¡ç®— Jaccard ç›¸ä¼¼åº¦ï¼ˆåŸºç¡€ï¼‰
    const tagsASet = new Set(tagsA.map(t => t.tag_id));
    const tagsBSet = new Set(tagsB.map(t => t.tag_id));
    
    const intersection = new Set([...tagsASet].filter(x => tagsBSet.has(x)));
    const union = new Set([...tagsASet, ...tagsBSet]);
    
    const jaccardSimilarity = intersection.size / union.size;

    // 3. åŠ æƒç›¸ä¼¼åº¦ï¼ˆè€ƒè™‘æ ‡ç­¾æƒé‡å’Œç›¸ä¼¼åº¦çŸ©é˜µï¼‰
    let weightedSimilarity = 0;
    let totalWeight = 0;

    for (const tagA of tagsA) {
      for (const tagB of tagsB) {
        // ç›´æ¥åŒ¹é…
        if (tagA.tag_id === tagB.tag_id) {
          const weight = tagA.weight * tagA.confidence * tagB.confidence;
          weightedSimilarity += weight;
          totalWeight += weight;
        } else {
          // é—´æ¥åŒ¹é…ï¼ˆé€šè¿‡ç›¸ä¼¼åº¦çŸ©é˜µï¼‰
          const crossSimilarity = await this.getTagSimilarity(tagA.tag_id, tagB.tag_id);
          if (crossSimilarity > 0.5) {
            const weight = tagA.weight * tagA.confidence * tagB.confidence * crossSimilarity;
            weightedSimilarity += weight * crossSimilarity;
            totalWeight += weight;
          }
        }
      }
    }

    const finalSimilarity = totalWeight > 0 
      ? (weightedSimilarity / totalWeight) * 0.7 + jaccardSimilarity * 0.3
      : jaccardSimilarity;

    return Math.min(finalSimilarity, 1.0);
  }

  /**
   * ä¸ºç”¨æˆ·æ¨èç›¸ä¼¼ç”¨æˆ·ï¼ˆç”¨äºå°ç»„æ¨èï¼‰
   */
  async recommendUsers(userId: string, limit: number = 10): Promise<UserRecommendation[]> {
    // 1. è·å–æ‰€æœ‰å€™é€‰ç”¨æˆ·
    const candidates = await db.query<{id: string, email: string}>(
      'SELECT id, email FROM users WHERE id != \$1 AND id IN (SELECT DISTINCT user_id FROM user_tags)',
      [userId]
    );

    // 2. è®¡ç®—ç›¸ä¼¼åº¦
    const similarities: UserRecommendation[] = [];

    for (const candidate of candidates) {
      const similarity = await this.calculateSimilarity(userId, candidate.id);
      
      if (similarity > 0.3) { // é˜ˆå€¼è¿‡æ»¤
        similarities.push({
          user_id: candidate.id,
          similarity_score: similarity,
          common_tags: await this.getCommonTags(userId, candidate.id),
          reason: await this.generateRecommendationReason(userId, candidate.id)
        });
      }
    }

    // 3. æ’åºå¹¶è¿”å› top N
    return similarities
      .sort((a, b) => b.similarity_score - a.similarity_score)
      .slice(0, limit);
  }

  /**
   * æ¨èå°ç»„
   */
  async recommendGroups(userId: string, limit: number = 5): Promise<GroupRecommendation[]> {
    const userTags = await this.getUserTags(userId);
    const userTagIds = userTags.map(t => t.tag_id);

    // æŸ¥æ‰¾åŒ…å«ç›¸ä¼¼æ ‡ç­¾çš„å°ç»„
    const groups = await db.query<any>(
      \`SELECT g.*, 
              ARRAY_AGG(DISTINCT gt.tag_id) as group_tags,
              COUNT(DISTINCT gm.user_id) as member_count
       FROM groups g
       LEFT JOIN group_tags gt ON g.id = gt.group_id
       LEFT JOIN group_members gm ON g.id = gm.group_id
       WHERE g.is_public = true
         AND g.is_active = true
         AND g.id NOT IN (
           SELECT group_id FROM group_members WHERE user_id = \$1
         )
       GROUP BY g.id
       HAVING ARRAY_LENGTH(ARRAY_AGG(DISTINCT gt.tag_id), 1) > 0\`,
      [userId]
    );

    // è®¡ç®—åŒ¹é…åˆ†æ•°
    const recommendations: GroupRecommendation[] = groups.map(group => {
      const groupTagIds = group.group_tags;
      const intersection = userTagIds.filter(t => groupTagIds.includes(t));
      const matchScore = intersection.length / Math.max(userTagIds.length, groupTagIds.length);

      return {
        group_id: group.id,
        group_name: group.name,
        match_score: matchScore,
        member_count: group.member_count,
        common_tags: intersection,
        reason: this.generateGroupRecommendationReason(intersection.length, group.member_count)
      };
    });

    return recommendations
      .filter(r => r.match_score > 0.2)
      .sort((a, b) => b.match_score - a.match_score)
      .slice(0, limit);
  }

  /**
   * è·å–ç”¨æˆ·çš„æ‰€æœ‰æ ‡ç­¾
   */
  private async getUserTags(userId: string): Promise<UserTag[]> {
    return await db.query<UserTag>(
      \`SELECT ut.*, t.weight, t.category 
       FROM user_tags ut
       JOIN tags t ON ut.tag_id = t.id
       WHERE ut.user_id = \$1\`,
      [userId]
    );
  }

  /**
   * è·å–ä¸¤ä¸ªæ ‡ç­¾ä¹‹é—´çš„ç›¸ä¼¼åº¦
   */
  private async getTagSimilarity(tagA: string, tagB: string): Promise<number> {
    if (tagA === tagB) return 1.0;

    const result = await db.queryOne<{similarity_score: number}>(
      \`SELECT similarity_score FROM tag_similarity_matrix 
       WHERE (tag_a_id = \$1 AND tag_b_id = \$2) 
          OR (tag_a_id = \$2 AND tag_b_id = \$1)\`,
      [tagA, tagB]
    );

    return result?.similarity_score || 0;
  }

  /**
   * è·å–ä¸¤ä¸ªç”¨æˆ·çš„å…±åŒæ ‡ç­¾
   */
  private async getCommonTags(userA: string, userB: string): Promise<string[]> {
    const result = await db.query<{tag_key: string}>(
      \`SELECT DISTINCT t.tag_key 
       FROM user_tags uta
       JOIN user_tags utb ON uta.tag_id = utb.tag_id
       JOIN tags t ON uta.tag_id = t.id
       WHERE uta.user_id = \$1 AND utb.user_id = \$2\`,
      [userA, userB]
    );

    return result.map(r => r.tag_key);
  }

  /**
   * ç”Ÿæˆæ¨èç†ç”±
   */
  private async generateRecommendationReason(userA: string, userB: string): Promise<string> {
    const commonTags = await this.getCommonTags(userA, userB);
    
    if (commonTags.length === 0) return 'å¯èƒ½æœ‰ç›¸ä¼¼çš„äº¤æ˜“é£æ ¼';
    
    const tagNames = await db.query<{display_name: string}>(
      'SELECT display_name FROM tags WHERE tag_key = ANY(\$1)',
      [commonTags]
    );

    return \`ä½ ä»¬éƒ½å…³æ³¨ï¼š\${tagNames.map(t => t.display_name).join('ã€')}\`;
  }

  /**
   * ç”Ÿæˆå°ç»„æ¨èç†ç”±
   */
  private generateGroupRecommendationReason(commonTagCount: number, memberCount: number): string {
    return \`\${commonTagCount} ä¸ªå…±åŒæ ‡ç­¾ Â· \${memberCount} åæˆå‘˜\`;
  }
}

interface UserTag {
  user_id: string;
  tag_id: string;
  confidence: number;
  weight: number;
  category: string;
}

interface UserRecommendation {
  user_id: string;
  similarity_score: number;
  common_tags: string[];
  reason: string;
}

interface GroupRecommendation {
  group_id: string;
  group_name: string;
  match_score: number;
  member_count: number;
  common_tags: string[];
  reason: string;
}
\`\`\`

---

### 10.3 åå¥½æµ‹è¯•å®ç°

**åˆ›å»ºæ–‡ä»¶ï¼š\`components/onboarding/PreferenceTest.tsx\`**

\`\`\`typescript
import React, { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';

interface Question {
  id: number;
  scenario: string;
  options: Array<{
    label: string;
    tags: string[]; // é€‰æ‹©æ­¤é€‰é¡¹ä¼šå¢åŠ çš„æ ‡ç­¾
    emoji: string;
  }>;
}

const QUESTIONS: Question[] = [
  {
    id: 1,
    scenario: 'BTC çªç„¶æš´è·Œ 10%ï¼Œä½ çš„ç¬¬ä¸€ååº”æ˜¯ï¼Ÿ',
    options: [
      { label: 'ç«‹å³æ­¢æŸç¦»åœº', tags: ['conservative', 'day_trading'], emoji: 'ğŸ›¡ï¸' },
      { label: 'åŠ ä»“æŠ„åº•', tags: ['aggressive', 'swing'], emoji: 'ğŸš€' },
      { label: 'è§‚æœ›ï¼Œç­‰å¾…æ›´å¤šä¿¡æ¯', tags: ['balanced', 'technical'], emoji: 'ğŸ‘€' },
      { label: 'ä¸å…³å¿ƒçŸ­æœŸæ³¢åŠ¨ï¼Œé•¿æœŸæŒæœ‰', tags: ['long_term', 'fundamental'], emoji: 'ğŸ¯' }
    ]
  },
  {
    id: 2,
    scenario: 'é€‰æ‹©ä¸€ä¸ªä½ æœ€ä¿¡ä»»çš„æ•°æ®æ¥æºï¼š',
    options: [
      { label: 'æŠ€æœ¯å›¾è¡¨å’ŒæŒ‡æ ‡', tags: ['technical'], emoji: 'ğŸ“Š' },
      { label: 'é“¾ä¸Šæ•°æ®å’Œåœ°å€è¡Œä¸º', tags: ['onchain', 'crypto'], emoji: 'â›“ï¸' },
      { label: 'å®è§‚ç»æµæ–°é—»', tags: ['macro', 'stocks'], emoji: 'ğŸŒ' },
      { label: 'ç¤¾äº¤åª’ä½“æƒ…ç»ª', tags: ['sentiment'], emoji: 'ğŸ’­' }
    ]
  },
  {
    id: 3,
    scenario: 'ä½ é€šå¸¸æŒä»“å¤šä¹…ï¼Ÿ',
    options: [
      { label: 'å‡ åˆ†é’Ÿåˆ°å‡ å°æ—¶', tags: ['scalping', 'day_trading'], emoji: 'âš¡' },
      { label: 'å‡ å¤©åˆ°å‡ å‘¨', tags: ['swing'], emoji: 'ğŸ“ˆ' },
      { label: 'å‡ ä¸ªæœˆåˆ°å‡ å¹´', tags: ['long_term'], emoji: 'ğŸ¯' },
      { label: 'æˆ‘ç”¨ç¨‹åºè‡ªåŠ¨äº¤æ˜“', tags: ['quantitative'], emoji: 'ğŸ¤–' }
    ]
  },
  {
    id: 4,
    scenario: 'ä½ æœ€æ„Ÿå…´è¶£çš„å¸‚åœºæ˜¯ï¼Ÿ',
    options: [
      { label: 'åŠ å¯†è´§å¸ï¼ˆBTC, ETH, DeFiï¼‰', tags: ['crypto'], emoji: 'â‚¿' },
      { label: 'ç¾è‚¡ï¼ˆç§‘æŠ€è‚¡ã€æˆé•¿è‚¡ï¼‰', tags: ['stocks'], emoji: 'ğŸ“ˆ' },
      { label: 'å¤–æ±‡å’Œè´µé‡‘å±', tags: ['forex', 'commodities'], emoji: 'ğŸ’±' },
      { label: 'éƒ½æ„Ÿå…´è¶£', tags: [], emoji: 'ğŸŒ' }
    ]
  },
  {
    id: 5,
    scenario: 'å¦‚æœä¸€ç¬”äº¤æ˜“äºæŸ 20%ï¼Œä½ ä¼šï¼Ÿ',
    options: [
      { label: 'ä¸¥æ ¼æ­¢æŸï¼Œæ§åˆ¶é£é™©', tags: ['conservative'], emoji: 'ğŸ›¡ï¸' },
      { label: 'åˆ†æåŸå› ï¼Œè°ƒæ•´ç­–ç•¥', tags: ['balanced', 'technical'], emoji: 'ğŸ”' },
      { label: 'åŠ å€ä¸‹æ³¨ï¼Œç›¸ä¿¡åå¼¹', tags: ['aggressive'], emoji: 'ğŸš€' },
      { label: 'ä¸ç®¡å®ƒï¼Œç­‰é•¿æœŸå›æœ¬', tags: ['long_term'], emoji: 'â³' }
    ]
  },
  {
    id: 6,
    scenario: 'ä½ è®¤ä¸ºå“ªä¸ªæœ€é‡è¦ï¼Ÿ',
    options: [
      { label: 'å‡†ç¡®çš„ä¹°å–æ—¶æœº', tags: ['technical', 'day_trading'], emoji: 'â°' },
      { label: 'é€‰å¯¹èµ„äº§æ¯”æ—¶æœºé‡è¦', tags: ['fundamental', 'long_term'], emoji: 'ğŸ¯' },
      { label: 'é£é™©æ§åˆ¶å’Œèµ„é‡‘ç®¡ç†', tags: ['conservative'], emoji: 'ğŸ’°' },
      { label: 'è·Ÿéšè¶‹åŠ¿å’Œå¸‚åœºæƒ…ç»ª', tags: ['sentiment', 'swing'], emoji: 'ğŸŒŠ' }
    ]
  },
  {
    id: 7,
    scenario: 'ä½ æ›´å–œæ¬¢çœ‹ä»€ä¹ˆå†…å®¹ï¼Ÿ',
    options: [
      { label: 'è¯¦ç»†çš„å›¾è¡¨å’ŒæŠ€æœ¯åˆ†æ', tags: ['technical'], emoji: 'ğŸ“Š' },
      { label: 'æ•°æ®é©±åŠ¨çš„é‡åŒ–æŠ¥å‘Š', tags: ['quantitative', 'onchain'], emoji: 'ğŸ“ˆ' },
      { label: 'å®è§‚ç»æµåˆ†æå’Œæ–°é—»è§£è¯»', tags: ['macro', 'fundamental'], emoji: 'ğŸ—ï¸' },
      { label: 'ç®€æ´çš„ç»“è®ºå’Œæ“ä½œå»ºè®®', tags: ['day_trading'], emoji: 'âœ…' }
    ]
  },
  {
    id: 8,
    scenario: 'ä½ å¸Œæœ› Agent å¤šä¹…æ¨é€ä¸€æ¬¡ï¼Ÿ',
    options: [
      { label: 'å®æ—¶æ¨é€é‡è¦ä¿¡æ¯', tags: ['day_trading', 'scalping'], emoji: 'ğŸ“²' },
      { label: 'æ¯å¤© 1-2 æ¬¡æ‘˜è¦', tags: ['swing', 'balanced'], emoji: 'ğŸ“…' },
      { label: 'æ¯å‘¨å¤ç›˜å³å¯', tags: ['long_term'], emoji: 'ğŸ“†' },
      { label: 'åªåœ¨é‡å¤§äº‹ä»¶æ—¶é€šçŸ¥', tags: ['conservative'], emoji: 'ğŸš¨' }
    ]
  }
];

export const PreferenceTest: React.FC<{
  onComplete: (tags: string[]) => void;
}> = ({ onComplete }) => {
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [answers, setAnswers] = useState<Record<number, number>>({});
  const [isComplete, setIsComplete] = useState(false);

  const handleAnswer = (optionIndex: number) => {
    setAnswers({ ...answers, [currentQuestion]: optionIndex });

    if (currentQuestion < QUESTIONS.length - 1) {
      setTimeout(() => setCurrentQuestion(currentQuestion + 1), 300);
    } else {
      // æµ‹è¯•å®Œæˆï¼Œè®¡ç®—æ ‡ç­¾
      setTimeout(() => {
        const tags = calculateTags(answers);
        setIsComplete(true);
        onComplete(tags);
      }, 300);
    }
  };

  const progress = ((currentQuestion + 1) / QUESTIONS.length) * 100;
  const question = QUESTIONS[currentQuestion];

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-4">
      <div className="max-w-3xl w-full">
        {/* Progress bar */}
        <div className="mb-8">
          <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
            <motion.div
              initial={{ width: 0 }}
              animate={{ width: \`\${progress}%\` }}
              transition={{ duration: 0.5 }}
              className="h-full bg-gradient-to-r from-blue-500 to-purple-600"
            />
          </div>
          <div className="mt-2 text-sm text-gray-600 text-center">
            é—®é¢˜ {currentQuestion + 1} / {QUESTIONS.length}
          </div>
        </div>

        {/* Question card */}
        <AnimatePresence mode="wait">
          {!isComplete ? (
            <motion.div
              key={currentQuestion}
              initial={{ opacity: 0, x: 50 }}
              animate={{ opacity: 1, x: 0 }}
              exit={{ opacity: 0, x: -50 }}
              transition={{ duration: 0.3 }}
              className="bg-white rounded-2xl shadow-2xl p-8"
            >
              <h2 className="text-2xl font-bold text-gray-900 mb-6 text-center">
                {question.scenario}
              </h2>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {question.options.map((option, index) => (
                  <motion.button
                    key={index}
                    whileHover={{ scale: 1.05, boxShadow: '0 10px 40px rgba(99, 102, 241, 0.3)' }}
                    whileTap={{ scale: 0.95 }}
                    onClick={() => handleAnswer(index)}
                    className="p-6 rounded-xl border-2 border-gray-200 hover:border-blue-500 transition-all text-left"
                  >
                    <div className="text-4xl mb-3">{option.emoji}</div>
                    <div className="font-semibold text-gray-900">{option.label}</div>
                  </motion.button>
                ))}
              </div>
            </motion.div>
          ) : (
            <motion.div
              initial={{ opacity: 0, scale: 0.9 }}
              animate={{ opacity: 1, scale: 1 }}
              className="bg-white rounded-2xl shadow-2xl p-12 text-center"
            >
              <div className="text-6xl mb-6">ğŸ‰</div>
              <h2 className="text-3xl font-bold text-gray-900 mb-4">
                å®Œæˆï¼
              </h2>
              <p className="text-gray-600 text-lg mb-6">
                æ­£åœ¨ä¸ºä½ ç”Ÿæˆä¸“å± Agent...
              </p>
              <motion.div
                animate={{ rotate: 360 }}
                transition={{ duration: 2, repeat: Infinity, ease: 'linear' }}
                className="inline-block text-4xl"
              >
                ğŸ¤–
              </motion.div>
            </motion.div>
          )}
        </AnimatePresence>
      </div>
    </div>
  );
};

/**
 * æ ¹æ®ç­”æ¡ˆè®¡ç®—ç”¨æˆ·æ ‡ç­¾
 */
function calculateTags(answers: Record<number, number>): string[] {
  const tagCounts: Record<string, number> = {};

  Object.entries(answers).forEach(([questionIndex, optionIndex]) => {
    const question = QUESTIONS[parseInt(questionIndex)];
    const selectedOption = question.options[optionIndex];

    selectedOption.tags.forEach(tag => {
      tagCounts[tag] = (tagCounts[tag] || 0) + 1;
    });
  });

  // è¿”å›å‡ºç°æ¬¡æ•° >= 2 çš„æ ‡ç­¾
  return Object.entries(tagCounts)
    .filter(([tag, count]) => count >= 2)
    .map(([tag]) => tag);
}
\`\`\`

---

## ç« èŠ‚åä¸€ï¼šAgent è‡ªå®šä¹‰ - è¡¥å…¨éƒ¨åˆ†

### 11.1 è¿›é˜¶è‡ªå®šä¹‰ - è‡ªç„¶è¯­è¨€è°ƒæ•™

**åˆ›å»ºæ–‡ä»¶ï¼š\`components/agent/NaturalLanguageCustomization.tsx\`**

\`\`\`typescript
import React, { useState } from 'react';
import { motion } from 'framer-motion';

export const NaturalLanguageCustomization: React.FC<{
  agentId: string;
}> = ({ agentId }) => {
  const [input, setInput] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);
  const [history, setHistory] = useState<Array<{
    input: string;
    interpretation: string;
    appliedChanges: string[];
  }>>([]);

  const handleSubmit = async () => {
    if (!input.trim()) return;

    setIsProcessing(true);

    try {
      const response = await fetch(\`/api/agents/\${agentId}/customize\`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ instruction: input })
      });

      const result = await response.json();

      setHistory([...history, {
        input: input,
        interpretation: result.interpretation,
        appliedChanges: result.changes
      }]);

      setInput('');
    } catch (error) {
      console.error('è‡ªå®šä¹‰å¤±è´¥:', error);
    } finally {
      setIsProcessing(false);
    }
  };

  return (
    <div className="bg-white rounded-xl shadow-lg p-6">
      <h2 className="text-2xl font-bold mb-4">è‡ªç„¶è¯­è¨€è°ƒæ•™ Agent</h2>

      {/* Input */}
      <div className="mb-6">
        <textarea
          value={input}
          onChange={(e) => setInput(e.target.value)}
          placeholder="å‘Šè¯‰ Agent ä½ æƒ³è¦ä»€ä¹ˆæ”¹å˜...

ä¾‹å¦‚ï¼š
Â· æˆ‘æ›´å…³æ³¨é“¾ä¸Šæ•°æ®ï¼ŒæŠ€æœ¯é¢ä¸å¤ªçœ‹
Â· å½“ RSI ä½äº 30 çš„æ—¶å€™é‡ç‚¹æé†’æˆ‘
Â· æˆ‘ä¸å…³å¿ƒ meme å¸ï¼Œåªçœ‹ BTC å’Œ ETH
Â· æ¯å¤©æ—©ä¸Š 8 ç‚¹æ¨é€å¸‚åœºæ‘˜è¦"
          className="w-full h-32 p-4 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        />

        <motion.button
          whileHover={{ scale: 1.02 }}
          whileTap={{ scale: 0.98 }}
          onClick={handleSubmit}
          disabled={!input.trim() || isProcessing}
          className="mt-4 w-full py-3 bg-blue-600 text-white font-semibold rounded-lg disabled:opacity-50"
        >
          {isProcessing ? 'å¤„ç†ä¸­...' : 'åº”ç”¨æ›´æ”¹'}
        </motion.button>
      </div>

      {/* History */}
      {history.length > 0 && (
        <div className="space-y-4">
          <h3 className="text-lg font-semibold">è°ƒæ•™å†å²</h3>
          {history.map((item, index) => (
            <div key={index} className="p-4 bg-gray-50 rounded-lg">
              <div className="font-medium text-gray-900 mb-2">
                ä½ è¯´ï¼š"{item.input}"
              </div>
              <div className="text-sm text-gray-600 mb-2">
                ç†è§£ä¸ºï¼š{item.interpretation}
              </div>
              <div className="text-sm">
                <span className="font-semibold">å·²åº”ç”¨ï¼š</span>
                <ul className="mt-1 space-y-1">
                  {item.appliedChanges.map((change, i) => (
                    <li key={i} className="flex items-center gap-2">
                      <span className="text-green-600">âœ“</span>
                      <span>{change}</span>
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};
\`\`\`

**åç«¯ API å®ç°ï¼š**

\`\`\`typescript
// apps/api/src/routes/agents/customize.ts
import { FastifyInstance } from 'fastify';
import { z } from 'zod';

const CustomizeSchema = z.object({
  instruction: z.string().min(5).max(500)
});

export async function customizeRoutes(fastify: FastifyInstance) {
  fastify.post('/agents/:agentId/customize', async (request, reply) => {
    const { agentId } = request.params as { agentId: string };
    const { instruction } = CustomizeSchema.parse(request.body);

    // 1. è°ƒç”¨ AI è§£æç”¨æˆ·æŒ‡ä»¤
    const interpretation = await interpretInstruction(instruction);

    // 2. åº”ç”¨æ›´æ”¹åˆ° Agent é…ç½®
    const changes = await applyCustomization(agentId, interpretation);

    // 3. é‡å¯ Agent å®¹å™¨ï¼ˆçƒ­é‡è½½é…ç½®ï¼‰
    await restartAgentContainer(agentId);

    return {
      interpretation: interpretation.summary,
      changes: changes.map(c => c.description)
    };
  });
}

/**
 * AI è§£æç”¨æˆ·æŒ‡ä»¤
 */
async function interpretInstruction(instruction: string): Promise<any> {
  const aiPrompt = \`ç”¨æˆ·æƒ³è°ƒæ•´ä»–çš„é‡‘è Agentï¼Œä»–è¯´ï¼š

"\${instruction}"

è¯·è§£æä»–çš„æ„å›¾ï¼Œè¾“å‡ºJSONæ ¼å¼ï¼š
{
  "category": "analysis_weight" | "notification" | "data_source" | "strategy",
  "actions": [
    {"type": "adjust_weight", "dimension": "onchain", "value": 0.4},
    {"type": "add_alert", "condition": "RSI < 30", "action": "notify"},
    {"type": "filter_asset", "exclude": ["DOGE", "SHIB"]},
    {"type": "schedule_notification", "time": "08:00", "type": "daily_summary"}
  ],
  "summary": "ç”¨æˆ·å¸Œæœ›æ›´å…³æ³¨é“¾ä¸Šæ•°æ®ï¼Œå½“ RSI ä½äº 30 æ—¶æé†’"
}\`;

  const response = await callAI(aiPrompt);
  return JSON.parse(response);
}

/**
 * åº”ç”¨è‡ªå®šä¹‰åˆ° Agent é…ç½®
 */
async function applyCustomization(agentId: string, interpretation: any): Promise<any[]> {
  const changes: any[] = [];

  for (const action of interpretation.actions) {
    if (action.type === 'adjust_weight') {
      // ä¿®æ”¹ SOUL.md ä¸­çš„æƒé‡é…ç½®
      await updateSOUL(agentId, {
        [\`analysis_weights.\${action.dimension}\`]: action.value
      });

      changes.push({
        description: \`è°ƒæ•´ \${action.dimension} æƒé‡è‡³ \${Math.round(action.value * 100)}%\`
      });
    }
    // ... å…¶ä»– action ç±»å‹å¤„ç†
  }

  return changes;
}
\`\`\`

---

### 11.2 é«˜çº§è‡ªå®šä¹‰ - SOUL.md ç¼–è¾‘å™¨

**åˆ›å»ºæ–‡ä»¶ï¼š\`components/agent/SOULEditor.tsx\`**

\`\`\`typescript
import React, { useState, useEffect } from 'react';
import Editor from '@monaco-editor/react';

export const SOULEditor: React.FC<{
  agentId: string;
}> = ({ agentId }) => {
  const [soulContent, setSoulContent] = useState('');
  const [isSaving, setIsSaving] = useState(false);
  const [hasChanges, setHasChanges] = useState(false);

  useEffect(() => {
    loadSOUL();
  }, [agentId]);

  async function loadSOUL() {
    const response = await fetch(\`/api/agents/\${agentId}/soul\`);
    const data = await response.json();
    setSoulContent(data.content);
  }

  async function saveSOUL() {
    setIsSaving(true);

    try {
      await fetch(\`/api/agents/\${agentId}/soul\`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          content: soulContent,
          auto_restart: true
        })
      });

      setHasChanges(false);
      alert('ä¿å­˜æˆåŠŸï¼Agent å°†åœ¨ 30 ç§’å†…é‡å¯åº”ç”¨æ–°é…ç½®ã€‚');
    } catch (error) {
      alert('ä¿å­˜å¤±è´¥');
    } finally {
      setIsSaving(false);
    }
  }

  return (
    <div className="h-screen flex flex-col bg-gray-900">
      {/* Header */}
      <div className="flex items-center justify-between p-4 bg-gray-800 border-b border-gray-700">
        <h1 className="text-xl font-bold text-white">SOUL.md ç¼–è¾‘å™¨</h1>
        <div className="flex items-center gap-4">
          {hasChanges && (
            <span className="text-yellow-400 text-sm">æœªä¿å­˜</span>
          )}
          <button
            onClick={saveSOUL}
            disabled={!hasChanges || isSaving}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg disabled:opacity-50 hover:bg-blue-700 transition"
          >
            {isSaving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜å¹¶é‡å¯'}
          </button>
        </div>
      </div>

      {/* Editor */}
      <div className="flex-1">
        <Editor
          height="100%"
          defaultLanguage="markdown"
          theme="vs-dark"
          value={soulContent}
          onChange={(value) => {
            setSoulContent(value || '');
            setHasChanges(true);
          }}
          options={{
            fontSize: 14,
            minimap: { enabled: false },
            wordWrap: 'on',
            lineNumbers: 'on'
          }}
        />
      </div>

      {/* Tips */}
      <div className="p-4 bg-gray-800 border-t border-gray-700 text-sm text-gray-400">
        ğŸ’¡ æç¤ºï¼šSOUL.md å®šä¹‰äº† Agent çš„èº«ä»½ã€åˆ†ææƒé‡ã€ç­–ç•¥ç­‰ã€‚ä¿®æ”¹åéœ€è¦é‡å¯ Agent ç”Ÿæ•ˆã€‚
      </div>
    </div>
  );
};
\`\`\`

---

## ç« èŠ‚åäºŒï¼šå¤šè¯­è¨€ä¸å¤šæ—¶åŒº - å®Œæ•´å®ç°

### 12.1 è‡ªåŠ¨ç¿»è¯‘ç³»ç»Ÿ

**åˆ›å»ºæ–‡ä»¶ï¼š\`packages/i18n/src/translator.ts\`**

\`\`\`typescript
import { db } from '@finverse/database';

/**
 * è‡ªåŠ¨ç¿»è¯‘æœåŠ¡
 * ä½¿ç”¨ç”¨æˆ·è‡ªå·±çš„ AI API key è¿›è¡Œç¿»è¯‘
 */
export class TranslationService {
  
  /**
   * ç¿»è¯‘æ–‡æœ¬
   */
  async translate(
    text: string,
    targetLanguage: string,
    userId: string,
    context?: string
  ): Promise<string> {
    // 1. æ£€æŸ¥ç¼“å­˜
    const cacheKey = this.getCacheKey(text, targetLanguage);
    const cached = await db.redis.get(cacheKey);
    
    if (cached) {
      return cached;
    }

    // 2. è·å–ç”¨æˆ·çš„ AI API key
    const aiKey = await this.getUserAIKey(userId);

    // 3. è°ƒç”¨ AI è¿›è¡Œç¿»è¯‘
    const prompt = context
      ? \`è¯·å°†ä»¥ä¸‹\${context}ä»è‹±æ–‡ç¿»è¯‘ä¸º\${this.getLanguageName(targetLanguage)}ï¼Œä¿æŒä¸“ä¸šæœ¯è¯­å‡†ç¡®ï¼š\\n\\n\${text}\`
      : \`Translate to \${targetLanguage}:\\n\\n\${text}\`;

    const translated = await this.callAI(aiKey, prompt);

    // 4. ç¼“å­˜ç»“æœï¼ˆ30 å¤©ï¼‰
    await db.redis.setex(cacheKey, 2592000, translated);

    return translated;
  }

  /**
   * æ‰¹é‡ç¿»è¯‘ï¼ˆç”¨äºä¿¡å·æ‘˜è¦ï¼‰
   */
  async translateBatch(
    texts: string[],
    targetLanguage: string,
    userId: string
  ): Promise<string[]> {
    const promises = texts.map(text => this.translate(text, targetLanguage, userId));
    return await Promise.all(promises);
  }

  /**
   * ç¿»è¯‘ç»“æ„åŒ–ä¿¡å·
   */
  async translateSignal(
    signal: any,
    targetLanguage: string,
    userId: string
  ): Promise<any> {
    const translated = { ...signal };

    // ç¿»è¯‘ç»´åº¦æ‘˜è¦
    for (const [dim, data] of Object.entries(signal.dimensions)) {
      (translated.dimensions as any)[dim].summary = await this.translate(
        (data as any).summary,
        targetLanguage,
        userId,
        'é‡‘èåˆ†ææ‘˜è¦'
      );
    }

    // ç¿»è¯‘æ¨ç†è¿‡ç¨‹
    translated.reasoning = await this.translate(
      signal.reasoning,
      targetLanguage,
      userId,
      'é‡‘èåˆ†ææ¨ç†'
    );

    return translated;
  }

  private getCacheKey(text: string, lang: string): string {
    const hash = require('crypto').createHash('md5').update(text).digest('hex');
    return \`translation:\${lang}:\${hash}\`;
  }

  private getLanguageName(code: string): string {
    const names: Record<string, string> = {
      'zh-CN': 'ç®€ä½“ä¸­æ–‡',
      'zh-TW': 'ç¹ä½“ä¸­æ–‡',
      'ja': 'æ—¥æ–‡',
      'ko': 'éŸ©æ–‡',
      'es': 'è¥¿ç­ç‰™æ–‡',
      'fr': 'æ³•æ–‡',
      'de': 'å¾·æ–‡'
    };
    return names[code] || code;
  }

  private async getUserAIKey(userId: string): Promise<string> {
    // ä»åŠ å¯†å­˜å‚¨ä¸­è·å–
    // å®ç°çœç•¥
    return '';
  }

  private async callAI(apiKey: string, prompt: string): Promise<string> {
    // è°ƒç”¨ AI API
    // å®ç°çœç•¥
    return '';
  }
}
\`\`\`

---

### 12.2 æ—¶åŒºè½¬æ¢ä¸­é—´ä»¶

**åˆ›å»ºæ–‡ä»¶ï¼š\`packages/timezone/src/converter.ts\`**

\`\`\`typescript
import { DateTime } from 'luxon';

/**
 * æ—¶åŒºè½¬æ¢å·¥å…·
 */
export class TimezoneConverter {
  
  /**
   * å°† UTC æ—¶é—´è½¬æ¢ä¸ºç”¨æˆ·æ—¶åŒº
   */
  toUserTimezone(utcTime: Date, userTimezone: string): DateTime {
    return DateTime.fromJSDate(utcTime, { zone: 'utc' }).setZone(userTimezone);
  }

  /**
   * å°†ç”¨æˆ·æ—¶åŒºæ—¶é—´è½¬æ¢ä¸º UTC
   */
  toUTC(localTime: Date, userTimezone: string): DateTime {
    return DateTime.fromJSDate(localTime, { zone: userTimezone }).toUTC();
  }

  /**
   * æ ¼å¼åŒ–ä¸ºç”¨æˆ·å‹å¥½çš„æ—¶é—´
   */
  format(time: DateTime, format: string = 'yyyy-MM-dd HH:mm:ss'): string {
    return time.toFormat(format);
  }

  /**
   * ç›¸å¯¹æ—¶é—´ï¼ˆ"3 å°æ—¶å‰"ï¼‰
   */
  relative(time: DateTime, now: DateTime = DateTime.now()): string {
    const diffSeconds = now.diff(time, 'seconds').seconds;

    if (diffSeconds < 60) return 'åˆšåˆš';
    if (diffSeconds < 3600) return \`\${Math.floor(diffSeconds / 60)} åˆ†é’Ÿå‰\`;
    if (diffSeconds < 86400) return \`\${Math.floor(diffSeconds / 3600)} å°æ—¶å‰\`;
    if (diffSeconds < 604800) return \`\${Math.floor(diffSeconds / 86400)} å¤©å‰\`;
    
    return time.toFormat('yyyy-MM-dd');
  }

  /**
   * è®¡ç®—ç”¨æˆ·çš„å¸‚åœºå¼€ç›˜æ—¶é—´
   */
  getMarketOpenTime(market: 'US' | 'CN' | 'EU', userTimezone: string): DateTime {
    const openTimes = {
      US: { timezone: 'America/New_York', time: '09:30' },
      CN: { timezone: 'Asia/Shanghai', time: '09:30' },
      EU: { timezone: 'Europe/London', time: '08:00' }
    };

    const { timezone, time } = openTimes[market];
    const [hour, minute] = time.split(':').map(Number);

    const marketOpen = DateTime.now()
      .setZone(timezone)
      .set({ hour, minute, second: 0, millisecond: 0 });

    return marketOpen.setZone(userTimezone);
  }
}
\`\`\`

---

### 12.3 å¤šè¯­è¨€ UI æ”¯æŒ

**åˆ›å»ºæ–‡ä»¶ï¼š\`apps/web/i18n/config.ts\`**

\`\`\`typescript
export const i18nConfig = {
  locales: ['zh-CN', 'zh-TW', 'en', 'ja', 'ko', 'es'],
  defaultLocale: 'en',
  localeDetection: true
};

export const translations = {
  'zh-CN': {
    common: {
      signIn: 'ç™»å½•',
      signUp: 'æ³¨å†Œ',
      dashboard: 'ä»ªè¡¨æ¿',
      settings: 'è®¾ç½®',
      logout: 'é€€å‡º'
    },
    signals: {
      bullish: 'çœ‹å¤š',
      bearish: 'çœ‹ç©º',
      neutral: 'ä¸­æ€§',
      confidence: 'ç½®ä¿¡åº¦',
      consensus: 'å…±è¯†'
    },
    dimensions: {
      on_chain: 'é“¾ä¸Š',
      technical: 'æŠ€æœ¯',
      macro: 'å®è§‚',
      sentiment: 'æƒ…ç»ª'
    }
  },
  'en': {
    common: {
      signIn: 'Sign In',
      signUp: 'Sign Up',
      dashboard: 'Dashboard',
      settings: 'Settings',
      logout: 'Logout'
    },
    signals: {
      bullish: 'Bullish',
      bearish: 'Bearish',
      neutral: 'Neutral',
      confidence: 'Confidence',
      consensus: 'Consensus'
    },
    dimensions: {
      on_chain: 'On-Chain',
      technical: 'Technical',
      macro: 'Macro',
      sentiment: 'Sentiment'
    }
  }
  // ... å…¶ä»–è¯­è¨€
};
\`\`\`

**Next.js i18n é…ç½®ï¼š**

\`\`\`javascript
// next.config.js
module.exports = {
  i18n: {
    locales: ['zh-CN', 'zh-TW', 'en', 'ja', 'ko', 'es'],
    defaultLocale: 'en',
    localeDetection: true
  }
};
\`\`\`

---

## æ€»ç»“

ä»¥ä¸Šè¡¥å…¨äº†ä»¥ä¸‹ç« èŠ‚çš„å®Œæ•´å¼€å‘æç¤ºè¯ï¼š

âœ… **ç¬¬ 6 ç« ï¼šå…¬åŸŸï¼ˆä¿¡å·ç³»ç»Ÿï¼‰**
- ä¿¡å·æ± æ•°æ®åº“å®Œæ•´è®¾è®¡
- ä¿¡å·èšåˆç®—æ³•å®ç°
- å…±è¯†çƒ­åŠ›å›¾å‰ç«¯ç»„ä»¶

âœ… **ç¬¬ 9 ç« ï¼šå¯è§†åŒ–ï¼ˆè¡¥å…¨éƒ¨åˆ†ï¼‰**
- å›¾è¡¨æ¨¡å¼çš„å›¾å±‚ç³»ç»Ÿå®Œæ•´å®ç°
- æ•°æ®æ¨¡å¼å®Œæ•´å®ç°
- AI æ¨ç†é“¾å¯è§†åŒ–ç»„ä»¶

âœ… **ç¬¬ 10 ç« ï¼šç”¨æˆ·åˆ†ç±»ä¸åŒ¹é…ç³»ç»Ÿ**
- å¤šç»´æ ‡ç­¾æ•°æ®åº“è®¾è®¡
- åŒ¹é…ç®—æ³•å®ç°
- åå¥½æµ‹è¯•å®ç°

âœ… **ç¬¬ 11 ç« ï¼šAgent è‡ªå®šä¹‰ï¼ˆè¡¥å…¨éƒ¨åˆ†ï¼‰**
- è¿›é˜¶è‡ªå®šä¹‰ï¼ˆè‡ªç„¶è¯­è¨€è°ƒæ•™ï¼‰
- é«˜çº§è‡ªå®šä¹‰ï¼ˆSOUL.md ç¼–è¾‘å™¨ï¼‰

âœ… **ç¬¬ 12 ç« ï¼šå¤šè¯­è¨€ä¸å¤šæ—¶åŒº**
- è‡ªåŠ¨ç¿»è¯‘ç³»ç»Ÿ
- æ—¶åŒºè½¬æ¢ä¸­é—´ä»¶
- å¤šè¯­è¨€ UI æ”¯æŒ

ç°åœ¨æ‰€æœ‰é—æ¼çš„ç« èŠ‚éƒ½å·²è¡¥å…¨ï¼

        `.trim();

        // ç®€å•çš„ markdown è§£æå™¨
        function parseMarkdown(md) {
            let html = md;

            // Headers
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');

            // Bold
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // Italic
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // Code blocks
            html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                const id = 'code-' + Math.random().toString(36).substr(2, 9);
                return `<div class="code-block"><pre id="${id}"><code>${escapeHtml(code.trim())}</code></pre><button class="copy-btn" onclick="copyCode('${id}')">å¤åˆ¶</button></div>`;
            });

            // Inline code
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

            // Links
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');

            // Blockquotes
            html = html.replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>');

            // Lists
            html = html.replace(/^\- (.*$)/gim, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

            // Paragraphs
            html = html.split('\n\n').map(para => {
                if (para.startsWith('<') || para.trim() === '') return para;
                return `<p>${para}</p>`;
            }).join('\n');

            return html;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // æå–ç« èŠ‚ç»“æ„
        function extractChapters(content) {
            const lines = content.split('\n');
            const chapters = [];
            let currentChapter = null;

            lines.forEach(line => {
                if (line.startsWith('# ') || line.startsWith('## ç« èŠ‚')) {
                    if (currentChapter) {
                        chapters.push(currentChapter);
                    }
                    currentChapter = {
                        title: line.replace(/^#+\s*/, ''),
                        content: line + '\n',
                        sections: []
                    };
                } else if (line.startsWith('### ') && currentChapter) {
                    currentChapter.sections.push(line.replace(/^###\s*/, ''));
                    currentChapter.content += line + '\n';
                } else if (currentChapter) {
                    currentChapter.content += line + '\n';
                }
            });

            if (currentChapter) {
                chapters.push(currentChapter);
            }

            return chapters;
        }

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            // è¿™é‡Œä¼šåµŒå…¥å®é™…çš„ markdown å†…å®¹
            // ç”±äºå†…å®¹å¤ªå¤§ï¼Œæˆ‘ä¼šåœ¨åç»­æ­¥éª¤ä¸­å®Œæˆ
            const content = CHAPTERS_CONTENT;
            
            const chapters = extractChapters(content);
            
            // æ¸²æŸ“å¯¼èˆª
            renderNavigation(chapters);
            
            // æ¸²æŸ“å†…å®¹
            renderContent(chapters);
            
            // åˆå§‹åŒ–æœç´¢
            initSearch(content);
            
            // åˆå§‹åŒ–è¿›åº¦è¿½è¸ª
            initProgress(chapters);
            
            // ç»Ÿè®¡ä»£ç å—æ•°é‡
            updateStats();

            // æ˜¾ç¤ºåº”ç”¨
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
        }

        function renderNavigation(chapters) {
            const navTree = document.getElementById('nav-tree');
            chapters.forEach((chapter, index) => {
                const chapterDiv = document.createElement('div');
                chapterDiv.className = 'nav-chapter';
                chapterDiv.innerHTML = `
                    <div class="nav-chapter-title" onclick="toggleChapter(${index})">
                        <span class="nav-chapter-icon">${index + 1}</span>
                        <span>${chapter.title}</span>
                    </div>
                    <div class="nav-sections">
                        ${chapter.sections.map(section => 
                            `<div class="nav-section">${section}</div>`
                        ).join('')}
                    </div>
                `;
                navTree.appendChild(chapterDiv);
            });
        }

        function renderContent(chapters) {
            const contentDiv = document.getElementById('content');
            chapters.forEach(chapter => {
                const html = parseMarkdown(chapter.content);
                contentDiv.innerHTML += html;
            });
        }

        function toggleChapter(index) {
            const chapters = document.querySelectorAll('.nav-chapter');
            chapters[index].classList.toggle('expanded');
        }

        function initSearch(content) {
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                if (query.length < 2) return;

                const contentDiv = document.getElementById('content');
                const html = contentDiv.innerHTML;
                
                // ç®€å•çš„é«˜äº®å®ç°
                const highlighted = html.replace(
                    new RegExp(query, 'gi'),
                    match => `<mark style="background: #f59e0b; color: #000;">${match}</mark>`
                );
                
                contentDiv.innerHTML = highlighted;
            });
        }

        function initProgress(chapters) {
            const progressList = document.getElementById('progress-list');
            const saved = JSON.parse(localStorage.getItem('finverse-progress') || '{}');

            chapters.forEach((chapter, index) => {
                const item = document.createElement('div');
                item.className = 'progress-item';
                item.innerHTML = `
                    <input 
                        type="checkbox" 
                        class="progress-checkbox" 
                        id="progress-${index}"
                        ${saved[index] ? 'checked' : ''}
                        onchange="saveProgress(${index}, this.checked)"
                    >
                    <label for="progress-${index}">${chapter.title.substring(0, 20)}...</label>
                `;
                progressList.appendChild(item);
            });
        }

        function saveProgress(index, checked) {
            const saved = JSON.parse(localStorage.getItem('finverse-progress') || '{}');
            saved[index] = checked;
            localStorage.setItem('finverse-progress', JSON.stringify(saved));
        }

        function updateStats() {
            const codeBlocks = document.querySelectorAll('pre code');
            document.getElementById('code-block-count').textContent = codeBlocks.length;
        }

        function copyCode(id) {
            const codeBlock = document.getElementById(id);
            const code = codeBlock.textContent;
            navigator.clipboard.writeText(code).then(() => {
                const btn = codeBlock.nextElementSibling;
                btn.textContent = 'âœ“ å·²å¤åˆ¶';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'å¤åˆ¶';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        function copyAll() {
            const content = document.getElementById('content').textContent;
            navigator.clipboard.writeText(content).then(() => {
                alert('å·²å¤åˆ¶å…¨éƒ¨å†…å®¹åˆ°å‰ªè´´æ¿ï¼');
            });
        }

        // å¯åŠ¨åº”ç”¨
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
